# ğŸŒ¸æˆ‘çš„SpringCloudâ˜ï¸ç¬”è®°ğŸŒ¸







## ğŸ”è®¤è¯†å¾®æœåŠ¡

éšç€äº’è”ç½‘è¡Œä¸šçš„å‘å±•ï¼Œå¯¹æœåŠ¡çš„è¦æ±‚ä¹Ÿè¶Šæ¥è¶Šé«˜ï¼ŒæœåŠ¡æ¶æ„ä¹Ÿä»å•ä½“æ¶æ„é€æ¸æ¼”å˜ä¸ºç°åœ¨æµè¡Œçš„å¾®æœåŠ¡æ¶æ„ã€‚è¿™äº›æ¶æ„ä¹‹é—´æœ‰æ€æ ·çš„å·®åˆ«å‘¢ï¼Ÿ



### å•ä½“æ¶æ„

**å•ä½“æ¶æ„**ï¼šå°†ä¸šåŠ¡çš„æ‰€æœ‰åŠŸèƒ½é›†ä¸­åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­å¼€å‘ï¼Œæ‰“æˆä¸€ä¸ªåŒ…éƒ¨ç½²ã€‚

![image-20210713202807818](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713202807818.png)

å•ä½“æ¶æ„çš„ä¼˜ç¼ºç‚¹å¦‚ä¸‹ï¼š

**ä¼˜ç‚¹ï¼š**

- æ¶æ„ç®€å•
- éƒ¨ç½²æˆæœ¬ä½

**ç¼ºç‚¹ï¼š**

- è€¦åˆåº¦é«˜ï¼ˆç»´æŠ¤å›°éš¾ã€å‡çº§å›°éš¾ï¼‰



### åˆ†å¸ƒå¼æ¶æ„

**åˆ†å¸ƒå¼æ¶æ„**ï¼šæ ¹æ®ä¸šåŠ¡åŠŸèƒ½å¯¹ç³»ç»Ÿåšæ‹†åˆ†ï¼Œæ¯ä¸ªä¸šåŠ¡åŠŸèƒ½æ¨¡å—ä½œä¸ºç‹¬ç«‹é¡¹ç›®å¼€å‘ï¼Œç§°ä¸ºä¸€ä¸ªæœåŠ¡ã€‚

![image-20210713203124797](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713203124797.png)



åˆ†å¸ƒå¼æ¶æ„çš„ä¼˜ç¼ºç‚¹ï¼š

**ä¼˜ç‚¹ï¼š**

- é™ä½æœåŠ¡è€¦åˆ
- æœ‰åˆ©äºæœåŠ¡å‡çº§å’Œæ‹“å±•

**ç¼ºç‚¹ï¼š**

- æœåŠ¡è°ƒç”¨å…³ç³»é”™ç»¼å¤æ‚



åˆ†å¸ƒå¼æ¶æ„è™½ç„¶é™ä½äº†æœåŠ¡è€¦åˆï¼Œä½†æ˜¯æœåŠ¡æ‹†åˆ†æ—¶ä¹Ÿæœ‰å¾ˆå¤šé—®é¢˜éœ€è¦æ€è€ƒï¼š

- æœåŠ¡æ‹†åˆ†çš„ç²’åº¦å¦‚ä½•ç•Œå®šï¼Ÿ
- æœåŠ¡ä¹‹é—´å¦‚ä½•è°ƒç”¨ï¼Ÿ
- æœåŠ¡çš„è°ƒç”¨å…³ç³»å¦‚ä½•ç®¡ç†ï¼Ÿ

äººä»¬éœ€è¦åˆ¶å®šä¸€å¥—è¡Œä¹‹æœ‰æ•ˆçš„æ ‡å‡†æ¥çº¦æŸåˆ†å¸ƒå¼æ¶æ„ã€‚



### å¾®æœåŠ¡

å¾®æœåŠ¡çš„æ¶æ„ç‰¹å¾ï¼š

- å•ä¸€èŒè´£ï¼šå¾®æœåŠ¡æ‹†åˆ†ç²’åº¦æ›´å°ï¼Œæ¯ä¸€ä¸ªæœåŠ¡éƒ½å¯¹åº”å”¯ä¸€çš„ä¸šåŠ¡èƒ½åŠ›ï¼Œåšåˆ°å•ä¸€èŒè´£
- è‡ªæ²»ï¼šå›¢é˜Ÿç‹¬ç«‹ã€æŠ€æœ¯ç‹¬ç«‹ã€æ•°æ®ç‹¬ç«‹ï¼Œç‹¬ç«‹éƒ¨ç½²å’Œäº¤ä»˜
- é¢å‘æœåŠ¡ï¼šæœåŠ¡æä¾›ç»Ÿä¸€æ ‡å‡†çš„æ¥å£ï¼Œä¸è¯­è¨€å’ŒæŠ€æœ¯æ— å…³
- éš”ç¦»æ€§å¼ºï¼šæœåŠ¡è°ƒç”¨åšå¥½éš”ç¦»ã€å®¹é”™ã€é™çº§ï¼Œé¿å…å‡ºç°çº§è”é—®é¢˜

![image-20210713203753373](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713203753373.png)

å¾®æœåŠ¡çš„ä¸Šè¿°ç‰¹æ€§å…¶å®æ˜¯åœ¨ç»™åˆ†å¸ƒå¼æ¶æ„åˆ¶å®šä¸€ä¸ªæ ‡å‡†ï¼Œè¿›ä¸€æ­¥é™ä½æœåŠ¡ä¹‹é—´çš„è€¦åˆåº¦ï¼Œæä¾›æœåŠ¡çš„ç‹¬ç«‹æ€§å’Œçµæ´»æ€§ã€‚åšåˆ°é«˜å†…èšï¼Œä½è€¦åˆã€‚

å› æ­¤ï¼Œå¯ä»¥è®¤ä¸º**å¾®æœåŠ¡**æ˜¯ä¸€ç§ç»è¿‡è‰¯å¥½æ¶æ„è®¾è®¡çš„**åˆ†å¸ƒå¼æ¶æ„æ–¹æ¡ˆ** ã€‚

ä½†æ–¹æ¡ˆè¯¥æ€ä¹ˆè½åœ°ï¼Ÿé€‰ç”¨ä»€ä¹ˆæ ·çš„æŠ€æœ¯æ ˆï¼Ÿå…¨çƒçš„äº’è”ç½‘å…¬å¸éƒ½åœ¨ç§¯æå°è¯•è‡ªå·±çš„å¾®æœåŠ¡è½åœ°æ–¹æ¡ˆã€‚

å…¶ä¸­åœ¨Javaé¢†åŸŸæœ€å¼•äººæ³¨ç›®çš„å°±æ˜¯SpringCloudæä¾›çš„æ–¹æ¡ˆäº†ã€‚



### SpringCloud

SpringCloudæ˜¯ç›®å‰å›½å†…ä½¿ç”¨æœ€å¹¿æ³›çš„å¾®æœåŠ¡æ¡†æ¶ã€‚å®˜ç½‘åœ°å€ï¼šhttps://spring.io/projects/spring-cloudã€‚

SpringCloudé›†æˆäº†å„ç§å¾®æœåŠ¡åŠŸèƒ½ç»„ä»¶ï¼Œå¹¶åŸºäºSpringBootå®ç°äº†è¿™äº›ç»„ä»¶çš„è‡ªåŠ¨è£…é…ï¼Œä»è€Œæä¾›äº†è‰¯å¥½çš„å¼€ç®±å³ç”¨ä½“éªŒã€‚

å…¶ä¸­å¸¸è§çš„ç»„ä»¶åŒ…æ‹¬ï¼š

![image-20210713204155887](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713204155887.png)



å¦å¤–ï¼ŒSpringCloudåº•å±‚æ˜¯ä¾èµ–äºSpringBootçš„ï¼Œå¹¶ä¸”æœ‰ç‰ˆæœ¬çš„å…¼å®¹å…³ç³»ï¼Œå¦‚ä¸‹ï¼š

![image-20210713205003790](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713205003790.png)

æˆ‘ä»¬è¯¾å ‚å­¦ä¹ çš„ç‰ˆæœ¬æ˜¯ Hoxton.SR10ï¼Œå› æ­¤å¯¹åº”çš„SpringBootç‰ˆæœ¬æ˜¯2.3.xç‰ˆæœ¬ã€‚



### æ€»ç»“

- å•ä½“æ¶æ„ï¼šç®€å•æ–¹ä¾¿ï¼Œé«˜åº¦è€¦åˆï¼Œæ‰©å±•æ€§å·®ï¼Œé€‚åˆå°å‹é¡¹ç›®ã€‚ä¾‹å¦‚ï¼šå­¦ç”Ÿç®¡ç†ç³»ç»Ÿ

- åˆ†å¸ƒå¼æ¶æ„ï¼šæ¾è€¦åˆï¼Œæ‰©å±•æ€§å¥½ï¼Œä½†æ¶æ„å¤æ‚ï¼Œéš¾åº¦å¤§ã€‚é€‚åˆå¤§å‹äº’è”ç½‘é¡¹ç›®ï¼Œä¾‹å¦‚ï¼šäº¬ä¸œã€æ·˜å®

- å¾®æœåŠ¡ï¼šä¸€ç§è‰¯å¥½çš„åˆ†å¸ƒå¼æ¶æ„æ–¹æ¡ˆ

  â‘ ä¼˜ç‚¹ï¼šæ‹†åˆ†ç²’åº¦æ›´å°ã€æœåŠ¡æ›´ç‹¬ç«‹ã€è€¦åˆåº¦æ›´ä½

  â‘¡ç¼ºç‚¹ï¼šæ¶æ„éå¸¸å¤æ‚ï¼Œè¿ç»´ã€ç›‘æ§ã€éƒ¨ç½²éš¾åº¦æé«˜

- SpringCloudæ˜¯å¾®æœåŠ¡æ¶æ„çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆï¼Œé›†æˆäº†å„ç§ä¼˜ç§€å¾®æœåŠ¡åŠŸèƒ½ç»„ä»¶





## â™¾ï¸æœåŠ¡æ‹†åˆ†å’Œè¿œç¨‹è°ƒç”¨

ä»»ä½•åˆ†å¸ƒå¼æ¶æ„éƒ½ç¦»ä¸å¼€æœåŠ¡çš„æ‹†åˆ†ï¼Œå¾®æœåŠ¡ä¹Ÿæ˜¯ä¸€æ ·ã€‚

### æœåŠ¡æ‹†åˆ†åŸåˆ™

è¿™é‡Œæˆ‘æ€»ç»“äº†å¾®æœåŠ¡æ‹†åˆ†æ—¶çš„å‡ ä¸ªåŸåˆ™ï¼š

- ä¸åŒå¾®æœåŠ¡ï¼Œä¸è¦é‡å¤å¼€å‘ç›¸åŒä¸šåŠ¡
- å¾®æœåŠ¡æ•°æ®ç‹¬ç«‹ï¼Œä¸è¦è®¿é—®å…¶å®ƒå¾®æœåŠ¡çš„æ•°æ®åº“
- å¾®æœåŠ¡å¯ä»¥å°†è‡ªå·±çš„ä¸šåŠ¡æš´éœ²ä¸ºæ¥å£ï¼Œä¾›å…¶å®ƒå¾®æœåŠ¡è°ƒç”¨

![image-20210713210800950](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713210800950.png)



### æœåŠ¡æ‹†åˆ†ç¤ºä¾‹

ä»¥è¯¾å‰èµ„æ–™ä¸­çš„å¾®æœåŠ¡cloud-demoä¸ºä¾‹ï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š

![image-20210713211009593](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713211009593.png)

cloud-demoï¼šçˆ¶å·¥ç¨‹ï¼Œç®¡ç†ä¾èµ–

- order-serviceï¼šè®¢å•å¾®æœåŠ¡ï¼Œè´Ÿè´£è®¢å•ç›¸å…³ä¸šåŠ¡
- user-serviceï¼šç”¨æˆ·å¾®æœåŠ¡ï¼Œè´Ÿè´£ç”¨æˆ·ç›¸å…³ä¸šåŠ¡

è¦æ±‚ï¼š

- è®¢å•å¾®æœåŠ¡å’Œç”¨æˆ·å¾®æœåŠ¡éƒ½å¿…é¡»æœ‰å„è‡ªçš„æ•°æ®åº“ï¼Œç›¸äº’ç‹¬ç«‹
- è®¢å•æœåŠ¡å’Œç”¨æˆ·æœåŠ¡éƒ½å¯¹å¤–æš´éœ²Restfulçš„æ¥å£
- è®¢å•æœåŠ¡å¦‚æœéœ€è¦æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œåªèƒ½è°ƒç”¨ç”¨æˆ·æœåŠ¡çš„Restfulæ¥å£ï¼Œä¸èƒ½æŸ¥è¯¢ç”¨æˆ·æ•°æ®åº“



### å¯¼å…¥Sqlè¯­å¥

é¦–å…ˆï¼Œå°†è¯¾å‰èµ„æ–™æä¾›çš„`cloud-order.sql`å’Œ`cloud-user.sql`å¯¼å…¥åˆ°mysqlä¸­ï¼š

![image-20210713211417049](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713211417049.png)



cloud-userè¡¨ä¸­åˆå§‹æ•°æ®å¦‚ä¸‹ï¼š

![image-20210713211550169](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713211550169.png)

cloud-orderè¡¨ä¸­åˆå§‹æ•°æ®å¦‚ä¸‹ï¼š

![image-20210713211657319](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713211657319.png)



cloud-orderè¡¨ä¸­æŒæœ‰cloud-userè¡¨ä¸­çš„idå­—æ®µã€‚



### å¯¼å…¥demoå·¥ç¨‹

ç”¨IDEAå¯¼å…¥è¯¾å‰èµ„æ–™æä¾›çš„Demoï¼š

![image-20210713211814094](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713211814094.png)



é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š

![image-20210713212656887](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713212656887.png)





å¯¼å…¥åï¼Œä¼šåœ¨IDEAå³ä¸‹è§’å‡ºç°å¼¹çª—ï¼š

![image-20210713212349272](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713212349272.png)

ç‚¹å‡»å¼¹çª—ï¼Œç„¶åæŒ‰ä¸‹å›¾é€‰æ‹©ï¼š

![image-20210713212336185](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713212336185.png)

ä¼šå‡ºç°è¿™æ ·çš„èœå•ï¼š

![image-20210713212513324](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713212513324.png)



é…ç½®ä¸‹é¡¹ç›®ä½¿ç”¨çš„JDKï¼š

![image-20210713220736408](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713220736408.png)



### å®ç°è¿œç¨‹è°ƒç”¨æ¡ˆä¾‹



åœ¨order-serviceæœåŠ¡ä¸­ï¼Œæœ‰ä¸€ä¸ªæ ¹æ®idæŸ¥è¯¢è®¢å•çš„æ¥å£ï¼š

![image-20210713212749575](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713212749575.png)

æ ¹æ®idæŸ¥è¯¢è®¢å•ï¼Œè¿”å›å€¼æ˜¯Orderå¯¹è±¡ï¼Œå¦‚å›¾ï¼š

![image-20210713212901725](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713212901725.png)

å…¶ä¸­çš„userä¸ºnull





åœ¨user-serviceä¸­æœ‰ä¸€ä¸ªæ ¹æ®idæŸ¥è¯¢ç”¨æˆ·çš„æ¥å£ï¼š

![image-20210713213146089](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713213146089.png)

æŸ¥è¯¢çš„ç»“æœå¦‚å›¾ï¼š

![image-20210713213213075](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713213213075.png)





### æ¡ˆä¾‹éœ€æ±‚ï¼š

ä¿®æ”¹order-serviceä¸­çš„æ ¹æ®idæŸ¥è¯¢è®¢å•ä¸šåŠ¡ï¼Œè¦æ±‚åœ¨æŸ¥è¯¢è®¢å•çš„åŒæ—¶ï¼Œæ ¹æ®è®¢å•ä¸­åŒ…å«çš„userIdæŸ¥è¯¢å‡ºç”¨æˆ·ä¿¡æ¯ï¼Œä¸€èµ·è¿”å›ã€‚

![image-20210713213312278](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713213312278.png)



å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨order-serviceä¸­ å‘user-serviceå‘èµ·ä¸€ä¸ªhttpçš„è¯·æ±‚ï¼Œè°ƒç”¨http://localhost:8081/user/{userId}è¿™ä¸ªæ¥å£ã€‚

å¤§æ¦‚çš„æ­¥éª¤æ˜¯è¿™æ ·çš„ï¼š

- æ³¨å†Œä¸€ä¸ªRestTemplateçš„å®ä¾‹åˆ°Springå®¹å™¨
- ä¿®æ”¹order-serviceæœåŠ¡ä¸­çš„OrderServiceç±»ä¸­çš„queryOrderByIdæ–¹æ³•ï¼Œæ ¹æ®Orderå¯¹è±¡ä¸­çš„userIdæŸ¥è¯¢User
- å°†æŸ¥è¯¢çš„Userå¡«å……åˆ°Orderå¯¹è±¡ï¼Œä¸€èµ·è¿”å›



### æ³¨å†ŒRestTemplate

é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨order-serviceæœåŠ¡ä¸­çš„OrderApplicationå¯åŠ¨ç±»ä¸­ï¼Œæ³¨å†ŒRestTemplateå®ä¾‹ï¼š

```java
package com.ganga.order;

import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.web.client.RestTemplate;

@MapperScan("com.ganga.order.mapper")
@SpringBootApplication
public class OrderApplication {

    public static void main(String[] args) {
        SpringApplication.run(OrderApplication.class, args);
    }

    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```



### å®ç°è¿œç¨‹è°ƒç”¨

ä¿®æ”¹order-serviceæœåŠ¡ä¸­çš„com.ganga.order.serviceåŒ…ä¸‹çš„OrderServiceç±»ä¸­çš„queryOrderByIdæ–¹æ³•ï¼š

![image-20210713213959569](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713213959569.png)







### æä¾›è€…ä¸æ¶ˆè´¹è€…

åœ¨æœåŠ¡è°ƒç”¨å…³ç³»ä¸­ï¼Œä¼šæœ‰ä¸¤ä¸ªä¸åŒçš„è§’è‰²ï¼š

**æœåŠ¡æä¾›è€…**ï¼šä¸€æ¬¡ä¸šåŠ¡ä¸­ï¼Œè¢«å…¶å®ƒå¾®æœåŠ¡è°ƒç”¨çš„æœåŠ¡ã€‚ï¼ˆæä¾›æ¥å£ç»™å…¶å®ƒå¾®æœåŠ¡ï¼‰

**æœåŠ¡æ¶ˆè´¹è€…**ï¼šä¸€æ¬¡ä¸šåŠ¡ä¸­ï¼Œè°ƒç”¨å…¶å®ƒå¾®æœåŠ¡çš„æœåŠ¡ã€‚ï¼ˆè°ƒç”¨å…¶å®ƒå¾®æœåŠ¡æä¾›çš„æ¥å£ï¼‰

![image-20210713214404481](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713214404481.png)



ä½†æ˜¯ï¼ŒæœåŠ¡æä¾›è€…ä¸æœåŠ¡æ¶ˆè´¹è€…çš„è§’è‰²å¹¶ä¸æ˜¯ç»å¯¹çš„ï¼Œè€Œæ˜¯ç›¸å¯¹äºä¸šåŠ¡è€Œè¨€ã€‚

å¦‚æœæœåŠ¡Aè°ƒç”¨äº†æœåŠ¡Bï¼Œè€ŒæœåŠ¡Båˆè°ƒç”¨äº†æœåŠ¡Cï¼ŒæœåŠ¡Bçš„è§’è‰²æ˜¯ä»€ä¹ˆï¼Ÿ

- å¯¹äºAè°ƒç”¨Bçš„ä¸šåŠ¡è€Œè¨€ï¼šAæ˜¯æœåŠ¡æ¶ˆè´¹è€…ï¼ŒBæ˜¯æœåŠ¡æä¾›è€…
- å¯¹äºBè°ƒç”¨Cçš„ä¸šåŠ¡è€Œè¨€ï¼šBæ˜¯æœåŠ¡æ¶ˆè´¹è€…ï¼ŒCæ˜¯æœåŠ¡æä¾›è€…



å› æ­¤ï¼ŒæœåŠ¡Bæ—¢å¯ä»¥æ˜¯æœåŠ¡æä¾›è€…ï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡æ¶ˆè´¹è€…ã€‚



## ğŸ—‚ï¸ç»„ä»¶-æ³¨å†Œä¸­å¿ƒ



### ğŸ”–Eurekaæ³¨å†Œä¸­å¿ƒ



å‡å¦‚æˆ‘ä»¬çš„æœåŠ¡æä¾›è€…user-serviceéƒ¨ç½²äº†å¤šä¸ªå®ä¾‹ï¼Œå¦‚å›¾ï¼š

![image-20210713214925388](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713214925388.png)



å¤§å®¶æ€è€ƒå‡ ä¸ªé—®é¢˜ï¼š

- order-serviceåœ¨å‘èµ·è¿œç¨‹è°ƒç”¨çš„æ—¶å€™ï¼Œè¯¥å¦‚ä½•å¾—çŸ¥user-serviceå®ä¾‹çš„ipåœ°å€å’Œç«¯å£ï¼Ÿ
- æœ‰å¤šä¸ªuser-serviceå®ä¾‹åœ°å€ï¼Œorder-serviceè°ƒç”¨æ—¶è¯¥å¦‚ä½•é€‰æ‹©ï¼Ÿ
- order-serviceå¦‚ä½•å¾—çŸ¥æŸä¸ªuser-serviceå®ä¾‹æ˜¯å¦ä¾ç„¶å¥åº·ï¼Œæ˜¯ä¸æ˜¯å·²ç»å®•æœºï¼Ÿ



#### Eurekaçš„ç»“æ„å’Œä½œç”¨

è¿™äº›é—®é¢˜éƒ½éœ€è¦åˆ©ç”¨SpringCloudä¸­çš„æ³¨å†Œä¸­å¿ƒæ¥è§£å†³ï¼Œå…¶ä¸­æœ€å¹¿ä¸ºäººçŸ¥çš„æ³¨å†Œä¸­å¿ƒå°±æ˜¯Eurekaï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š

![image-20210713220104956](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713220104956.png)



å›ç­”ä¹‹å‰çš„å„ä¸ªé—®é¢˜ã€‚

é—®é¢˜1ï¼šorder-serviceå¦‚ä½•å¾—çŸ¥user-serviceå®ä¾‹åœ°å€ï¼Ÿ

è·å–åœ°å€ä¿¡æ¯çš„æµç¨‹å¦‚ä¸‹ï¼š

- user-serviceæœåŠ¡å®ä¾‹å¯åŠ¨åï¼Œå°†è‡ªå·±çš„ä¿¡æ¯æ³¨å†Œåˆ°eureka-serverï¼ˆEurekaæœåŠ¡ç«¯ï¼‰ã€‚è¿™ä¸ªå«æœåŠ¡æ³¨å†Œ
- eureka-serverä¿å­˜æœåŠ¡åç§°åˆ°æœåŠ¡å®ä¾‹åœ°å€åˆ—è¡¨çš„æ˜ å°„å…³ç³»
- order-serviceæ ¹æ®æœåŠ¡åç§°ï¼Œæ‹‰å–å®ä¾‹åœ°å€åˆ—è¡¨ã€‚è¿™ä¸ªå«æœåŠ¡å‘ç°æˆ–æœåŠ¡æ‹‰å–



é—®é¢˜2ï¼šorder-serviceå¦‚ä½•ä»å¤šä¸ªuser-serviceå®ä¾‹ä¸­é€‰æ‹©å…·ä½“çš„å®ä¾‹ï¼Ÿ

- order-serviceä»å®ä¾‹åˆ—è¡¨ä¸­åˆ©ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•é€‰ä¸­ä¸€ä¸ªå®ä¾‹åœ°å€
- å‘è¯¥å®ä¾‹åœ°å€å‘èµ·è¿œç¨‹è°ƒç”¨



é—®é¢˜3ï¼šorder-serviceå¦‚ä½•å¾—çŸ¥æŸä¸ªuser-serviceå®ä¾‹æ˜¯å¦ä¾ç„¶å¥åº·ï¼Œæ˜¯ä¸æ˜¯å·²ç»å®•æœºï¼Ÿ

- user-serviceä¼šæ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆé»˜è®¤30ç§’ï¼‰å‘eureka-serverå‘èµ·è¯·æ±‚ï¼ŒæŠ¥å‘Šè‡ªå·±çŠ¶æ€ï¼Œç§°ä¸ºå¿ƒè·³
- å½“è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰å‘é€å¿ƒè·³æ—¶ï¼Œeureka-serverä¼šè®¤ä¸ºå¾®æœåŠ¡å®ä¾‹æ•…éšœï¼Œå°†è¯¥å®ä¾‹ä»æœåŠ¡åˆ—è¡¨ä¸­å‰”é™¤
- order-serviceæ‹‰å–æœåŠ¡æ—¶ï¼Œå°±èƒ½å°†æ•…éšœå®ä¾‹æ’é™¤äº†



> æ³¨æ„ï¼šä¸€ä¸ªå¾®æœåŠ¡ï¼Œæ—¢å¯ä»¥æ˜¯æœåŠ¡æä¾›è€…ï¼Œåˆå¯ä»¥æ˜¯æœåŠ¡æ¶ˆè´¹è€…ï¼Œå› æ­¤eurekaå°†æœåŠ¡æ³¨å†Œã€æœåŠ¡å‘ç°ç­‰åŠŸèƒ½ç»Ÿä¸€å°è£…åˆ°äº†eureka-clientç«¯



å› æ­¤ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åŠ¨æ‰‹å®è·µçš„æ­¥éª¤åŒ…æ‹¬ï¼š

![image-20210713220509769](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713220509769.png)



#### æ­å»ºeureka-server

é¦–å…ˆå¤§å®¶æ³¨å†Œä¸­å¿ƒæœåŠ¡ç«¯ï¼šeureka-serverï¼Œè¿™å¿…é¡»æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡

##### åˆ›å»ºeureka-serveræœåŠ¡

åœ¨cloud-demoçˆ¶å·¥ç¨‹ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªå­æ¨¡å—ï¼š

![image-20210713220605881](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713220605881.png)

å¡«å†™æ¨¡å—ä¿¡æ¯ï¼š

![image-20210713220857396](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713220857396.png)



ç„¶åå¡«å†™æœåŠ¡ä¿¡æ¯ï¼š

![image-20210713221339022](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713221339022.png)



##### å¼•å…¥eurekaä¾èµ–

å¼•å…¥SpringCloudä¸ºeurekaæä¾›çš„starterä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
</dependency>
```



##### ç¼–å†™å¯åŠ¨ç±»

ç»™eureka-serveræœåŠ¡ç¼–å†™ä¸€ä¸ªå¯åŠ¨ç±»ï¼Œä¸€å®šè¦æ·»åŠ ä¸€ä¸ª@EnableEurekaServeræ³¨è§£ï¼Œå¼€å¯eurekaçš„æ³¨å†Œä¸­å¿ƒåŠŸèƒ½ï¼š

```java
package com.ganga.eureka;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

@SpringBootApplication
@EnableEurekaServer
public class EurekaApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaApplication.class, args);
    }
}
```



##### ç¼–å†™é…ç½®æ–‡ä»¶

ç¼–å†™ä¸€ä¸ªapplication.ymlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```yaml
server:
  port: 10086
spring:
  application:
    name: eureka-server
eureka:
  client:
    service-url: 
      defaultZone: http://127.0.0.1:10086/eureka
```



##### å¯åŠ¨æœåŠ¡

å¯åŠ¨å¾®æœåŠ¡ï¼Œç„¶ååœ¨æµè§ˆå™¨è®¿é—®ï¼šhttp://127.0.0.1:10086

çœ‹åˆ°ä¸‹é¢ç»“æœåº”è¯¥æ˜¯æˆåŠŸäº†ï¼š

![image-20210713222157190](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713222157190.png)







#### æœåŠ¡æ³¨å†Œ

ä¸‹é¢ï¼Œæˆ‘ä»¬å°†user-serviceæ³¨å†Œåˆ°eureka-serverä¸­å»ã€‚

##### å¼•å…¥ä¾èµ–

åœ¨user-serviceçš„pomæ–‡ä»¶ä¸­ï¼Œå¼•å…¥ä¸‹é¢çš„eureka-clientä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```



##### é…ç½®æ–‡ä»¶

åœ¨user-serviceä¸­ï¼Œä¿®æ”¹application.ymlæ–‡ä»¶ï¼Œæ·»åŠ æœåŠ¡åç§°ã€eurekaåœ°å€ï¼š

```yaml
spring:
  application:
    name: userservice
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka
```



##### å¯åŠ¨å¤šä¸ªuser-serviceå®ä¾‹

ä¸ºäº†æ¼”ç¤ºä¸€ä¸ªæœåŠ¡æœ‰å¤šä¸ªå®ä¾‹çš„åœºæ™¯ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªSpringBootçš„å¯åŠ¨é…ç½®ï¼Œå†å¯åŠ¨ä¸€ä¸ªuser-serviceã€‚



é¦–å…ˆï¼Œå¤åˆ¶åŸæ¥çš„user-serviceå¯åŠ¨é…ç½®ï¼š

![image-20210713222656562](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713222656562.png)

ç„¶åï¼Œåœ¨å¼¹å‡ºçš„çª—å£ä¸­ï¼Œå¡«å†™ä¿¡æ¯ï¼š

![image-20210713222757702](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713222757702.png)



ç°åœ¨ï¼ŒSpringBootçª—å£ä¼šå‡ºç°ä¸¤ä¸ªuser-serviceå¯åŠ¨é…ç½®ï¼š

![image-20210713222841951](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713222841951.png)

ä¸è¿‡ï¼Œç¬¬ä¸€ä¸ªæ˜¯8081ç«¯å£ï¼Œç¬¬äºŒä¸ªæ˜¯8082ç«¯å£ã€‚

å¯åŠ¨ä¸¤ä¸ªuser-serviceå®ä¾‹ï¼š

![image-20210713223041491](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713223041491.png)

æŸ¥çœ‹eureka-serverç®¡ç†é¡µé¢ï¼š

![image-20210713223150650](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713223150650.png)





#### æœåŠ¡å‘ç°

ä¸‹é¢ï¼Œæˆ‘ä»¬å°†order-serviceçš„é€»è¾‘ä¿®æ”¹ï¼šå‘eureka-serveræ‹‰å–user-serviceçš„ä¿¡æ¯ï¼Œå®ç°æœåŠ¡å‘ç°ã€‚

##### å¼•å…¥ä¾èµ–

ä¹‹å‰è¯´è¿‡ï¼ŒæœåŠ¡å‘ç°ã€æœåŠ¡æ³¨å†Œç»Ÿä¸€éƒ½å°è£…åœ¨eureka-clientä¾èµ–ï¼Œå› æ­¤è¿™ä¸€æ­¥ä¸æœåŠ¡æ³¨å†Œæ—¶ä¸€è‡´ã€‚

åœ¨order-serviceçš„pomæ–‡ä»¶ä¸­ï¼Œå¼•å…¥ä¸‹é¢çš„eureka-clientä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```



##### é…ç½®æ–‡ä»¶

æœåŠ¡å‘ç°ä¹Ÿéœ€è¦çŸ¥é“eurekaåœ°å€ï¼Œå› æ­¤ç¬¬äºŒæ­¥ä¸æœåŠ¡æ³¨å†Œä¸€è‡´ï¼Œéƒ½æ˜¯é…ç½®eurekaä¿¡æ¯ï¼š

åœ¨order-serviceä¸­ï¼Œä¿®æ”¹application.ymlæ–‡ä»¶ï¼Œæ·»åŠ æœåŠ¡åç§°ã€eurekaåœ°å€ï¼š

```yaml
spring:
  application:
    name: orderservice
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka
```



##### æœåŠ¡æ‹‰å–å’Œè´Ÿè½½å‡è¡¡

æœ€åï¼Œæˆ‘ä»¬è¦å»eureka-serverä¸­æ‹‰å–user-serviceæœåŠ¡çš„å®ä¾‹åˆ—è¡¨ï¼Œå¹¶ä¸”å®ç°è´Ÿè½½å‡è¡¡ã€‚

ä¸è¿‡è¿™äº›åŠ¨ä½œä¸ç”¨æˆ‘ä»¬å»åšï¼Œåªéœ€è¦æ·»åŠ ä¸€äº›æ³¨è§£å³å¯ã€‚



åœ¨order-serviceçš„OrderApplicationä¸­ï¼Œç»™RestTemplateè¿™ä¸ªBeanæ·»åŠ ä¸€ä¸ª@LoadBalancedæ³¨è§£ï¼š

![image-20210713224049419](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713224049419.png)



ä¿®æ”¹order-serviceæœåŠ¡ä¸­çš„com.ganga.order.serviceåŒ…ä¸‹çš„OrderServiceç±»ä¸­çš„queryOrderByIdæ–¹æ³•ã€‚ä¿®æ”¹è®¿é—®çš„urlè·¯å¾„ï¼Œç”¨æœåŠ¡åä»£æ›¿ipã€ç«¯å£ï¼š

![image-20210713224245731](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713224245731.png)



springä¼šè‡ªåŠ¨å¸®åŠ©æˆ‘ä»¬ä»eureka-serverç«¯ï¼Œæ ¹æ®userserviceè¿™ä¸ªæœåŠ¡åç§°ï¼Œè·å–å®ä¾‹åˆ—è¡¨ï¼Œè€Œåå®Œæˆè´Ÿè½½å‡è¡¡ã€‚



---





#### å¤‡å¿˜

**ä¾èµ–**

```xml
<!-- eureka-server -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
</dependency>

<!-- eureka-server -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

**æ³¨è§£**

```java
//åœ¨é…ç½®ç±»ä¸­ å¼€å¯ æš´éœ²EurekaServer  //åªåœ¨eureka-serverä¸­å¼€å¯
@EnableEurekaServer
```

**ç®€å•é…ç½®**

server

```yaml
server:
  port: 10086
spring:
  application:
    name: eureka-server
# é…ç½®EurekaServiceåœ°å€
eureka:
  client:
    service-url:
      defaultZone: http://localhost:10086/eureka
```

client

```yaml
spring:
  application:
    name: orderservice # ä½¿ç”¨Eurekaå¿…é¡»è¦æä¾›æœåŠ¡åå­—
# æ³¨å†Œ Eureka
eureka:
  client:
    service-url:
      defaultZone: http://localhost:10086/eureka
```











### ğŸ”–Nacosæ³¨å†Œä¸­å¿ƒ

å›½å†…å…¬å¸ä¸€èˆ¬éƒ½æ¨å´‡é˜¿é‡Œå·´å·´çš„æŠ€æœ¯ï¼Œæ¯”å¦‚æ³¨å†Œä¸­å¿ƒï¼ŒSpringCloudAlibabaä¹Ÿæ¨å‡ºäº†ä¸€ä¸ªåä¸ºNacosçš„æ³¨å†Œä¸­å¿ƒã€‚

#### è®¤è¯†å’Œå®‰è£…Nacos

[Nacos](https://nacos.io/)æ˜¯é˜¿é‡Œå·´å·´çš„äº§å“ï¼Œç°åœ¨æ˜¯[SpringCloud](https://spring.io/projects/spring-cloud)ä¸­çš„ä¸€ä¸ªç»„ä»¶ã€‚ç›¸æ¯”[Eureka](https://github.com/Netflix/eureka)åŠŸèƒ½æ›´åŠ ä¸°å¯Œï¼Œåœ¨å›½å†…å—æ¬¢è¿ç¨‹åº¦è¾ƒé«˜ã€‚

![image-20210713230444308](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713230444308.png)



å®‰è£…æ–¹å¼å¯ä»¥å‚è€ƒè¯¾å‰èµ„æ–™ã€ŠNacoså®‰è£…æŒ‡å—.mdã€‹



#### Nacoså®‰è£…æŒ‡å—





##### 1.Windowså®‰è£…

å¼€å‘é˜¶æ®µé‡‡ç”¨å•æœºå®‰è£…å³å¯ã€‚



###### 1.1.ä¸‹è½½å®‰è£…åŒ…

åœ¨Nacosçš„GitHubé¡µé¢ï¼Œæä¾›æœ‰ä¸‹è½½é“¾æ¥ï¼Œå¯ä»¥ä¸‹è½½ç¼–è¯‘å¥½çš„NacosæœåŠ¡ç«¯æˆ–è€…æºä»£ç ï¼š

GitHubä¸»é¡µï¼šhttps://github.com/alibaba/nacos

GitHubçš„Releaseä¸‹è½½é¡µï¼šhttps://github.com/alibaba/nacos/releases

å¦‚å›¾ï¼š

![image-20210402161102887](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210402161102887.png)



æœ¬è¯¾ç¨‹é‡‡ç”¨1.4.1.ç‰ˆæœ¬çš„Nacosï¼Œè¯¾å‰èµ„æ–™å·²ç»å‡†å¤‡äº†å®‰è£…åŒ…ï¼š

![image-20210402161130261](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210402161130261.png)

windowsç‰ˆæœ¬ä½¿ç”¨`nacos-server-1.4.1.zip`åŒ…å³å¯ã€‚



###### 1.2.è§£å‹

å°†è¿™ä¸ªåŒ…è§£å‹åˆ°ä»»æ„éä¸­æ–‡ç›®å½•ä¸‹ï¼Œå¦‚å›¾ï¼š

![image-20210402161843337](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210402161843337.png)

ç›®å½•è¯´æ˜ï¼š

- binï¼šå¯åŠ¨è„šæœ¬
- confï¼šé…ç½®æ–‡ä»¶



###### 1.3.ç«¯å£é…ç½®

Nacosçš„é»˜è®¤ç«¯å£æ˜¯8848ï¼Œå¦‚æœä½ ç”µè„‘ä¸Šçš„å…¶å®ƒè¿›ç¨‹å ç”¨äº†8848ç«¯å£ï¼Œè¯·å…ˆå°è¯•å…³é—­è¯¥è¿›ç¨‹ã€‚

**å¦‚æœæ— æ³•å…³é—­å ç”¨8848ç«¯å£çš„è¿›ç¨‹**ï¼Œä¹Ÿå¯ä»¥è¿›å…¥nacosçš„confç›®å½•ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£ï¼š

![image-20210402162008280](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210402162008280.png)

ä¿®æ”¹å…¶ä¸­çš„å†…å®¹ï¼š

![image-20210402162251093](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210402162251093.png)



###### 1.4.å¯åŠ¨

å¯åŠ¨éå¸¸ç®€å•ï¼Œè¿›å…¥binç›®å½•ï¼Œç»“æ„å¦‚ä¸‹ï¼š

![image-20210402162350977](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210402162350977.png)

ç„¶åæ‰§è¡Œå‘½ä»¤å³å¯ï¼š

- windowså‘½ä»¤ï¼š

  ```
  startup.cmd -m standalone
  ```


æ‰§è¡Œåçš„æ•ˆæœå¦‚å›¾ï¼š

![image-20210402162526774](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210402162526774.png)



###### 1.5.è®¿é—®

åœ¨æµè§ˆå™¨è¾“å…¥åœ°å€ï¼šhttp://127.0.0.1:8848/nacoså³å¯ï¼š

![image-20210402162630427](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210402162630427.png)

é»˜è®¤çš„è´¦å·å’Œå¯†ç éƒ½æ˜¯nacosï¼Œè¿›å…¥åï¼š

![image-20210402162709515](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210402162709515.png)







##### 2.Linuxå®‰è£…

Linuxæˆ–è€…Macå®‰è£…æ–¹å¼ä¸Windowsç±»ä¼¼ã€‚



###### 2.1.å®‰è£…JDK

Nacosä¾èµ–äºJDKè¿è¡Œï¼Œç´¢å¼•Linuxä¸Šä¹Ÿéœ€è¦å®‰è£…JDKæ‰è¡Œã€‚

ä¸Šä¼ jdkå®‰è£…åŒ…ï¼š

![image-20210402172334810](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210402172334810.png)

ä¸Šä¼ åˆ°æŸä¸ªç›®å½•ï¼Œä¾‹å¦‚ï¼š`/usr/local/`



ç„¶åè§£å‹ç¼©ï¼š

```sh
tar -xvf jdk-8u144-linux-x64.tar.gz
```

ç„¶åé‡å‘½åä¸ºjava



é…ç½®ç¯å¢ƒå˜é‡ï¼š

```sh
export JAVA_HOME=/usr/local/java
export PATH=$PATH:$JAVA_HOME/bin
```

è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

```sh
source /etc/profile
```





###### 2.2.ä¸Šä¼ å®‰è£…åŒ…

å¦‚å›¾ï¼š

![image-20210402161102887](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210402161102887.png)

ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨è¯¾å‰èµ„æ–™ä¸­çš„tar.gzï¼š

![image-20210402161130261](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210402161130261.png)

ä¸Šä¼ åˆ°LinuxæœåŠ¡å™¨çš„æŸä¸ªç›®å½•ï¼Œä¾‹å¦‚`/usr/local/src`ç›®å½•ä¸‹ï¼š

![image-20210402163715580](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210402163715580.png)



###### 2.3.è§£å‹

å‘½ä»¤è§£å‹ç¼©å®‰è£…åŒ…ï¼š

```sh
tar -xvf nacos-server-1.4.1.tar.gz
```

ç„¶ååˆ é™¤å®‰è£…åŒ…ï¼š

```sh
rm -rf nacos-server-1.4.1.tar.gz
```

ç›®å½•ä¸­æœ€ç»ˆæ ·å¼ï¼š

![image-20210402163858429](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210402163858429.png)

ç›®å½•å†…éƒ¨ï¼š

![image-20210402164414827](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210402164414827.png)



###### 2.4.ç«¯å£é…ç½®

ä¸windowsä¸­ç±»ä¼¼



###### 2.5.å¯åŠ¨

åœ¨nacos/binç›®å½•ä¸­ï¼Œè¾“å…¥å‘½ä»¤å¯åŠ¨Nacosï¼š

```sh
sh startup.sh -m standalone
```









##### 3.Nacosçš„ä¾èµ–

çˆ¶å·¥ç¨‹ï¼š

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-alibaba-dependencies</artifactId>
    <version>2.2.5.RELEASE</version>
    <type>pom</type>
    <scope>import</scope>
</dependency>
```





å®¢æˆ·ç«¯ï¼š

```xml
<!-- nacoså®¢æˆ·ç«¯ä¾èµ–åŒ… -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>

```





#### æœåŠ¡æ³¨å†Œåˆ°nacos

Nacosæ˜¯SpringCloudAlibabaçš„ç»„ä»¶ï¼Œè€ŒSpringCloudAlibabaä¹Ÿéµå¾ªSpringCloudä¸­å®šä¹‰çš„æœåŠ¡æ³¨å†Œã€æœåŠ¡å‘ç°è§„èŒƒã€‚å› æ­¤ä½¿ç”¨Nacoså’Œä½¿ç”¨Eurekaå¯¹äºå¾®æœåŠ¡æ¥è¯´ï¼Œå¹¶æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚

ä¸»è¦å·®å¼‚åœ¨äºï¼š

- ä¾èµ–ä¸åŒ
- æœåŠ¡åœ°å€ä¸åŒ



##### å¼•å…¥ä¾èµ–

åœ¨cloud-demoçˆ¶å·¥ç¨‹çš„pomæ–‡ä»¶ä¸­çš„`<dependencyManagement>`ä¸­å¼•å…¥SpringCloudAlibabaçš„ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-alibaba-dependencies</artifactId>
    <version>2.2.6.RELEASE</version>
    <type>pom</type>
    <scope>import</scope>
</dependency>
```

ç„¶ååœ¨user-serviceå’Œorder-serviceä¸­çš„pomæ–‡ä»¶ä¸­å¼•å…¥nacos-discoveryä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```



> **æ³¨æ„**ï¼šä¸è¦å¿˜äº†æ³¨é‡Šæ‰eurekaçš„ä¾èµ–ã€‚



##### é…ç½®nacosåœ°å€

åœ¨user-serviceå’Œorder-serviceçš„application.ymlä¸­æ·»åŠ nacosåœ°å€ï¼š

```yaml
spring:
  cloud:
    nacos:
      server-addr: localhost:8848
```



> **æ³¨æ„**ï¼šä¸è¦å¿˜äº†æ³¨é‡Šæ‰eurekaçš„åœ°å€







##### é‡å¯

é‡å¯å¾®æœåŠ¡åï¼Œç™»å½•nacosç®¡ç†é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°å¾®æœåŠ¡ä¿¡æ¯ï¼š

![image-20210713231439607](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713231439607.png)



#### æœåŠ¡åˆ†çº§å­˜å‚¨æ¨¡å‹

ä¸€ä¸ª**æœåŠ¡**å¯ä»¥æœ‰å¤šä¸ª**å®ä¾‹**ï¼Œä¾‹å¦‚æˆ‘ä»¬çš„user-serviceï¼Œå¯ä»¥æœ‰:

- 127.0.0.1:8081
- 127.0.0.1:8082
- 127.0.0.1:8083

å‡å¦‚è¿™äº›å®ä¾‹åˆ†å¸ƒäºå…¨å›½å„åœ°çš„ä¸åŒæœºæˆ¿ï¼Œä¾‹å¦‚ï¼š

- 127.0.0.1:8081ï¼Œåœ¨ä¸Šæµ·æœºæˆ¿
- 127.0.0.1:8082ï¼Œåœ¨ä¸Šæµ·æœºæˆ¿
- 127.0.0.1:8083ï¼Œåœ¨æ­å·æœºæˆ¿

Nacoså°±å°†åŒä¸€æœºæˆ¿å†…çš„å®ä¾‹ åˆ’åˆ†ä¸ºä¸€ä¸ª**é›†ç¾¤**ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œuser-serviceæ˜¯æœåŠ¡ï¼Œä¸€ä¸ªæœåŠ¡å¯ä»¥åŒ…å«å¤šä¸ªé›†ç¾¤ï¼Œå¦‚æ­å·ã€ä¸Šæµ·ï¼Œæ¯ä¸ªé›†ç¾¤ä¸‹å¯ä»¥æœ‰å¤šä¸ªå®ä¾‹ï¼Œå½¢æˆåˆ†çº§æ¨¡å‹ï¼Œå¦‚å›¾ï¼š

![image-20210713232522531](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713232522531.png)



å¾®æœåŠ¡äº’ç›¸è®¿é—®æ—¶ï¼Œåº”è¯¥å°½å¯èƒ½è®¿é—®åŒé›†ç¾¤å®ä¾‹ï¼Œå› ä¸ºæœ¬åœ°è®¿é—®é€Ÿåº¦æ›´å¿«ã€‚å½“æœ¬é›†ç¾¤å†…ä¸å¯ç”¨æ—¶ï¼Œæ‰è®¿é—®å…¶å®ƒé›†ç¾¤ã€‚ä¾‹å¦‚ï¼š

![image-20210713232658928](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713232658928.png)

æ­å·æœºæˆ¿å†…çš„order-serviceåº”è¯¥ä¼˜å…ˆè®¿é—®åŒæœºæˆ¿çš„user-serviceã€‚





##### ç»™user-serviceé…ç½®é›†ç¾¤



ä¿®æ”¹user-serviceçš„application.ymlæ–‡ä»¶ï¼Œæ·»åŠ é›†ç¾¤é…ç½®ï¼š

```yaml
spring:
  cloud:
    nacos:
      server-addr: localhost:8848
      discovery:
        cluster-name: HZ # é›†ç¾¤åç§°
```

é‡å¯ä¸¤ä¸ªuser-serviceå®ä¾‹åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨nacosæ§åˆ¶å°çœ‹åˆ°ä¸‹é¢ç»“æœï¼š

![image-20210713232916215](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713232916215.png)



æˆ‘ä»¬å†æ¬¡å¤åˆ¶ä¸€ä¸ªuser-serviceå¯åŠ¨é…ç½®ï¼Œæ·»åŠ å±æ€§ï¼š

```sh
-Dserver.port=8083 -Dspring.cloud.nacos.discovery.cluster-name=SH
```

é…ç½®å¦‚å›¾æ‰€ç¤ºï¼š

![image-20210713233528982](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713233528982.png)



å¯åŠ¨UserApplication3åå†æ¬¡æŸ¥çœ‹nacosæ§åˆ¶å°ï¼š

![image-20210713233727923](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713233727923.png)



##### åŒé›†ç¾¤ä¼˜å…ˆçš„è´Ÿè½½å‡è¡¡

é»˜è®¤çš„`ZoneAvoidanceRule`å¹¶ä¸èƒ½å®ç°æ ¹æ®åŒé›†ç¾¤ä¼˜å…ˆæ¥å®ç°è´Ÿè½½å‡è¡¡ã€‚

å› æ­¤Nacosä¸­æä¾›äº†ä¸€ä¸ª`NacosRule`çš„å®ç°ï¼Œå¯ä»¥ä¼˜å…ˆä»åŒé›†ç¾¤ä¸­æŒ‘é€‰å®ä¾‹ã€‚

1ï¼‰ç»™order-serviceé…ç½®é›†ç¾¤ä¿¡æ¯

ä¿®æ”¹order-serviceçš„application.ymlæ–‡ä»¶ï¼Œæ·»åŠ é›†ç¾¤é…ç½®ï¼š

```sh
spring:
  cloud:
    nacos:
      server-addr: localhost:8848
      discovery:
        cluster-name: HZ # é›†ç¾¤åç§°
```



2ï¼‰ä¿®æ”¹è´Ÿè½½å‡è¡¡è§„åˆ™

ä¿®æ”¹order-serviceçš„application.ymlæ–‡ä»¶ï¼Œä¿®æ”¹è´Ÿè½½å‡è¡¡è§„åˆ™ï¼š

```yaml
userservice:
  ribbon:
    NFLoadBalancerRuleClassName: com.alibaba.cloud.nacos.ribbon.NacosRule # è´Ÿè½½å‡è¡¡è§„åˆ™ 
```



#### æƒé‡é…ç½®

å®é™…éƒ¨ç½²ä¸­ä¼šå‡ºç°è¿™æ ·çš„åœºæ™¯ï¼š

æœåŠ¡å™¨è®¾å¤‡æ€§èƒ½æœ‰å·®å¼‚ï¼Œéƒ¨åˆ†å®ä¾‹æ‰€åœ¨æœºå™¨æ€§èƒ½è¾ƒå¥½ï¼Œå¦ä¸€äº›è¾ƒå·®ï¼Œæˆ‘ä»¬å¸Œæœ›æ€§èƒ½å¥½çš„æœºå™¨æ‰¿æ‹…æ›´å¤šçš„ç”¨æˆ·è¯·æ±‚ã€‚

ä½†é»˜è®¤æƒ…å†µä¸‹NacosRuleæ˜¯åŒé›†ç¾¤å†…éšæœºæŒ‘é€‰ï¼Œä¸ä¼šè€ƒè™‘æœºå™¨çš„æ€§èƒ½é—®é¢˜ã€‚



å› æ­¤ï¼ŒNacosæä¾›äº†æƒé‡é…ç½®æ¥æ§åˆ¶è®¿é—®é¢‘ç‡ï¼Œæƒé‡è¶Šå¤§åˆ™è®¿é—®é¢‘ç‡è¶Šé«˜ã€‚



åœ¨nacosæ§åˆ¶å°ï¼Œæ‰¾åˆ°user-serviceçš„å®ä¾‹åˆ—è¡¨ï¼Œç‚¹å‡»ç¼–è¾‘ï¼Œå³å¯ä¿®æ”¹æƒé‡ï¼š

![image-20210713235133225](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713235133225.png)

åœ¨å¼¹å‡ºçš„ç¼–è¾‘çª—å£ï¼Œä¿®æ”¹æƒé‡ï¼š

![image-20210713235235219](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713235235219.png)





> **æ³¨æ„**ï¼šå¦‚æœæƒé‡ä¿®æ”¹ä¸º0ï¼Œåˆ™è¯¥å®ä¾‹æ°¸è¿œä¸ä¼šè¢«è®¿é—®



#### ç¯å¢ƒéš”ç¦»

Nacosæä¾›äº†namespaceæ¥å®ç°ç¯å¢ƒéš”ç¦»åŠŸèƒ½ã€‚

- nacosä¸­å¯ä»¥æœ‰å¤šä¸ªnamespace
- namespaceä¸‹å¯ä»¥æœ‰groupã€serviceç­‰
- ä¸åŒnamespaceä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œä¾‹å¦‚ä¸åŒnamespaceçš„æœåŠ¡äº’ç›¸ä¸å¯è§



![image-20210714000101516](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210714000101516.png)



##### åˆ›å»ºnamespace

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰serviceã€dataã€groupéƒ½åœ¨åŒä¸€ä¸ªnamespaceï¼Œåä¸ºpublicï¼š

![image-20210714000414781](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210714000414781.png)



æˆ‘ä»¬å¯ä»¥ç‚¹å‡»é¡µé¢æ–°å¢æŒ‰é’®ï¼Œæ·»åŠ ä¸€ä¸ªnamespaceï¼š

![image-20210714000440143](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210714000440143.png)



ç„¶åï¼Œå¡«å†™è¡¨å•ï¼š

![image-20210714000505928](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210714000505928.png)

å°±èƒ½åœ¨é¡µé¢çœ‹åˆ°ä¸€ä¸ªæ–°çš„namespaceï¼š

![image-20210714000522913](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210714000522913.png)



##### ç»™å¾®æœåŠ¡é…ç½®namespace

ç»™å¾®æœåŠ¡é…ç½®namespaceåªèƒ½é€šè¿‡ä¿®æ”¹é…ç½®æ¥å®ç°ã€‚

ä¾‹å¦‚ï¼Œä¿®æ”¹order-serviceçš„application.ymlæ–‡ä»¶ï¼š

```yaml
spring:
  cloud:
    nacos:
      server-addr: localhost:8848
      discovery:
        cluster-name: HZ
        namespace: 492a7d5d-237b-46a1-a99a-fa8e98e4b0f9 # å‘½åç©ºé—´ï¼Œå¡«ID
```



é‡å¯order-serviceåï¼Œè®¿é—®æ§åˆ¶å°ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢çš„ç»“æœï¼š

![image-20210714000830703](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210714000830703.png)



![image-20210714000837140](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210714000837140.png)

æ­¤æ—¶è®¿é—®order-serviceï¼Œå› ä¸ºnamespaceä¸åŒï¼Œä¼šå¯¼è‡´æ‰¾ä¸åˆ°userserviceï¼Œæ§åˆ¶å°ä¼šæŠ¥é”™ï¼š

![image-20210714000941256](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210714000941256.png)



#### Nacosä¸Eurekaçš„åŒºåˆ«

Nacosçš„æœåŠ¡å®ä¾‹åˆ†ä¸ºä¸¤ç§lç±»å‹ï¼š

- ä¸´æ—¶å®ä¾‹ï¼šå¦‚æœå®ä¾‹å®•æœºè¶…è¿‡ä¸€å®šæ—¶é—´ï¼Œä¼šä»æœåŠ¡åˆ—è¡¨å‰”é™¤ï¼Œé»˜è®¤çš„ç±»å‹ã€‚

- éä¸´æ—¶å®ä¾‹ï¼šå¦‚æœå®ä¾‹å®•æœºï¼Œä¸ä¼šä»æœåŠ¡åˆ—è¡¨å‰”é™¤ï¼Œä¹Ÿå¯ä»¥å«æ°¸ä¹…å®ä¾‹ã€‚



é…ç½®ä¸€ä¸ªæœåŠ¡å®ä¾‹ä¸ºæ°¸ä¹…å®ä¾‹ï¼š

```yaml
spring:
  cloud:
    nacos:
      discovery:
        ephemeral: false # è®¾ç½®ä¸ºéä¸´æ—¶å®ä¾‹
```





Nacoså’ŒEurekaæ•´ä½“ç»“æ„ç±»ä¼¼ï¼ŒæœåŠ¡æ³¨å†Œã€æœåŠ¡æ‹‰å–ã€å¿ƒè·³ç­‰å¾…ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨ä¸€äº›å·®å¼‚ï¼š

![image-20210714001728017](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210714001728017.png)



- Nacosä¸eurekaçš„å…±åŒç‚¹
  - éƒ½æ”¯æŒæœåŠ¡æ³¨å†Œå’ŒæœåŠ¡æ‹‰å–
  - éƒ½æ”¯æŒæœåŠ¡æä¾›è€…å¿ƒè·³æ–¹å¼åšå¥åº·æ£€æµ‹

- Nacosä¸Eurekaçš„åŒºåˆ«
  - Nacosæ”¯æŒæœåŠ¡ç«¯ä¸»åŠ¨æ£€æµ‹æä¾›è€…çŠ¶æ€ï¼šä¸´æ—¶å®ä¾‹é‡‡ç”¨å¿ƒè·³æ¨¡å¼ï¼Œéä¸´æ—¶å®ä¾‹é‡‡ç”¨ä¸»åŠ¨æ£€æµ‹æ¨¡å¼
  - ä¸´æ—¶å®ä¾‹å¿ƒè·³ä¸æ­£å¸¸ä¼šè¢«å‰”é™¤ï¼Œéä¸´æ—¶å®ä¾‹åˆ™ä¸ä¼šè¢«å‰”é™¤
  - Nacosæ”¯æŒæœåŠ¡åˆ—è¡¨å˜æ›´çš„æ¶ˆæ¯æ¨é€æ¨¡å¼ï¼ŒæœåŠ¡åˆ—è¡¨æ›´æ–°æ›´åŠæ—¶
  - Nacosé›†ç¾¤é»˜è®¤é‡‡ç”¨APæ–¹å¼ï¼Œå½“é›†ç¾¤ä¸­å­˜åœ¨éä¸´æ—¶å®ä¾‹æ—¶ï¼Œé‡‡ç”¨CPæ¨¡å¼ï¼›Eurekaé‡‡ç”¨APæ–¹å¼







#### å¤‡å¿˜

**ä¾èµ–**

```xml
<!-- Nacosä¾èµ– çˆ¶å·¥ç¨‹ä¾èµ– -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-alibaba-dependencies</artifactId>
    <version>2.2.5.RELEASE</version>
    <type>pom</type>
    <scope>import</scope>
</dependency>

<!-- nacoså®¢æˆ·ç«¯ä¾èµ–åŒ… -->
<dependency>
     <groupId>com.alibaba.cloud</groupId>
     <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

**é…ç½®**

```yaml
spring: 
  application:
    name: orderservice
  # cloudé…ç½®
  cloud: # é…ç½® nacos åœ°å€
    nacos:
      server-addr: localhost:8848
      discovery: # æœåŠ¡åˆ†çº§å­˜å‚¨æ¨¡å‹ ç»™è¯¥æœåŠ¡é…ç½® é›†ç¾¤
        cluster-name: Ayaka
        namespace: 492a7d5d-237b-46a1-a99a-fa8e98e4b0f9 # å‘½åç©ºé—´ï¼Œå¡«ID
        ephemeral: false # è®¾ç½®ä¸ºéä¸´æ—¶å®ä¾‹ é»˜è®¤æ˜¯ä¸´æ—¶å®ä¾‹
# ä¸Šé¢å¹¶ä¸ä¼šç”Ÿæ•ˆ è¦è¿›è¡Œè´Ÿè½½å‡è¡¡ä»æ–°é…ç½®
userservice: # å¯¹ userservice å•ç‹¬è¿›è¡Œé…ç½®è´Ÿè½½å‡è¡¡ç®—æ³•
  ribbon:
    NFLoadBalancerRuleClassName: com.alibaba.cloud.nacos.ribbon.NacosRule # è´Ÿè½½å‡è¡¡è§„åˆ™
```









## ğŸ—‚ï¸ç»„ä»¶-è´Ÿè½½å‡è¡¡





### ğŸ”–Ribbonè´Ÿè½½å‡è¡¡

ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†@LoadBalancedæ³¨è§£ï¼Œå³å¯å®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œè¿™æ˜¯ä»€ä¹ˆåŸç†å‘¢ï¼Ÿ



#### è´Ÿè½½å‡è¡¡åŸç†

SpringCloudåº•å±‚å…¶å®æ˜¯åˆ©ç”¨äº†ä¸€ä¸ªåä¸ºRibbonçš„ç»„ä»¶ï¼Œæ¥å®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½çš„ã€‚

![image-20210713224517686](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713224517686.png)

é‚£ä¹ˆæˆ‘ä»¬å‘å‡ºçš„è¯·æ±‚æ˜æ˜æ˜¯http://userservice/user/1ï¼Œæ€ä¹ˆå˜æˆäº†http://localhost:8081çš„å‘¢ï¼Ÿ



#### æºç è·Ÿè¸ª

ä¸ºä»€ä¹ˆæˆ‘ä»¬åªè¾“å…¥äº†serviceåç§°å°±å¯ä»¥è®¿é—®äº†å‘¢ï¼Ÿä¹‹å‰è¿˜è¦è·å–ipå’Œç«¯å£ã€‚

æ˜¾ç„¶æœ‰äººå¸®æˆ‘ä»¬æ ¹æ®serviceåç§°ï¼Œè·å–åˆ°äº†æœåŠ¡å®ä¾‹çš„ipå’Œç«¯å£ã€‚å®ƒå°±æ˜¯`LoadBalancerInterceptor`ï¼Œè¿™ä¸ªç±»ä¼šåœ¨å¯¹RestTemplateçš„è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œç„¶åä»Eurekaæ ¹æ®æœåŠ¡idè·å–æœåŠ¡åˆ—è¡¨ï¼Œéšååˆ©ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•å¾—åˆ°çœŸå®çš„æœåŠ¡åœ°å€ä¿¡æ¯ï¼Œæ›¿æ¢æœåŠ¡idã€‚

æˆ‘ä»¬è¿›è¡Œæºç è·Ÿè¸ªï¼š

##### LoadBalancerIntercepor

![1525620483637](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/1525620483637.png)

å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„interceptæ–¹æ³•ï¼Œæ‹¦æˆªäº†ç”¨æˆ·çš„HttpRequestè¯·æ±‚ï¼Œç„¶ååšäº†å‡ ä»¶äº‹ï¼š

- `request.getURI()`ï¼šè·å–è¯·æ±‚uriï¼Œæœ¬ä¾‹ä¸­å°±æ˜¯ http://user-service/user/8
- `originalUri.getHost()`ï¼šè·å–uriè·¯å¾„çš„ä¸»æœºåï¼Œå…¶å®å°±æ˜¯æœåŠ¡idï¼Œ`user-service`
- `this.loadBalancer.execute()`ï¼šå¤„ç†æœåŠ¡idï¼Œå’Œç”¨æˆ·è¯·æ±‚ã€‚

è¿™é‡Œçš„`this.loadBalancer`æ˜¯`LoadBalancerClient`ç±»å‹ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿå…¥ã€‚



##### LoadBalancerClient

ç»§ç»­è·Ÿå…¥executeæ–¹æ³•ï¼š

![1525620787090](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/1525620787090.png)

ä»£ç æ˜¯è¿™æ ·çš„ï¼š

- getLoadBalancer(serviceId)ï¼šæ ¹æ®æœåŠ¡idè·å–ILoadBalancerï¼Œè€ŒILoadBalancerä¼šæ‹¿ç€æœåŠ¡idå»eurekaä¸­è·å–æœåŠ¡åˆ—è¡¨å¹¶ä¿å­˜èµ·æ¥ã€‚
- getServer(loadBalancer)ï¼šåˆ©ç”¨å†…ç½®çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œä»æœåŠ¡åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªã€‚æœ¬ä¾‹ä¸­ï¼Œå¯ä»¥çœ‹åˆ°è·å–äº†8082ç«¯å£çš„æœåŠ¡



æ”¾è¡Œåï¼Œå†æ¬¡è®¿é—®å¹¶è·Ÿè¸ªï¼Œå‘ç°è·å–çš„æ˜¯8081ï¼š

![1525620835911](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/1525620835911.png)

æœç„¶å®ç°äº†è´Ÿè½½å‡è¡¡ã€‚



##### è´Ÿè½½å‡è¡¡ç­–ç•¥IRule

åœ¨åˆšæ‰çš„ä»£ç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°è·å–æœåŠ¡ä½¿é€šè¿‡ä¸€ä¸ª`getServer`æ–¹æ³•æ¥åšè´Ÿè½½å‡è¡¡:

![1525620835911](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/1525620835911.png)

æˆ‘ä»¬ç»§ç»­è·Ÿå…¥ï¼š

![1544361421671](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/1544361421671.png)

ç»§ç»­è·Ÿè¸ªæºç chooseServeræ–¹æ³•ï¼Œå‘ç°è¿™ä¹ˆä¸€æ®µä»£ç ï¼š

![1525622652849](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/1525622652849.png)

æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªruleæ˜¯è°ï¼š

![1525622699666](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/1525622699666.png)

è¿™é‡Œçš„ruleé»˜è®¤å€¼æ˜¯ä¸€ä¸ª`RoundRobinRule`ï¼Œçœ‹ç±»çš„ä»‹ç»ï¼š

![1525622754316](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/1525622754316.png)

è¿™ä¸å°±æ˜¯è½®è¯¢çš„æ„æ€å˜›ã€‚

åˆ°è¿™é‡Œï¼Œæ•´ä¸ªè´Ÿè½½å‡è¡¡çš„æµç¨‹æˆ‘ä»¬å°±æ¸…æ¥šäº†ã€‚



##### æ€»ç»“

SpringCloudRibbonçš„åº•å±‚é‡‡ç”¨äº†ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œæ‹¦æˆªäº†RestTemplateå‘å‡ºçš„è¯·æ±‚ï¼Œå¯¹åœ°å€åšäº†ä¿®æ”¹ã€‚ç”¨ä¸€å¹…å›¾æ¥æ€»ç»“ä¸€ä¸‹ï¼š

![image-20210713224724673](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713224724673.png)



åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š

- æ‹¦æˆªæˆ‘ä»¬çš„RestTemplateè¯·æ±‚http://userservice/user/1
- RibbonLoadBalancerClientä¼šä»è¯·æ±‚urlä¸­è·å–æœåŠ¡åç§°ï¼Œä¹Ÿå°±æ˜¯user-service
- DynamicServerListLoadBalanceræ ¹æ®user-serviceåˆ°eurekaæ‹‰å–æœåŠ¡åˆ—è¡¨
- eurekaè¿”å›åˆ—è¡¨ï¼Œlocalhost:8081ã€localhost:8082
- IRuleåˆ©ç”¨å†…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œä¾‹å¦‚localhost:8081
- RibbonLoadBalancerClientä¿®æ”¹è¯·æ±‚åœ°å€ï¼Œç”¨localhost:8081æ›¿ä»£userserviceï¼Œå¾—åˆ°http://localhost:8081/user/1ï¼Œå‘èµ·çœŸå®è¯·æ±‚



#### è´Ÿè½½å‡è¡¡ç­–ç•¥



##### è´Ÿè½½å‡è¡¡ç­–ç•¥

è´Ÿè½½å‡è¡¡çš„è§„åˆ™éƒ½å®šä¹‰åœ¨IRuleæ¥å£ä¸­ï¼Œè€ŒIRuleæœ‰å¾ˆå¤šä¸åŒçš„å®ç°ç±»ï¼š

![image-20210713225653000](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210713225653000.png)

ä¸åŒè§„åˆ™çš„å«ä¹‰å¦‚ä¸‹ï¼š

| **å†…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ç±»**    | **è§„åˆ™æè¿°**                                                 |
| ------------------------- | ------------------------------------------------------------ |
| RoundRobinRule            | ç®€å•è½®è¯¢æœåŠ¡åˆ—è¡¨æ¥é€‰æ‹©æœåŠ¡å™¨ã€‚å®ƒæ˜¯Ribboné»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™ã€‚ |
| AvailabilityFilteringRule | å¯¹ä»¥ä¸‹ä¸¤ç§æœåŠ¡å™¨è¿›è¡Œå¿½ç•¥ï¼š   ï¼ˆ1ï¼‰åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™å°æœåŠ¡å™¨å¦‚æœ3æ¬¡è¿æ¥å¤±è´¥ï¼Œè¿™å°æœåŠ¡å™¨å°±ä¼šè¢«è®¾ç½®ä¸ºâ€œçŸ­è·¯â€çŠ¶æ€ã€‚çŸ­è·¯çŠ¶æ€å°†æŒç»­30ç§’ï¼Œå¦‚æœå†æ¬¡è¿æ¥å¤±è´¥ï¼ŒçŸ­è·¯çš„æŒç»­æ—¶é—´å°±ä¼šå‡ ä½•çº§åœ°å¢åŠ ã€‚  ï¼ˆ2ï¼‰å¹¶å‘æ•°è¿‡é«˜çš„æœåŠ¡å™¨ã€‚å¦‚æœä¸€ä¸ªæœåŠ¡å™¨çš„å¹¶å‘è¿æ¥æ•°è¿‡é«˜ï¼Œé…ç½®äº†AvailabilityFilteringRuleè§„åˆ™çš„å®¢æˆ·ç«¯ä¹Ÿä¼šå°†å…¶å¿½ç•¥ã€‚å¹¶å‘è¿æ¥æ•°çš„ä¸Šé™ï¼Œå¯ä»¥ç”±å®¢æˆ·ç«¯çš„<clientName>.<clientConfigNameSpace>.ActiveConnectionsLimitå±æ€§è¿›è¡Œé…ç½®ã€‚ |
| WeightedResponseTimeRule  | ä¸ºæ¯ä¸€ä¸ªæœåŠ¡å™¨èµ‹äºˆä¸€ä¸ªæƒé‡å€¼ã€‚æœåŠ¡å™¨å“åº”æ—¶é—´è¶Šé•¿ï¼Œè¿™ä¸ªæœåŠ¡å™¨çš„æƒé‡å°±è¶Šå°ã€‚è¿™ä¸ªè§„åˆ™ä¼šéšæœºé€‰æ‹©æœåŠ¡å™¨ï¼Œè¿™ä¸ªæƒé‡å€¼ä¼šå½±å“æœåŠ¡å™¨çš„é€‰æ‹©ã€‚ |
| **ZoneAvoidanceRule**     | ä»¥åŒºåŸŸå¯ç”¨çš„æœåŠ¡å™¨ä¸ºåŸºç¡€è¿›è¡ŒæœåŠ¡å™¨çš„é€‰æ‹©ã€‚ä½¿ç”¨Zoneå¯¹æœåŠ¡å™¨è¿›è¡Œåˆ†ç±»ï¼Œè¿™ä¸ªZoneå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæœºæˆ¿ã€ä¸€ä¸ªæœºæ¶ç­‰ã€‚è€Œåå†å¯¹Zoneå†…çš„å¤šä¸ªæœåŠ¡åšè½®è¯¢ã€‚ |
| BestAvailableRule         | å¿½ç•¥é‚£äº›çŸ­è·¯çš„æœåŠ¡å™¨ï¼Œå¹¶é€‰æ‹©å¹¶å‘æ•°è¾ƒä½çš„æœåŠ¡å™¨ã€‚             |
| RandomRule                | éšæœºé€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡å™¨ã€‚                                   |
| RetryRule                 | é‡è¯•æœºåˆ¶çš„é€‰æ‹©é€»è¾‘                                           |



é»˜è®¤çš„å®ç°å°±æ˜¯ZoneAvoidanceRuleï¼Œæ˜¯ä¸€ç§è½®è¯¢æ–¹æ¡ˆ



##### è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥

é€šè¿‡å®šä¹‰IRuleå®ç°å¯ä»¥ä¿®æ”¹è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š

1. ä»£ç æ–¹å¼ï¼šåœ¨order-serviceä¸­çš„OrderApplicationç±»ä¸­ï¼Œå®šä¹‰ä¸€ä¸ªæ–°çš„IRuleï¼š

```java
@Bean
public IRule randomRule(){
    return new RandomRule();
}
```



2. é…ç½®æ–‡ä»¶æ–¹å¼ï¼šåœ¨order-serviceçš„application.ymlæ–‡ä»¶ä¸­ï¼Œæ·»åŠ æ–°çš„é…ç½®ä¹Ÿå¯ä»¥ä¿®æ”¹è§„åˆ™ï¼š

```yaml
userservice: # ç»™æŸä¸ªå¾®æœåŠ¡é…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œè¿™é‡Œæ˜¯userserviceæœåŠ¡
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule # è´Ÿè½½å‡è¡¡è§„åˆ™ 
```



> **æ³¨æ„**ï¼Œä¸€èˆ¬ç”¨é»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œä¸åšä¿®æ”¹ã€‚



#### é¥¥é¥¿åŠ è½½

Ribboné»˜è®¤æ˜¯é‡‡ç”¨æ‡’åŠ è½½ï¼Œå³ç¬¬ä¸€æ¬¡è®¿é—®æ—¶æ‰ä¼šå»åˆ›å»ºLoadBalanceClientï¼Œè¯·æ±‚æ—¶é—´ä¼šå¾ˆé•¿ã€‚

è€Œé¥¥é¥¿åŠ è½½åˆ™ä¼šåœ¨é¡¹ç›®å¯åŠ¨æ—¶åˆ›å»ºï¼Œé™ä½ç¬¬ä¸€æ¬¡è®¿é—®çš„è€—æ—¶ï¼Œé€šè¿‡ä¸‹é¢é…ç½®å¼€å¯é¥¥é¥¿åŠ è½½ï¼š

```yaml
ribbon:
  eager-load:
    enabled: true
    clients: userservice
```





#### å¤‡å¿˜



**è§„åˆ™é€‰æ‹©**

| **å†…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ç±»**    | **è§„åˆ™æè¿°**                                                 |
| ------------------------- | ------------------------------------------------------------ |
| RoundRobinRule            | ç®€å•è½®è¯¢æœåŠ¡åˆ—è¡¨æ¥é€‰æ‹©æœåŠ¡å™¨ã€‚å®ƒæ˜¯Ribboné»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™ã€‚ |
| AvailabilityFilteringRule | å¯¹ä»¥ä¸‹ä¸¤ç§æœåŠ¡å™¨è¿›è¡Œå¿½ç•¥ï¼š   ï¼ˆ1ï¼‰åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™å°æœåŠ¡å™¨å¦‚æœ3æ¬¡è¿æ¥å¤±è´¥ï¼Œè¿™å°æœåŠ¡å™¨å°±ä¼šè¢«è®¾ç½®ä¸ºâ€œçŸ­è·¯â€çŠ¶æ€ã€‚çŸ­è·¯çŠ¶æ€å°†æŒç»­30ç§’ï¼Œå¦‚æœå†æ¬¡è¿æ¥å¤±è´¥ï¼ŒçŸ­è·¯çš„æŒç»­æ—¶é—´å°±ä¼šå‡ ä½•çº§åœ°å¢åŠ ã€‚  ï¼ˆ2ï¼‰å¹¶å‘æ•°è¿‡é«˜çš„æœåŠ¡å™¨ã€‚å¦‚æœä¸€ä¸ªæœåŠ¡å™¨çš„å¹¶å‘è¿æ¥æ•°è¿‡é«˜ï¼Œé…ç½®äº†AvailabilityFilteringRuleè§„åˆ™çš„å®¢æˆ·ç«¯ä¹Ÿä¼šå°†å…¶å¿½ç•¥ã€‚å¹¶å‘è¿æ¥æ•°çš„ä¸Šé™ï¼Œå¯ä»¥ç”±å®¢æˆ·ç«¯çš„<clientName>.<clientConfigNameSpace>.ActiveConnectionsLimitå±æ€§è¿›è¡Œé…ç½®ã€‚ |
| WeightedResponseTimeRule  | ä¸ºæ¯ä¸€ä¸ªæœåŠ¡å™¨èµ‹äºˆä¸€ä¸ªæƒé‡å€¼ã€‚æœåŠ¡å™¨å“åº”æ—¶é—´è¶Šé•¿ï¼Œè¿™ä¸ªæœåŠ¡å™¨çš„æƒé‡å°±è¶Šå°ã€‚è¿™ä¸ªè§„åˆ™ä¼šéšæœºé€‰æ‹©æœåŠ¡å™¨ï¼Œè¿™ä¸ªæƒé‡å€¼ä¼šå½±å“æœåŠ¡å™¨çš„é€‰æ‹©ã€‚ |
| **ZoneAvoidanceRule**     | ä»¥åŒºåŸŸå¯ç”¨çš„æœåŠ¡å™¨ä¸ºåŸºç¡€è¿›è¡ŒæœåŠ¡å™¨çš„é€‰æ‹©ã€‚ä½¿ç”¨Zoneå¯¹æœåŠ¡å™¨è¿›è¡Œåˆ†ç±»ï¼Œè¿™ä¸ªZoneå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæœºæˆ¿ã€ä¸€ä¸ªæœºæ¶ç­‰ã€‚è€Œåå†å¯¹Zoneå†…çš„å¤šä¸ªæœåŠ¡åšè½®è¯¢ã€‚ |
| BestAvailableRule         | å¿½ç•¥é‚£äº›çŸ­è·¯çš„æœåŠ¡å™¨ï¼Œå¹¶é€‰æ‹©å¹¶å‘æ•°è¾ƒä½çš„æœåŠ¡å™¨ã€‚             |
| RandomRule                | éšæœºé€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡å™¨ã€‚                                   |
| RetryRule                 | é‡è¯•æœºåˆ¶çš„é€‰æ‹©é€»è¾‘                                           |

**å®ç°æ–¹å¼ä¸€**

```java
//å…¨å±€ä½¿ç”¨è¯¥è´Ÿè½½å‡è¡¡ç®—æ³•
@Bean
public IRule iRule(){
    return new NacosRule();
}
```

**å®ç°æ–¹å¼äºŒ**

```yaml
# å¯¹ userservice å•ç‹¬è¿›è¡Œé…ç½®è´Ÿè½½å‡è¡¡ç®—æ³•
userservice:
  ribbon:
    NFLoadBalancerRuleClassName: com.alibaba.cloud.nacos.ribbon.NacosRule # è´Ÿè½½å‡è¡¡è§„åˆ™
```

**é¥¥é¥¿åŠ è½½**

```yaml
# å¯¹ribbonè¿›è¡Œé…ç½®
ribbon:
  eager-load:
    enabled: true # é¥¥é¥¿åŠ è½½ å¼€å¯ é¥¥é¥¿åŠ è½½
    clients: userservice # å¯¹userserviceè¿›è¡Œé¥¥é¥¿åŠ è½½  
      #- userservice #ä¹Ÿå¯è¿›è¡Œå¤šä¸ªæœåŠ¡
      #- shopservice
```











## ğŸ—‚ï¸ç»„ä»¶-è¿œç¨‹è°ƒç”¨



### ğŸ”–Feignè¿œç¨‹è°ƒç”¨



å…ˆæ¥çœ‹æˆ‘ä»¬ä»¥å‰åˆ©ç”¨RestTemplateå‘èµ·è¿œç¨‹è°ƒç”¨çš„ä»£ç ï¼š

![image-20230207022040132](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230207022040132.png)

å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š

â€¢ä»£ç å¯è¯»æ€§å·®ï¼Œç¼–ç¨‹ä½“éªŒä¸ç»Ÿä¸€

â€¢å‚æ•°å¤æ‚URLéš¾ä»¥ç»´æŠ¤



Feignæ˜¯ä¸€ä¸ªå£°æ˜å¼çš„httpå®¢æˆ·ç«¯ï¼Œå®˜æ–¹åœ°å€ï¼šhttps://github.com/OpenFeign/feign

å…¶ä½œç”¨å°±æ˜¯å¸®åŠ©æˆ‘ä»¬ä¼˜é›…çš„å®ç°httpè¯·æ±‚çš„å‘é€ï¼Œè§£å†³ä¸Šé¢æåˆ°çš„é—®é¢˜ã€‚

![image-20230207022126480](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230207022126480.png)





#### Feignæ›¿ä»£RestTemplate

Feginçš„ä½¿ç”¨æ­¥éª¤å¦‚ä¸‹ï¼š

##### å¼•å…¥ä¾èµ–

æˆ‘ä»¬åœ¨order-serviceæœåŠ¡çš„pomæ–‡ä»¶ä¸­å¼•å…¥feignçš„ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```



##### æ·»åŠ æ³¨è§£

åœ¨order-serviceçš„å¯åŠ¨ç±»æ·»åŠ æ³¨è§£å¼€å¯Feignçš„åŠŸèƒ½ï¼š

![image-20230207022239692](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230207022239692.png)



##### ç¼–å†™Feignçš„å®¢æˆ·ç«¯

åœ¨order-serviceä¸­æ–°å»ºä¸€ä¸ªæ¥å£ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```java
package com.ganga.order.clients;

import com.ganga.order.pojo.User;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

//æŒ‡å®šè¿œç¨‹è°ƒç”¨çš„ æœåŠ¡åç§°
@FeignClient("userservice")
public interface FeigeClient {

    @GetMapping("user/{id}")
    User findById(@PathVariable("id") Long id);

}

```



è¿™ä¸ªå®¢æˆ·ç«¯ä¸»è¦æ˜¯åŸºäºSpringMVCçš„æ³¨è§£æ¥å£°æ˜è¿œç¨‹è°ƒç”¨çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼š

- æœåŠ¡åç§°ï¼šuserservice
- è¯·æ±‚æ–¹å¼ï¼šGET
- è¯·æ±‚è·¯å¾„ï¼š/user/{id}
- è¯·æ±‚å‚æ•°ï¼šLong id
- è¿”å›å€¼ç±»å‹ï¼šUser

è¿™æ ·ï¼ŒFeignå°±å¯ä»¥å¸®åŠ©æˆ‘ä»¬å‘é€httpè¯·æ±‚ï¼Œæ— éœ€è‡ªå·±ä½¿ç”¨RestTemplateæ¥å‘é€äº†ã€‚







##### æµ‹è¯•

ä¿®æ”¹order-serviceä¸­çš„OrderServiceç±»ä¸­çš„queryOrderByIdæ–¹æ³•ï¼Œä½¿ç”¨Feignå®¢æˆ·ç«¯ä»£æ›¿RestTemplateï¼š

![image-20230207022818976](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230207022818976.png)

æ˜¯ä¸æ˜¯çœ‹èµ·æ¥ä¼˜é›…å¤šäº†ã€‚





##### æ€»ç»“

ä½¿ç”¨Feignçš„æ­¥éª¤ï¼š

â‘  å¼•å…¥ä¾èµ–

â‘¡ æ·»åŠ @EnableFeignClientsæ³¨è§£

â‘¢ ç¼–å†™FeignClientæ¥å£

â‘£ ä½¿ç”¨FeignClientä¸­å®šä¹‰çš„æ–¹æ³•ä»£æ›¿RestTemplate



---





#### è‡ªå®šä¹‰é…ç½®

Feignå¯ä»¥æ”¯æŒå¾ˆå¤šçš„è‡ªå®šä¹‰é…ç½®ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

| ç±»å‹                   | ä½œç”¨             | è¯´æ˜                                                   |
| ---------------------- | ---------------- | ------------------------------------------------------ |
| **feign.Logger.Level** | ä¿®æ”¹æ—¥å¿—çº§åˆ«     | åŒ…å«å››ç§ä¸åŒçš„çº§åˆ«ï¼šNONEã€BASICã€HEADERSã€FULL         |
| feign.codec.Decoder    | å“åº”ç»“æœçš„è§£æå™¨ | httpè¿œç¨‹è°ƒç”¨çš„ç»“æœåšè§£æï¼Œä¾‹å¦‚è§£æjsonå­—ç¬¦ä¸²ä¸ºjavaå¯¹è±¡ |
| feign.codec.Encoder    | è¯·æ±‚å‚æ•°ç¼–ç      | å°†è¯·æ±‚å‚æ•°ç¼–ç ï¼Œä¾¿äºé€šè¿‡httpè¯·æ±‚å‘é€                   |
| feign. Contract        | æ”¯æŒçš„æ³¨è§£æ ¼å¼   | é»˜è®¤æ˜¯SpringMVCçš„æ³¨è§£                                  |
| feign. Retryer         | å¤±è´¥é‡è¯•æœºåˆ¶     | è¯·æ±‚å¤±è´¥çš„é‡è¯•æœºåˆ¶ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰ï¼Œä¸è¿‡ä¼šä½¿ç”¨Ribbonçš„é‡è¯• |

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé»˜è®¤å€¼å°±èƒ½æ»¡è¶³æˆ‘ä»¬ä½¿ç”¨ï¼Œå¦‚æœè¦è‡ªå®šä¹‰æ—¶ï¼Œåªéœ€è¦åˆ›å»ºè‡ªå®šä¹‰çš„@Beanè¦†ç›–é»˜è®¤Beanå³å¯ã€‚



ä¸‹é¢ä»¥æ—¥å¿—ä¸ºä¾‹æ¥æ¼”ç¤ºå¦‚ä½•è‡ªå®šä¹‰é…ç½®ã€‚

##### é…ç½®æ–‡ä»¶æ–¹å¼

åŸºäºé…ç½®æ–‡ä»¶ä¿®æ”¹feignçš„æ—¥å¿—çº§åˆ«å¯ä»¥é’ˆå¯¹å•ä¸ªæœåŠ¡ï¼š

```yaml
feign:  
  client:
    config: 
      userservice: # é’ˆå¯¹æŸä¸ªå¾®æœåŠ¡çš„é…ç½®
        loggerLevel: FULL #  æ—¥å¿—çº§åˆ« 
```

ä¹Ÿå¯ä»¥é’ˆå¯¹æ‰€æœ‰æœåŠ¡ï¼š

```yaml
feign:  
  client:
    config: 
      default: # è¿™é‡Œç”¨defaultå°±æ˜¯å…¨å±€é…ç½®ï¼Œå¦‚æœæ˜¯å†™æœåŠ¡åç§°ï¼Œåˆ™æ˜¯é’ˆå¯¹æŸä¸ªå¾®æœåŠ¡çš„é…ç½®
        loggerLevel: FULL #  æ—¥å¿—çº§åˆ« 
```



è€Œæ—¥å¿—çš„çº§åˆ«åˆ†ä¸ºå››ç§ï¼š

- NONEï¼šä¸è®°å½•ä»»ä½•æ—¥å¿—ä¿¡æ¯ï¼Œè¿™æ˜¯é»˜è®¤å€¼ã€‚
- BASICï¼šä»…è®°å½•è¯·æ±‚çš„æ–¹æ³•ï¼ŒURLä»¥åŠå“åº”çŠ¶æ€ç å’Œæ‰§è¡Œæ—¶é—´
- HEADERSï¼šåœ¨BASICçš„åŸºç¡€ä¸Šï¼Œé¢å¤–è®°å½•äº†è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯
- FULLï¼šè®°å½•æ‰€æœ‰è¯·æ±‚å’Œå“åº”çš„æ˜ç»†ï¼ŒåŒ…æ‹¬å¤´ä¿¡æ¯ã€è¯·æ±‚ä½“ã€å…ƒæ•°æ®ã€‚



##### Javaä»£ç æ–¹å¼

ä¹Ÿå¯ä»¥åŸºäºJavaä»£ç æ¥ä¿®æ”¹æ—¥å¿—çº§åˆ«ï¼Œå…ˆå£°æ˜ä¸€ä¸ªç±»ï¼Œç„¶åå£°æ˜ä¸€ä¸ªLogger.Levelçš„å¯¹è±¡ï¼š

```java
public class DefaultFeignConfiguration  {
    @Bean
    public Logger.Level feignLogLevel(){
        return Logger.Level.BASIC; // æ—¥å¿—çº§åˆ«ä¸ºBASIC
    }
}
```



å¦‚æœè¦**å…¨å±€ç”Ÿæ•ˆ**ï¼Œå°†å…¶æ”¾åˆ°å¯åŠ¨ç±»çš„@EnableFeignClientsè¿™ä¸ªæ³¨è§£ä¸­ï¼š

```java
@EnableFeignClients(defaultConfiguration = DefaultFeignConfiguration .class) 
```



å¦‚æœæ˜¯**å±€éƒ¨ç”Ÿæ•ˆ**ï¼Œåˆ™æŠŠå®ƒæ”¾åˆ°å¯¹åº”çš„@FeignClientè¿™ä¸ªæ³¨è§£ä¸­ï¼š

```java
@FeignClient(value = "userservice", configuration = DefaultFeignConfiguration .class) 
```







#### Feignä½¿ç”¨ä¼˜åŒ–

Feignåº•å±‚å‘èµ·httpè¯·æ±‚ï¼Œä¾èµ–äºå…¶å®ƒçš„æ¡†æ¶ã€‚å…¶åº•å±‚å®¢æˆ·ç«¯å®ç°åŒ…æ‹¬ï¼š

â€¢URLConnectionï¼šé»˜è®¤å®ç°ï¼Œä¸æ”¯æŒè¿æ¥æ± 

â€¢Apache HttpClient ï¼šæ”¯æŒè¿æ¥æ± 

â€¢OKHttpï¼šæ”¯æŒè¿æ¥æ± 



å› æ­¤æé«˜Feignçš„æ€§èƒ½ä¸»è¦æ‰‹æ®µå°±æ˜¯ä½¿ç”¨**è¿æ¥æ± **ä»£æ›¿é»˜è®¤çš„URLConnectionã€‚



è¿™é‡Œæˆ‘ä»¬ç”¨Apacheçš„HttpClientæ¥æ¼”ç¤ºã€‚

1ï¼‰å¼•å…¥ä¾èµ–

åœ¨order-serviceçš„pomæ–‡ä»¶ä¸­å¼•å…¥Apacheçš„HttpClientä¾èµ–ï¼š

```xml
<!--httpClientçš„ä¾èµ– -->
<dependency>
    <groupId>io.github.openfeign</groupId>
    <artifactId>feign-httpclient</artifactId>
</dependency>
```



2ï¼‰é…ç½®è¿æ¥æ± 

åœ¨order-serviceçš„application.ymlä¸­æ·»åŠ é…ç½®ï¼š

```yaml
feign:
  client:
    config:
      default: # defaultå…¨å±€çš„é…ç½®
        loggerLevel: BASIC # æ—¥å¿—çº§åˆ«ï¼ŒBASICå°±æ˜¯åŸºæœ¬çš„è¯·æ±‚å’Œå“åº”ä¿¡æ¯
  httpclient:
    enabled: true # å¼€å¯feignå¯¹HttpClientçš„æ”¯æŒ
    max-connections: 200 # æœ€å¤§çš„è¿æ¥æ•°
    max-connections-per-route: 50 # æ¯ä¸ªè·¯å¾„çš„æœ€å¤§è¿æ¥æ•°
```





æ¥ä¸‹æ¥ï¼Œåœ¨FeignClientFactoryBeanä¸­çš„loadBalanceæ–¹æ³•ä¸­æ‰“æ–­ç‚¹ï¼š



Debugæ–¹å¼å¯åŠ¨order-serviceæœåŠ¡ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„clientï¼Œåº•å±‚å°±æ˜¯Apache HttpClientï¼š









æ€»ç»“ï¼ŒFeignçš„ä¼˜åŒ–ï¼š

1.æ—¥å¿—çº§åˆ«å°½é‡ç”¨basic

2.ä½¿ç”¨HttpClientæˆ–OKHttpä»£æ›¿URLConnection

â‘   å¼•å…¥feign-httpClientä¾èµ–

â‘¡  é…ç½®æ–‡ä»¶å¼€å¯httpClientåŠŸèƒ½ï¼Œè®¾ç½®è¿æ¥æ± å‚æ•°









#### æœ€ä½³å®è·µ

æ‰€è°“æœ€è¿‘å®è·µï¼Œå°±æ˜¯ä½¿ç”¨è¿‡ç¨‹ä¸­æ€»ç»“çš„ç»éªŒï¼Œæœ€å¥½çš„ä¸€ç§ä½¿ç”¨æ–¹å¼ã€‚

è‡ªä¹ è§‚å¯Ÿå¯ä»¥å‘ç°ï¼ŒFeignçš„å®¢æˆ·ç«¯ä¸æœåŠ¡æä¾›è€…çš„controllerä»£ç éå¸¸ç›¸ä¼¼ï¼š

feignå®¢æˆ·ç«¯ï¼š

![image-20230207180244271](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230207180244271.png)

UserControllerï¼š

![image-20230207180321240](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230207180321240.png)



æœ‰æ²¡æœ‰ä¸€ç§åŠæ³•ç®€åŒ–è¿™ç§é‡å¤çš„ä»£ç ç¼–å†™å‘¢ï¼Ÿ





##### ç»§æ‰¿æ–¹å¼

ä¸€æ ·çš„ä»£ç å¯ä»¥é€šè¿‡ç»§æ‰¿æ¥å…±äº«ï¼š

1ï¼‰å®šä¹‰ä¸€ä¸ªAPIæ¥å£ï¼Œåˆ©ç”¨å®šä¹‰æ–¹æ³•ï¼Œå¹¶åŸºäºSpringMVCæ³¨è§£åšå£°æ˜ã€‚

2ï¼‰Feignå®¢æˆ·ç«¯å’ŒControlleréƒ½é›†æˆæ”¹æ¥å£



![image-20230207180142967](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230207180142967.png)



ä¼˜ç‚¹ï¼š

- ç®€å•
- å®ç°äº†ä»£ç å…±äº«

ç¼ºç‚¹ï¼š

- æœåŠ¡æä¾›æ–¹ã€æœåŠ¡æ¶ˆè´¹æ–¹ç´§è€¦åˆ

- å‚æ•°åˆ—è¡¨ä¸­çš„æ³¨è§£æ˜ å°„å¹¶ä¸ä¼šç»§æ‰¿ï¼Œå› æ­¤Controllerä¸­å¿…é¡»å†æ¬¡å£°æ˜æ–¹æ³•ã€å‚æ•°åˆ—è¡¨ã€æ³¨è§£





##### æŠ½å–æ–¹å¼

å°†Feignçš„ClientæŠ½å–ä¸ºç‹¬ç«‹æ¨¡å—ï¼Œå¹¶ä¸”æŠŠæ¥å£æœ‰å…³çš„POJOã€é»˜è®¤çš„Feigné…ç½®éƒ½æ”¾åˆ°è¿™ä¸ªæ¨¡å—ä¸­ï¼Œæä¾›ç»™æ‰€æœ‰æ¶ˆè´¹è€…ä½¿ç”¨ã€‚

ä¾‹å¦‚ï¼Œå°†UserClientã€Userã€Feignçš„é»˜è®¤é…ç½®éƒ½æŠ½å–åˆ°ä¸€ä¸ªfeign-apiåŒ…ä¸­ï¼Œæ‰€æœ‰å¾®æœåŠ¡å¼•ç”¨è¯¥ä¾èµ–åŒ…ï¼Œå³å¯ç›´æ¥ä½¿ç”¨ã€‚

![image-20230207180209071](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230207180209071.png)





##### å®ç°åŸºäºæŠ½å–çš„æœ€ä½³å®è·µ

###### 1.æŠ½å–

é¦–å…ˆåˆ›å»ºä¸€ä¸ªmoduleï¼Œå‘½åä¸ºfeign-apiï¼š

![image-20230207204036123](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230207204036123.png)

é¡¹ç›®ç»“æ„ï¼š

![image-20230207204117772](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230207204117772.png)

åœ¨feign-apiä¸­ç„¶åå¼•å…¥feignçš„starterä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```



ç„¶åï¼Œorder-serviceä¸­ç¼–å†™çš„UserClientã€Userã€FeignConfigéƒ½å¤åˆ¶åˆ°feign-apié¡¹ç›®ä¸­

![image-20230207204255027](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230207204255027.png)

###### 2.åœ¨order-serviceä¸­ä½¿ç”¨feign-api

é¦–å…ˆï¼Œåˆ é™¤order-serviceä¸­çš„UserClientã€Userã€DefaultFeignConfigurationç­‰ç±»æˆ–æ¥å£ã€‚



åœ¨order-serviceçš„pomæ–‡ä»¶ä¸­ä¸­å¼•å…¥feign-apiçš„ä¾èµ–ï¼š

```xml
<!--å¼•å…¥åŒæ„api feign-api -->
<dependency>
	<groupId>com.ganga.A2-Feign-api</groupId>
	<artifactId>feign-api</artifactId>
	<version>1.0</version>
</dependency>
```



ä¿®æ”¹order-serviceä¸­çš„æ‰€æœ‰ä¸ä¸Šè¿°ä¸‰ä¸ªç»„ä»¶æœ‰å…³çš„å¯¼åŒ…éƒ¨åˆ†ï¼Œæ”¹æˆå¯¼å…¥feign-apiä¸­çš„åŒ…



###### 3.é‡å¯æµ‹è¯•

é‡å¯åï¼Œå‘ç°æœåŠ¡æŠ¥é”™äº†ï¼š



è¿™æ˜¯å› ä¸ºUserClientç°åœ¨åœ¨com.ganga.feign.clientsåŒ…ä¸‹ï¼Œ

è€Œorder-serviceçš„@EnableFeignClientsæ³¨è§£æ˜¯åœ¨com.ganga.orderåŒ…ä¸‹ï¼Œä¸åœ¨åŒä¸€ä¸ªåŒ…ï¼Œæ— æ³•æ‰«æåˆ°UserClientã€‚



###### 4.è§£å†³æ‰«æåŒ…é—®é¢˜

æ–¹å¼ä¸€ï¼š

æŒ‡å®šFeignåº”è¯¥æ‰«æçš„åŒ…ï¼š

```java
@EnableFeignClients(basePackages = "com.ganga.feign.clients")
```



æ–¹å¼äºŒï¼š

æŒ‡å®šéœ€è¦åŠ è½½çš„Clientæ¥å£ï¼š

```java
@EnableFeignClients(clients = {UserClient.class})
```





---

---





## ğŸ—‚ï¸ç»„ä»¶-åŒä¸€ç½‘å…³



Spring Cloud Gateway æ˜¯ Spring Cloud çš„ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼Œè¯¥é¡¹ç›®æ˜¯åŸºäº Spring 5.0ï¼ŒSpring Boot 2.0 å’Œ Project Reactor ç­‰å“åº”å¼ç¼–ç¨‹å’Œäº‹ä»¶æµæŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚



**ä¸ºä»€ä¹ˆéœ€è¦ç½‘å…³**

Gatewayç½‘å…³æ˜¯æˆ‘ä»¬æœåŠ¡çš„å®ˆé—¨ç¥ï¼Œæ‰€æœ‰å¾®æœåŠ¡çš„ç»Ÿä¸€å…¥å£ã€‚

ç½‘å…³çš„**æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§**ï¼š

- è¯·æ±‚è·¯ç”±
- æƒé™æ§åˆ¶
- é™æµ

æ¶æ„å›¾ï¼š

![image-20230221235052543](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230221235052543.png)





**æƒé™æ§åˆ¶**ï¼šç½‘å…³ä½œä¸ºå¾®æœåŠ¡å…¥å£ï¼Œéœ€è¦æ ¡éªŒç”¨æˆ·æ˜¯æ˜¯å¦æœ‰è¯·æ±‚èµ„æ ¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›è¡Œæ‹¦æˆªã€‚

**è·¯ç”±å’Œè´Ÿè½½å‡è¡¡**ï¼šä¸€åˆ‡è¯·æ±‚éƒ½å¿…é¡»å…ˆç»è¿‡gatewayï¼Œä½†ç½‘å…³ä¸å¤„ç†ä¸šåŠ¡ï¼Œè€Œæ˜¯æ ¹æ®æŸç§è§„åˆ™ï¼ŒæŠŠè¯·æ±‚è½¬å‘åˆ°æŸä¸ªå¾®æœåŠ¡ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšè·¯ç”±ã€‚å½“ç„¶è·¯ç”±çš„ç›®æ ‡æœåŠ¡æœ‰å¤šä¸ªæ—¶ï¼Œè¿˜éœ€è¦åšè´Ÿè½½å‡è¡¡ã€‚

**é™æµ**ï¼šå½“è¯·æ±‚æµé‡è¿‡é«˜æ—¶ï¼Œåœ¨ç½‘å…³ä¸­æŒ‰ç…§ä¸‹æµçš„å¾®æœåŠ¡èƒ½å¤Ÿæ¥å—çš„é€Ÿåº¦æ¥æ”¾è¡Œè¯·æ±‚ï¼Œé¿å…æœåŠ¡å‹åŠ›è¿‡å¤§ã€‚



åœ¨SpringCloudä¸­ç½‘å…³çš„å®ç°åŒ…æ‹¬ä¸¤ç§ï¼š

- gateway
- zuul

Zuulæ˜¯åŸºäºServletçš„å®ç°ï¼Œå±äºé˜»å¡å¼ç¼–ç¨‹ã€‚è€ŒSpringCloudGatewayåˆ™æ˜¯åŸºäºSpring5ä¸­æä¾›çš„WebFluxï¼Œå±äºå“åº”å¼ç¼–ç¨‹çš„å®ç°ï¼Œå…·å¤‡æ›´å¥½çš„æ€§èƒ½ã€‚







### ğŸ”–Gatewayç½‘å…³



#### gatewayå¿«é€Ÿå…¥é—¨

ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¼”ç¤ºä¸‹ç½‘å…³çš„åŸºæœ¬è·¯ç”±åŠŸèƒ½ã€‚åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š

1. åˆ›å»ºSpringBootå·¥ç¨‹gatewayï¼Œå¼•å…¥ç½‘å…³ä¾èµ–
2. ç¼–å†™å¯åŠ¨ç±»
3. ç¼–å†™åŸºç¡€é…ç½®å’Œè·¯ç”±è§„åˆ™
4. å¯åŠ¨ç½‘å…³æœåŠ¡è¿›è¡Œæµ‹è¯•



##### å¼•å…¥ä¾èµ–

åˆ›å»ºæœåŠ¡ï¼š

![image-20230221235145808](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230221235145808.png)

å¼•å…¥ä¾èµ–ï¼š

```xml
<!--ç½‘å…³-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
<!--nacosæœåŠ¡å‘ç°ä¾èµ–-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```





##### ç¼–å†™å¯åŠ¨ç±»

```java
package com.ganga.gateway;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class GatewayApplication {

	public static void main(String[] args) {
		SpringApplication.run(GatewayApplication.class, args);
	}
}
```



##### ç¼–å†™åŸºç¡€é…ç½®å’Œè·¯ç”±è§„åˆ™

åˆ›å»ºapplication.ymlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```yaml
server:
  port: 10010 # ç½‘å…³ç«¯å£
spring:
  application:
    name: gateway # æœåŠ¡åç§°
  cloud:
    nacos:
      server-addr: localhost:8848 # nacosåœ°å€
    gateway:
      routes: # ç½‘å…³è·¯ç”±é…ç½®
        - id: user-service # è·¯ç”±idï¼Œè‡ªå®šä¹‰ï¼Œåªè¦å”¯ä¸€å³å¯
          # uri: http://127.0.0.1:8081 # è·¯ç”±çš„ç›®æ ‡åœ°å€ httpå°±æ˜¯å›ºå®šåœ°å€
          uri: lb://userservice # è·¯ç”±çš„ç›®æ ‡åœ°å€ lbå°±æ˜¯è´Ÿè½½å‡è¡¡ï¼Œåé¢è·ŸæœåŠ¡åç§°
          predicates: # è·¯ç”±æ–­è¨€ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆè·¯ç”±è§„åˆ™çš„æ¡ä»¶
            - Path=/user/** # è¿™ä¸ªæ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œåªè¦ä»¥/user/å¼€å¤´å°±ç¬¦åˆè¦æ±‚
```





æˆ‘ä»¬å°†ç¬¦åˆ`Path` è§„åˆ™çš„ä¸€åˆ‡è¯·æ±‚ï¼Œéƒ½ä»£ç†åˆ° `uri`å‚æ•°æŒ‡å®šçš„åœ°å€ã€‚

æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°† `/user/**`å¼€å¤´çš„è¯·æ±‚ï¼Œä»£ç†åˆ°`lb://userservice`ï¼Œlbæ˜¯è´Ÿè½½å‡è¡¡ï¼Œæ ¹æ®æœåŠ¡åæ‹‰å–æœåŠ¡åˆ—è¡¨ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚



##### é‡å¯æµ‹è¯•

é‡å¯ç½‘å…³ï¼Œè®¿é—®http://localhost:10010/user/1æ—¶ï¼Œç¬¦åˆ`/user/**`è§„åˆ™ï¼Œè¯·æ±‚è½¬å‘åˆ°uriï¼šhttp://userservice/user/1ï¼Œå¾—åˆ°äº†ç»“æœ





##### ç½‘å…³è·¯ç”±çš„æµç¨‹å›¾

æ•´ä¸ªè®¿é—®çš„æµç¨‹å¦‚ä¸‹ï¼š

![image-20230221235420379](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230221235420379.png)









##### æ€»ç»“ï¼š

ç½‘å…³æ­å»ºæ­¥éª¤ï¼š

1. åˆ›å»ºé¡¹ç›®ï¼Œå¼•å…¥nacosæœåŠ¡å‘ç°å’Œgatewayä¾èµ–

2. é…ç½®application.ymlï¼ŒåŒ…æ‹¬æœåŠ¡åŸºæœ¬ä¿¡æ¯ã€nacosåœ°å€ã€è·¯ç”±

è·¯ç”±é…ç½®åŒ…æ‹¬ï¼š

1. è·¯ç”±idï¼šè·¯ç”±çš„å”¯ä¸€æ ‡ç¤º

2. è·¯ç”±ç›®æ ‡ï¼ˆuriï¼‰ï¼šè·¯ç”±çš„ç›®æ ‡åœ°å€ï¼Œhttpä»£è¡¨å›ºå®šåœ°å€ï¼Œlbä»£è¡¨æ ¹æ®æœåŠ¡åè´Ÿè½½å‡è¡¡

3. è·¯ç”±æ–­è¨€ï¼ˆpredicatesï¼‰ï¼šåˆ¤æ–­è·¯ç”±çš„è§„åˆ™ï¼Œ

4. è·¯ç”±è¿‡æ»¤å™¨ï¼ˆfiltersï¼‰ï¼šå¯¹è¯·æ±‚æˆ–å“åº”åšå¤„ç†



æ¥ä¸‹æ¥ï¼Œå°±é‡ç‚¹æ¥å­¦ä¹ è·¯ç”±æ–­è¨€å’Œè·¯ç”±è¿‡æ»¤å™¨çš„è¯¦ç»†çŸ¥è¯†







#### æ–­è¨€å·¥å‚

æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­å†™çš„æ–­è¨€è§„åˆ™åªæ˜¯å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²ä¼šè¢«Predicate Factoryè¯»å–å¹¶å¤„ç†ï¼Œè½¬å˜ä¸ºè·¯ç”±åˆ¤æ–­çš„æ¡ä»¶

ä¾‹å¦‚Path=/user/**æ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œè¿™ä¸ªè§„åˆ™æ˜¯ç”±

`org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory`ç±»æ¥

å¤„ç†çš„ï¼Œåƒè¿™æ ·çš„æ–­è¨€å·¥å‚åœ¨SpringCloudGatewayè¿˜æœ‰åå‡ ä¸ª:

| **åç§°**   | **è¯´æ˜**                       | **ç¤ºä¾‹**                                                     |
| ---------- | ------------------------------ | ------------------------------------------------------------ |
| After      | æ˜¯æŸä¸ªæ—¶é—´ç‚¹åçš„è¯·æ±‚           | -  After=2037-01-20T17:42:47.789-07:00[America/Denver]       |
| Before     | æ˜¯æŸä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„è¯·æ±‚         | -  Before=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]       |
| Between    | æ˜¯æŸä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„è¯·æ±‚       | -  Between=2037-01-20T17:42:47.789-07:00[America/Denver],  2037-01-21T17:42:47.789-07:00[America/Denver] |
| Cookie     | è¯·æ±‚å¿…é¡»åŒ…å«æŸäº›cookie         | - Cookie=chocolate, ch.p                                     |
| Header     | è¯·æ±‚å¿…é¡»åŒ…å«æŸäº›header         | - Header=X-Request-Id, \d+                                   |
| Host       | è¯·æ±‚å¿…é¡»æ˜¯è®¿é—®æŸä¸ªhostï¼ˆåŸŸåï¼‰ | -  Host=**.somehost.org,**.anotherhost.org                   |
| Method     | è¯·æ±‚æ–¹å¼å¿…é¡»æ˜¯æŒ‡å®šæ–¹å¼         | - Method=GET,POST                                            |
| Path       | è¯·æ±‚è·¯å¾„å¿…é¡»ç¬¦åˆæŒ‡å®šè§„åˆ™       | - Path=/red/{segment},/blue/**                               |
| Query      | è¯·æ±‚å‚æ•°å¿…é¡»åŒ…å«æŒ‡å®šå‚æ•°       | - Query=name, Jackæˆ–è€…-  Query=name                          |
| RemoteAddr | è¯·æ±‚è€…çš„ipå¿…é¡»æ˜¯æŒ‡å®šèŒƒå›´       | - RemoteAddr=192.168.1.1/24                                  |
| Weight     | æƒé‡å¤„ç†                       |                                                              |

è¿™é‡Œæœ‰å®˜ç½‘æ¨¡æ¿ï¼š[Spring Cloud Gateway](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-after-route-predicate-factory)

![image-20230221221802131](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230221221802131.png)



æˆ‘ä»¬åªéœ€è¦æŒæ¡Pathè¿™ç§è·¯ç”±å·¥ç¨‹å°±å¯ä»¥äº†ã€‚





#### è¿‡æ»¤å™¨å·¥å‚

GatewayFilteræ˜¯ç½‘å…³ä¸­æä¾›çš„ä¸€ç§è¿‡æ»¤å™¨ï¼Œå¯ä»¥å¯¹è¿›å…¥ç½‘å…³çš„è¯·æ±‚å’Œå¾®æœåŠ¡è¿”å›çš„å“åº”åšå¤„ç†ï¼š

è¿™é‡Œæœ‰å®˜ç½‘æ¨¡æ¿ï¼š[Spring Cloud Gateway](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories)

![image-20230221223143932](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230221223143932.png)





##### è·¯ç”±è¿‡æ»¤å™¨çš„ç§ç±»

Springæä¾›äº†31ç§ä¸åŒçš„è·¯ç”±è¿‡æ»¤å™¨å·¥å‚ã€‚ä¾‹å¦‚ï¼š

| **åç§°**             | **è¯´æ˜**                     |
| -------------------- | ---------------------------- |
| AddRequestHeader     | ç»™å½“å‰è¯·æ±‚æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´     |
| RemoveRequestHeader  | ç§»é™¤è¯·æ±‚ä¸­çš„ä¸€ä¸ªè¯·æ±‚å¤´       |
| AddResponseHeader    | ç»™å“åº”ç»“æœä¸­æ·»åŠ ä¸€ä¸ªå“åº”å¤´   |
| RemoveResponseHeader | ä»å“åº”ç»“æœä¸­ç§»é™¤æœ‰ä¸€ä¸ªå“åº”å¤´ |
| RequestRateLimiter   | é™åˆ¶è¯·æ±‚çš„æµé‡               |
| ...                  | ...                          |

![image-20230221224358347](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230221224358347.png)





##### è¯·æ±‚å¤´è¿‡æ»¤å™¨

ä¸‹é¢æˆ‘ä»¬ä»¥AddRequestHeader ä¸ºä¾‹æ¥è®²è§£ã€‚

> **éœ€æ±‚**ï¼šç»™æ‰€æœ‰è¿›å…¥userserviceçš„è¯·æ±‚æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´ï¼šTruth=ganga is freaking awesome!



åªéœ€è¦ä¿®æ”¹gatewayæœåŠ¡çš„application.ymlæ–‡ä»¶ï¼Œæ·»åŠ è·¯ç”±è¿‡æ»¤å³å¯ï¼š

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: user-service 
        uri: lb://userservice 
        predicates: 
        - Path=/user/** 
        filters: # è¿‡æ»¤å™¨
        - AddRequestHeader=header-key, value! # æ·»åŠ è¯·æ±‚å¤´
```

å½“å‰è¿‡æ»¤å™¨å†™åœ¨userserviceè·¯ç”±ä¸‹ï¼Œå› æ­¤ä»…ä»…å¯¹è®¿é—®userserviceçš„è¯·æ±‚æœ‰æ•ˆã€‚





##### é»˜è®¤è¿‡æ»¤å™¨

å¦‚æœè¦å¯¹æ‰€æœ‰çš„è·¯ç”±éƒ½ç”Ÿæ•ˆï¼Œåˆ™å¯ä»¥å°†è¿‡æ»¤å™¨å·¥å‚å†™åˆ°defaultä¸‹ã€‚æ ¼å¼å¦‚ä¸‹ï¼š

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: user-service 
        uri: lb://userservice 
        predicates: 
        - Path=/user/**
      default-filters: # é»˜è®¤è¿‡æ»¤é¡¹
      - AddRequestHeader=Truth, ganga is freaking awesome! 
```



##### æ€»ç»“

è¿‡æ»¤å™¨çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

â‘  å¯¹è·¯ç”±çš„è¯·æ±‚æˆ–å“åº”åšåŠ å·¥å¤„ç†ï¼Œæ¯”å¦‚æ·»åŠ è¯·æ±‚å¤´

â‘¡ é…ç½®åœ¨è·¯ç”±ä¸‹çš„è¿‡æ»¤å™¨åªå¯¹å½“å‰è·¯ç”±çš„è¯·æ±‚ç”Ÿæ•ˆ

defaultFiltersçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

â‘  å¯¹æ‰€æœ‰è·¯ç”±éƒ½ç”Ÿæ•ˆçš„è¿‡æ»¤å™¨





#### å…¨å±€è¿‡æ»¤å™¨

ä¸Šä¸€èŠ‚å­¦ä¹ çš„è¿‡æ»¤å™¨ï¼Œç½‘å…³æä¾›äº†31ç§ï¼Œä½†æ¯ä¸€ç§è¿‡æ»¤å™¨çš„ä½œç”¨éƒ½æ˜¯å›ºå®šçš„ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›æ‹¦æˆªè¯·æ±‚ï¼Œåšè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘åˆ™æ²¡åŠæ³•å®ç°ã€‚

##### å…¨å±€è¿‡æ»¤å™¨ä½œç”¨

å…¨å±€è¿‡æ»¤å™¨çš„ä½œç”¨ä¹Ÿæ˜¯å¤„ç†ä¸€åˆ‡è¿›å…¥ç½‘å…³çš„è¯·æ±‚å’Œå¾®æœåŠ¡å“åº”ï¼Œä¸GatewayFilterçš„ä½œç”¨ä¸€æ ·ã€‚åŒºåˆ«åœ¨äºGatewayFilteré€šè¿‡é…ç½®å®šä¹‰ï¼Œå¤„ç†é€»è¾‘æ˜¯å›ºå®šçš„ï¼›è€ŒGlobalFilterçš„é€»è¾‘éœ€è¦è‡ªå·±å†™ä»£ç å®ç°ã€‚

å®šä¹‰æ–¹å¼æ˜¯å®ç°GlobalFilteræ¥å£ã€‚

```java
public interface GlobalFilter {
    /**
     *  å¤„ç†å½“å‰è¯·æ±‚ï¼Œæœ‰å¿…è¦çš„è¯é€šè¿‡{@link GatewayFilterChain}å°†è¯·æ±‚äº¤ç»™ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨å¤„ç†
     *
     * @param exchange è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œé‡Œé¢å¯ä»¥è·å–Requestã€Responseç­‰ä¿¡æ¯
     * @param chain ç”¨æ¥æŠŠè¯·æ±‚å§”æ‰˜ç»™ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨ 
     * @return {@code Mono<Void>} è¿”å›æ ‡ç¤ºå½“å‰è¿‡æ»¤å™¨ä¸šåŠ¡ç»“æŸ
     */
    Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain);
}
```



åœ¨filterä¸­ç¼–å†™è‡ªå®šä¹‰é€»è¾‘ï¼Œå¯ä»¥å®ç°ä¸‹åˆ—åŠŸèƒ½ï¼š

- ç™»å½•çŠ¶æ€åˆ¤æ–­
- æƒé™æ ¡éªŒ
- è¯·æ±‚é™æµç­‰







##### è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨

éœ€æ±‚ï¼šå®šä¹‰å…¨å±€è¿‡æ»¤å™¨ï¼Œæ‹¦æˆªè¯·æ±‚ï¼Œåˆ¤æ–­è¯·æ±‚çš„å‚æ•°æ˜¯å¦æ»¡è¶³ä¸‹é¢æ¡ä»¶ï¼š

- å‚æ•°ä¸­æ˜¯å¦æœ‰authorizationï¼Œ

- authorizationå‚æ•°å€¼æ˜¯å¦ä¸ºadmin

å¦‚æœåŒæ—¶æ»¡è¶³åˆ™æ”¾è¡Œï¼Œå¦åˆ™æ‹¦æˆª



å®ç°ï¼š

åœ¨gatewayä¸­å®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ï¼š

```java
package com.ganga.gateway.filters;

import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.cloud.gateway.filter.GlobalFilter;
import org.springframework.core.annotation.Order;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

@Order(-1)
@Component
public class AuthorizeFilter implements GlobalFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // 1.è·å–è¯·æ±‚å‚æ•°
        MultiValueMap<String, String> params = exchange.getRequest().getQueryParams();
        // 2.è·å–authorizationå‚æ•°
        String auth = params.getFirst("authorization");
        // 3.æ ¡éªŒ
        if ("admin".equals(auth)) {
            // æ”¾è¡Œ
            return chain.filter(exchange);
        }
        // 4.æ‹¦æˆª
        // 4.1.ç¦æ­¢è®¿é—®ï¼Œè®¾ç½®çŠ¶æ€ç 
        exchange.getResponse().setStatusCode(HttpStatus.FORBIDDEN);
        // 4.2.ç»“æŸå¤„ç†
        return exchange.getResponse().setComplete();
    }
}
```





##### è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº

è¯·æ±‚è¿›å…¥ç½‘å…³ä¼šç¢°åˆ°ä¸‰ç±»è¿‡æ»¤å™¨ï¼šå½“å‰è·¯ç”±çš„è¿‡æ»¤å™¨ã€DefaultFilterã€GlobalFilter

è¯·æ±‚è·¯ç”±åï¼Œä¼šå°†å½“å‰è·¯ç”±è¿‡æ»¤å™¨å’ŒDefaultFilterã€GlobalFilterï¼Œåˆå¹¶åˆ°ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼ˆé›†åˆï¼‰ä¸­ï¼Œæ’åºåä¾æ¬¡æ‰§è¡Œæ¯ä¸ªè¿‡æ»¤å™¨ï¼š

![image-20230221235539330](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230221235539330.png)





æ’åºçš„è§„åˆ™æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

- æ¯ä¸€ä¸ªè¿‡æ»¤å™¨éƒ½å¿…é¡»æŒ‡å®šä¸€ä¸ªintç±»å‹çš„orderå€¼ï¼Œ**orderå€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œæ‰§è¡Œé¡ºåºè¶Šé å‰**ã€‚
- GlobalFilteré€šè¿‡å®ç°Orderedæ¥å£ï¼Œæˆ–è€…æ·»åŠ @Orderæ³¨è§£æ¥æŒ‡å®šorderå€¼ï¼Œç”±æˆ‘ä»¬è‡ªå·±æŒ‡å®š
- è·¯ç”±è¿‡æ»¤å™¨å’ŒdefaultFilterçš„orderç”±SpringæŒ‡å®šï¼Œé»˜è®¤æ˜¯æŒ‰ç…§å£°æ˜é¡ºåºä»1é€’å¢ã€‚
- å½“è¿‡æ»¤å™¨çš„orderå€¼ä¸€æ ·æ—¶ï¼Œä¼šæŒ‰ç…§ **defaultFilter > è·¯ç”±è¿‡æ»¤å™¨ > GlobalFilter **çš„é¡ºåºæ‰§è¡Œã€‚





è¯¦ç»†å†…å®¹ï¼Œå¯ä»¥æŸ¥çœ‹æºç ï¼š

`org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator#getFilters()`æ–¹æ³•æ˜¯å…ˆåŠ è½½defaultFiltersï¼Œç„¶åå†åŠ è½½æŸä¸ªrouteçš„filtersï¼Œç„¶ååˆå¹¶ã€‚



`org.springframework.cloud.gateway.handler.FilteringWebHandler#handle()`æ–¹æ³•ä¼šåŠ è½½å…¨å±€è¿‡æ»¤å™¨ï¼Œä¸å‰é¢çš„è¿‡æ»¤å™¨åˆå¹¶åæ ¹æ®orderæ’åºï¼Œç»„ç»‡è¿‡æ»¤å™¨é“¾



#### è·¨åŸŸé—®é¢˜



##### ä»€ä¹ˆæ˜¯è·¨åŸŸé—®é¢˜

è·¨åŸŸï¼šåŸŸåä¸ä¸€è‡´å°±æ˜¯è·¨åŸŸï¼Œä¸»è¦åŒ…æ‹¬ï¼š

- åŸŸåä¸åŒï¼š www.taobao.com å’Œ www.taobao.org å’Œ www.jd.com å’Œ miaosha.jd.com

- åŸŸåç›¸åŒï¼Œç«¯å£ä¸åŒï¼šlocalhost:8080å’Œlocalhost8081

è·¨åŸŸé—®é¢˜ï¼šæµè§ˆå™¨ç¦æ­¢è¯·æ±‚çš„å‘èµ·è€…ä¸æœåŠ¡ç«¯å‘ç”Ÿè·¨åŸŸajaxè¯·æ±‚ï¼Œè¯·æ±‚è¢«æµè§ˆå™¨æ‹¦æˆªçš„é—®é¢˜



è§£å†³æ–¹æ¡ˆï¼šCORSï¼Œè¿™ä¸ªä»¥å‰åº”è¯¥å­¦ä¹ è¿‡ï¼Œè¿™é‡Œä¸å†èµ˜è¿°äº†ã€‚ä¸çŸ¥é“çš„å°ä¼™ä¼´å¯ä»¥æŸ¥çœ‹https://www.ruanyifeng.com/blog/2016/04/cors.html



##### æ¨¡æ‹Ÿè·¨åŸŸé—®é¢˜



ä»localhost:8090è®¿é—®localhost:10010ï¼Œç«¯å£ä¸åŒï¼Œæ˜¾ç„¶æ˜¯è·¨åŸŸçš„è¯·æ±‚ã€‚



##### è§£å†³è·¨åŸŸé—®é¢˜

åœ¨gatewayæœåŠ¡çš„application.ymlæ–‡ä»¶ä¸­ï¼Œæ·»åŠ ä¸‹é¢çš„é…ç½®ï¼š

```yaml
spring:
  cloud:
    gateway:
      # ã€‚ã€‚ã€‚
      globalcors: # å…¨å±€çš„è·¨åŸŸå¤„ç†
        add-to-simple-url-handler-mapping: true # è§£å†³optionsè¯·æ±‚è¢«æ‹¦æˆªé—®é¢˜
        corsConfigurations:
          '[/**]':
            allowedOrigins: # å…è®¸å“ªäº›ç½‘ç«™çš„è·¨åŸŸè¯·æ±‚ 
              - "http://localhost:8090"
            allowedMethods: # å…è®¸çš„è·¨åŸŸajaxçš„è¯·æ±‚æ–¹å¼
              - "GET"
              - "POST"
              - "DELETE"
              - "PUT"
              - "OPTIONS"
            allowedHeaders: "*" # å…è®¸åœ¨è¯·æ±‚ä¸­æºå¸¦çš„å¤´ä¿¡æ¯
            allowCredentials: true # æ˜¯å¦å…è®¸æºå¸¦cookie
            maxAge: 360000 # è¿™æ¬¡è·¨åŸŸæ£€æµ‹çš„æœ‰æ•ˆæœŸ
```





#### é…ç½®æ–‡ä»¶



```yaml
server:
  port: 10010
spring:
  application:
    name: wateway
  cloud:
    nacos:
      server-addr: localhost:8848
    #é…ç½®gatewayç½‘å…³
    gateway:
      routes: # é…ç½®ç½‘å…³è·¯ç”± ä¸€ç»„éœ€è¦ä¸‰ä¸ªå¿…è¦å‚æ•° idã€uriã€predicates å¤–åŠ ä¸€ä¸ª filters
        - id: user-service # è·¯ç”±idï¼Œè‡ªå®šä¹‰ï¼Œåªè¦å”¯ä¸€å³å¯
          uri: lb://userservice # è·¯ç”±çš„ç›®æ ‡åœ°å€ lbæ˜¯è´Ÿè½½å‡è¡¡ åé¢æ˜¯æœåŠ¡åç§°
          predicates: # è·¯ç”±æ–­è¨€ï¼Œæ˜¯åˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆè·¯ç”±è§„åˆ™çš„æ¡ä»¶
            - Path=/user/**
          filters:
            - AddRequestHeader=header-key, value! # æ·»åŠ è¯·æ±‚å¤´
        - id: order-service
          uri: lb://orderservice
          predicates:
            - Path=/order/**
          filters:
            - AddRequestHeader=Header-key, Filter!
      default-filters: # é»˜è®¤è¿‡æ»¤å™¨ spring.cloud.gateway.default-filters
        - AddRequestHeader=Header-key, Filter!
      # é…ç½®å…¨å±€çš„è·¨åŸŸå¤„ç†
      globalcors:
        add-to-simple-url-handler-mapping: true # è§£å†³optionsè¯·æ±‚è¢«æ‹¦æˆªé—®é¢˜
        cors-configurations:
          '[/**]':
            allowedOrigins: # å…è®¸å“ªäº›ç½‘ç«™çš„è·¨åŸŸè¯·æ±‚
              - "http://localhost:8090"
              - "http://www.baidu.com"
            allowedMethods: # å…è®¸çš„è·¨åŸŸajaxçš„è¯·æ±‚æ–¹å¼
              - "GET"
              - "POST"
              - "DELETE"
              - "PUT"
              - "OPTIONS"
            allowedHeaders: "*" # å…è®¸åœ¨è¯·æ±‚ä¸­æºå¸¦çš„å¤´ä¿¡æ¯
            allowCredentials: true # æ˜¯å¦å…è®¸æºå¸¦cookie
            maxAge: 360000 # è¿™æ¬¡è·¨åŸŸæ£€æµ‹çš„æœ‰æ•ˆæœŸ
            
#æ–‡æ¡£: https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-addrequestheader-gatewayfilter-factory

```









---





## ğŸ¥ğŸ¥ğŸ¥ğŸ¥ğŸ¥

**ä¸­é—´ä»¶**





---







## ğŸ“¬æ¶ˆæ¯é˜Ÿåˆ—MQ







### åˆè¯†MQ

---

#### åŒæ­¥å’Œå¼‚æ­¥é€šè®¯

å¾®æœåŠ¡é—´é€šè®¯æœ‰åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ–¹å¼ï¼š

åŒæ­¥é€šè®¯ï¼šå°±åƒæ‰“ç”µè¯ï¼Œéœ€è¦å®æ—¶å“åº”ã€‚

å¼‚æ­¥é€šè®¯ï¼šå°±åƒå‘é‚®ä»¶ï¼Œä¸éœ€è¦é©¬ä¸Šå›å¤ã€‚

![image-20230223173200789](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230223173200789.png)

ä¸¤ç§æ–¹å¼å„æœ‰ä¼˜åŠ£ï¼Œæ‰“ç”µè¯å¯ä»¥ç«‹å³å¾—åˆ°å“åº”ï¼Œä½†æ˜¯ä½ å´ä¸èƒ½è·Ÿå¤šä¸ªäººåŒæ—¶é€šè¯ã€‚å‘é€é‚®ä»¶å¯ä»¥åŒæ—¶ä¸å¤šä¸ªäººæ”¶å‘é‚®ä»¶ï¼Œä½†æ˜¯å¾€å¾€å“åº”ä¼šæœ‰å»¶è¿Ÿã€‚



#### åŒæ­¥é€šè®¯

æˆ‘ä»¬ä¹‹å‰å­¦ä¹ çš„Feignè°ƒç”¨å°±å±äºåŒæ­¥æ–¹å¼ï¼Œè™½ç„¶è°ƒç”¨å¯ä»¥å®æ—¶å¾—åˆ°ç»“æœï¼Œä½†å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š

![image-20230223173228947](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230223173228947.png)

---

![image-20230223173259369](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230223173259369.png)

---

æ€»ç»“ï¼š

åŒæ­¥è°ƒç”¨çš„ä¼˜ç‚¹ï¼š

- æ—¶æ•ˆæ€§è¾ƒå¼ºï¼Œå¯ä»¥ç«‹å³å¾—åˆ°ç»“æœ

åŒæ­¥è°ƒç”¨çš„é—®é¢˜ï¼š

- è€¦åˆåº¦é«˜
- æ€§èƒ½å’Œååèƒ½åŠ›ä¸‹é™
- æœ‰é¢å¤–çš„èµ„æºæ¶ˆè€—
- æœ‰çº§è”å¤±è´¥é—®é¢˜





#### å¼‚æ­¥é€šè®¯

å¼‚æ­¥è°ƒç”¨åˆ™å¯ä»¥é¿å…ä¸Šè¿°é—®é¢˜ï¼š

![image-20230223173348339](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230223173348339.png)

æˆ‘ä»¬ä»¥è´­ä¹°å•†å“ä¸ºä¾‹ï¼Œç”¨æˆ·æ”¯ä»˜åéœ€è¦è°ƒç”¨è®¢å•æœåŠ¡å®Œæˆè®¢å•çŠ¶æ€ä¿®æ”¹ï¼Œè°ƒç”¨ç‰©æµæœåŠ¡ï¼Œä»ä»“åº“åˆ†é…å“åº”çš„åº“å­˜å¹¶å‡†å¤‡å‘è´§ã€‚

åœ¨äº‹ä»¶æ¨¡å¼ä¸­ï¼Œæ”¯ä»˜æœåŠ¡æ˜¯äº‹ä»¶å‘å¸ƒè€…ï¼ˆpublisherï¼‰ï¼Œåœ¨æ”¯ä»˜å®Œæˆååªéœ€è¦å‘å¸ƒä¸€ä¸ªæ”¯ä»˜æˆåŠŸçš„äº‹ä»¶ï¼ˆeventï¼‰ï¼Œäº‹ä»¶ä¸­å¸¦ä¸Šè®¢å•idã€‚

è®¢å•æœåŠ¡å’Œç‰©æµæœåŠ¡æ˜¯äº‹ä»¶è®¢é˜…è€…ï¼ˆConsumerï¼‰ï¼Œè®¢é˜…æ”¯ä»˜æˆåŠŸçš„äº‹ä»¶ï¼Œç›‘å¬åˆ°äº‹ä»¶åå®Œæˆè‡ªå·±ä¸šåŠ¡å³å¯ã€‚



ä¸ºäº†è§£é™¤äº‹ä»¶å‘å¸ƒè€…ä¸è®¢é˜…è€…ä¹‹é—´çš„è€¦åˆï¼Œä¸¤è€…å¹¶ä¸æ˜¯ç›´æ¥é€šä¿¡ï¼Œè€Œæ˜¯æœ‰ä¸€ä¸ªä¸­é—´äººï¼ˆBrokerï¼‰ã€‚å‘å¸ƒè€…å‘å¸ƒäº‹ä»¶åˆ°Brokerï¼Œä¸å…³å¿ƒè°æ¥è®¢é˜…äº‹ä»¶ã€‚è®¢é˜…è€…ä»Brokerè®¢é˜…äº‹ä»¶ï¼Œä¸å…³å¿ƒè°å‘æ¥çš„æ¶ˆæ¯ã€‚

![image-20230223173431797](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230223173431797.png)

---

![image-20230223173557567](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230223173557567.png)

---

![image-20230223173612430](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230223173612430.png)

---



Broker æ˜¯ä¸€ä¸ªåƒæ•°æ®æ€»çº¿ä¸€æ ·çš„ä¸œè¥¿ï¼Œæ‰€æœ‰çš„æœåŠ¡è¦æ¥æ”¶æ•°æ®å’Œå‘é€æ•°æ®éƒ½å‘åˆ°è¿™ä¸ªæ€»çº¿ä¸Šï¼Œè¿™ä¸ªæ€»çº¿å°±åƒåè®®ä¸€æ ·ï¼Œè®©æœåŠ¡é—´çš„é€šè®¯å˜å¾—æ ‡å‡†å’Œå¯æ§ã€‚



å¥½å¤„ï¼š

- ååé‡æå‡ï¼šæ— éœ€ç­‰å¾…è®¢é˜…è€…å¤„ç†å®Œæˆï¼Œå“åº”æ›´å¿«é€Ÿ

- æ•…éšœéš”ç¦»ï¼šæœåŠ¡æ²¡æœ‰ç›´æ¥è°ƒç”¨ï¼Œä¸å­˜åœ¨çº§è”å¤±è´¥é—®é¢˜
- è°ƒç”¨é—´æ²¡æœ‰é˜»å¡ï¼Œä¸ä¼šé€ æˆæ— æ•ˆçš„èµ„æºå ç”¨
- è€¦åˆåº¦æä½ï¼Œæ¯ä¸ªæœåŠ¡éƒ½å¯ä»¥çµæ´»æ’æ‹”ï¼Œå¯æ›¿æ¢
- æµé‡å‰Šå³°ï¼šä¸ç®¡å‘å¸ƒäº‹ä»¶çš„æµé‡æ³¢åŠ¨å¤šå¤§ï¼Œéƒ½ç”±Brokeræ¥æ”¶ï¼Œè®¢é˜…è€…å¯ä»¥æŒ‰ç…§è‡ªå·±çš„é€Ÿåº¦å»å¤„ç†äº‹ä»¶



ç¼ºç‚¹ï¼š

- æ¶æ„å¤æ‚äº†ï¼Œä¸šåŠ¡æ²¡æœ‰æ˜æ˜¾çš„æµç¨‹çº¿ï¼Œä¸å¥½ç®¡ç†
- éœ€è¦ä¾èµ–äºBrokerçš„å¯é ã€å®‰å…¨ã€æ€§èƒ½





å¥½åœ¨ç°åœ¨å¼€æºè½¯ä»¶æˆ–äº‘å¹³å°ä¸Š Broker çš„è½¯ä»¶æ˜¯éå¸¸æˆç†Ÿçš„ï¼Œæ¯”è¾ƒå¸¸è§çš„ä¸€ç§å°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦å­¦ä¹ çš„MQæŠ€æœ¯ã€‚

---



#### æŠ€æœ¯å¯¹æ¯”ï¼š

MQï¼Œä¸­æ–‡æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessageQueueï¼‰ï¼Œå­—é¢æ¥çœ‹å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚ä¹Ÿå°±æ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„ä¸­çš„Brokerã€‚

æ¯”è¾ƒå¸¸è§çš„MQå®ç°ï¼š

- ActiveMQ
- RabbitMQ
- RocketMQ
- Kafka



å‡ ç§å¸¸è§MQçš„å¯¹æ¯”ï¼š

![image-20230223173726065](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230223173726065.png)

|            |      **RabbitMQ**       |          **ActiveMQ**          | **RocketMQ** | **Kafka**  |
| :--------: | :---------------------: | :----------------------------: | :----------: | :--------: |
| å…¬å¸/ç¤¾åŒº  |         Rabbit          |             Apache             |     é˜¿é‡Œ     |   Apache   |
|  å¼€å‘è¯­è¨€  |         Erlang          |              Java              |     Java     | Scala&Java |
|  åè®®æ”¯æŒ  | AMQPï¼ŒXMPPï¼ŒSMTPï¼ŒSTOMP | OpenWire,STOMPï¼ŒREST,XMPP,AMQP |  è‡ªå®šä¹‰åè®®  | è‡ªå®šä¹‰åè®® |
|   å¯ç”¨æ€§   |           é«˜            |              ä¸€èˆ¬              |      é«˜      |     é«˜     |
| å•æœºååé‡ |          ä¸€èˆ¬           |               å·®               |      é«˜      |   éå¸¸é«˜   |
|  æ¶ˆæ¯å»¶è¿Ÿ  |         å¾®ç§’çº§          |             æ¯«ç§’çº§             |    æ¯«ç§’çº§    |  æ¯«ç§’ä»¥å†…  |
| æ¶ˆæ¯å¯é æ€§ |           é«˜            |              ä¸€èˆ¬              |      é«˜      |    ä¸€èˆ¬    |



**è¿½æ±‚å¯ç”¨æ€§ï¼šKafkaã€ RocketMQ ã€RabbitMQ**

**è¿½æ±‚å¯é æ€§ï¼šRabbitMQã€RocketMQ**

**è¿½æ±‚ååèƒ½åŠ›ï¼šRocketMQã€Kafka**

**è¿½æ±‚æ¶ˆæ¯ä½å»¶è¿Ÿï¼šRabbitMQã€Kafka**



---

---





### RabbitMQ

---

RabbitMQæ˜¯åŸºäºErlangè¯­è¨€å¼€å‘çš„å¼€æºæ¶ˆæ¯é€šä¿¡ä¸­é—´ä»¶ï¼Œå®˜ç½‘åœ°å€ï¼šhttps://www.rabbitmq.com/

RabbitMQçš„ç»“æ„å’Œæ¦‚å¿µï¼š

![image-20230223174122810](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230223174122810.png)



RabbitMQä¸­çš„ä¸€äº›è§’è‰²ï¼š

- publisherï¼šç”Ÿäº§è€…
- consumerï¼šæ¶ˆè´¹è€…
- exchangeä¸ªï¼šäº¤æ¢æœºï¼Œè´Ÿè´£æ¶ˆæ¯è·¯ç”±
- queueï¼šé˜Ÿåˆ—ï¼Œå­˜å‚¨æ¶ˆæ¯
- virtualHostï¼šè™šæ‹Ÿä¸»æœºï¼Œéš”ç¦»ä¸åŒç§Ÿæˆ·çš„exchangeã€queueã€æ¶ˆæ¯çš„éš”ç¦»





#### éƒ¨ç½²RebbitMQ

##### å•æœºéƒ¨ç½²

æ‹‰å–é•œåƒ

``` sh
docker pull rabbitmq:3-management
```

å®‰è£… æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥è¿è¡ŒMQå®¹å™¨ï¼š

```sh
docker run \
 -e RABBITMQ_DEFAULT_USER=ç”¨æˆ·å \
 -e RABBITMQ_DEFAULT_PASS=å¯†ç  \
 --name mq \
 --hostname mq1 \
 -p 15672:15672 \
 -p 5672:5672 \
 -d \
 rabbitmq:3-management
```







##### é›†ç¾¤éƒ¨ç½²

å®‰è£…RabbitMQçš„é›†ç¾¤ã€‚



##### é›†ç¾¤åˆ†ç±»

åœ¨RabbitMQçš„å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œè®²è¿°äº†ä¸¤ç§é›†ç¾¤çš„é…ç½®æ–¹å¼ï¼š

- æ™®é€šæ¨¡å¼ï¼šæ™®é€šæ¨¡å¼é›†ç¾¤ä¸è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œæ¯ä¸ªMQéƒ½æœ‰è‡ªå·±çš„é˜Ÿåˆ—ã€æ•°æ®ä¿¡æ¯ï¼ˆå…¶å®ƒå…ƒæ•°æ®ä¿¡æ¯å¦‚äº¤æ¢æœºç­‰ä¼šåŒæ­¥ï¼‰ã€‚ä¾‹å¦‚æˆ‘ä»¬æœ‰2ä¸ªMQï¼šmq1ï¼Œå’Œmq2ï¼Œå¦‚æœä½ çš„æ¶ˆæ¯åœ¨mq1ï¼Œè€Œä½ è¿æ¥åˆ°äº†mq2ï¼Œé‚£ä¹ˆmq2ä¼šå»mq1æ‹‰å–æ¶ˆæ¯ï¼Œç„¶åè¿”å›ç»™ä½ ã€‚å¦‚æœmq1å®•æœºï¼Œæ¶ˆæ¯å°±ä¼šä¸¢å¤±ã€‚
- é•œåƒæ¨¡å¼ï¼šä¸æ™®é€šæ¨¡å¼ä¸åŒï¼Œé˜Ÿåˆ—ä¼šåœ¨å„ä¸ªmqçš„é•œåƒèŠ‚ç‚¹ä¹‹é—´åŒæ­¥ï¼Œå› æ­¤ä½ è¿æ¥åˆ°ä»»ä½•ä¸€ä¸ªé•œåƒèŠ‚ç‚¹ï¼Œå‡å¯è·å–åˆ°æ¶ˆæ¯ã€‚è€Œä¸”å¦‚æœä¸€ä¸ªèŠ‚ç‚¹å®•æœºï¼Œå¹¶ä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ä¸è¿‡ï¼Œè¿™ç§æ–¹å¼å¢åŠ äº†æ•°æ®åŒæ­¥çš„å¸¦å®½æ¶ˆè€—ã€‚



æˆ‘ä»¬å…ˆæ¥çœ‹æ™®é€šæ¨¡å¼é›†ç¾¤ã€‚

##### è®¾ç½®ç½‘ç»œ

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è®©3å°MQäº’ç›¸çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ã€‚

åˆ†åˆ«åœ¨3å°æœºå™¨ä¸­ï¼Œè®¾ç½® /etc/hostsæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

```
192.168.150.101 mq1
192.168.150.102 mq2
192.168.150.103 mq3
```

å¹¶åœ¨æ¯å°æœºå™¨ä¸Šæµ‹è¯•ï¼Œæ˜¯å¦å¯ä»¥pingé€šå¯¹æ–¹ï¼š









#### å¸¸è§æ¶ˆæ¯æ¨¡å‹

![image-20230223174544477](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230223174544477.png)





##### åŸºæœ¬æ¶ˆæ¯é˜Ÿåˆ—

å®˜æ–¹çš„HelloWorldæ˜¯åŸºäºæœ€åŸºç¡€çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹æ¥å®ç°çš„ï¼ŒåªåŒ…æ‹¬ä¸‰ä¸ªè§’è‰²ï¼š

- publisherï¼šæ¶ˆæ¯å‘å¸ƒè€…ï¼Œå°†æ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—queue
- queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè´Ÿè´£æ¥å—å¹¶ç¼“å­˜æ¶ˆæ¯
- consumerï¼šè®¢é˜…é˜Ÿåˆ—ï¼Œå¤„ç†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯

![image-20230223174854086](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230223174854086.png)





publisherå®ç°

```java
package com.ganga.mq.helloworld;

import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
import org.junit.Test;

import java.io.IOException;
import java.util.concurrent.TimeoutException;

public class PublisherTest {
    @Test
    public void testSendMessage() throws IOException, TimeoutException {
        // 1.å»ºç«‹è¿æ¥
        ConnectionFactory factory = new ConnectionFactory();
        // 1.1.è®¾ç½®è¿æ¥å‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼šä¸»æœºåã€ç«¯å£å·ã€vhostã€ç”¨æˆ·åã€å¯†ç 
        factory.setHost("192.168.150.101");
        factory.setPort(5672);
        factory.setVirtualHost("/");
        factory.setUsername("user");
        factory.setPassword("pass");
        // 1.2.å»ºç«‹è¿æ¥
        Connection connection = factory.newConnection();

        // 2.åˆ›å»ºé€šé“Channel
        Channel channel = connection.createChannel();

        // 3.åˆ›å»ºé˜Ÿåˆ—
        String queueName = "simple.queue";
        channel.queueDeclare(queueName, false, false, false, null);

        // 4.å‘é€æ¶ˆæ¯
        String message = "hello, rabbitmq!";
        channel.basicPublish("", queueName, null, message.getBytes());
        System.out.println("å‘é€æ¶ˆæ¯æˆåŠŸï¼šã€" + message + "ã€‘");

        // 5.å…³é—­é€šé“å’Œè¿æ¥
        channel.close();
        connection.close();

    }
}
```

consumerå®ç°

```java
package com.ganga.mq.helloworld;

import com.rabbitmq.client.*;

import java.io.IOException;
import java.util.concurrent.TimeoutException;

public class ConsumerTest {

    public static void main(String[] args) throws IOException, TimeoutException {
        // 1.å»ºç«‹è¿æ¥
        ConnectionFactory factory = new ConnectionFactory();
        // 1.1.è®¾ç½®è¿æ¥å‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼šä¸»æœºåã€ç«¯å£å·ã€vhostã€ç”¨æˆ·åã€å¯†ç 
        factory.setHost("192.168.150.101");
        factory.setPort(5672);
        factory.setVirtualHost("/");
        factory.setUsername("user");
        factory.setPassword("pass");
        // 1.2.å»ºç«‹è¿æ¥
        Connection connection = factory.newConnection();

        // 2.åˆ›å»ºé€šé“Channel
        Channel channel = connection.createChannel();

        // 3.åˆ›å»ºé˜Ÿåˆ—
        String queueName = "simple.queue";
        channel.queueDeclare(queueName, false, false, false, null);

        // 4.è®¢é˜…æ¶ˆæ¯
        channel.basicConsume(queueName, true, new DefaultConsumer(channel){
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope,
                                       AMQP.BasicProperties properties, byte[] body) throws IOException {
                // 5.å¤„ç†æ¶ˆæ¯
                String message = new String(body);
                System.out.println("æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€" + message + "ã€‘");
            }
        });
        System.out.println("ç­‰å¾…æ¥æ”¶æ¶ˆæ¯ã€‚ã€‚ã€‚ã€‚");
    }
}
```





**åŸºæœ¬æ¶ˆæ¯é˜Ÿåˆ—**çš„æ¶ˆæ¯å‘é€æµç¨‹ï¼š

1. å»ºç«‹connection

2. åˆ›å»ºchannel

3. åˆ©ç”¨channelå£°æ˜é˜Ÿåˆ—

4. åˆ©ç”¨channelå‘é˜Ÿåˆ—å‘é€æ¶ˆæ¯



**åŸºæœ¬æ¶ˆæ¯é˜Ÿåˆ—**çš„æ¶ˆæ¯æ¥æ”¶æµç¨‹ï¼š

1. å»ºç«‹connection

2. åˆ›å»ºchannel

3. åˆ©ç”¨channelå£°æ˜é˜Ÿåˆ—

4. å®šä¹‰consumerçš„æ¶ˆè´¹è¡Œä¸ºhandleDelivery()

5. åˆ©ç”¨channelå°†æ¶ˆè´¹è€…ä¸é˜Ÿåˆ—ç»‘å®š





### SpringAMQP

SpringAMQPæ˜¯åŸºäºRabbitMQå°è£…çš„ä¸€å¥—æ¨¡æ¿ï¼Œå¹¶ä¸”è¿˜åˆ©ç”¨SpringBootå¯¹å…¶å®ç°äº†è‡ªåŠ¨è£…é…ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚

SpringAmqpçš„å®˜æ–¹åœ°å€ï¼šhttps://spring.io/projects/spring-amqp

![image-20230223175745584](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230223175745584.png)

![image-20230223175828733](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230223175828733.png)



SpringAMQPæä¾›äº†ä¸‰ä¸ªåŠŸèƒ½ï¼š

- è‡ªåŠ¨å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºåŠå…¶ç»‘å®šå…³ç³»
- åŸºäºæ³¨è§£çš„ç›‘å¬å™¨æ¨¡å¼ï¼Œå¼‚æ­¥æ¥æ”¶æ¶ˆæ¯
- å°è£…äº†RabbitTemplateå·¥å…·ï¼Œç”¨äºå‘é€æ¶ˆæ¯



#### ä¾èµ–åæ ‡

```xml
<!--AMQPä¾èµ–ï¼ŒåŒ…å«RabbitMQ-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

```yaml
spring:
  rabbitmq:
    host: 192.168.150.101 # ä¸»æœºå
    port: 5672 # ç«¯å£
    virtual-host: / # è™šæ‹Ÿä¸»æœº
    username: ganga # ç”¨æˆ·å
    password: 123321 # å¯†ç 
```





#### å¸¸è§æ¶ˆæ¯æ¨¡å‹



##### å¸¸è§æ¶ˆæ¯æ¨¡å‹åˆ†ç±»ï¼š



BasicQueueç®€å•æ¶ˆæ¯é˜Ÿåˆ—

WorkQueueå·¥ä½œæ¶ˆæ¯é˜Ÿåˆ—

FanoutExchangeå¹¿æ’­æ¶ˆæ¯é˜Ÿåˆ—

DirectExchangeè·¯ç”±æ¶ˆæ¯é˜Ÿåˆ—

TopicExchangeä¸»é¢˜æ¶ˆæ¯é˜Ÿåˆ—

---





å…¶ä¸­ï¼š

---

![image-20230223182837205](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230223182837205.png)

---









##### BasicQueueç®€å•é˜Ÿåˆ—



###### æ¶ˆæ¯å‘é€

é¦–å…ˆé…ç½®MQåœ°å€ï¼Œåœ¨publisheræœåŠ¡çš„application.ymlä¸­æ·»åŠ é…ç½®ï¼š

```yaml
spring:
  rabbitmq:
    host: 192.168.150.101 # ä¸»æœºå
    port: 5672 # ç«¯å£
    virtual-host: / # è™šæ‹Ÿä¸»æœº
    username: user # ç”¨æˆ·å
    password: passw # å¯†ç 
```



ç„¶ååœ¨publisheræœåŠ¡ä¸­ç¼–å†™æµ‹è¯•ç±»SpringAmqpTestï¼Œå¹¶åˆ©ç”¨RabbitTemplateå®ç°æ¶ˆæ¯å‘é€ï¼š

```java
package com.ganga.mq.spring;

import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

@RunWith(SpringRunner.class)
@SpringBootTest
public class SpringAmqpTest {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    @Test
    public void testSimpleQueue() {
        // é˜Ÿåˆ—åç§°
        String queueName = "simple.queue";
        // æ¶ˆæ¯
        String message = "hello, spring amqp!";
        // å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend(queueName, message);
    }
}
```





###### æ¶ˆæ¯æ¥æ”¶

é¦–å…ˆé…ç½®MQåœ°å€ï¼Œåœ¨consumeræœåŠ¡çš„application.ymlä¸­æ·»åŠ é…ç½®ï¼š

```yaml
spring:
  rabbitmq:
    host: 192.168.150.101 # ä¸»æœºå
    port: 5672 # ç«¯å£
    virtual-host: / # è™šæ‹Ÿä¸»æœº
    username: ganga # ç”¨æˆ·å
    password: 123321 # å¯†ç 
```



ç„¶ååœ¨consumeræœåŠ¡çš„`com.ganga.mq.listener`åŒ…ä¸­æ–°å»ºä¸€ä¸ªç±»SpringRabbitListenerï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
package com.ganga.mq.listener;

import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;

@Component
public class SpringRabbitListener {

    @RabbitListener(queues = "simple.queue")
    public void listenSimpleQueueMessage(String msg) throws InterruptedException {
        System.out.println("spring æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€" + msg + "ã€‘");
    }
}
```



###### æµ‹è¯•

å¯åŠ¨consumeræœåŠ¡ï¼Œç„¶ååœ¨publisheræœåŠ¡ä¸­è¿è¡Œæµ‹è¯•ä»£ç ï¼Œå‘é€MQæ¶ˆæ¯



---

---





##### WorkQueueå·¥ä½œé˜Ÿåˆ—



###### æ¦‚è¿°ï¼š

Work queuesï¼Œä¹Ÿè¢«ç§°ä¸ºï¼ˆTask queuesï¼‰ï¼Œä»»åŠ¡æ¨¡å‹ã€‚

ç®€å•æ¥è¯´å°±æ˜¯**è®©å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…±åŒæ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯**ã€‚

![image-20230223180724904](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230223180724904.png)

å½“æ¶ˆæ¯å¤„ç†æ¯”è¾ƒè€—æ—¶çš„æ—¶å€™ï¼Œå¯èƒ½ç”Ÿäº§æ¶ˆæ¯çš„é€Ÿåº¦ä¼šè¿œè¿œå¤§äºæ¶ˆæ¯çš„æ¶ˆè´¹é€Ÿåº¦ã€‚é•¿æ­¤ä»¥å¾€ï¼Œæ¶ˆæ¯å°±ä¼šå †ç§¯è¶Šæ¥è¶Šå¤šï¼Œæ— æ³•åŠæ—¶å¤„ç†ã€‚

æ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨work æ¨¡å‹ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å…±åŒå¤„ç†æ¶ˆæ¯å¤„ç†ï¼Œé€Ÿåº¦å°±èƒ½å¤§å¤§æé«˜äº†ã€‚





###### æ¶ˆæ¯å‘é€

æ¨¡æ‹Ÿå¤§é‡æ¶ˆæ¯å †ç§¯ç°è±¡ã€‚

åœ¨publisheræœåŠ¡ä¸­çš„SpringAmqpTestç±»ä¸­æ·»åŠ ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼š

```java
/**
     * workQueue
     * å‘é˜Ÿåˆ—ä¸­ä¸åœå‘é€æ¶ˆæ¯ï¼Œæ¨¡æ‹Ÿæ¶ˆæ¯å †ç§¯ã€‚
     */
@Test
public void testWorkQueue() throws InterruptedException {
    // é˜Ÿåˆ—åç§°
    String queueName = "simple.queue";
    // æ¶ˆæ¯
    String message = "hello, message_";
    for (int i = 0; i < 50; i++) {
        // å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend(queueName, message + i);
        Thread.sleep(20);
    }
}
```





###### æ¶ˆæ¯æ¥æ”¶

è¦æ¨¡æ‹Ÿå¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œæˆ‘ä»¬åœ¨consumeræœåŠ¡çš„SpringRabbitListenerä¸­æ·»åŠ 2ä¸ªæ–°çš„æ–¹æ³•ï¼š

```java
@Component
public class WorkMQListener {

    @RabbitListener(queues = "work.queue")
    public void listenWorkQueue01(String message) throws InterruptedException {
        System.out.println("æ¶ˆè´¹è€…[1]æ¥æ”¶åˆ°ï¼š" + message + "  " + LocalTime.now());
        Thread.sleep(20);
    }

    @RabbitListener(queues = "work.queue")
    public void listenWorkQueue02(String message) throws InterruptedException {
        System.err.println("æ¶ˆè´¹è€…[2]æ¥æ”¶åˆ°ï¼š" + message + "  " + LocalTime.now());
        Thread.sleep(200);
    }

}
```

æ³¨æ„åˆ°è¿™ä¸ªæ¶ˆè´¹è€…sleepäº†1000ç§’ï¼Œæ¨¡æ‹Ÿä»»åŠ¡è€—æ—¶ã€‚





###### æµ‹è¯•

å¯åŠ¨ConsumerApplicationåï¼Œåœ¨æ‰§è¡ŒpublisheræœåŠ¡ä¸­åˆšåˆšç¼–å†™çš„å‘é€æµ‹è¯•æ–¹æ³•testWorkQueueã€‚

å¯ä»¥çœ‹åˆ°æ¶ˆè´¹è€…1å¾ˆå¿«å®Œæˆäº†è‡ªå·±çš„25æ¡æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…2å´åœ¨ç¼“æ…¢çš„å¤„ç†è‡ªå·±çš„25æ¡æ¶ˆæ¯ã€‚



ä¹Ÿå°±æ˜¯è¯´æ¶ˆæ¯æ˜¯å¹³å‡åˆ†é…ç»™æ¯ä¸ªæ¶ˆè´¹è€…ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘åˆ°æ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›ã€‚è¿™æ ·æ˜¾ç„¶æ˜¯æœ‰é—®é¢˜çš„ã€‚





###### é¢„å–æœºåˆ¶

åœ¨springä¸­æœ‰ä¸€ä¸ªç®€å•çš„é…ç½®ï¼Œå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬ä¿®æ”¹consumeræœåŠ¡çš„application.ymlæ–‡ä»¶ï¼Œæ·»åŠ é…ç½®ï¼š

```yaml
spring:
  rabbitmq:
    listener:
      simple:
        prefetch: 1 # æ¯æ¬¡åªèƒ½è·å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆæ‰èƒ½è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯
```



###### æ€»ç»“

Workæ¨¡å‹çš„ä½¿ç”¨ï¼š

- å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼ŒåŒä¸€æ¡æ¶ˆæ¯åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†
- é€šè¿‡è®¾ç½®prefetchæ¥æ§åˆ¶æ¶ˆè´¹è€…é¢„å–çš„æ¶ˆæ¯æ•°é‡





---





##### å‘å¸ƒ/è®¢é˜… æ¨¡å¼

å‘å¸ƒè®¢é˜…çš„æ¨¡å‹å¦‚å›¾ï¼š

![image-20230223181118494](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230223181118494.png)



---

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è®¢é˜…æ¨¡å‹ä¸­ï¼Œå¤šäº†ä¸€ä¸ªexchangeè§’è‰²ï¼Œè€Œä¸”è¿‡ç¨‹ç•¥æœ‰å˜åŒ–ï¼š

- Publisherï¼šç”Ÿäº§è€…ï¼Œä¹Ÿå°±æ˜¯è¦å‘é€æ¶ˆæ¯çš„ç¨‹åºï¼Œä½†æ˜¯ä¸å†å‘é€åˆ°é˜Ÿåˆ—ä¸­ï¼Œè€Œæ˜¯å‘ç»™Xï¼ˆäº¤æ¢æœºï¼‰
- Exchangeï¼šäº¤æ¢æœºï¼Œå›¾ä¸­çš„Xã€‚ä¸€æ–¹é¢ï¼Œæ¥æ”¶ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ã€‚å¦ä¸€æ–¹é¢ï¼ŒçŸ¥é“å¦‚ä½•å¤„ç†æ¶ˆæ¯ï¼Œä¾‹å¦‚é€’äº¤ç»™æŸä¸ªç‰¹åˆ«é˜Ÿåˆ—ã€é€’äº¤ç»™æ‰€æœ‰é˜Ÿåˆ—ã€æˆ–æ˜¯å°†æ¶ˆæ¯ä¸¢å¼ƒã€‚åˆ°åº•å¦‚ä½•æ“ä½œï¼Œå–å†³äºExchangeçš„ç±»å‹ã€‚Exchangeæœ‰ä»¥ä¸‹3ç§ç±»å‹ï¼š
  - Fanoutï¼šå¹¿æ’­ï¼Œå°†æ¶ˆæ¯äº¤ç»™æ‰€æœ‰ç»‘å®šåˆ°äº¤æ¢æœºçš„é˜Ÿåˆ—
  - Directï¼šå®šå‘ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆæŒ‡å®šrouting key çš„é˜Ÿåˆ—
  - Topicï¼šé€šé…ç¬¦ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆrouting patternï¼ˆè·¯ç”±æ¨¡å¼ï¼‰ çš„é˜Ÿåˆ—
- Consumerï¼šæ¶ˆè´¹è€…ï¼Œä¸ä»¥å‰ä¸€æ ·ï¼Œè®¢é˜…é˜Ÿåˆ—ï¼Œæ²¡æœ‰å˜åŒ–
- Queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿä¸ä»¥å‰ä¸€æ ·ï¼Œæ¥æ”¶æ¶ˆæ¯ã€ç¼“å­˜æ¶ˆæ¯ã€‚



**Exchangeï¼ˆäº¤æ¢æœºï¼‰åªè´Ÿè´£è½¬å‘æ¶ˆæ¯ï¼Œä¸å…·å¤‡å­˜å‚¨æ¶ˆæ¯çš„èƒ½åŠ›**ï¼Œå› æ­¤å¦‚æœæ²¡æœ‰ä»»ä½•é˜Ÿåˆ—ä¸Exchangeç»‘å®šï¼Œæˆ–è€…æ²¡æœ‰ç¬¦åˆè·¯ç”±è§„åˆ™çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¼šä¸¢å¤±ï¼





---





##### FanoutExchangeå¹¿æ’­

Fanoutï¼Œè‹±æ–‡ç¿»è¯‘æ˜¯æ‰‡å‡ºï¼Œæˆ‘è§‰å¾—åœ¨MQä¸­å«å¹¿æ’­æ›´åˆé€‚ã€‚

![image-20230223181131594](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230223181131594.png)

---

![image-20230225155305223](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230225155305223.png)

---

åœ¨å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯å‘é€æµç¨‹æ˜¯è¿™æ ·çš„ï¼š

- 1ï¼‰  å¯ä»¥æœ‰å¤šä¸ªé˜Ÿåˆ—
- 2ï¼‰  æ¯ä¸ªé˜Ÿåˆ—éƒ½è¦ç»‘å®šåˆ°Exchangeï¼ˆäº¤æ¢æœºï¼‰
- 3ï¼‰  ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œåªèƒ½å‘é€åˆ°äº¤æ¢æœºï¼Œäº¤æ¢æœºæ¥å†³å®šè¦å‘ç»™å“ªä¸ªé˜Ÿåˆ—ï¼Œç”Ÿäº§è€…æ— æ³•å†³å®š
- 4ï¼‰  äº¤æ¢æœºæŠŠæ¶ˆæ¯å‘é€ç»™ç»‘å®šè¿‡çš„æ‰€æœ‰é˜Ÿåˆ—
- 5ï¼‰  è®¢é˜…é˜Ÿåˆ—çš„æ¶ˆè´¹è€…éƒ½èƒ½æ‹¿åˆ°æ¶ˆæ¯



###### æ¡ˆä¾‹è¦æ±‚

![image-20230225160341413](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230225160341413.png)



###### å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº

Springæä¾›äº†ä¸€ä¸ªæ¥å£Exchangeï¼Œæ¥è¡¨ç¤ºæ‰€æœ‰ä¸åŒç±»å‹çš„äº¤æ¢æœºï¼š

åœ¨consumerä¸­åˆ›å»ºä¸€ä¸ªç±»ï¼Œå£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº

```java
@Configuration
public class FanoutMQConfig {

    @Bean //å£°æ˜ FanoutExchange å¹¿æ’­äº¤æ¢æœº
    public FanoutExchange fanoutExchange(){
        return new FanoutExchange("fanoutName");
    }

    @Bean //å£°æ˜æ¶ˆæ¯é˜Ÿåˆ—
    public Queue newQueue01(){
        return new Queue("fanout.queue01");
    }

    @Bean //å°† æ¶ˆæ¯é˜Ÿåˆ— ä¸ å¹¿æ’­äº¤æ¢æœº è¿›è¡Œç»‘å®š
    public Binding fanoutBindingQueue01(){
        //ä½¿ç”¨ BindingBuilder æ„å»ºç»‘å®šå…³ç³»
        return BindingBuilder.bind(newQueue01()).to(fanoutExchange());
    }

    //==================================================================

    @Bean //å£°æ˜æ¶ˆæ¯é˜Ÿåˆ—
    public Queue newQueue02(){
        return new Queue("fanout.queue02");
    }

    @Bean //å°† æ¶ˆæ¯é˜Ÿåˆ— ä¸ å¹¿æ’­äº¤æ¢æœº è¿›è¡Œç»‘å®š
    public Binding fanoutBindingQueue02(){
        //ä½¿ç”¨ BindingBuilder æ„å»ºç»‘å®šå…³ç³»
        return BindingBuilder.bind(newQueue02()).to(fanoutExchange());
    }

}
```





###### æ¶ˆæ¯å‘é€

åœ¨publisheræœåŠ¡çš„SpringAmqpTestç±»ä¸­æ·»åŠ æµ‹è¯•æ–¹æ³•ï¼š

```java
@RunWith(SpringRunner.class)
@SpringBootTest(classes = PublisherApp.class)
public class FanoutExchange {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    @Test
    public void testFanoutExchangeQueue(){
        String exchangeName = "fanoutName";
        String key = "";
        String message = "æ¶ˆæ¯xxx";
        //åœ¨å¯¹äº¤æ¢æœºå‘é€æ¶ˆæ¯æ—¶ äº¤æ¢æœºè¦æå‰å£°æ˜ï¼ï¼ï¼
        //å‚æ•°ç¬¬ä¸€ä¸ªæ˜¯ äº¤æ¢æœºåç§° è€Œä¸æ˜¯ æ¶ˆæ¯é˜Ÿåˆ—åç§°ï¼ï¼ï¼
        //å› ä¸ºå‘é€åˆ°äº¤æ¢æœºä¸­ ç”±äº¤æ¢æœº è¿›è¡Œå‘é€åˆ°é˜Ÿåˆ— è®¢é˜…è€…ç»‘å®šçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿›è¡Œè·å–æ¶ˆæ¯
        rabbitTemplate.convertAndSend(exchangeName,key,message);
    }

}
```





###### æ¶ˆæ¯æ¥æ”¶

åœ¨consumeræœåŠ¡çš„SpringRabbitListenerä¸­æ·»åŠ ä¸¤ä¸ªæ–¹æ³•ï¼Œä½œä¸ºæ¶ˆè´¹è€…ï¼š

```java
package com.ganga.listener.exchange;

import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;

@Component
public class FanoutMQListener {

    @RabbitListener(queues = "fanout.queue01")
    public void listenFanoutQueue01(String msg){
        System.out.println("queue [01] é˜Ÿåˆ—è·å–æ¶ˆæ¯: " + msg);
    }

    @RabbitListener(queues = "fanout.queue02")
    public void listenFanoutQueue02(String msg){
        System.out.println("queue [02] é˜Ÿåˆ—è·å–æ¶ˆæ¯: " + msg);
    }
}
```





###### æ³¨æ„äº‹é¡¹



äº¤æ¢æœºçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

- æ¥æ”¶publisherå‘é€çš„æ¶ˆæ¯
- å°†æ¶ˆæ¯æŒ‰ç…§è§„åˆ™è·¯ç”±åˆ°ä¸ä¹‹ç»‘å®šçš„é˜Ÿåˆ—
- ä¸èƒ½ç¼“å­˜æ¶ˆæ¯ï¼Œè·¯ç”±å¤±è´¥ï¼Œæ¶ˆæ¯ä¸¢å¤±
- FanoutExchangeçš„ä¼šå°†æ¶ˆæ¯è·¯ç”±åˆ°æ¯ä¸ªç»‘å®šçš„é˜Ÿåˆ—

å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºã€ç»‘å®šå…³ç³»çš„Beanæ˜¯ä»€ä¹ˆï¼Ÿ

- Queue
- FanoutExchange
- Binding

```java
@Test
public void testFanoutExchangeQueue(){
    String exchangeName = "fanoutName";
    String key = "";
    String message = "æ¶ˆæ¯xxx";
    //åœ¨å¯¹äº¤æ¢æœºå‘é€æ¶ˆæ¯æ—¶ äº¤æ¢æœºè¦æå‰å£°æ˜ï¼ï¼ï¼
    //å‚æ•°ç¬¬ä¸€ä¸ªæ˜¯ äº¤æ¢æœºåç§° è€Œä¸æ˜¯ æ¶ˆæ¯é˜Ÿåˆ—åç§°ï¼ï¼ï¼
    //å› ä¸ºå‘é€åˆ°äº¤æ¢æœºä¸­ ç”±äº¤æ¢æœº è¿›è¡Œå‘é€åˆ°é˜Ÿåˆ— è®¢é˜…è€…ç»‘å®šçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿›è¡Œè·å–æ¶ˆæ¯
    rabbitTemplate.convertAndSend(exchangeName,key,message);
}
```







---







##### DirectExchangeè·¯ç”±

åœ¨Fanoutæ¨¡å¼ä¸­ï¼Œä¸€æ¡æ¶ˆæ¯ï¼Œä¼šè¢«æ‰€æœ‰è®¢é˜…çš„é˜Ÿåˆ—éƒ½æ¶ˆè´¹ã€‚ä½†æ˜¯ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸åŒçš„æ¶ˆæ¯è¢«ä¸åŒçš„é˜Ÿåˆ—æ¶ˆè´¹ã€‚è¿™æ—¶å°±è¦ç”¨åˆ°Directç±»å‹çš„Exchangeã€‚



åœ¨Directæ¨¡å‹ä¸‹ï¼š

![image-20230225155403877](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230225155403877.png)

- é˜Ÿåˆ—ä¸äº¤æ¢æœºçš„ç»‘å®šï¼Œä¸èƒ½æ˜¯ä»»æ„ç»‘å®šäº†ï¼Œè€Œæ˜¯è¦æŒ‡å®šä¸€ä¸ª`RoutingKey`ï¼ˆè·¯ç”±keyï¼‰
- æ¶ˆæ¯çš„å‘é€æ–¹åœ¨ å‘ Exchangeå‘é€æ¶ˆæ¯æ—¶ï¼Œä¹Ÿå¿…é¡»æŒ‡å®šæ¶ˆæ¯çš„ `RoutingKey`ã€‚
- Exchangeä¸å†æŠŠæ¶ˆæ¯äº¤ç»™æ¯ä¸€ä¸ªç»‘å®šçš„é˜Ÿåˆ—ï¼Œè€Œæ˜¯æ ¹æ®æ¶ˆæ¯çš„`Routing Key`è¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰é˜Ÿåˆ—çš„`Routingkey`ä¸æ¶ˆæ¯çš„ `Routing key`å®Œå…¨ä¸€è‡´ï¼Œæ‰ä¼šæ¥æ”¶åˆ°æ¶ˆæ¯





###### æ¡ˆä¾‹è¦æ±‚

![image-20230225160300127](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230225160300127.png)





###### åŸºäºæ³¨è§£å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº



åŸºäº@Beançš„æ–¹å¼å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœºæ¯”è¾ƒéº»çƒ¦ï¼ŒSpringè¿˜æä¾›äº†åŸºäºæ³¨è§£æ–¹å¼æ¥å£°æ˜ã€‚

åœ¨consumerçš„SpringRabbitListenerä¸­æ·»åŠ ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼ŒåŒæ—¶åŸºäºæ³¨è§£æ¥å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœºï¼š

```java
@Component
public class DirectMQListener {

    // åŸºäºæ³¨è§£å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº
    @RabbitListener(bindings = @QueueBinding(
            value = @Queue(name = "direct.queue01"),
            exchange = @Exchange(name = "directName",type = ExchangeTypes.DIRECT),
            key = {"jk"}
    ))
    public void listenDirectExchangeQueue01(String msg) {
        System.out.println("å–œæ¬¢ [jk] çš„ç‹—æ¥æ”¶åˆ°æ¶ˆæ¯: " + msg);
    }

    // åŸºäºæ³¨è§£å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº
    @RabbitListener(bindings = @QueueBinding(
            value = @Queue(name = "direct.queue02"),
            exchange = @Exchange(name = "directName",type = ExchangeTypes.DIRECT),
            key = {"loli"} //è¦ç›‘å¬å»ºä¸º jk å’Œ loli çš„æ¶ˆæ¯
    ))
    public void listenDirectExchangeQueue02(String msg) {
        System.out.println("å–œæ¬¢ [loli] çš„ç‹—æ¥æ”¶åˆ°æ¶ˆæ¯: " + msg);
    }

    // åŸºäºæ³¨è§£å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº
    @RabbitListener(bindings = @QueueBinding(
            value = @Queue(name = "direct.queue03"),
            exchange = @Exchange(name = "directName",type = ExchangeTypes.DIRECT),
            key = {"jk","loli"} //è¦ç›‘å¬å»ºä¸º jk å’Œ loli çš„æ¶ˆæ¯
    ))
    public void listenDirectExchangeQueue03(String msg) {
        System.err.println("æ—¢å–œæ¬¢ [jk] åˆå–œæ¬¢ [loli] çš„ç•œç‰²æ¥æ”¶åˆ°æ¶ˆæ¯: " + msg);
    }
}
```



###### æ¶ˆæ¯å‘é€

åœ¨publisheræœåŠ¡çš„SpringAmqpTestç±»ä¸­æ·»åŠ æµ‹è¯•æ–¹æ³•ï¼š

```java
@RunWith(SpringRunner.class)
@SpringBootTest(classes = PublisherApp.class)
public class DirectExchange {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    @Test
    public void testDirectExchangeQueue01(){
        //å‘ äº¤æ¢æœº ä¸Šå‘é€æ¶ˆæ¯
        String exchangeName = "directName";
        String key = "jk";
        rabbitTemplate.convertAndSend(exchangeName,key,"jk: æ”¾å­¦åè¦åšäº›ä»€ä¹ˆå‘¢ï¼Ÿâ™¥~");
    }

    @Test
    public void testDirectExchangeQueue02(){
        //å‘ äº¤æ¢æœº ä¸Šå‘é€æ¶ˆæ¯
        String exchangeName = "directName";
        String key = "loli";
        rabbitTemplate.convertAndSend(exchangeName,key,"loli: æ¬§å°¼é…±é™ªæˆ‘ç©ï¼â™¥~");
    }
}
```





###### æ€»ç»“

æè¿°ä¸‹Directäº¤æ¢æœºä¸Fanoutäº¤æ¢æœºçš„å·®å¼‚ï¼Ÿ

- Fanoutäº¤æ¢æœºå°†æ¶ˆæ¯è·¯ç”±ç»™æ¯ä¸€ä¸ªä¸ä¹‹ç»‘å®šçš„é˜Ÿåˆ—
- Directäº¤æ¢æœºæ ¹æ®RoutingKeyåˆ¤æ–­è·¯ç”±ç»™å“ªä¸ªé˜Ÿåˆ—
- å¦‚æœå¤šä¸ªé˜Ÿåˆ—å…·æœ‰ç›¸åŒçš„RoutingKeyï¼Œåˆ™ä¸FanoutåŠŸèƒ½ç±»ä¼¼

åŸºäº@RabbitListeneræ³¨è§£å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœºæœ‰å“ªäº›å¸¸è§æ³¨è§£ï¼Ÿ

- @Queue
- @Exchange



```java
@RabbitListener(bindings = @QueueBinding(
            value = @Queue(name = "direct.queue01"),
            exchange = @Exchange(name = "directName",type = ExchangeTypes.DIRECT),
            key = {"key1"}
))
public void listenQueue(String msg) {}
```





---

---







##### TopicExchangeä¸»é¢˜



###### è¯´æ˜

`Topic`ç±»å‹çš„`Exchange`ä¸`Direct`ç›¸æ¯”ï¼Œéƒ½æ˜¯å¯ä»¥æ ¹æ®`RoutingKey`æŠŠæ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„é˜Ÿåˆ—ã€‚åªä¸è¿‡`Topic`ç±»å‹`Exchange`å¯ä»¥è®©é˜Ÿåˆ—åœ¨ç»‘å®š`Routing key` çš„æ—¶å€™ä½¿ç”¨é€šé…ç¬¦ï¼



`Routingkey` ä¸€èˆ¬éƒ½æ˜¯æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå•è¯ç»„æˆï¼Œå¤šä¸ªå•è¯ä¹‹é—´ä»¥â€.â€åˆ†å‰²

é€šé…ç¬¦è§„åˆ™ï¼š

`#`ï¼šåŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯

`*`ï¼šåŒ¹é…ä¸å¤šä¸å°‘æ°å¥½1ä¸ªè¯![image-20230225155831898](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230225155831898.png)



ä¸¾ä¾‹ï¼š

`ganga.#`ï¼šèƒ½å¤ŸåŒ¹é…`ganga.spu.xyz` æˆ–è€… `ganga.spu`

`ai.*`ï¼šåªèƒ½åŒ¹é…`ai.spu`

â€‹

å›¾ç¤ºï¼š

![image-20230225160109645](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230225160109645.png)

è§£é‡Šï¼š

- Queue1ï¼šç»‘å®šçš„æ˜¯`china.#` ï¼Œå› æ­¤å‡¡æ˜¯ä»¥ `china.`å¼€å¤´çš„`routing key` éƒ½ä¼šè¢«åŒ¹é…åˆ°ã€‚åŒ…æ‹¬china.newså’Œchina.weather
- Queue2ï¼šç»‘å®šçš„æ˜¯`#.news` ï¼Œå› æ­¤å‡¡æ˜¯ä»¥ `.news`ç»“å°¾çš„ `routing key` éƒ½ä¼šè¢«åŒ¹é…ã€‚åŒ…æ‹¬china.newså’Œjapan.news



---

###### æ¡ˆä¾‹è¦æ±‚

![image-20230225160205116](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230225160205116.png)



###### æ¶ˆæ¯å‘é€

åœ¨publisheræœåŠ¡çš„SpringAmqpTestç±»ä¸­æ·»åŠ æµ‹è¯•æ–¹æ³•ï¼š

```java
package com.ganga.mq.spring.PubSub;

@RunWith(SpringRunner.class)
@SpringBootTest(classes = PublisherApp.class)
public class TopicExchange {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    // queue01  -->  #.loli
    // queue02  -->  *.yvjie
    // queue03  -->  jk.#
    // queue04  -->  cos.*
    // queue05  -->  loli.#

    @Test
    public void sendTopicExchangeQueue01() {
        String exchangeName = "topicName";
        String key = "jk.loli";
        rabbitTemplate.convertAndSend(exchangeName, key, "ä¸€ä¸ªç©¿ç€ [jk] çš„ å°[loli] ...");
    }
    // Queue[03]  keyä¸º: [ "jk.#" ] æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ï¼šä¸€ä¸ªç©¿ç€ [jk] çš„ å°[loli] ...
    // Queue[01]  keyä¸º: [ "#.loli" ] æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ï¼šä¸€ä¸ªç©¿ç€ [jk] çš„ å°[loli] ...

    @Test
    public void sendTopicExchangeQueue02() {
        String exchangeName = "topicName";
        String key = "jk.yvjie";
        rabbitTemplate.convertAndSend(exchangeName, key, "ä¸€ä¸ªç©¿ç€ [jk] çš„ [yvjie] ...");
    }
    // Queue[03]  keyä¸º: [ "jk.#" ] æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ï¼šä¸€ä¸ªç©¿ç€ [jk] çš„ [yvjie] ...
    // Queue[04]  keyä¸º: [ "cos.*" ] æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ï¼šä¸€ä¸ªç©¿ç€ [jk] çš„ [yvjie] ...
    // Queue[02]  keyä¸º: [ "*.yvjie" ] æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ï¼šä¸€ä¸ªç©¿ç€ [jk] çš„ [yvjie] ...


    @Test
    public void sendTopicExchangeQueue03() {
        String exchangeName = "topicName";
        String key = "cos.loli";
        rabbitTemplate.convertAndSend(exchangeName, key, "ä¸€ä¸ªç©¿ç€ [cos] çš„ [loli] ...");
    }
    // Queue[03]  keyä¸º: [ "jk.#" ] æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ï¼šä¸€ä¸ªç©¿ç€ [cos] çš„ [loli] ...
    // Queue[04]  keyä¸º: [ "cos.*" ] æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ï¼šä¸€ä¸ªç©¿ç€ [cos] çš„ [loli] ...
    // Queue[01]  keyä¸º: [ "#.loli" ] æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ï¼šä¸€ä¸ªç©¿ç€ [cos] çš„ [loli] ...

    @Test
    public void sendTopicExchangeQueue04() {
        String exchangeName = "topicName";
        String key = "cos.yvjie";
        rabbitTemplate.convertAndSend(exchangeName, key, "ä¸€ä¸ªç©¿ç€ [cos] çš„ [yvjie] ...");
    }
    // Queue[04]  keyä¸º: [ "cos.*" ] æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ï¼šä¸€ä¸ªç©¿ç€ [cos] çš„ [yvjie] ...
    // Queue[03]  keyä¸º: [ "jk.#" ] æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ï¼šä¸€ä¸ªç©¿ç€ [cos] çš„ [yvjie] ...
    // Queue[02]  keyä¸º: [ "*.yvjie" ] æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ï¼šä¸€ä¸ªç©¿ç€ [cos] çš„ [yvjie] ..
}
```



###### æ¶ˆæ¯æ¥æ”¶

åœ¨consumeræœåŠ¡çš„SpringRabbitListenerä¸­æ·»åŠ æ–¹æ³•ï¼š

```java
package com.ganga.listener.exchange;

import org.springframework.amqp.core.ExchangeTypes;
import org.springframework.amqp.rabbit.annotation.Exchange;
import org.springframework.amqp.rabbit.annotation.Queue;
import org.springframework.amqp.rabbit.annotation.QueueBinding;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;

// #.loli
// *.yvjie
// jk.#
// cos.*
// loli.#
@Component
public class TopicMQListener {

    // #.loli
    @RabbitListener(bindings = @QueueBinding(
            value = @Queue(name = "topic.queue01"),
            exchange = @Exchange(name = "topicName", type = ExchangeTypes.TOPIC),
            key = {"#.loli"}
    ))
    public void listenTopicExchangeQueue01(String msg) {
        System.out.println("Queue[01]  keyä¸º: [ \"#.loli\" ] æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ï¼š" + msg);
    }

    // *.yvjie
    @RabbitListener(bindings = @QueueBinding(
            value = @Queue(name = "topic.queue02"),
            exchange = @Exchange(name = "topicName", type = ExchangeTypes.TOPIC),
            key = {"*.yvjie"}
    ))
    public void listenTopicExchangeQueue02(String msg) {
        System.out.println("Queue[02]  keyä¸º: [ \"*.yvjie\" ] æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ï¼š" + msg);
    }

    // jk.#
    @RabbitListener(bindings = @QueueBinding(
            value = @Queue(name = "topic.queue03"),
            exchange = @Exchange(name = "topicName", type = ExchangeTypes.TOPIC),
            key = {"jk.#"}
    ))
    public void listenTopicExchangeQueue03(String msg) {
        System.out.println("Queue[03]  keyä¸º: [ \"jk.#\" ] æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ï¼š" + msg);
    }

    // cos.*
    @RabbitListener(bindings = @QueueBinding(
            value = @Queue(name = "topic.queue04"),
            exchange = @Exchange(name = "topicName", type = ExchangeTypes.TOPIC),
            key = {"cos.*"}
    ))
    public void listenTopicExchangeQueue04(String msg) {
        System.out.println("Queue[04]  keyä¸º: [ \"cos.*\" ] æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ï¼š" + msg);
    }

    // loli.#
    @RabbitListener(bindings = @QueueBinding(
            value = @Queue(name = "topic.queue05"),
            exchange = @Exchange(name = "topicName", type = ExchangeTypes.TOPIC),
            key = {"loli.#"}
    ))
    public void listenTopicExchangeQueue05(String msg) {
        System.out.println("Queue[05]  keyä¸º: [ \"loli.#\" ] æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ï¼š" + msg);
    }
}
```





###### æ€»ç»“

æè¿°ä¸‹Directäº¤æ¢æœºä¸Topicäº¤æ¢æœºçš„å·®å¼‚ï¼Ÿ

- Topicäº¤æ¢æœºæ¥æ”¶çš„æ¶ˆæ¯RoutingKeyå¿…é¡»æ˜¯å¤šä¸ªå•è¯ï¼Œä»¥ `**.**` åˆ†å‰²
- Topicäº¤æ¢æœºä¸é˜Ÿåˆ—ç»‘å®šæ—¶çš„bindingKeyå¯ä»¥æŒ‡å®šé€šé…ç¬¦
- `#`ï¼šä»£è¡¨0ä¸ªæˆ–å¤šä¸ªè¯
- `*`ï¼šä»£è¡¨1ä¸ªè¯





##### æ¶ˆæ¯è½¬æ¢å™¨

ä¹‹å‰è¯´è¿‡ï¼ŒSpringä¼šæŠŠä½ å‘é€çš„æ¶ˆæ¯åºåˆ—åŒ–ä¸ºå­—èŠ‚å‘é€ç»™MQï¼Œæ¥æ”¶æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¿˜ä¼šæŠŠå­—èŠ‚ååºåˆ—åŒ–ä¸ºJavaå¯¹è±¡ã€‚

![image-20230225172433202](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230225172433202.png)

åªä¸è¿‡ï¼Œé»˜è®¤æƒ…å†µä¸‹Springé‡‡ç”¨çš„åºåˆ—åŒ–æ–¹å¼æ˜¯JDKåºåˆ—åŒ–ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒJDKåºåˆ—åŒ–å­˜åœ¨ä¸‹åˆ—é—®é¢˜ï¼š

- æ•°æ®ä½“ç§¯è¿‡å¤§
- æœ‰å®‰å…¨æ¼æ´
- å¯è¯»æ€§å·®

æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ã€‚







###### æµ‹è¯•é»˜è®¤è½¬æ¢å™¨



æˆ‘ä»¬ä¿®æ”¹æ¶ˆæ¯å‘é€çš„ä»£ç ï¼Œå‘é€ä¸€ä¸ªMapå¯¹è±¡ï¼š

```java
@Test
public void testSendMap() throws InterruptedException {
    // å‡†å¤‡æ¶ˆæ¯
    Map<String,Object> msg = new HashMap<>();
    msg.put("name", "Jack");
    msg.put("age", 21);
    // å‘é€æ¶ˆæ¯
    rabbitTemplate.convertAndSend("simple.queue","", msg);
}
```



åœæ­¢consumeræœåŠ¡



å‘é€æ¶ˆæ¯åæŸ¥çœ‹æ§åˆ¶å°ï¼š

![image-20230225172433202](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230225172433202.png)







###### é…ç½®JSONè½¬æ¢å™¨

æ˜¾ç„¶ï¼ŒJDKåºåˆ—åŒ–æ–¹å¼å¹¶ä¸åˆé€‚ã€‚æˆ‘ä»¬å¸Œæœ›æ¶ˆæ¯ä½“çš„ä½“ç§¯æ›´å°ã€å¯è¯»æ€§æ›´é«˜ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨JSONæ–¹å¼æ¥åšåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚

åœ¨publisherå’Œconsumerä¸¤ä¸ªæœåŠ¡ä¸­éƒ½å¼•å…¥ä¾èµ–ï¼š

```xml
<dependency>
	<groupId>com.fasterxml.jackson.core</groupId>
	<artifactId>jackson-databind</artifactId>
</dependency>

<!--æˆ–è€…-->

<dependency>
    <groupId>com.fasterxml.jackson.dataformat</groupId>
    <artifactId>jackson-dataformat-xml</artifactId>
    <version>2.9.10</version>
</dependency>
```

é…ç½®æ¶ˆæ¯è½¬æ¢å™¨ã€‚

åœ¨å¯åŠ¨ç±»ä¸­æ·»åŠ ä¸€ä¸ªBeanå³å¯ï¼š

```java
@Bean
public MessageConverter jsonMessageConverter(){
    return new Jackson2JsonMessageConverter();
}
```

![image-20230225173018857](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230225173018857.png)

![image-20230225173441313](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230225173441313.png)





---

---







## ğŸ§¬é«˜çº§æœç´¢ES







### ç®€å•ä»‹ç»



#### ä»€ä¹ˆæ˜¯elasticsearch

![image-20230226213611635](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230226213611635.png)

---

![image-20230226213652461](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230226213652461.png)

---

![image-20230226213724571](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230226213724571.png)



**elasticsearchçš„å‘å±• **

Luceneæ˜¯ä¸€ä¸ªJavaè¯­è¨€çš„æœç´¢å¼•æ“ç±»åº“ï¼Œæ˜¯Apacheå…¬å¸çš„é¡¶çº§é¡¹ç›®ï¼Œç”±DougCuttingäº1999å¹´ç ”å‘ ã€‚

å®˜ç½‘åœ°å€ï¼šhttps://lucene.apache.org/

Luceneçš„ä¼˜åŠ¿ï¼š

- æ˜“æ‰©å±•
- é«˜æ€§èƒ½ï¼ˆåŸºäºå€’æ’ç´¢å¼•ï¼‰

Luceneçš„ç¼ºç‚¹ï¼š

- åªé™äºJavaè¯­è¨€å¼€å‘
- å­¦ä¹ æ›²çº¿é™¡å³­
- ä¸æ”¯æŒæ°´å¹³æ‰©å±•

2004å¹´Shay BanonåŸºäºLuceneå¼€å‘äº†Compass

2010å¹´Shay Banon é‡å†™äº†Compassï¼Œå–åä¸ºElasticsearchã€‚

å®˜ç½‘åœ°å€: https://www.elastic.co/cn/

ç›®å‰æœ€æ–°çš„ç‰ˆæœ¬æ˜¯ï¼š7.12.1 ç›¸æ¯”ä¸luceneï¼Œelasticsearchå…·å¤‡ä¸‹åˆ—ä¼˜åŠ¿ï¼š

- æ”¯æŒåˆ†å¸ƒå¼ï¼Œå¯æ°´å¹³æ‰©å±•
- æä¾›Restfulæ¥å£ï¼Œå¯è¢«ä»»ä½•è¯­è¨€è°ƒç”¨



---





#### å€’æ’ç´¢å¼•





ä¼ ç»Ÿæ•°æ®åº“ï¼ˆå¦‚MySQLï¼‰é‡‡ç”¨æ­£å‘ç´¢å¼•ï¼Œä¾‹å¦‚ç»™ä¸‹è¡¨ï¼ˆtb_goodsï¼‰ä¸­çš„idåˆ›å»ºç´¢å¼•ï¼š

![image-20230226214309182](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230226214309182.png)





---



elasticsearché‡‡ç”¨å€’æ’ç´¢å¼•ï¼š

- æ–‡æ¡£ï¼ˆdocumentï¼‰ï¼šæ¯æ¡æ•°æ®å°±æ˜¯ä¸€ä¸ªæ–‡æ¡£
- è¯æ¡ï¼ˆtermï¼‰ï¼šæ–‡æ¡£æŒ‰ç…§è¯­ä¹‰åˆ†æˆçš„è¯è¯­

![image-20230226214844496](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230226214844496.png)





---



#### ESä¸MySQL



Elasticsearchä¸mysqlçš„æ¦‚å¿µå¯¹æ¯”ï¼š

![image-20230226214549511](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230226214549511.png)

![image-20230226214913497](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230226214913497.png)





#### æ¶æ„



Mysqlï¼šæ“…é•¿äº‹åŠ¡ç±»å‹æ“ä½œï¼Œå¯ä»¥ç¡®ä¿æ•°æ®çš„å®‰å…¨å’Œä¸€è‡´æ€§

Elasticsearchï¼šæ“…é•¿æµ·é‡æ•°æ®çš„æœç´¢ã€åˆ†æã€è®¡ç®—

![image-20230226215207273](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230226215207273.png)

---

---



### å®‰è£…éƒ¨ç½²



#### å•æœºéƒ¨ç½²



**åˆ›å»ºç½‘ç»œ**

å› ä¸ºæˆ‘ä»¬è¿˜éœ€è¦éƒ¨ç½²kibanaå®¹å™¨ï¼Œå› æ­¤éœ€è¦è®©eså’Œkibanaå®¹å™¨äº’è”ã€‚è¿™é‡Œå…ˆåˆ›å»ºä¸€ä¸ªç½‘ç»œï¼š

```sh
docker network create es-net
```



**åŠ è½½é•œåƒ**

```sh
docker pull elasticsearch:7.12.1
```



**åˆ›å»ºå®¹å™¨å¹¶è¿è¡Œ**

è¿è¡Œdockerå‘½ä»¤ï¼Œéƒ¨ç½²å•ç‚¹esï¼š

```sh
docker run -d \
	--name es7 \
    -e "ES_JAVA_OPTS=-Xms512m -Xmx512m" \
    -e "discovery.type=single-node" \
    -v es-data:/usr/share/elasticsearch/data \
    -v es-plugins:/usr/share/elasticsearch/plugins \
    --privileged \
    --network es-net \
    -p 9200:9200 \
    -p 9300:9300 \
elasticsearch:7.12.1
```

å‘½ä»¤è§£é‡Šï¼š

- `-e "cluster.name=es-docker-cluster"`ï¼šè®¾ç½®é›†ç¾¤åç§°
- `-e "http.host=0.0.0.0"`ï¼šç›‘å¬çš„åœ°å€ï¼Œå¯ä»¥å¤–ç½‘è®¿é—®
- `-e "ES_JAVA_OPTS=-Xms512m -Xmx512m"`ï¼šå†…å­˜å¤§å°
- `-e "discovery.type=single-node"`ï¼šéé›†ç¾¤æ¨¡å¼
- `-v es-data:/usr/share/elasticsearch/data`ï¼šæŒ‚è½½é€»è¾‘å·ï¼Œç»‘å®šesçš„æ•°æ®ç›®å½•
- `-v es-logs:/usr/share/elasticsearch/logs`ï¼šæŒ‚è½½é€»è¾‘å·ï¼Œç»‘å®šesçš„æ—¥å¿—ç›®å½•
- `-v es-plugins:/usr/share/elasticsearch/plugins`ï¼šæŒ‚è½½é€»è¾‘å·ï¼Œç»‘å®šesçš„æ’ä»¶ç›®å½•
- `--privileged`ï¼šæˆäºˆé€»è¾‘å·è®¿é—®æƒ
- `--network es-net` ï¼šåŠ å…¥ä¸€ä¸ªåä¸ºes-netçš„ç½‘ç»œä¸­
- `-p 9200:9200`ï¼šç«¯å£æ˜ å°„é…ç½®



è®¾ç½®å¯†ç ï¼š

```yml
# å…ˆè¿›å…¥å®¹å™¨ï¼Œç¼–å†™ config/elasticsearch.yml
# docker exec -it elasticsearch bash


# æ­¤å¤„å¼€å¯xpack
http.cors.enabled: true
http.cors.allow-origin: "*"
http.cors.allow-headers: Authorization
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true


# æ¨å‡ºå®¹å™¨ é‡å¯å®¹å™¨ è¿›å…¥å®¹å™¨ è¿è¡Œå‘½ä»¤åè®¾ç½®å¯†ç 
# exit
# docker restart es
# docker exec -it elasticsearch bash
# elasticsearch-setup-passwords interactive
```

[è®¾å¯†ç å‚è€ƒ](https://blog.csdn.net/IT_road_qxc/article/details/121858843)



åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ï¼šhttp://ip:9200 å³å¯çœ‹åˆ°elasticsearchçš„å“åº”ç»“æœã€‚





---





#### éƒ¨ç½²kibana

kibanaå¯ä»¥ç»™æˆ‘ä»¬æä¾›ä¸€ä¸ªelasticsearchçš„å¯è§†åŒ–ç•Œé¢ï¼Œä¾¿äºæˆ‘ä»¬å­¦ä¹ ã€‚



**éƒ¨ç½²**

è¿è¡Œdockerå‘½ä»¤ï¼Œéƒ¨ç½²kibana

```sh
docker run -d \
--name kibana \
-e ELASTICSEARCH_HOSTS=http://es7:9200 \
--network=es-net \
-p 5601:5601  \
kibana:7.12.1
```

- `--network es-net` ï¼šåŠ å…¥ä¸€ä¸ªåä¸ºes-netçš„ç½‘ç»œä¸­ï¼Œä¸elasticsearchåœ¨åŒä¸€ä¸ªç½‘ç»œä¸­
- `-e ELASTICSEARCH_HOSTS=http://es:9200"`ï¼šè®¾ç½®elasticsearchçš„åœ°å€ï¼Œå› ä¸ºkibanaå·²ç»ä¸elasticsearchåœ¨ä¸€ä¸ªç½‘ç»œï¼Œå› æ­¤å¯ä»¥ç”¨å®¹å™¨åç›´æ¥è®¿é—®elasticsearch
- `-p 5601:5601`ï¼šç«¯å£æ˜ å°„é…ç½®



è®¾ç½®å¯†ç ï¼š

```yaml
#
# ** THIS IS AN AUTO-GENERATED FILE **
#

# Default Kibana configuration for docker target
server.host: "0"
server.shutdownTimeout: "5s"
elasticsearch.hosts: [ "http://172.0.0.1:9200" ]
monitoring.ui.container.elasticsearch.enabled: true
i18n.locale: "zh-CN"
# æ­¤å¤„è®¾ç½®elasticçš„ç”¨æˆ·åå’Œå¯†ç 
elasticsearch.username: elastic
elasticsearch.password: elastic
```





kibanaå¯åŠ¨ä¸€èˆ¬æ¯”è¾ƒæ…¢ï¼Œéœ€è¦å¤šç­‰å¾…ä¸€ä¼šï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤ï¼š

```sh
docker logs -f kibana
```

æŸ¥çœ‹è¿è¡Œæ—¥å¿—ï¼Œå½“æŸ¥çœ‹åˆ°ä¸‹é¢çš„æ—¥å¿—ï¼Œè¯´æ˜æˆåŠŸï¼š

![image-20210109105135812](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210109105135812.png)

æ­¤æ—¶ï¼Œåœ¨æµè§ˆå™¨è¾“å…¥åœ°å€è®¿é—®ï¼šhttp://192.168.150.101:5601ï¼Œå³å¯çœ‹åˆ°ç»“æœ







**DevTools**

kibanaä¸­æä¾›äº†ä¸€ä¸ªDevToolsç•Œé¢ï¼š

![image-20210506102630393](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210506102630393.png)

è¿™ä¸ªç•Œé¢ä¸­å¯ä»¥ç¼–å†™DSLæ¥æ“ä½œelasticsearchã€‚å¹¶ä¸”å¯¹DSLè¯­å¥æœ‰è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚





---





#### å®‰è£…IKåˆ†è¯å™¨



**åœ¨çº¿å®‰è£…ikæ’ä»¶**

```shell
# è¿›å…¥å®¹å™¨å†…éƒ¨
docker exec -it elasticsearch /bin/bash

# åœ¨çº¿ä¸‹è½½å¹¶å®‰è£…
./bin/elasticsearch-plugin  install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.12.1/elasticsearch-analysis-ik-7.12.1.zip

#é€€å‡º
exit
#é‡å¯å®¹å™¨
docker restart elasticsearch
```





**ç¦»çº¿å®‰è£…ikæ’ä»¶**



æŸ¥çœ‹æ•°æ®å·ç›®å½•

å®‰è£…æ’ä»¶éœ€è¦çŸ¥é“elasticsearchçš„pluginsç›®å½•ä½ç½®ï¼Œè€Œæˆ‘ä»¬ç”¨äº†æ•°æ®å·æŒ‚è½½ï¼Œå› æ­¤éœ€è¦æŸ¥çœ‹elasticsearchçš„æ•°æ®å·ç›®å½•ï¼Œé€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥çœ‹:

```sh
docker volume inspect es-plugins
```

æ˜¾ç¤ºç»“æœï¼š

```json
[
    {
        "CreatedAt": "2022-05-06T10:06:34+08:00",
        "Driver": "local",
        "Labels": null,
        "Mountpoint": "/var/lib/docker/volumes/es-plugins/_data",
        "Name": "es-plugins",
        "Options": null,
        "Scope": "local"
    }
]
```

è¯´æ˜pluginsç›®å½•è¢«æŒ‚è½½åˆ°äº†ï¼š`/var/lib/docker/volumes/es-plugins/_data `è¿™ä¸ªç›®å½•ä¸­ã€‚



è§£å‹ç¼©åˆ†è¯å™¨å®‰è£…åŒ…

ä¸‹é¢æˆ‘ä»¬éœ€è¦æŠŠè¯¾å‰èµ„æ–™ä¸­çš„ikåˆ†è¯å™¨è§£å‹ç¼©ï¼Œé‡å‘½åä¸ºik

![image-20210506110249144](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210506110249144.png)



ä¼ åˆ°eså®¹å™¨çš„æ’ä»¶æ•°æ®å·ä¸­

ä¹Ÿå°±æ˜¯`/var/lib/docker/volumes/es-plugins/_data `ï¼š

![image-20210506110704293](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210506110704293.png)



é‡å¯å®¹å™¨

```shell
# 4ã€é‡å¯å®¹å™¨
docker restart es
```

```sh
# æŸ¥çœ‹esæ—¥å¿—
docker logs -f es
```





---

---



#### éƒ¨ç½²esé›†ç¾¤

éƒ¨ç½²esé›†ç¾¤å¯ä»¥ç›´æ¥ä½¿ç”¨docker-composeæ¥å®Œæˆï¼Œä¸è¿‡è¦æ±‚ä½ çš„Linuxè™šæ‹Ÿæœºè‡³å°‘æœ‰**4G**çš„å†…å­˜ç©ºé—´



é¦–å…ˆç¼–å†™ä¸€ä¸ªdocker-composeæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```sh
version: '2.2'
services:
  es01:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.12.1
    container_name: es01
    environment:
      - node.name=es01
      - cluster.name=es-docker-cluster
      - discovery.seed_hosts=es02,es03
      - cluster.initial_master_nodes=es01,es02,es03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - data01:/usr/share/elasticsearch/data
    ports:
      - 9200:9200
    networks:
      - elastic
  es02:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.12.1
    container_name: es02
    environment:
      - node.name=es02
      - cluster.name=es-docker-cluster
      - discovery.seed_hosts=es01,es03
      - cluster.initial_master_nodes=es01,es02,es03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - data02:/usr/share/elasticsearch/data
    networks:
      - elastic
  es03:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.12.1
    container_name: es03
    environment:
      - node.name=es03
      - cluster.name=es-docker-cluster
      - discovery.seed_hosts=es01,es02
      - cluster.initial_master_nodes=es01,es02,es03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - data03:/usr/share/elasticsearch/data
    networks:
      - elastic

volumes:
  data01:
    driver: local
  data02:
    driver: local
  data03:
    driver: local

networks:
  elastic:
    driver: bridge
```



Run `docker-compose` to bring up the cluster:

```sh
docker-compose up
```





---

---





### IKåˆ†è¯å™¨



#### IKåˆ†æ¨¡å¼

IKåˆ†è¯å™¨åŒ…å«ä¸¤ç§æ¨¡å¼ï¼š

* `ik_smart`ï¼šæœ€å°‘åˆ‡åˆ†

* `ik_max_word`ï¼šæœ€ç»†åˆ‡åˆ†



```json
GET /_analyze
{
  "analyzer": "ik_max_word",
  "text": "é»‘é©¬ç¨‹åºå‘˜å­¦ä¹ javaå¤ªæ£’äº†"
}
```

ç»“æœï¼š

```json
{
  "tokens" : [
    {
      "token" : "é»‘é©¬",
      "start_offset" : 0,
      "end_offset" : 2,
      "type" : "CN_WORD",
      "position" : 0
    },
    {
      "token" : "ç¨‹åºå‘˜",
      "start_offset" : 2,
      "end_offset" : 5,
      "type" : "CN_WORD",
      "position" : 1
    },
    {
      "token" : "ç¨‹åº",
      "start_offset" : 2,
      "end_offset" : 4,
      "type" : "CN_WORD",
      "position" : 2
    },
    {
      "token" : "å‘˜",
      "start_offset" : 4,
      "end_offset" : 5,
      "type" : "CN_CHAR",
      "position" : 3
    },
    {
      "token" : "å­¦ä¹ ",
      "start_offset" : 5,
      "end_offset" : 7,
      "type" : "CN_WORD",
      "position" : 4
    },
    {
      "token" : "java",
      "start_offset" : 7,
      "end_offset" : 11,
      "type" : "ENGLISH",
      "position" : 5
    },
    {
      "token" : "å¤ªæ£’äº†",
      "start_offset" : 11,
      "end_offset" : 14,
      "type" : "CN_WORD",
      "position" : 6
    },
    {
      "token" : "å¤ªæ£’",
      "start_offset" : 11,
      "end_offset" : 13,
      "type" : "CN_WORD",
      "position" : 7
    },
    {
      "token" : "äº†",
      "start_offset" : 13,
      "end_offset" : 14,
      "type" : "CN_CHAR",
      "position" : 8
    }
  ]
}
```





#### æ‰©å±•è¯è¯å…¸

éšç€äº’è”ç½‘çš„å‘å±•ï¼Œâ€œé€ è¯è¿åŠ¨â€ä¹Ÿè¶Šå‘çš„é¢‘ç¹ã€‚å‡ºç°äº†å¾ˆå¤šæ–°çš„è¯è¯­ï¼Œåœ¨åŸæœ‰çš„è¯æ±‡åˆ—è¡¨ä¸­å¹¶ä¸å­˜åœ¨ã€‚æ¯”å¦‚ï¼šâ€œå¥¥åŠ›ç»™â€ï¼Œâ€œä¼ æ™ºæ’­å®¢â€ ç­‰ã€‚

æ‰€ä»¥æˆ‘ä»¬çš„è¯æ±‡ä¹Ÿéœ€è¦ä¸æ–­çš„æ›´æ–°ï¼ŒIKåˆ†è¯å™¨æä¾›äº†æ‰©å±•è¯æ±‡çš„åŠŸèƒ½ã€‚

1ï¼‰æ‰“å¼€IKåˆ†è¯å™¨configç›®å½•ï¼š /var/lib/docker/volumes/es-plugins/_data

![image-20210506112225508](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210506112225508.png)

2ï¼‰åœ¨IKAnalyzer.cfg.xmlé…ç½®æ–‡ä»¶å†…å®¹æ·»åŠ ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
        <comment>IK Analyzer æ‰©å±•é…ç½®</comment>
        <!--ç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œé…ç½®è‡ªå·±çš„æ‰©å±•å­—å…¸ *** æ·»åŠ æ‰©å±•è¯å…¸-->
        <entry key="ext_dict">ext.dic</entry>
</properties>
```

3ï¼‰æ–°å»ºä¸€ä¸ª ext.dicï¼Œå¯ä»¥å‚è€ƒconfigç›®å½•ä¸‹å¤åˆ¶ä¸€ä¸ªé…ç½®æ–‡ä»¶è¿›è¡Œä¿®æ”¹

```properties
ä¼ æ™ºæ’­å®¢
å¥¥åŠ›ç»™
```

4ï¼‰é‡å¯elasticsearch

```sh
docker restart es

# æŸ¥çœ‹ æ—¥å¿—
docker logs -f elasticsearch
```

![image-20201115230900504](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20201115230900504.png)

æ—¥å¿—ä¸­å·²ç»æˆåŠŸåŠ è½½ext.dicé…ç½®æ–‡ä»¶

5ï¼‰æµ‹è¯•æ•ˆæœï¼š

```json
GET /_analyze
{
  "analyzer": "ik_max_word",
  "text": "ä¼ æ™ºæ’­å®¢Javaå°±ä¸šè¶…è¿‡90%,å¥¥åŠ›ç»™ï¼"
}
```

> æ³¨æ„å½“å‰æ–‡ä»¶çš„ç¼–ç å¿…é¡»æ˜¯ UTF-8 æ ¼å¼ï¼Œä¸¥ç¦ä½¿ç”¨Windowsè®°äº‹æœ¬ç¼–è¾‘



#### åœç”¨è¯è¯å…¸

åœ¨äº’è”ç½‘é¡¹ç›®ä¸­ï¼Œåœ¨ç½‘ç»œé—´ä¼ è¾“çš„é€Ÿåº¦å¾ˆå¿«ï¼Œæ‰€ä»¥å¾ˆå¤šè¯­è¨€æ˜¯ä¸å…è®¸åœ¨ç½‘ç»œä¸Šä¼ é€’çš„ï¼Œå¦‚ï¼šå…³äºå®—æ•™ã€æ”¿æ²»ç­‰æ•æ„Ÿè¯è¯­ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨æœç´¢æ—¶ä¹Ÿåº”è¯¥å¿½ç•¥å½“å‰è¯æ±‡ã€‚

IKåˆ†è¯å™¨ä¹Ÿæä¾›äº†å¼ºå¤§çš„åœç”¨è¯åŠŸèƒ½ï¼Œè®©æˆ‘ä»¬åœ¨ç´¢å¼•æ—¶å°±ç›´æ¥å¿½ç•¥å½“å‰çš„åœç”¨è¯æ±‡è¡¨ä¸­çš„å†…å®¹ã€‚

1ï¼‰IKAnalyzer.cfg.xmlé…ç½®æ–‡ä»¶å†…å®¹æ·»åŠ ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
        <comment>IK Analyzer æ‰©å±•é…ç½®</comment>
        <!--ç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œé…ç½®è‡ªå·±çš„æ‰©å±•å­—å…¸-->
        <entry key="ext_dict">ext.dic</entry>
         <!--ç”¨æˆ·å¯ä»¥åœ¨è¿™é‡Œé…ç½®è‡ªå·±çš„æ‰©å±•åœæ­¢è¯å­—å…¸  *** æ·»åŠ åœç”¨è¯è¯å…¸-->
        <entry key="ext_stopwords">stopword.dic</entry>
</properties>
```

3ï¼‰åœ¨ stopword.dic æ·»åŠ åœç”¨è¯

```properties
çš„
å—
å˜¤
```

4ï¼‰é‡å¯elasticsearch

```sh
# é‡å¯æœåŠ¡
docker restart elasticsearch
docker restart kibana

# æŸ¥çœ‹ æ—¥å¿—
docker logs -f elasticsearch
```

æ—¥å¿—ä¸­å·²ç»æˆåŠŸåŠ è½½stopword.dicé…ç½®æ–‡ä»¶

5ï¼‰æµ‹è¯•æ•ˆæœï¼š

```json
GET /_analyze
{
  "analyzer": "ik_max_word",
  "text": "ä¼ æ™ºæ’­å®¢Javaå°±ä¸šç‡è¶…è¿‡95%,ä¹ å¤§å¤§éƒ½ç‚¹èµ,å¥¥åŠ›ç»™ï¼"
}
```

> æ³¨æ„å½“å‰æ–‡ä»¶çš„ç¼–ç å¿…é¡»æ˜¯ UTF-8 æ ¼å¼ï¼Œä¸¥ç¦ä½¿ç”¨Windowsè®°äº‹æœ¬ç¼–è¾‘







---

---





### API-Index



**mappingå±æ€§**

mappingæ˜¯å¯¹ç´¢å¼•åº“ä¸­æ–‡æ¡£çš„çº¦æŸï¼Œå¸¸è§çš„mappingå±æ€§åŒ…æ‹¬ï¼š

- `type`ï¼šå­—æ®µæ•°æ®ç±»å‹ï¼Œå¸¸è§çš„ç®€å•ç±»å‹æœ‰ï¼š
  - å­—ç¬¦ä¸²ï¼š`text`ï¼ˆå¯åˆ†è¯çš„æ–‡æœ¬ï¼‰ã€`keyword`ï¼ˆç²¾ç¡®å€¼ï¼Œä¾‹å¦‚ï¼šå“ç‰Œã€å›½å®¶ã€ipåœ°å€ï¼‰
  - æ•°å€¼ï¼š`long`ã€`integer`ã€`short`ã€`byte`ã€`double`ã€`float`ã€
  - å¸ƒå°”ï¼š`boolean `
  - æ—¥æœŸï¼š`date `
  - å¯¹è±¡ï¼š`object`
- `index`ï¼šæ˜¯å¦åˆ›å»ºç´¢å¼•ï¼Œé»˜è®¤ä¸ºtrue
- `analyzer`ï¼šä½¿ç”¨å“ªç§åˆ†è¯å™¨
- `properties`ï¼šè¯¥å­—æ®µçš„å­å­—æ®µ





#### **åˆ›å»ºç´¢å¼•åº“å’Œæ˜ å°„**

```json
PUTÂ /ç´¢å¼•åº“åç§°
{
Â Â "mappings":Â {
Â Â Â Â "properties":Â {
Â Â Â Â Â Â "å­—æ®µå":{
Â Â Â Â Â Â Â Â "type":Â "text",
Â Â Â Â Â Â Â Â "analyzer":Â "ik_smart"
Â Â Â Â Â Â },
Â Â Â Â Â Â "å­—æ®µå2":{
Â Â Â Â Â Â Â Â "type":Â "keyword",
Â Â Â Â Â Â Â Â "index":Â "false"
Â Â Â Â Â Â },
Â Â Â Â Â Â "å­—æ®µå3":{
Â Â Â Â Â Â Â Â "properties":Â {
Â Â Â Â Â Â Â Â Â Â "å­å­—æ®µ":Â {
Â Â Â Â Â Â Â Â Â Â Â Â "type":Â "keyword"
Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â }
      // ...ç•¥
Â Â Â Â }
Â Â }
}
```

ç¤ºä¾‹ï¼š

```sh
PUTÂ /heima
{
Â Â "mappings":Â {
Â Â Â Â "properties":Â {
Â Â Â Â Â Â "info":{
Â Â Â Â Â Â Â Â "type":Â "text",
Â Â Â Â Â Â Â Â "analyzer":Â "ik_smart"
Â Â Â Â Â Â },
Â Â Â Â Â Â "email":{
Â Â Â Â Â Â Â Â "type":Â "keyword",
Â Â Â Â Â Â Â Â "index":Â "falsae"
Â Â Â Â Â Â },
Â Â Â Â Â Â "name":{
Â Â Â Â Â Â Â Â "properties":Â {
Â Â Â Â Â Â Â Â Â Â "firstName":Â {
Â Â Â Â Â Â Â Â Â Â Â Â "type":Â "keyword"
Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â },
      // ... ç•¥
Â Â Â Â }
Â Â }
}
```





#### **æŸ¥è¯¢æ–‡æ¡£**

```json
GET /index #### 
```



#### **åˆ é™¤æ–‡æ¡£**

```json
DELETE /index
```



#### **ä¿®æ”¹æ–‡æ¡£--æ·»åŠ æ–°æ˜ å°„**

```json
PUT /incex/_mapping

PUT /ganga/_mapping
{
  "properties":{
    "æ–°å­—æ®µ":{
      "type": "integer"
    }
  }
}
```











### API-document



#### **æ·»åŠ æ–‡æ¡£ - POST**

æ–¹å¼ä¸€:

```json
POST /ganga/_doc/1
{
  "info": "å°´å°¬é…±ä¸‡å²ï¼å¥¥é‡Œç»™ï¼",
  "email": "2282514478@qq.com",
  "age": 9,
  "name": {
    "first": "å°¬é…±",
    "last": "å°´"
  },
  "newField": "666"
}
```

æ–¹å¼äºŒï¼š

```json
POST /ganga/_create/1
{
  "info": "å°´å°¬é…±ä¸‡å²ï¼å¥¥é‡Œç»™ï¼",
  "email": "2282514478@qq.com",
  "age": 9,
  "name": {
    "first": "å°¬é…±",
    "last": "å°´"
  },
  "newField": "666"
}
```



#### **æ ¹æ®IDæŸ¥è¯¢æ–‡æ¡£ - GET**

```json
GET /ganga/_doc/1
```



#### **æ ¹æ®IDåˆ é™¤æ–‡æ¡£ - DELETE**

```json
DELETE /ganga/_doc/1
```



#### **æ ¹æ®IDå…¨é‡ä¿®æ”¹ - PUT**

```json
PUT /ganga/_doc/1
{
  "info": "å°´å°¬é…±ä¸‡å²ï¼å¥¥é‡Œç»™ï¼å˜¤",
  "email": "2282514478@qq.com",
  "age": 9,
  "name": {
    "first": "å°¬é…±",
    "last": "å°´"
  },
  "newField": "666666"
}

PUT /ganga/_doc/1
{
  "info": "å¦‚æœå…¶ä»–å­—æ®µä¸å†™æˆ–å†™é”™äº†ï¼Œéƒ½ä¼šè¢«ä¿®æ”¹æ‰",
  "newField": "6"
}
```



#### **æ ¹æ®IDå¢é‡ä¿®æ”¹ - POST**

```json
POST /ganga/_update/1

{
	"doc": {
        "info": "å°´å°¬é…±ä¸‡å²",
        "newField": "6"
    }
}
```





---



### API-Search

Elasticsearchæä¾›äº†åŸºäºJSONçš„DSLï¼ˆ[Domain Specific Language](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html)ï¼‰æ¥å®šä¹‰æŸ¥è¯¢ã€‚å¸¸è§çš„æŸ¥è¯¢ç±»å‹åŒ…æ‹¬ï¼š

- **æŸ¥è¯¢æ‰€æœ‰**ï¼šæŸ¥è¯¢å‡ºæ‰€æœ‰æ•°æ®ï¼Œä¸€èˆ¬æµ‹è¯•ç”¨ã€‚ä¾‹å¦‚ï¼šmatch_all

- **å…¨æ–‡æ£€ç´¢ï¼ˆfull textï¼‰æŸ¥è¯¢**ï¼šåˆ©ç”¨åˆ†è¯å™¨å¯¹ç”¨æˆ·è¾“å…¥å†…å®¹åˆ†è¯ï¼Œç„¶åå»å€’æ’ç´¢å¼•åº“ä¸­åŒ¹é…ã€‚ä¾‹å¦‚ï¼š
  - match_query
  - multi_match_query
- **ç²¾ç¡®æŸ¥è¯¢**ï¼šæ ¹æ®ç²¾ç¡®è¯æ¡å€¼æŸ¥æ‰¾æ•°æ®ï¼Œä¸€èˆ¬æ˜¯æŸ¥æ‰¾keywordã€æ•°å€¼ã€æ—¥æœŸã€booleanç­‰ç±»å‹å­—æ®µã€‚ä¾‹å¦‚ï¼š
  - ids
  - range
  - term
- **åœ°ç†ï¼ˆgeoï¼‰æŸ¥è¯¢**ï¼šæ ¹æ®ç»çº¬åº¦æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼š
  - geo_distance
  - geo_bounding_box
- **å¤åˆï¼ˆcompoundï¼‰æŸ¥è¯¢**ï¼šå¤åˆæŸ¥è¯¢å¯ä»¥å°†ä¸Šè¿°å„ç§æŸ¥è¯¢æ¡ä»¶ç»„åˆèµ·æ¥ï¼Œåˆå¹¶æŸ¥è¯¢æ¡ä»¶ã€‚ä¾‹å¦‚ï¼š
  - bool
  - function_score





#### **æŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£-match_all**

```json
GET /hotel/_search
{
  "query": {
    "match_all": {
    }
  }
}
```



#### **å…¨æ–‡æ£€ç´¢æŸ¥è¯¢-match**

```json
# å…¨æ–‡æ£€ç´¢æŸ¥è¯¢ match
GET /hotel/_search
{
  "query": {
    "match":{
      "all": "ä¸Šæµ·"
    }
  }
}

```





#### **å…¨æ–‡æ£€ç´¢æŸ¥è¯¢-multi_match**

```json

# å…¨æ–‡æ£€ç´¢æŸ¥è¯¢ multi_match
# è¿™ç§æ–¹å¼ç›¸å¯¹ä¸match ç»“æœç›¸åŒ ä½†æ˜¯æ€§èƒ½ä¼šå¾ˆå·® matchåˆ©ç”¨copy_toå¤åˆ¶åˆ°äº†allå­—æ®µä¸­
GET /hotel/_search
{
  "query": {
    "multi_match": {
      "query": "ä¸Šæµ·",
      "fields": ["name","brand","city"]
    }
  }
}
```





#### **ç²¾ç¡®æŸ¥æ‰¾-term**

```json
# ç²¾ç¡®æŸ¥æ‰¾ term
GET /hotel/_search
{
  "query": {
    "term": {
      "starName": {
        "value": "äº”é’»" //ä¸è¿›è¡Œåˆ†è¯çš„å­—æ®µæŸ¥è¯¢
      }
    }
  }
}
```





#### **ç²¾ç¡®æŸ¥æ‰¾-range**

```json
# ç²¾ç¡®æŸ¥æ‰¾ range
GET /hotel/_search
{
  "query": {
    "range":{
      "price": {
        "gte": 1000, // "gte"å¤§äºç­‰äº "gt"å¤§äº
        "lte": 1302  // "lte"å°äºç­‰äº "lt"å°äº
      }
    }
  }
}
```





#### **åœ°ç†åæ ‡æŸ¥è¯¢-geo_distance**

```json
# åœ°ç†åæ ‡æŸ¥è¯¢
# é™„è¿‘æŸ¥è¯¢ï¼Œä¹Ÿå«åšè·ç¦»æŸ¥è¯¢ï¼ˆgeo_distanceï¼‰ä¿—ç§°:"æ–¹åœ†å†…"
GET /hotel/_search
{
  "query": {
    "geo_distance":{
      "distance": "10km",
      "location": "31.21, 121.5"
    }
  }
}
GET /hotel/_search
{
  "query": {
    "geo_distance":{
      "distance": "5km",
      "location": "31.21, 121.5"
    }
  }
}
```





#### **å¤åˆæŸ¥è¯¢-ç®—åˆ†å‡½æ•°**

function score æŸ¥è¯¢ä¸­åŒ…å«å››éƒ¨åˆ†å†…å®¹ï¼š

- **åŸå§‹æŸ¥è¯¢**æ¡ä»¶ï¼šqueryéƒ¨åˆ†ï¼ŒåŸºäºè¿™ä¸ªæ¡ä»¶æœç´¢æ–‡æ¡£ï¼Œå¹¶ä¸”åŸºäºBM25ç®—æ³•ç»™æ–‡æ¡£æ‰“åˆ†ï¼Œ**åŸå§‹ç®—åˆ†**ï¼ˆquery score)
- **è¿‡æ»¤æ¡ä»¶**ï¼šfilteréƒ¨åˆ†ï¼Œç¬¦åˆè¯¥æ¡ä»¶çš„æ–‡æ¡£æ‰ä¼šé‡æ–°ç®—åˆ†
- **ç®—åˆ†å‡½æ•°**ï¼šç¬¦åˆfilteræ¡ä»¶çš„æ–‡æ¡£è¦æ ¹æ®è¿™ä¸ªå‡½æ•°åšè¿ç®—ï¼Œå¾—åˆ°çš„**å‡½æ•°ç®—åˆ†**ï¼ˆfunction scoreï¼‰ï¼Œæœ‰å››ç§å‡½æ•°
  - weightï¼šå‡½æ•°ç»“æœæ˜¯å¸¸é‡
  - field_value_factorï¼šä»¥æ–‡æ¡£ä¸­çš„æŸä¸ªå­—æ®µå€¼ä½œä¸ºå‡½æ•°ç»“æœ
  - random_scoreï¼šä»¥éšæœºæ•°ä½œä¸ºå‡½æ•°ç»“æœ
  - script_scoreï¼šè‡ªå®šä¹‰ç®—åˆ†å‡½æ•°ç®—æ³•
- **è¿ç®—æ¨¡å¼**ï¼šç®—åˆ†å‡½æ•°çš„ç»“æœã€åŸå§‹æŸ¥è¯¢çš„ç›¸å…³æ€§ç®—åˆ†ï¼Œä¸¤è€…ä¹‹é—´çš„è¿ç®—æ–¹å¼ï¼ŒåŒ…æ‹¬ï¼š
  - multiplyï¼šç›¸ä¹˜
  - replaceï¼šç”¨function scoreæ›¿æ¢query score
  - å…¶å®ƒï¼Œä¾‹å¦‚ï¼šsumã€avgã€maxã€min



function scoreçš„è¿è¡Œæµç¨‹å¦‚ä¸‹ï¼š

- 1ï¼‰æ ¹æ®**åŸå§‹æ¡ä»¶**æŸ¥è¯¢æœç´¢æ–‡æ¡£ï¼Œå¹¶ä¸”è®¡ç®—ç›¸å…³æ€§ç®—åˆ†ï¼Œç§°ä¸º**åŸå§‹ç®—åˆ†**ï¼ˆquery scoreï¼‰
- 2ï¼‰æ ¹æ®**è¿‡æ»¤æ¡ä»¶**ï¼Œè¿‡æ»¤æ–‡æ¡£
- 3ï¼‰ç¬¦åˆ**è¿‡æ»¤æ¡ä»¶**çš„æ–‡æ¡£ï¼ŒåŸºäº**ç®—åˆ†å‡½æ•°**è¿ç®—ï¼Œå¾—åˆ°**å‡½æ•°ç®—åˆ†**ï¼ˆfunction scoreï¼‰
- 4ï¼‰å°†**åŸå§‹ç®—åˆ†**ï¼ˆquery scoreï¼‰å’Œ**å‡½æ•°ç®—åˆ†**ï¼ˆfunction scoreï¼‰åŸºäº**è¿ç®—æ¨¡å¼**åšè¿ç®—ï¼Œå¾—åˆ°æœ€ç»ˆç»“æœï¼Œä½œä¸ºç›¸å…³æ€§ç®—åˆ†ã€‚



å› æ­¤ï¼Œå…¶ä¸­çš„å…³é”®ç‚¹æ˜¯ï¼š

- è¿‡æ»¤æ¡ä»¶ï¼šå†³å®šå“ªäº›æ–‡æ¡£çš„ç®—åˆ†è¢«ä¿®æ”¹
- ç®—åˆ†å‡½æ•°ï¼šå†³å®šå‡½æ•°ç®—åˆ†çš„ç®—æ³•
- è¿ç®—æ¨¡å¼ï¼šå†³å®šæœ€ç»ˆç®—åˆ†ç»“æœ



![image-20210721193458182](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210721193458182.png)

```json
# å¤åˆæŸ¥è¯¢ fuction score ç®—åˆ†å‡½æ•°æŸ¥è¯¢ï¼Œå¯ä»¥æ§åˆ¶æ–‡æ¡£ç›¸å…³æ€§ç®—åˆ†ï¼Œæ§åˆ¶æ–‡æ¡£æ’å
# æ—©æœŸä½¿ç”¨çš„æ‰“åˆ†ç®—æ³•æ˜¯TF-IDFç®—æ³•
# åœ¨åæ¥çš„5.1ç‰ˆæœ¬å‡çº§ä¸­ï¼Œelasticsearchå°†ç®—æ³•æ”¹è¿›ä¸ºBM25ç®—æ³•
GET /hotel/_search
GETÂ /hotel/_search
{
Â Â "query":Â {
Â Â Â Â "function_score":Â {
Â Â Â Â Â Â "query":Â {  .... }, // åŸå§‹æŸ¥è¯¢ï¼Œå¯ä»¥æ˜¯ä»»æ„æ¡ä»¶
Â Â Â Â Â Â "functions":Â [Â //Â ç®—åˆ†å‡½æ•°
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â "filter":Â {Â //Â æ»¡è¶³çš„æ¡ä»¶ï¼Œå“ç‰Œå¿…é¡»æ˜¯å¦‚å®¶
Â Â Â Â Â Â Â Â Â Â Â Â "term":Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â "brand":Â "å¦‚å®¶"
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â Â Â "weight":Â 2Â //Â ç®—åˆ†æƒé‡ä¸º2
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â ],
      "boost_mode": "sum" // åŠ æƒæ¨¡å¼ï¼Œæ±‚å’Œ
Â Â Â Â }
Â Â }
}
```





#### **å¤åˆæŸ¥è¯¢-å¸ƒå°”æŸ¥è¯¢**

å¸ƒå°”æŸ¥è¯¢æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªæŸ¥è¯¢å­å¥çš„ç»„åˆï¼Œæ¯ä¸€ä¸ªå­å¥å°±æ˜¯ä¸€ä¸ª**å­æŸ¥è¯¢**ã€‚å­æŸ¥è¯¢çš„ç»„åˆæ–¹å¼æœ‰ï¼š

- mustï¼šå¿…é¡»åŒ¹é…æ¯ä¸ªå­æŸ¥è¯¢ï¼Œç±»ä¼¼â€œä¸â€
- shouldï¼šé€‰æ‹©æ€§åŒ¹é…å­æŸ¥è¯¢ï¼Œç±»ä¼¼â€œæˆ–â€
- must_notï¼šå¿…é¡»ä¸åŒ¹é…ï¼Œ**ä¸å‚ä¸ç®—åˆ†**ï¼Œç±»ä¼¼â€œéâ€
- filterï¼šå¿…é¡»åŒ¹é…ï¼Œ**ä¸å‚ä¸ç®—åˆ†**

```json
GETÂ /ganga/_search
{
Â Â "query":Â {
Â Â Â Â "bool":Â {
Â Â Â Â Â Â "must":Â [
Â Â Â Â Â Â Â Â {"term":Â {"city":Â "ä¸Šæµ·"Â }}
Â Â Â Â Â Â ],
Â Â Â Â Â Â "should":Â [
Â Â Â Â Â Â Â Â {"term":Â {"brand":Â "çš‡å† å‡æ—¥"Â }},
        {"term":Â {"brand":Â "åç¾è¾¾"Â }}
Â Â Â Â Â Â ],
Â Â Â Â Â Â "must_not":Â [
Â Â Â Â Â Â Â Â {Â "range":Â {Â "price":Â {Â "lte":Â 500Â }Â }}
Â Â Â Â Â Â ],
Â Â Â Â Â Â "filter":Â [
Â Â Â Â Â Â Â Â {Â "range":Â {"score":Â {Â "gte":Â 45Â }Â }}
Â Â Â Â Â Â ]
Â Â Â Â }
Â Â }
}
```



---



### API-èšåˆå‡½æ•°



#### TODO:







---



### æœç´¢ç»“æœå¤„ç†

æœç´¢çš„ç»“æœå¯ä»¥æŒ‰ç…§ç”¨æˆ·æŒ‡å®šçš„æ–¹å¼å»å¤„ç†æˆ–å±•ç¤ºã€‚



#### æ’åº

elasticsearché»˜è®¤æ˜¯æ ¹æ®ç›¸å…³åº¦ç®—åˆ†ï¼ˆ_scoreï¼‰æ¥æ’åºï¼Œä½†æ˜¯ä¹Ÿæ”¯æŒè‡ªå®šä¹‰æ–¹å¼å¯¹æœç´¢[ç»“æœæ’åº](https://www.elastic.co/guide/en/elasticsearch/reference/current/sort-search-results.html)ã€‚å¯ä»¥æ’åºå­—æ®µç±»å‹æœ‰ï¼škeywordç±»å‹ã€æ•°å€¼ç±»å‹ã€åœ°ç†åæ ‡ç±»å‹ã€æ—¥æœŸç±»å‹ç­‰ã€‚



**æ™®é€šå­—æ®µæ’åº**

keywordã€æ•°å€¼ã€æ—¥æœŸç±»å‹æ’åºçš„è¯­æ³•åŸºæœ¬ä¸€è‡´ã€‚

```json
GETÂ /indexName/_search
{
Â Â "query":Â {
Â Â Â Â "match_all":Â {}
Â Â },
Â Â "sort":Â [
Â Â Â Â {
Â Â Â Â Â Â "FIELD":Â "desc"Â Â //Â æ’åºå­—æ®µã€æ’åºæ–¹å¼ASCã€DESC
Â Â Â Â }
Â Â ]
}
```





**åœ°ç†åæ ‡æ’åº**

åœ°ç†åæ ‡æ’åºç•¥æœ‰ä¸åŒã€‚

```json
GETÂ /indexName/_search
{
Â Â "query":Â {
Â Â Â Â "match_all":Â {}
Â Â },
Â Â "sort":Â [
Â Â Â Â {
Â Â Â Â Â Â "_geo_distance"Â :Â {
Â Â Â Â Â Â Â Â Â Â "FIELD"Â :Â "çº¬åº¦ï¼Œç»åº¦", // æ–‡æ¡£ä¸­geo_pointç±»å‹çš„å­—æ®µåã€ç›®æ ‡åæ ‡ç‚¹
Â Â Â Â Â Â Â Â Â Â "order"Â :Â "asc", // æ’åºæ–¹å¼
Â Â Â Â Â Â Â Â Â Â "unit"Â :Â "km" // æ’åºçš„è·ç¦»å•ä½
Â Â Â Â Â Â }
Â Â Â Â }
Â Â ]
}
```

è¿™ä¸ªæŸ¥è¯¢çš„å«ä¹‰æ˜¯ï¼š

- æŒ‡å®šä¸€ä¸ªåæ ‡ï¼Œä½œä¸ºç›®æ ‡ç‚¹
- è®¡ç®—æ¯ä¸€ä¸ªæ–‡æ¡£ä¸­ï¼ŒæŒ‡å®šå­—æ®µï¼ˆå¿…é¡»æ˜¯geo_pointç±»å‹ï¼‰çš„åæ ‡ åˆ°ç›®æ ‡ç‚¹çš„è·ç¦»æ˜¯å¤šå°‘
- æ ¹æ®è·ç¦»æ’åº



éœ€æ±‚æè¿°ï¼šå®ç°å¯¹é…’åº—æ•°æ®æŒ‰ç…§åˆ°ä½ çš„ä½ç½®åæ ‡çš„è·ç¦»å‡åºæ’åº

è·å–ä½ çš„ä½ç½®çš„ç»çº¬åº¦çš„æ–¹å¼ï¼šhttps://lbs.amap.com/demo/jsapi-v2/example/map/click-to-get-lnglat/

å‡è®¾æˆ‘çš„ä½ç½®æ˜¯ï¼š31.034661ï¼Œ121.612282ï¼Œå¯»æ‰¾æˆ‘å‘¨å›´è·ç¦»æœ€è¿‘çš„é…’åº—ã€‚

![image-20210721200214690](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210721200214690-16776020221702.png)





---



#### åˆ†é¡µ

elasticsearch é»˜è®¤æƒ…å†µä¸‹åªè¿”å›top10çš„æ•°æ®ã€‚è€Œå¦‚æœè¦æŸ¥è¯¢æ›´å¤šæ•°æ®å°±éœ€è¦ä¿®æ”¹åˆ†é¡µå‚æ•°äº†ã€‚elasticsearchä¸­é€šè¿‡ä¿®æ”¹fromã€sizeå‚æ•°æ¥æ§åˆ¶è¦è¿”å›çš„åˆ†é¡µç»“æœï¼š

- fromï¼šä»ç¬¬å‡ ä¸ªæ–‡æ¡£å¼€å§‹
- sizeï¼šæ€»å…±æŸ¥è¯¢å‡ ä¸ªæ–‡æ¡£

ç±»ä¼¼äºmysqlä¸­çš„`limit ?, ?`



åˆ†é¡µçš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š

```json
GETÂ /hotel/_search
{
Â Â "query":Â {
Â Â Â Â "match_all":Â {}
Â Â },
Â Â "from":Â 0,Â //Â åˆ†é¡µå¼€å§‹çš„ä½ç½®ï¼Œé»˜è®¤ä¸º0
Â Â "size":Â 10,Â //Â æœŸæœ›è·å–çš„æ–‡æ¡£æ€»æ•°
Â Â "sort":Â [
Â Â Â Â {"price":Â "asc"}
Â Â ]
}
```



**æ·±åº¦åˆ†é¡µé—®é¢˜**

ç°åœ¨ï¼Œæˆ‘è¦æŸ¥è¯¢990~1000çš„æ•°æ®ï¼ŒæŸ¥è¯¢é€»è¾‘è¦è¿™ä¹ˆå†™ï¼š

```json
GETÂ /hotel/_search
{
Â Â "query":Â {
Â Â Â Â "match_all":Â {}
Â Â },
Â Â "from":Â 990,Â //Â åˆ†é¡µå¼€å§‹çš„ä½ç½®ï¼Œé»˜è®¤ä¸º0
Â Â "size":Â 10,Â //Â æœŸæœ›è·å–çš„æ–‡æ¡£æ€»æ•°
Â Â "sort":Â [
Â Â Â Â {"price":Â "asc"}
Â Â ]
}
```

è¿™é‡Œæ˜¯æŸ¥è¯¢990å¼€å§‹çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ ç¬¬990~ç¬¬1000æ¡ æ•°æ®ã€‚

ä¸è¿‡ï¼Œelasticsearchå†…éƒ¨åˆ†é¡µæ—¶ï¼Œå¿…é¡»å…ˆæŸ¥è¯¢ 0~1000æ¡ï¼Œç„¶åæˆªå–å…¶ä¸­çš„990 ~ 1000çš„è¿™10æ¡ï¼š

![image-20210721200643029](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210721200643029.png)



æŸ¥è¯¢TOP1000ï¼Œå¦‚æœesæ˜¯å•ç‚¹æ¨¡å¼ï¼Œè¿™å¹¶æ— å¤ªå¤§å½±å“ã€‚

ä½†æ˜¯elasticsearchå°†æ¥ä¸€å®šæ˜¯é›†ç¾¤ï¼Œä¾‹å¦‚æˆ‘é›†ç¾¤æœ‰5ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘è¦æŸ¥è¯¢TOP1000çš„æ•°æ®ï¼Œå¹¶ä¸æ˜¯æ¯ä¸ªèŠ‚ç‚¹æŸ¥è¯¢200æ¡å°±å¯ä»¥äº†ã€‚

å› ä¸ºèŠ‚ç‚¹Açš„TOP200ï¼Œåœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹å¯èƒ½æ’åˆ°10000åä»¥å¤–äº†ã€‚

å› æ­¤è¦æƒ³è·å–æ•´ä¸ªé›†ç¾¤çš„TOP1000ï¼Œå¿…é¡»å…ˆæŸ¥è¯¢å‡ºæ¯ä¸ªèŠ‚ç‚¹çš„TOP1000ï¼Œæ±‡æ€»ç»“æœåï¼Œé‡æ–°æ’åï¼Œé‡æ–°æˆªå–TOP1000ã€‚

![image-20210721201003229](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210721201003229.png)



é‚£å¦‚æœæˆ‘è¦æŸ¥è¯¢9900~10000çš„æ•°æ®å‘¢ï¼Ÿæ˜¯ä¸æ˜¯è¦å…ˆæŸ¥è¯¢TOP10000å‘¢ï¼Ÿé‚£æ¯ä¸ªèŠ‚ç‚¹éƒ½è¦æŸ¥è¯¢10000æ¡ï¼Ÿæ±‡æ€»åˆ°å†…å­˜ä¸­ï¼Ÿ



å½“æŸ¥è¯¢åˆ†é¡µæ·±åº¦è¾ƒå¤§æ—¶ï¼Œæ±‡æ€»æ•°æ®è¿‡å¤šï¼Œå¯¹å†…å­˜å’ŒCPUä¼šäº§ç”Ÿéå¸¸å¤§çš„å‹åŠ›ï¼Œå› æ­¤elasticsearchä¼šç¦æ­¢from+ size è¶…è¿‡10000çš„è¯·æ±‚ã€‚



é’ˆå¯¹æ·±åº¦åˆ†é¡µï¼ŒESæä¾›äº†ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œ[å®˜æ–¹æ–‡æ¡£](https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html)ï¼š

- search afterï¼šåˆ†é¡µæ—¶éœ€è¦æ’åºï¼ŒåŸç†æ˜¯ä»ä¸Šä¸€æ¬¡çš„æ’åºå€¼å¼€å§‹ï¼ŒæŸ¥è¯¢ä¸‹ä¸€é¡µæ•°æ®ã€‚å®˜æ–¹æ¨èä½¿ç”¨çš„æ–¹å¼ã€‚
- scrollï¼šåŸç†å°†æ’åºåçš„æ–‡æ¡£idå½¢æˆå¿«ç…§ï¼Œä¿å­˜åœ¨å†…å­˜ã€‚å®˜æ–¹å·²ç»ä¸æ¨èä½¿ç”¨ã€‚





**å°ç»“**

åˆ†é¡µæŸ¥è¯¢çš„å¸¸è§å®ç°æ–¹æ¡ˆä»¥åŠä¼˜ç¼ºç‚¹ï¼š

- `from + size`ï¼š
  - ä¼˜ç‚¹ï¼šæ”¯æŒéšæœºç¿»é¡µ
  - ç¼ºç‚¹ï¼šæ·±åº¦åˆ†é¡µé—®é¢˜ï¼Œé»˜è®¤æŸ¥è¯¢ä¸Šé™ï¼ˆfrom + sizeï¼‰æ˜¯10000
  - åœºæ™¯ï¼šç™¾åº¦ã€äº¬ä¸œã€è°·æ­Œã€æ·˜å®è¿™æ ·çš„éšæœºç¿»é¡µæœç´¢
- `after search`ï¼š
  - ä¼˜ç‚¹ï¼šæ²¡æœ‰æŸ¥è¯¢ä¸Šé™ï¼ˆå•æ¬¡æŸ¥è¯¢çš„sizeä¸è¶…è¿‡10000ï¼‰
  - ç¼ºç‚¹ï¼šåªèƒ½å‘åé€é¡µæŸ¥è¯¢ï¼Œä¸æ”¯æŒéšæœºç¿»é¡µ
  - åœºæ™¯ï¼šæ²¡æœ‰éšæœºç¿»é¡µéœ€æ±‚çš„æœç´¢ï¼Œä¾‹å¦‚æ‰‹æœºå‘ä¸‹æ»šåŠ¨ç¿»é¡µ

- `scroll`ï¼š
  - ä¼˜ç‚¹ï¼šæ²¡æœ‰æŸ¥è¯¢ä¸Šé™ï¼ˆå•æ¬¡æŸ¥è¯¢çš„sizeä¸è¶…è¿‡10000ï¼‰
  - ç¼ºç‚¹ï¼šä¼šæœ‰é¢å¤–å†…å­˜æ¶ˆè€—ï¼Œå¹¶ä¸”æœç´¢ç»“æœæ˜¯éå®æ—¶çš„
  - åœºæ™¯ï¼šæµ·é‡æ•°æ®çš„è·å–å’Œè¿ç§»ã€‚ä»ES7.1å¼€å§‹ä¸æ¨èï¼Œå»ºè®®ç”¨ after searchæ–¹æ¡ˆã€‚









---



#### é«˜äº®



**é«˜äº®çš„è¯­æ³•**ï¼š

```json
GETÂ /hotel/_search
{
Â Â "query":Â {
Â Â Â Â "match":Â {
Â Â Â Â Â Â "FIELD":Â "TEXT" // æŸ¥è¯¢æ¡ä»¶ï¼Œé«˜äº®ä¸€å®šè¦ä½¿ç”¨å…¨æ–‡æ£€ç´¢æŸ¥è¯¢
Â Â Â Â }
Â Â },
Â Â "highlight":Â {
Â Â Â Â "fields":Â {Â //Â æŒ‡å®šè¦é«˜äº®çš„å­—æ®µ
Â Â Â Â Â Â "FIELD":Â {
Â Â Â Â Â Â Â Â "pre_tags":Â "<em>",Â Â //Â ç”¨æ¥æ ‡è®°é«˜äº®å­—æ®µçš„å‰ç½®æ ‡ç­¾
Â Â Â Â Â Â Â Â "post_tags":Â "</em>"Â //Â ç”¨æ¥æ ‡è®°é«˜äº®å­—æ®µçš„åç½®æ ‡ç­¾
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }
}
```



**æ³¨æ„ï¼š**

- é«˜äº®æ˜¯å¯¹å…³é”®å­—é«˜äº®ï¼Œå› æ­¤**æœç´¢æ¡ä»¶å¿…é¡»å¸¦æœ‰å…³é”®å­—**ï¼Œè€Œä¸èƒ½æ˜¯èŒƒå›´è¿™æ ·çš„æŸ¥è¯¢ã€‚
- é»˜è®¤æƒ…å†µä¸‹ï¼Œ**é«˜äº®çš„å­—æ®µï¼Œå¿…é¡»ä¸æœç´¢æŒ‡å®šçš„å­—æ®µä¸€è‡´**ï¼Œå¦åˆ™æ— æ³•é«˜äº®
- å¦‚æœè¦å¯¹éæœç´¢å­—æ®µé«˜äº®ï¼Œåˆ™éœ€è¦æ·»åŠ ä¸€ä¸ªå±æ€§ï¼šrequired_field_match=false



**ç¤ºä¾‹**ï¼š

![image-20210721203349633](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210721203349633.png)





---



#### **æ€»ç»“**

æŸ¥è¯¢çš„DSLæ˜¯ä¸€ä¸ªå¤§çš„JSONå¯¹è±¡ï¼ŒåŒ…å«ä¸‹åˆ—å±æ€§ï¼š

- queryï¼šæŸ¥è¯¢æ¡ä»¶
- fromå’Œsizeï¼šåˆ†é¡µæ¡ä»¶
- sortï¼šæ’åºæ¡ä»¶
- highlightï¼šé«˜äº®æ¡ä»¶

![image-20210721203657850](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210721203657850.png)





-

---

---







### RestClient

---



#### é…’åº—æ•°æ®ç´¢å¼•åº“åˆ†æ

è¿™æ˜¯è¡¨ç»“æ„ï¼š

![image-20230228234510099](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230228234510099.png)



**åˆ†æç´¢å¼•**

**åˆ†æé€»è¾‘ï¼š**
1. å­—æ®µçš„ç´¢å¼•ç±»å‹
2. å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œæ˜¯å¦éœ€è¦åˆ†è¯
3. ä¸åˆ†è¯ç”¨keyword
4. åˆ†è¯ç”¨testï¼Œåˆ†è¯å™¨analyzeræ˜¯ä»€ä¹ˆ?`ik_max_word`/`ik_smart`/`...`
5. è¯¥å­—æ®µæ˜¯è¿›è¡Œæœç´¢ï¼Œé»˜è®¤æœç´¢ï¼Œä¸æœç´¢ï¼š`"index": false`


æ•°æ®åº“
```sql
CREATE TABLE `tb_hotel` (
  `id` bigint(20) NOT NULL COMMENT 'é…’åº—id',    
  `name` varchar(255) NOT NULL COMMENT 'é…’åº—åç§°',
  `address` varchar(255) NOT NULL COMMENT 'é…’åº—åœ°å€',
  `price` int(10) NOT NULL COMMENT 'é…’åº—ä»·æ ¼',
  `score` int(2) NOT NULL COMMENT 'é…’åº—è¯„åˆ†',
  `brand` varchar(32) NOT NULL COMMENT 'é…’åº—å“ç‰Œ',
  `city` varchar(32) NOT NULL COMMENT 'æ‰€åœ¨åŸå¸‚',
  `star_name` varchar(16) DEFAULT NULL COMMENT 'é…’åº—æ˜Ÿçº§ï¼Œ1æ˜Ÿåˆ°5æ˜Ÿï¼Œ1é’»åˆ°5é’»',
  `business` varchar(255) DEFAULT NULL COMMENT 'å•†åœˆ',
  `latitude` varchar(32) NOT NULL COMMENT 'çº¬åº¦',
  `longitude` varchar(32) NOT NULL COMMENT 'ç»åº¦',
  `pic` varchar(255) DEFAULT NULL COMMENT 'é…’åº—å›¾ç‰‡',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=COMPACT;
```

---

ç´¢å¼•æ˜ å°„
```json
{
  "mappings": {
    "properties": {
      "id": {
        "type": "keyword"
      },
      "name": {
        "type": "text",
        "analyzer": "ik_max_word",
        "copy_to": "all"
      },
      "address": {
        "type": "keyword",
        "index": false
      },
      "price": {
        "type": "integer"
      },
      "score": {
        "type": "integer"
      },
      "brand": {
        "type": "keyword",
        "copy_to": "all"
      },
      "city": {
        "type": "keyword",
        "copy_to": "all"
      },
      "starName": {
        "type": "keyword"
      },
      "business": {
        "type": "keyword"
      },
      "location": {
        "type": "geo_point"
      },
      "pic": {
        "type": "keyword",
        "index": false
      },
      "all": {
        "type": "text",
        "analyzer": "ik_max_word"
      }
    }
  }
}
```
---



#### RestClientåˆå§‹åŒ–é…ç½®

pom.xml

```xml
<properties>
	<java.version>1.8</java.version>
	<!--ç”±äºspringbootç®¡ç†äº†es è¿™é‡Œè¦æŒ‡å®šesçš„ç‰ˆæœ¬ ä¸ esæœåŠ¡æ®µç‰ˆæœ¬ä¸€è‡´-->
	<elasticsearch.version>7.12.1</elasticsearch.version>
</properties>

<dependencies>
<!--es-highä¾èµ– - RestAPI-->
	<dependency>
    	<groupId>org.elasticsearch.client</groupId>
    	<artifactId>elasticsearch-rest-high-level-client</artifactId>
	</dependency>
</dependencies>
```



```java
@SpringBootTest(classes = HotelDemoApplication.class)
public class IndexDSLTest {	
    
	private RestHighLevelClient restClient;
    
    @BeforeEach //åˆ›å»º RestClient
    public void initRest() {
        CredentialsProvider credentialsProvider = new BasicCredentialsProvider();
        credentialsProvider.setCredentials(AuthScope.ANY,
                new UsernamePasswordCredentials("user", "password"));
        this.restClient = new RestHighLevelClient(
                RestClient.builder(
                    new HttpHost("ayaka520", 9200, "http"))
                        .setHttpClientConfigCallback(new RestClientBuilder.HttpClientConfigCallback() {
                        public HttpAsyncClientBuilder customizeHttpClient(HttpAsyncClientBuilder httpClientBuilder) {
                            httpClientBuilder.disableAuthCaching();
                            return httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider);
                    }
                })
        );
    }

    @AfterEach //æ¸…é™¤å®¢æˆ·ç«¯
    public void closeRest() throws IOException {
        restClient.close();
    }
    
    //Test
    
}
```



---



#### å®ä½“ç±»çš„è½¬æ¢

MySQL

```java
package com.ganga.hotel.pojo;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

@Data
@TableName("tb_hotel")
public class Hotel {
    @TableId(type = IdType.INPUT)
    private Long id;
    private String name;
    private String address;
    private Integer price;
    private Integer score;
    private String brand;
    private String city;
    private String starName;
    private String business;
    private String longitude;
    private String latitude;
    private String pic;
}
```

ESå®ä½“ç±»

```java
package com.ganga.hotel.pojo;

import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
public class HotelDoc {
    private Long id;
    private String name;
    private String address;
    private Integer price;
    private Integer score;
    private String brand;
    private String city;
    private String starName;
    private String business;
    private String location;
    private String pic;

    public HotelDoc(Hotel hotel) {
        this.id = hotel.getId();
        this.name = hotel.getName();
        this.address = hotel.getAddress();
        this.price = hotel.getPrice();
        this.score = hotel.getScore();
        this.brand = hotel.getBrand();
        this.city = hotel.getCity();
        this.starName = hotel.getStarName();
        this.business = hotel.getBusiness();
        this.location = hotel.getLatitude() + ", " + hotel.getLongitude();
        this.pic = hotel.getPic();
    }
}
```









---

#### å¯¹ç´¢å¼•åº“-DSL



##### **æ·»åŠ ç´¢å¼•åº“**



```java
/**
 * æ·»åŠ ç´¢å¼•åº“
 * @throws IOException
 */
@Test
public void createIndexTest() throws IOException {
    //1.è®¾ç½®Requestå¯¹è±¡ï¼Œå£°æ˜è¯·æ±‚æ–¹å¼å’Œè·¯å¾„ : GET /hotel
    CreateIndexRequest request = new CreateIndexRequest("hotel");
    //2.è®¾ç½®è¯·æ±‚å‚æ•°ï¼Œä¹Ÿå°±æ˜¯DSLè¯­å¥ã€‚
    request.source(CREATE_INDEX_HOTEL, XContentType.JSON);
    //3.å‘èµ·è¯·æ±‚
    restClient.indices().create(request, RequestOptions.DEFAULT);
}
```





##### **åˆ é™¤ç´¢å¼•åº“**

```java
/**
 * åˆ é™¤ç´¢å¼•
 * @throws IOException
 */
@Test
public void deleteIndexTest() throws IOException {
    //1.è®¾ç½®Requestå¯¹è±¡ï¼Œå£°æ˜è¯·æ±‚æ–¹å¼å’Œè·¯å¾„ : DELETE /hotel
    DeleteIndexRequest request = new DeleteIndexRequest("hotel");
    //2.è®¾ç½®è¯·æ±‚å‚æ•°ï¼Œä¹Ÿå°±æ˜¯DSLè¯­å¥ã€‚ æ— å‚æ•°
    //3.å‘èµ·è¯·æ±‚
    restClient.indices().delete(request, RequestOptions.DEFAULT);
}
```



##### ****æŸ¥è¯¢ç´¢å¼•æ˜¯å¦å­˜åœ¨****

```java
/**
 * æŸ¥è¯¢ç´¢å¼•æ˜¯å¦å­˜åœ¨
 * @throws IOException
 */
@Test
public void getIndexTest() throws IOException {
    //1.è®¾ç½®Requestå¯¹è±¡ï¼Œå£°æ˜è¯·æ±‚æ–¹å¼å’Œè·¯å¾„ : GET /hotel
    GetIndexRequest request = new GetIndexRequest("hotel");
    //2.è®¾ç½®è¯·æ±‚å‚æ•°ï¼Œä¹Ÿå°±æ˜¯DSLè¯­å¥ã€‚ æ— å‚æ•°
    //3.å‘èµ·è¯·æ±‚
    boolean exists = restClient.indices().exists(request, RequestOptions.DEFAULT);
    System.out.println(exists);
}
```





---



---



#### å¯¹æ–‡æ¡£çš„-DSL



##### **æ ¹æ®idæ·»åŠ æ–‡æ¡£**

```java
/**
 * æ ¹æ® id æ·»åŠ æ–‡æ¡£
 *
 * @throws IOException
 */
@Test
public void addDocumentTest() throws IOException {
    //1.ä»æ•°æ®åº“ä¸­æŸ¥è¯¢åº—é“º
    Hotel hotel = hotelService.getById(id);
    //2.è½¬æ¢ä¸º HotelDoc ç±»å‹
    HotelDoc hotelDoc = new HotelDoc(hotel);
    //3.åºåˆ—åŒ–ä¸º JSON
    String jsonString = JSON.toJSONString(hotelDoc);
    //1.åˆ›å»ºrequestå¯¹è±¡
    IndexRequest request = new IndexRequest("hotel").id(id.toString());//æ³¨æ„è¦åŠ ä¸Š.id()
    //2.å‡†å¤‡DSLè¯­å¥
    request.source(jsonString, XContentType.JSON);
    //3.å‘èµ·è¯·æ±‚
    restClient.index(request, RequestOptions.DEFAULT);
}
```





##### **æ ¹æ®idæŸ¥è¯¢æ–‡æ¡£**

```java
/**
 * æ ¹æ® id æŸ¥è¯¢æ–‡æ¡£
 *
 * @throws IOException
 */
@Test
public void getDocumentById() throws IOException {
    //1.åˆ›å»ºrequestå¯¹è±¡
    GetRequest request = new GetRequest("hotel").id(id.toString());
    //2.å‡†å¤‡DSLè¯­å¥
    //request.id("197488318");
    //3.å‘èµ·è¯·æ±‚
    GetResponse response = restClient.get(request, RequestOptions.DEFAULT);
    //4.ååºåˆ—åŒ–
    String json = response.getSourceAsString();
    HotelDoc hotelDoc = JSON.parseObject(json, HotelDoc.class);
    System.out.println(hotelDoc);
}



```



##### **æ ¹æ®idä¿®æ”¹æ–‡æ¡£**

```java
/**
 * æ ¹æ®id ä¿®æ”¹æ–‡æ¡£
 *
 * @throws IOException
 */
@Test
public void updateDocumentById() throws IOException {
    //è¿™æ˜¯å¢é‡ä¿®æ”¹ï¼ï¼ï¼
    restClient.update( //å‘: ä¸¤ä¸ªå‚æ•° ä¸€ä¸ªæ˜¯ index ä¸€ä¸ªæ˜¯id è€Œä¸æ˜¯é“¾å¼..... å‘:
            new UpdateRequest("hotel", id.toString()).doc(
                    "name", "ç¥é‡Œç»«å--ç¬¬äºŒå­—æ®µ",
                    "address", "ç¥é‡Œç»«å--ç¬¬äºŒå­—æ®µ"
            ),
            RequestOptions.DEFAULT
    );
}
```





##### **æ ¹æ®idåˆ é™¤æ–‡æ¡£**

```java
/**
 * æ ¹æ® id åˆ é™¤æ–‡æ¡£
 *
 * @throws IOException
 */
@Test
public void deleteDocumentById() throws IOException {
    restClient.delete(
            new DeleteRequest("hotel").id(id.toString()),
            RequestOptions.DEFAULT
    );
}
```



##### **æ ¹æ®idæ‰¹é‡å¯¼å…¥æ–‡æ¡£**

```java
/**
 * æ ¹æ®id æ‰¹é‡å¯¼å…¥æ–‡æ¡£
 */
@Test
public void bulkAddDocById() throws IOException {
    //ä» MySqlä¸­è·å–æ‰€æœ‰æ•°æ®
    List<Hotel> hotels = hotelService.list();
    //åˆ›å»º BulkRequestå¯¹è±¡
    BulkRequest request = new BulkRequest("hotel");
    hotels.forEach(hotel -> {
        //è½¬æ¢ä¸º HotelDoc å¹¶ åºåˆ—åŒ–ä¸º JSON
        String json = JSON.toJSONString(new HotelDoc(hotel));
        //ä½¿ç”¨ add() æ–¹æ³•æ·»åŠ  å•ä¸ª requestæ–¹æ³•  //å‘ï¼šåˆ«å¿˜äº†åŠ  .id()
        request.add(new IndexRequest("hotel").id(hotel.getId().toString()).source(json, XContentType.JSON));
    });
    //è¿™é‡Œä½¿ç”¨ restClient.bulk()
    restClient.bulk(request, RequestOptions.DEFAULT);
}
```







---









#### æ–‡æ¡£æœç´¢-Search







##### **æŸ¥è¯¢æ‰€æœ‰**

```java
/**
 * match_all æŸ¥è¯¢æ‰€æœ‰
 *
 * @throws IOException
 */
@Test
public void matchAllQueryTest() throws IOException {
    //1.å‡†å¤‡requestè¯·æ±‚
    SearchRequest request = new SearchRequest("hotel");
    //2.å‡†å¤‡DSLè¯­å¥
    request.source().query(QueryBuilders.matchAllQuery());
    //3.å‘èµ·è¯·æ±‚
    SearchResponse response = restClient.search(request, RequestOptions.DEFAULT);
    
    
    //è§£æç›¸åº”ç»“æœ åº”å°è£…ä¸ºä¸€ä¸ªå‡½æ•° ä¸‹é¢æœ‰
    SearchHits hits = response.getHits();
    long total = hits.getTotalHits().value;
    System.out.println("å…±æœç´¢åˆ°" + total + "æ¡æ•°æ®");
    //è§£ææ•°æ®
    for (SearchHit hit : hits.getHits()) {
        String json = hit.getSourceAsString();
        //ååºåˆ—åŒ–
        HotelDoc hotelDoc = JSON.parseObject(json, HotelDoc.class);
        System.out.println(hotelDoc + "\n");
    }
}
// ##### è§£æç»“æœ ğŸ‘‡
```







##### **æ£€ç´¢æŸ¥è¯¢**

```java
/**
 * æ£€ç´¢æŸ¥è¯¢
 *
 * @throws IOException
 */
@Test
public void matchQueryTest() throws IOException {
    //å‘èµ·è¯·æ±‚
    SearchRequest request = new SearchRequest("hotel");
    request.source().query(
            QueryBuilders.matchQuery("all", "å¦‚å®¶")
    );
    SearchResponse response = restClient.search(request, RequestOptions.DEFAULT);
    //è§£æç»“æœ
    handleResponse(response);
}
```







##### **å¤åˆæŸ¥è¯¢**

##### **ç²¾ç¡®æŸ¥è¯¢**

```java
/**
 * å¤åˆæŸ¥è¯¢ (å¸ƒå°”æŸ¥è¯¢)
 * ç²¾ç¡®æŸ¥è¯¢ (termã€range)
 *
 * @throws IOException
 */
@Test
public void boolQueryTest() throws IOException {
    SearchRequest request = new SearchRequest("hotel");
    request.source().query(
            //å…ˆæ„å»ºä¸€ä¸ª boolQuery() å¸ƒå°”æŸ¥è¯¢
            QueryBuilders.boolQuery()
                    .must(QueryBuilders.matchQuery("name", "å’Œé¢")) //match æ£€ç´¢æŸ¥è¯¢
                    .must(QueryBuilders.rangeQuery("price").gte(100).lte(300)) //range æ•°å€¼æŸ¥è¯¢
                    .mustNot(QueryBuilders.termQuery("starName", "ä¸€é’»")) //term ç²¾ç¡®æŸ¥è¯¢
                    .mustNot(QueryBuilders.termQuery("starName", "äºŒé’»"))
                    //.must(QueryBuilders.)    // å¿…é¡»åŒ¹é…
                    //.should(QueryBuilders.)  // é€‰æ‹©æ€§åŒ¹é…
                    //.mustNot(QueryBuilders.) // å¿…é¡»ä¸åŒ¹é… ä¸å‚ä¸ç®—åˆ†
                    //.filter(QueryBuilders.)  // å¿…é¡»åŒ¹é…   ä¸å‚ä¸ç®—åˆ†
    );
    SearchResponse response = restClient.search(request, RequestOptions.DEFAULT);
    // è§£æç»“æœ
    handleResponse(response);
}
```







##### **åˆ†é¡µæŸ¥è¯¢**

##### **æ’åºæŸ¥è¯¢**

```java
/**
 * åˆ†é¡µæŸ¥è¯¢
 * æ’åºæŸ¥è¯¢
 * @throws IOException
 */
@Test
public void OrderPageQueryTest() throws IOException {
    // æ¥æ”¶åˆ†é¡µå‚æ•°
    int page = 2, size = 5; // æŸ¥ç¬¬äºŒé¡µ æ¯é¡µ5æ¡
    // åˆ›å»º request
    SearchRequest request = new SearchRequest("hotel");
    // source ç›¸å½“äº jsonæ•°æ®çš„ { }  query,from,size,...éƒ½åœ¨å…¶å†…éƒ¨
    SearchSourceBuilder source = request.source();
    // æŸ¥è¯¢æ¡ä»¶
    source.query(QueryBuilders.matchQuery("all", "å¦‚å®¶"));
    // åˆ†é¡µ
    source.from((page - 1) * size).size(size); // ä»¥å page ä¼šå˜å¾— ç¬¬ä¸€é¡µå°±ä¸º 0
    // æ’åº
    source.sort("price", SortOrder.ASC);
    // å‘é€
    SearchResponse response = restClient.search(request, RequestOptions.DEFAULT);
    // ç»“æœå¤„ç†
    handleResponse(response);
}
```







##### **é«˜äº®æŸ¥è¯¢**

```java
/**
 * é«˜äº®æŸ¥è¯¢
 * é«˜äº®æ•°æ®è§£æ this.handleResponse(response)
 * @throws IOException
 */
@Test
public void addHighlightQueryTest() throws IOException {
    // æ¥æ”¶åˆ†é¡µå‚æ•°
    int page = 2, size = 5; // æŸ¥ç¬¬äºŒé¡µ æ¯é¡µ5æ¡
    // åˆ›å»º request
    SearchRequest request = new SearchRequest("hotel");
    // source ç›¸å½“äº jsonæ•°æ®çš„ { }  query,from,size,...éƒ½åœ¨å…¶å†…éƒ¨
    SearchSourceBuilder source = request.source();
    // æŸ¥è¯¢æ¡ä»¶
    source.query(QueryBuilders.matchQuery("all", "å¦‚å®¶"));
    // åˆ†é¡µ
    source.from((page - 1) * size).size(size); // ä»¥å page ä¼šå˜å¾— ç¬¬ä¸€é¡µå°±ä¸º 0
    // æ’åº
    source.sort("price", SortOrder.ASC);
    // é«˜äº®
    source.highlighter(
            new HighlightBuilder() // è¿™æ˜¯è¦ new ä¸€ä¸ª HighlightBuilder()
                    .field("name")      // field æŒ‡å®šé«˜äº®çš„å­—æ®µ
                    .requireFieldMatch(false) // false å¯¹éæœç´¢å­—æ®µé«˜äº®ï¼Œé»˜è®¤ä¸º true ä¸å¯¹éæœç´¢å­—æ®µé«˜äº®
    );
    // å‘é€
    SearchResponse response = restClient.search(request, RequestOptions.DEFAULT);
    // ç»“æœå¤„ç†
    handleResponse(response);
    // ä¸ºäº†å®ç°é«˜äº® è¿˜éœ€è¦å¯¹ç»“æœè§£æè¿›è¡Œ ç»§ç»­ å¤„ç†
}

```









##### **è§£æç»“æœ**

```java
/**
 * è§£æç»“æœ
 *
 * @param response
 */
private static void handleResponse(SearchResponse response) {
    //è§£æç»“æœ
    long total = response.getHits().getTotalHits().value;
    System.out.println("å…±æœç´¢åˆ°" + total + "æ¡æ•°æ®");
    for (SearchHit hit : response.getHits().getHits()) {
        // è·å–æŸ¥è¯¢æ•°æ®
        String json = hit.getSourceAsString();
        HotelDoc hotelDoc = JSON.parseObject(json, HotelDoc.class);
        // è·å–é«˜äº®æ•°æ®
        Map<String, HighlightField> highlightFields = hit.getHighlightFields();
        if (!CollectionUtils.isEmpty(highlightFields)){
            // è·å–é«˜äº®å­—æ®µ
            HighlightField field = highlightFields.get("name");
            if (field != null){
                String name = field.getFragments()[0].string();
                //æ›¿æ¢åŸæœ‰æ•°æ®
                hotelDoc.setName(name);
            }
        }
        System.out.println(hotelDoc + "\n");
    }
}
```



---





##### å¯¹æ–‡æ¡£çš„-èšåˆ



TODO:









---

---





### é…’åº—æ¡ˆä¾‹ - æœç´¢



#### å®¢æˆ·ç«¯

```java
@Configuration
public class RestClientConfig {

    @Bean
    public RestHighLevelClient restClient() {
        // Http åœ°å€ç«¯å£ åŠ ç”¨æˆ·è®¤è¯
        CredentialsProvider credentialsProvider = new BasicCredentialsProvider();
        credentialsProvider.setCredentials(
                AuthScope.ANY,
                new UsernamePasswordCredentials("elastic", "password"));

        //æ„å»ºRestHighLevelClientå¯¹è±¡
        return new RestHighLevelClient(
                org.elasticsearch.client.RestClient.builder(
                                new HttpHost("ayaka520", 9200, "http"))
                        .setHttpClientConfigCallback(new RestClientBuilder.HttpClientConfigCallback() {
                            public HttpAsyncClientBuilder customizeHttpClient(HttpAsyncClientBuilder httpClientBuilder) {
                                httpClientBuilder.disableAuthCaching();
                                return httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider);
                            }
                        })
        );
    }
}
```







#### å®ä½“ç±»

Hotel : æ¥æ”¶ MySQL æ•°æ®

```java
@Data
@TableName("tb_hotel")
public class Hotel {
    @TableId(type = IdType.INPUT)
    private Long id;
    private String name;
    private String address;
    private Integer price;
    private Integer score;
    private String brand;
    private String city;
    private String starName;
    private String business;
    private String longitude;
    private String latitude;
    private String pic;
}
```

HotelDoc : ç”¨æ¥æ¥æ”¶ ES æ•°æ®

```java
@Data
@NoArgsConstructor
public class HotelDoc {
    private Long id;
    private String name;
    private String address;
    private Integer price;
    private Integer score;
    private String brand;
    private String city;
    private String starName;
    private String business;
    private String location;
    private String pic;
    //ç”¨æˆ·ç›¸å¯¹è·ç¦»å€¼ éæ˜ å°„
    private Object distance;
    //æ˜¯å¦å¼€é€šäº†å¹¿å‘Š true->å¼€é€š
    private Boolean isAD;

    public HotelDoc(Hotel hotel) {
        this.id = hotel.getId();
        this.name = hotel.getName();
        this.address = hotel.getAddress();
        this.price = hotel.getPrice();
        this.score = hotel.getScore();
        this.brand = hotel.getBrand();
        this.city = hotel.getCity();
        this.starName = hotel.getStarName();
        this.business = hotel.getBusiness();
        this.location = hotel.getLatitude() + ", " + hotel.getLongitude();
        this.pic = hotel.getPic();
    }
}
```

RequestParams : æ¥æ”¶å‰ç«¯æ•°æ®

```java
@Data
public class RequestParams {

    private String key;
    private Integer page;
    private Integer size;
    private String sortBy;

    private String brand;
    private String city;
    private String starName;
    private Integer minPrice;
    private Integer maxPrice;
    private String location;

}
```

PageResult : ç”¨æ¥è¿”å›å‰ç«¯æ•°æ®

```java
@Data
public class PageResult {

    private Long total;
    private List<HotelDoc> hotels;

    public PageResult() {
    }

    public PageResult(Long total, List<HotelDoc> hotels) {
        this.total = total;
        this.hotels = hotels;
    }
}
```







#### æ¨¡æ‹Ÿ

æ¨¡æ‹Ÿå¼€é€šå¹¿å‘Š

```java
@Autowired
private RestHighLevelClient restClient;
/**
 * ç»™å‡ ä¸ªhotelæ·»åŠ å¹¿å‘Š
 * @throws IOException
 */
@Test
public void addADTest() throws IOException {
    BulkRequest request = new BulkRequest("hotel");
    request.add(new UpdateRequest("hotel",ADD_AD_TEST_01_ID).doc("isAD",true));
    request.add(new UpdateRequest("hotel",ADD_AD_TEST_02_ID).doc("isAD",true));
    request.add(new UpdateRequest("hotel",ADD_AD_TEST_03_ID).doc("isAD",true));
    restClient.bulk(request, RequestOptions.DEFAULT);
}
```







#### æ¥å£

Postè¯·æ±‚ /hotel/list

```java
@RestController()
@RequestMapping("/hotel")
public class HotelController {

    @Autowired
    private HotelService hotelService;

    @PostMapping("/list")
    public PageResult queryList(@RequestBody RequestParams requestParams){
        return hotelService.searchList(requestParams);
    }
}
```









#### ä¸šåŠ¡å®ç°

```java
@Service
public class HotelService extends ServiceImpl<HotelMapper, Hotel> implements IHotelService {

    @Autowired
    private RestHighLevelClient restClient;

    @Override
    public PageResult searchList(RequestParams requestParams) {

        try {
            // è§£æå‚æ•°
            String key = requestParams.getKey();
            int page = requestParams.getPage();
            int size = requestParams.getSize();
            // åˆ›å»ºè¯·æ±‚
            SearchRequest request = new SearchRequest("hotel");
            SearchSourceBuilder source = request.source();
            // å¸ƒå°”æŸ¥è¯¢ - åŸå§‹æŸ¥è¯¢
            BoolQueryBuilder boolQuery = new BoolQueryBuilder();
            if (ObjectUtils.isEmpty(key)) {
                // æ— æœç´¢å†…å®¹
                boolQuery.must(QueryBuilders.matchAllQuery());
            } else {
                // æœ‰æœç´¢å†…å®¹
                boolQuery.must(QueryBuilders.matchQuery("all", key));
            }
            // æ¡ä»¶æœç´¢ brand ç²¾ç¡®æŸ¥è¯¢
            if (ObjectUtils.isNotEmpty(requestParams.getBrand())) {
                boolQuery.filter(QueryBuilders.termQuery("brand", requestParams.getBrand()));
            }
            // æ¡ä»¶æœç´¢ city ç²¾ç¡®æŸ¥è¯¢
            if (ObjectUtils.isNotEmpty(requestParams.getCity())) {
                boolQuery.filter(QueryBuilders.termQuery("city", requestParams.getCity()));
            }
            // æ¡ä»¶æœç´¢ starName ç²¾ç¡®æŸ¥è¯¢
            if (ObjectUtils.isNotEmpty(requestParams.getStarName())) {
                boolQuery.filter(QueryBuilders.termQuery("starName", requestParams.getStarName()));
            }
            // æ¡ä»¶æŸ¥è¯¢ min/maxPrice èŒƒå›´æŸ¥è¯¢
            if (ObjectUtils.isNotEmpty(requestParams.getMinPrice()) && ObjectUtils.isNotEmpty(requestParams.getMaxPrice())) {
                boolQuery.filter(QueryBuilders.rangeQuery("price")
                        .gte(requestParams.getMinPrice())
                        .lte(requestParams.getMaxPrice()));
            }
            // æ’åº ç®—åˆ†å‡½æ•° å¹¿å‘Šä¼˜å…ˆ
            FunctionScoreQueryBuilder functionScore = QueryBuilders.functionScoreQuery(
                    // åŸå§‹æŸ¥è¯¢ï¼Œç›¸å…³æ€§ç®—åˆ†çš„æŸ¥è¯¢
                    boolQuery,
                    // function scoreçš„æ•°ç»„
                    new FunctionScoreQueryBuilder.FilterFunctionBuilder[]{
                            // å…¶ä¸­çš„ä¸€ä¸ªfunction score å…ƒç´ 
                            new FunctionScoreQueryBuilder.FilterFunctionBuilder(
                                    // è¿‡æ»¤æ¡ä»¶
                                    QueryBuilders.termQuery("isAD", true),
                                    // ç®—åˆ†å‡½æ•°
                                    ScoreFunctionBuilders.weightFactorFunction(10)
                            )
                    });
            // source å†…çš„ query å†…çš„ functionScoreQuery å†…çš„ boolQuery
            // åŸå§‹æŸ¥è¯¢boolQueryæ”¾å…¥functionScore functionScoreæ”¾å…¥query queryæ”¾å…¥source
            source.query(functionScore);


            // æ’åº ä½ç½®
            if (ObjectUtils.isNotEmpty(requestParams.getLocation())) {
                source.sort(SortBuilders.geoDistanceSort("location", new GeoPoint(requestParams.getLocation()))
                        .order(SortOrder.ASC)
                        .unit(DistanceUnit.KILOMETERS)
                );
            }
            // åˆ†é¡µ
            source.from((page - 1) * size).size(size);
            // é«˜äº®
            source.highlighter(new HighlightBuilder().field("name").requireFieldMatch(false));
            // å‘é€è¯·æ±‚
            SearchResponse response = restClient.search(request, RequestOptions.DEFAULT);
            // è¯·æ±‚ç»“æœå¤„ç†
            return this.handleResponse(response);
        } catch (IOException e) {
            throw new RuntimeException(e);
        }

    }

    
    /**
     * è§£æ å°è£…æ•°æ®
     *
     * @param response esæŸ¥è¯¢å…¨éƒ¨æ•°æ®
     * @return PageResult æ•°æ®
     */
    private PageResult handleResponse(SearchResponse response) {
        // è§£ææŸ¥è¯¢æ¡æ•°
        long total = response.getHits().getTotalHits().value;
        // è§£æé…’åº—æ•°æ®
        ArrayList<HotelDoc> hotels = new ArrayList<>();
        for (SearchHit hit : response.getHits().getHits()) {
            String json = hit.getSourceAsString();
            HotelDoc hotel = JSON.parseObject(json, HotelDoc.class);
            //è§£ææ’åºå­—æ®µ --> è·ç¦»
            Object[] sorts = hit.getSortValues();
            if (ObjectUtils.isNotEmpty(sorts)) {
                Object sort = sorts[0];
                hotel.setDistance(sort);
            }
            //é«˜äº®
            Map<String, HighlightField> highlights = hit.getHighlightFields();
            if (ObjectUtils.isNotEmpty(highlights)) {
                HighlightField field = highlights.get("name");
                if (ObjectUtils.isNotEmpty(field)) {
                    hotel.setName(field.getFragments()[0].string());
                }
            }
            //æ·»åŠ åˆ°é›†åˆ
            hotels.add(hotel);
        }
        // å°è£… è¿”å›
        return new PageResult(total, hotels);
    }
}
```





---

---

---







### é…’åº—æ•°æ® - åŒæ­¥



#### æ€è·¯åˆ†æ

elasticsearchä¸­çš„é…’åº—æ•°æ®æ¥è‡ªäºmysqlæ•°æ®åº“ï¼Œå› æ­¤mysqlæ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œelasticsearchä¹Ÿå¿…é¡»è·Ÿç€æ”¹å˜ï¼Œè¿™ä¸ªå°±æ˜¯elasticsearchä¸mysqlä¹‹é—´çš„**æ•°æ®åŒæ­¥**ã€‚



**æ€è·¯åˆ†æ**

å¸¸è§çš„æ•°æ®åŒæ­¥æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼š

- åŒæ­¥è°ƒç”¨
- å¼‚æ­¥é€šçŸ¥
- ç›‘å¬binlog





**æ–¹æ¡ˆä¸€ï¼šåŒæ­¥è°ƒç”¨**

![image-20210723214931869](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210723214931869.png)

åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š

- hotel-demoå¯¹å¤–æä¾›æ¥å£ï¼Œç”¨æ¥ä¿®æ”¹elasticsearchä¸­çš„æ•°æ®
- é…’åº—ç®¡ç†æœåŠ¡åœ¨å®Œæˆæ•°æ®åº“æ“ä½œåï¼Œç›´æ¥è°ƒç”¨hotel-demoæä¾›çš„æ¥å£ï¼Œ





**æ–¹æ¡ˆäºŒï¼šå¼‚æ­¥é€šçŸ¥**

![image-20210723215140735](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210723215140735.png)



æµç¨‹å¦‚ä¸‹ï¼š

- hotel-adminå¯¹mysqlæ•°æ®åº“æ•°æ®å®Œæˆå¢ã€åˆ ã€æ”¹åï¼Œå‘é€MQæ¶ˆæ¯
- hotel-demoç›‘å¬MQï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯åå®Œæˆelasticsearchæ•°æ®ä¿®æ”¹





**æ–¹æ¡ˆä¸‰ï¼šç›‘å¬binlog**

![image-20210723215518541](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210723215518541.png)

æµç¨‹å¦‚ä¸‹ï¼š

- ç»™mysqlå¼€å¯binlogåŠŸèƒ½
- mysqlå®Œæˆå¢ã€åˆ ã€æ”¹æ“ä½œéƒ½ä¼šè®°å½•åœ¨binlogä¸­
- hotel-demoåŸºäºcanalç›‘å¬binlogå˜åŒ–ï¼Œå®æ—¶æ›´æ–°elasticsearchä¸­çš„å†…å®¹





**é€‰æ‹©: **

æ–¹å¼ä¸€ï¼šåŒæ­¥è°ƒç”¨

- ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç²—æš´
- ç¼ºç‚¹ï¼šä¸šåŠ¡è€¦åˆåº¦é«˜

æ–¹å¼äºŒï¼šå¼‚æ­¥é€šçŸ¥

- ä¼˜ç‚¹ï¼šä½è€¦åˆï¼Œå®ç°éš¾åº¦ä¸€èˆ¬
- ç¼ºç‚¹ï¼šä¾èµ–mqçš„å¯é æ€§

æ–¹å¼ä¸‰ï¼šç›‘å¬binlog

- ä¼˜ç‚¹ï¼šå®Œå…¨è§£é™¤æœåŠ¡é—´è€¦åˆ
- ç¼ºç‚¹ï¼šå¼€å¯binlogå¢åŠ æ•°æ®åº“è´Ÿæ‹…ã€å®ç°å¤æ‚åº¦é«˜



---

---



#### ä¾èµ– / é…ç½®

**å¢åˆ æ”¹ - å‘é€æ–¹**

pom.xml

```xml
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

application.yaml

```yaml
spring:
  rabbitmq:
    host: xxx
    username: xxx
    password: xxx
    virtual-host: /
```



**æ¶ˆæ¯æ¥æ”¶æ–¹**

pom.xml

```xml
<properties>
    <java.version>1.8</java.version>
    <!--ç”±äºspringbootç®¡ç†äº†es è¿™é‡Œè¦æŒ‡å®šesçš„ç‰ˆæœ¬ ä¸ esæœåŠ¡æ®µç‰ˆæœ¬ä¸€è‡´-->
    <elasticsearch.version>7.12.1</elasticsearch.version>
</properties>

<dependencies>
    
    <!--es-highä¾èµ– - RestAPI-->
    <dependency>
        <groupId>org.elasticsearch.client</groupId>
        <artifactId>elasticsearch-rest-high-level-client</artifactId>
    </dependency>
    
</dependencies>
</properties>
```



æ³¨å…¥RestClient

```java
package com.ganga.hotel.clients;

import org.apache.http.HttpHost;
import org.apache.http.auth.AuthScope;
import org.apache.http.auth.UsernamePasswordCredentials;
import org.apache.http.client.CredentialsProvider;
import org.apache.http.impl.client.BasicCredentialsProvider;
import org.apache.http.impl.nio.client.HttpAsyncClientBuilder;
import org.elasticsearch.client.RestClientBuilder;
import org.elasticsearch.client.RestHighLevelClient;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class RestClientConfig {

    @Bean
    public RestHighLevelClient restClient() {
        // Http åœ°å€ç«¯å£ åŠ ç”¨æˆ·è®¤è¯
        CredentialsProvider credentialsProvider = new BasicCredentialsProvider();
        credentialsProvider.setCredentials(
                AuthScope.ANY,
                new UsernamePasswordCredentials("username", "password"));

        //æ„å»ºRestHighLevelClientå¯¹è±¡
        return new RestHighLevelClient(
                org.elasticsearch.client.RestClient.builder(
                                new HttpHost("xxx", 9200, "http"))
                        .setHttpClientConfigCallback(new RestClientBuilder.HttpClientConfigCallback() {
                            public HttpAsyncClientBuilder customizeHttpClient(HttpAsyncClientBuilder httpClientBuilder) {
                                httpClientBuilder.disableAuthCaching();
                                return httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider);
                            }
                        })
        );
    }

}
```









#### MqConstantå¸¸é‡

```java
package com.ganga.hotel.constant;

public class MqConstant {

    /**
     * äº¤æ¢æœº
     */
    public static final String HOTEL_EXCHANGE = "hotel.exchange";

    /**
     * æ¶ˆæ¯é˜Ÿåˆ—
     */
    public static final String HOTEL_INSERT_QUEUE = "hotel.insert.queue";
    public static final String HOTEL_DELETE_QUEUE = "hotel.delete.queue";


    /**
     * æ–°å¢ æˆ– ä¿®æ”¹ çš„ RoutingKey
     */
    public static final String HOTEL_INSERT_KEY = "hotel.insert";
    public static final String HOTEL_DELETE_KEY = "hotel.delete";
}
```





#### MqConfigé…ç½®

```java
package com.ganga.hotel.config;

import com.ganga.hotel.constant.MqConstant;
import org.springframework.amqp.core.Binding;
import org.springframework.amqp.core.BindingBuilder;
import org.springframework.amqp.core.Queue;
import org.springframework.amqp.core.TopicExchange;
import org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;
import org.springframework.amqp.support.converter.MessageConverter;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class MqConfig {

    /**
     * è‡ªå®šä¹‰ æ¶ˆæ¯è½¬æ¢å™¨
     * @return new Jackson2JsonMessageConverter()
     */
    @Bean
    public MessageConverter jsonMessageConverter(){
        return new Jackson2JsonMessageConverter();
    }

    /**
     *
     * @return Topicäº¤æ¢æœº
     */
    @Bean
    public TopicExchange topicExchange() {
        return new TopicExchange(MqConstant.HOTEL_EXCHANGE, true, false);
    }

    /**
     *
     * @return æ–°å¢ / ä¿®æ”¹ çš„æ¶ˆæ¯é˜Ÿåˆ—
     */
    @Bean
    public Queue insertQueue() {
        return new Queue(MqConstant.HOTEL_INSERT_QUEUE, true);
    }

    /**
     * åˆ é™¤ çš„æ¶ˆæ¯é˜Ÿåˆ—
     * @return
     */
    @Bean
    public Queue deleteQueue() {
        return new Queue(MqConstant.HOTEL_DELETE_QUEUE, true);
    }

    /**
     * æ¶ˆæ¯é˜Ÿåˆ— ä¸ äº¤æ¢æœº ç»‘å®š
     * æ³¨æ„ï¼šåˆ«å¿˜äº†åŠ ä¸Š RoutingKey ï¼ï¼ï¼
     * @return Binding
     */
    @Bean
    public Binding bindingInsertQueue() {
        return BindingBuilder.bind(insertQueue()).to(topicExchange()).with(MqConstant.HOTEL_INSERT_KEY);
    }

    @Bean
    public Binding bindingDeleteQueue(){
        return BindingBuilder.bind(deleteQueue()).to(topicExchange()).with(MqConstant.HOTEL_DELETE_KEY);
    }

}
```

















#### HotelController å‘é€æ¶ˆæ¯

```java
package com.ganga.hotel.web;

import com.ganga.hotel.pojo.Hotel;
import com.ganga.hotel.pojo.PageResult;
import com.ganga.hotel.service.IHotelService;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.security.InvalidParameterException;

import static com.ganga.hotel.constant.MqConstant.*;

@RestController
@RequestMapping("hotel")
public class HotelController {

    @Autowired
    private IHotelService hotelService;
	
    //æ³¨å…¥ RabbitTemplate
    @Autowired
    private RabbitTemplate rabbitTemplate;

    @GetMapping("/{id}")
    public Hotel queryById(@PathVariable("id") Long id) {
        return hotelService.getById(id);
    }

    @GetMapping("/list")
    public PageResult hotelList(
            @RequestParam(value = "page", defaultValue = "1") Integer page,
            @RequestParam(value = "size", defaultValue = "1") Integer size
    ) {
        Page<Hotel> result = hotelService.page(new Page<>(page, size));

        return new PageResult(result.getTotal(), result.getRecords());
    }

    /**
     * æ–°å¢
     *
     * @param hotel
     */
    @PostMapping
    public void saveHotel(@RequestBody Hotel hotel) {

        //æ•°æ®åº“æ–°å¢æ•°æ®
        boolean isSuccess = hotelService.save(hotel);
        System.out.println(hotel.getId());
        //å‘é€æ¶ˆæ¯ æ›´æ–°ç´¢å¼•
        if (isSuccess) {
            // HOTEL_EXCHANGE äº¤æ¢æœº, KEY , æ•°æ® -> ä¸ºäº†å‡å°æ¶ˆæ¯ä½“ç§¯ åªå‘ä¸ªidå°±è¡Œ
            rabbitTemplate.convertAndSend(HOTEL_EXCHANGE, HOTEL_INSERT_KEY, hotel.getId());
        }
    }

    /**
     * ä¿®æ”¹
     *
     * @param hotel
     */
    @PutMapping()
    public void updateById(@RequestBody Hotel hotel) {
        if (hotel.getId() == null) {
            throw new InvalidParameterException("idä¸èƒ½ä¸ºç©º");
        }
        boolean isSuccess = hotelService.updateById(hotel);
        if (isSuccess) {
            // å‘é€æ¶ˆæ¯
            rabbitTemplate.convertAndSend(HOTEL_EXCHANGE, HOTEL_INSERT_KEY, hotel.getId());
        }
    }

    /**
     * åˆ é™¤
     *
     * @param id
     */
    @DeleteMapping("/{id}")
    public void deleteById(@PathVariable("id") Long id) {
        boolean isSuccess = hotelService.removeById(id);
        if (isSuccess) {
            // å‘é€æ¶ˆæ¯
            rabbitTemplate.convertAndSend(HOTEL_EXCHANGE, HOTEL_DELETE_KEY, id);
        }
    }
}
```





#### MqListener-ç›‘å¬æ¶ˆæ¯

```java
package com.ganga.hotel.mq;

import com.alibaba.fastjson.JSON;
import com.baomidou.mybatisplus.core.toolkit.ObjectUtils;
import com.ganga.hotel.constant.MqConstant;
import com.ganga.hotel.pojo.Hotel;
import com.ganga.hotel.pojo.HotelDoc;
import com.ganga.hotel.service.impl.HotelService;
import org.elasticsearch.action.delete.DeleteRequest;
import org.elasticsearch.action.index.IndexRequest;
import org.elasticsearch.action.update.UpdateRequest;
import org.elasticsearch.client.RequestOptions;
import org.elasticsearch.client.RestClient;
import org.elasticsearch.client.RestHighLevelClient;
import org.elasticsearch.common.xcontent.XContentType;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.amqp.rabbit.annotation.RabbitListeners;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.io.IOException;

@Component
public class MqListener {

    @Autowired
    private HotelService hotelService;
    @Autowired
    private RestHighLevelClient restClient;

    @RabbitListener(queues = MqConstant.HOTEL_INSERT_QUEUE)
    public void insertOrUpdateQueue(Long id) {
        //æ ¹æ®é˜Ÿåˆ—ä¸­çš„ id æŸ¥è¯¢æ•°æ®åº“
        Hotel hotel = hotelService.getById(id);
        HotelDoc hotelDoc = new HotelDoc(hotel);
        System.err.println(JSON.toJSONString(hotelDoc));
        try {
            //æ›´æ–° ES æ–‡æ¡£
            IndexRequest request = new IndexRequest("hotel").id(id.toString());
            request.source(JSON.toJSONString(hotelDoc), XContentType.JSON);
            restClient.index(request, RequestOptions.DEFAULT);
        } catch (IOException e) {
            throw new RuntimeException(e);
        }

    }

    @RabbitListener(queues = MqConstant.HOTEL_DELETE_QUEUE)
    public void deleteQueue(String id) {
        System.err.println(id);
        try {
            // æ ¹æ® id åˆ é™¤ ES ä¸­çš„æ–‡æ¡£
            DeleteRequest request = new DeleteRequest("hotel").id(id);
            restClient.delete(request, RequestOptions.DEFAULT);
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }

}
```



---

---







---





## ğŸŒ¸ğŸŒ¸ğŸŒ¸ğŸŒ¸ğŸŒ¸

**å¾®æœåŠ¡é«˜çº§**

---









## â›‘ï¸å¾®æœåŠ¡ä¿æŠ¤







é›ªå´©é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ



### é›ªå´©é—®é¢˜





å¾®æœåŠ¡ä¸­ï¼ŒæœåŠ¡é—´è°ƒç”¨å…³ç³»é”™ç»¼å¤æ‚ï¼Œä¸€ä¸ªå¾®æœåŠ¡å¾€å¾€ä¾èµ–äºå¤šä¸ªå…¶å®ƒå¾®æœåŠ¡ã€‚

![1533829099748](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/1533829099748.png)



å¦‚å›¾ï¼Œå¦‚æœæœåŠ¡æä¾›è€…Iå‘ç”Ÿäº†æ•…éšœï¼Œå½“å‰çš„åº”ç”¨çš„éƒ¨åˆ†ä¸šåŠ¡å› ä¸ºä¾èµ–äºæœåŠ¡Iï¼Œå› æ­¤ä¹Ÿä¼šè¢«é˜»å¡ã€‚æ­¤æ—¶ï¼Œå…¶å®ƒä¸ä¾èµ–äºæœåŠ¡Içš„ä¸šåŠ¡ä¼¼ä¹ä¸å—å½±å“ã€‚

![1533829198240](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/1533829198240.png)

ä½†æ˜¯ï¼Œä¾èµ–æœåŠ¡Içš„ä¸šåŠ¡è¯·æ±‚è¢«é˜»å¡ï¼Œç”¨æˆ·ä¸ä¼šå¾—åˆ°å“åº”ï¼Œåˆ™tomcatçš„è¿™ä¸ªçº¿ç¨‹ä¸ä¼šé‡Šæ”¾ï¼Œäºæ˜¯è¶Šæ¥è¶Šå¤šçš„ç”¨æˆ·è¯·æ±‚åˆ°æ¥ï¼Œè¶Šæ¥è¶Šå¤šçš„çº¿ç¨‹ä¼šé˜»å¡ï¼š

![1533829307389](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/1533829307389.png)

æœåŠ¡å™¨æ”¯æŒçš„çº¿ç¨‹å’Œå¹¶å‘æ•°æœ‰é™ï¼Œè¯·æ±‚ä¸€ç›´é˜»å¡ï¼Œä¼šå¯¼è‡´æœåŠ¡å™¨èµ„æºè€—å°½ï¼Œä»è€Œå¯¼è‡´æ‰€æœ‰å…¶å®ƒæœåŠ¡éƒ½ä¸å¯ç”¨ï¼Œé‚£ä¹ˆå½“å‰æœåŠ¡ä¹Ÿå°±ä¸å¯ç”¨äº†ã€‚

é‚£ä¹ˆï¼Œä¾èµ–äºå½“å‰æœåŠ¡çš„å…¶å®ƒæœåŠ¡éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæœ€ç»ˆä¹Ÿéƒ½ä¼šå˜çš„ä¸å¯ç”¨ï¼Œå½¢æˆçº§è”å¤±è´¥ï¼Œé›ªå´©å°±å‘ç”Ÿäº†ï¼š

![image-20210715172710340](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210715172710340.png)





---



#### è§£å†³æ–¹æ¡ˆ:



**è§£å†³é›ªå´©é—®é¢˜çš„å¸¸è§æ–¹å¼æœ‰å››ç§ï¼š**

- è¶…æ—¶å¤„ç†
- ä»“ç’§æ¨¡å¼
- æ–­è·¯å™¨
- é™æµ







#### ä¸€ã€è¶…æ—¶å¤„ç†



â€¢è¶…æ—¶å¤„ç†ï¼šè®¾å®šè¶…æ—¶æ—¶é—´ï¼Œè¯·æ±‚è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰å“åº”å°±è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œä¸ä¼šæ— ä¼‘æ­¢ç­‰å¾…

![image-20210715172820438](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210715172820438.png)





#### äºŒã€ä»“å£æ¨¡å¼

æ–¹æ¡ˆ2ï¼šä»“å£æ¨¡å¼

ä»“å£æ¨¡å¼æ¥æºäºèˆ¹èˆ±çš„è®¾è®¡ï¼š

![image-20210715172946352](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210715172946352.png)

èˆ¹èˆ±éƒ½ä¼šè¢«éš”æ¿åˆ†ç¦»ä¸ºå¤šä¸ªç‹¬ç«‹ç©ºé—´ï¼Œå½“èˆ¹ä½“ç ´æŸæ—¶ï¼Œåªä¼šå¯¼è‡´éƒ¨åˆ†ç©ºé—´è¿›å…¥ï¼Œå°†æ•…éšœæ§åˆ¶åœ¨ä¸€å®šèŒƒå›´å†…ï¼Œé¿å…æ•´ä¸ªèˆ¹ä½“éƒ½è¢«æ·¹æ²¡ã€‚



äºæ­¤ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥é™å®šæ¯ä¸ªä¸šåŠ¡èƒ½ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œé¿å…è€—å°½æ•´ä¸ªtomcatçš„èµ„æºï¼Œå› æ­¤ä¹Ÿå«çº¿ç¨‹éš”ç¦»ã€‚

![image-20210715173215243](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210715173215243.png)



#### ä¸‰ã€æ–­è·¯å™¨

æ–­è·¯å™¨æ¨¡å¼ï¼šç”±**æ–­è·¯å™¨**ç»Ÿè®¡ä¸šåŠ¡æ‰§è¡Œçš„å¼‚å¸¸æ¯”ä¾‹ï¼Œå¦‚æœè¶…å‡ºé˜ˆå€¼åˆ™ä¼š**ç†”æ–­**è¯¥ä¸šåŠ¡ï¼Œæ‹¦æˆªè®¿é—®è¯¥ä¸šåŠ¡çš„ä¸€åˆ‡è¯·æ±‚ã€‚

æ–­è·¯å™¨ä¼šç»Ÿè®¡è®¿é—®æŸä¸ªæœåŠ¡çš„è¯·æ±‚æ•°é‡ï¼Œå¼‚å¸¸æ¯”ä¾‹ï¼š

![image-20210715173327075](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210715173327075.png)

å½“å‘ç°è®¿é—®æœåŠ¡Dçš„è¯·æ±‚å¼‚å¸¸æ¯”ä¾‹è¿‡é«˜æ—¶ï¼Œè®¤ä¸ºæœåŠ¡Dæœ‰å¯¼è‡´é›ªå´©çš„é£é™©ï¼Œä¼šæ‹¦æˆªè®¿é—®æœåŠ¡Dçš„ä¸€åˆ‡è¯·æ±‚ï¼Œå½¢æˆç†”æ–­ï¼š

![image-20210715173428073](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210715173428073.png)



#### å››ã€é™æµ

**æµé‡æ§åˆ¶**ï¼šé™åˆ¶ä¸šåŠ¡è®¿é—®çš„QPSï¼Œé¿å…æœåŠ¡å› æµé‡çš„çªå¢è€Œæ•…éšœã€‚

![image-20210715173555158](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210715173555158.png)







---





#### æ€»ç»“

ä»€ä¹ˆæ˜¯é›ªå´©é—®é¢˜ï¼Ÿ

- å¾®æœåŠ¡ä¹‹é—´ç›¸äº’è°ƒç”¨ï¼Œå› ä¸ºè°ƒç”¨é“¾ä¸­çš„ä¸€ä¸ªæœåŠ¡æ•…éšœï¼Œå¼•èµ·æ•´ä¸ªé“¾è·¯éƒ½æ— æ³•è®¿é—®çš„æƒ…å†µã€‚



å¯ä»¥è®¤ä¸ºï¼š

**é™æµ**æ˜¯å¯¹æœåŠ¡çš„ä¿æŠ¤ï¼Œé¿å…å› ç¬é—´é«˜å¹¶å‘æµé‡è€Œå¯¼è‡´æœåŠ¡æ•…éšœï¼Œè¿›è€Œé¿å…é›ªå´©ã€‚æ˜¯ä¸€ç§**é¢„é˜²**æªæ–½ã€‚

**è¶…æ—¶å¤„ç†ã€çº¿ç¨‹éš”ç¦»ã€é™çº§ç†”æ–­**æ˜¯åœ¨éƒ¨åˆ†æœåŠ¡æ•…éšœæ—¶ï¼Œå°†æ•…éšœæ§åˆ¶åœ¨ä¸€å®šèŒƒå›´ï¼Œé¿å…é›ªå´©ã€‚æ˜¯ä¸€ç§**è¡¥æ•‘**æªæ–½ã€‚





### æœåŠ¡ä¿æŠ¤æŠ€æœ¯å¯¹æ¯”

åœ¨SpringCloudå½“ä¸­æ”¯æŒå¤šç§æœåŠ¡ä¿æŠ¤æŠ€æœ¯ï¼š

- [Netfix Hystrix](https://github.com/Netflix/Hystrix)
- [Sentinel](https://github.com/alibaba/Sentinel)
- [Resilience4J](https://github.com/resilience4j/resilience4j)

æ—©æœŸæ¯”è¾ƒæµè¡Œçš„æ˜¯Hystrixæ¡†æ¶ï¼Œä½†ç›®å‰å›½å†…å®ç”¨æœ€å¹¿æ³›çš„è¿˜æ˜¯é˜¿é‡Œå·´å·´çš„Sentinelæ¡†æ¶ï¼Œè¿™é‡Œæˆ‘ä»¬åšä¸‹å¯¹æ¯”ï¼š

|                | **Sentinel**                                   | **Hystrix**                   |
| -------------- | ---------------------------------------------- | ----------------------------- |
| éš”ç¦»ç­–ç•¥       | ä¿¡å·é‡éš”ç¦»                                     | çº¿ç¨‹æ± éš”ç¦»/ä¿¡å·é‡éš”ç¦»         |
| ç†”æ–­é™çº§ç­–ç•¥   | åŸºäºæ…¢è°ƒç”¨æ¯”ä¾‹æˆ–å¼‚å¸¸æ¯”ä¾‹                       | åŸºäºå¤±è´¥æ¯”ç‡                  |
| å®æ—¶æŒ‡æ ‡å®ç°   | æ»‘åŠ¨çª—å£                                       | æ»‘åŠ¨çª—å£ï¼ˆåŸºäº RxJavaï¼‰       |
| è§„åˆ™é…ç½®       | æ”¯æŒå¤šç§æ•°æ®æº                                 | æ”¯æŒå¤šç§æ•°æ®æº                |
| æ‰©å±•æ€§         | å¤šä¸ªæ‰©å±•ç‚¹                                     | æ’ä»¶çš„å½¢å¼                    |
| åŸºäºæ³¨è§£çš„æ”¯æŒ | æ”¯æŒ                                           | æ”¯æŒ                          |
| é™æµ           | åŸºäº QPSï¼Œæ”¯æŒåŸºäºè°ƒç”¨å…³ç³»çš„é™æµ               | æœ‰é™çš„æ”¯æŒ                    |
| æµé‡æ•´å½¢       | æ”¯æŒæ…¢å¯åŠ¨ã€åŒ€é€Ÿæ’é˜Ÿæ¨¡å¼                       | ä¸æ”¯æŒ                        |
| ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤ | æ”¯æŒ                                           | ä¸æ”¯æŒ                        |
| æ§åˆ¶å°         | å¼€ç®±å³ç”¨ï¼Œå¯é…ç½®è§„åˆ™ã€æŸ¥çœ‹ç§’çº§ç›‘æ§ã€æœºå™¨å‘ç°ç­‰ | ä¸å®Œå–„                        |
| å¸¸è§æ¡†æ¶çš„é€‚é… | Servletã€Spring Cloudã€Dubboã€gRPC  ç­‰         | Servletã€Spring Cloud Netflix |





---

---





### Sentinel



Sentinelæ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€æ¬¾å¾®æœåŠ¡æµé‡æ§åˆ¶ç»„ä»¶ã€‚å®˜ç½‘åœ°å€ï¼šhttps://sentinelguard.io/zh-cn/index.html

Sentinel å…·æœ‰ä»¥ä¸‹ç‰¹å¾:

â€¢**ä¸°å¯Œçš„åº”ç”¨åœºæ™¯**ï¼šSentinel æ‰¿æ¥äº†é˜¿é‡Œå·´å·´è¿‘ 10 å¹´çš„åŒåä¸€å¤§ä¿ƒæµé‡çš„æ ¸å¿ƒåœºæ™¯ï¼Œä¾‹å¦‚ç§’æ€ï¼ˆå³çªå‘æµé‡æ§åˆ¶åœ¨ç³»ç»Ÿå®¹é‡å¯ä»¥æ‰¿å—çš„èŒƒå›´ï¼‰ã€æ¶ˆæ¯å‰Šå³°å¡«è°·ã€é›†ç¾¤æµé‡æ§åˆ¶ã€å®æ—¶ç†”æ–­ä¸‹æ¸¸ä¸å¯ç”¨åº”ç”¨ç­‰ã€‚

â€¢**å®Œå¤‡çš„å®æ—¶ç›‘æ§**ï¼šSentinel åŒæ—¶æä¾›å®æ—¶çš„ç›‘æ§åŠŸèƒ½ã€‚æ‚¨å¯ä»¥åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°æ¥å…¥åº”ç”¨çš„å•å°æœºå™¨ç§’çº§æ•°æ®ï¼Œç”šè‡³ 500 å°ä»¥ä¸‹è§„æ¨¡çš„é›†ç¾¤çš„æ±‡æ€»è¿è¡Œæƒ…å†µã€‚

â€¢**å¹¿æ³›çš„å¼€æºç”Ÿæ€**ï¼šSentinel æä¾›å¼€ç®±å³ç”¨çš„ä¸å…¶å®ƒå¼€æºæ¡†æ¶/åº“çš„æ•´åˆæ¨¡å—ï¼Œä¾‹å¦‚ä¸ Spring Cloudã€Dubboã€gRPC çš„æ•´åˆã€‚æ‚¨åªéœ€è¦å¼•å…¥ç›¸åº”çš„ä¾èµ–å¹¶è¿›è¡Œç®€å•çš„é…ç½®å³å¯å¿«é€Ÿåœ°æ¥å…¥ Sentinelã€‚

â€¢**å®Œå–„çš„** **SPI** **æ‰©å±•ç‚¹**ï¼šSentinel æä¾›ç®€å•æ˜“ç”¨ã€å®Œå–„çš„ SPI æ‰©å±•æ¥å£ã€‚æ‚¨å¯ä»¥é€šè¿‡å®ç°æ‰©å±•æ¥å£æ¥å¿«é€Ÿåœ°å®šåˆ¶é€»è¾‘ã€‚ä¾‹å¦‚å®šåˆ¶è§„åˆ™ç®¡ç†ã€é€‚é…åŠ¨æ€æ•°æ®æºç­‰ã€‚



---





#### å®‰è£…è¿è¡Œ



ä¸‹è½½

sentinelå®˜æ–¹æä¾›äº†UIæ§åˆ¶å°ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¯¹ç³»ç»Ÿåšé™æµè®¾ç½®ã€‚åœ¨[GitHub](https://github.com/alibaba/Sentinel/releases)ä¸‹è½½ã€‚

ä¸‹è½½å¥½çš„jaråŒ…ï¼š

![image-20210715174252531](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210715174252531.png)



è¿è¡Œ

å°†jaråŒ…æ”¾åˆ°ä»»æ„éä¸­æ–‡ç›®å½•ï¼Œæ‰§è¡Œå‘½ä»¤ï¼š

```sh
java -jar sentinel-dashboard-1.8.1.jar
```

å¦‚æœè¦ä¿®æ”¹Sentinelçš„é»˜è®¤ç«¯å£ã€è´¦æˆ·ã€å¯†ç ï¼Œå¯ä»¥é€šè¿‡ä¸‹åˆ—é…ç½®ï¼š

| **é…ç½®é¡¹**                       | **é»˜è®¤å€¼** | **è¯´æ˜**   |
| -------------------------------- | ---------- | ---------- |
| server.port                      | 8080       | æœåŠ¡ç«¯å£   |
| sentinel.dashboard.auth.username | sentinel   | é»˜è®¤ç”¨æˆ·å |
| sentinel.dashboard.auth.password | sentinel   | é»˜è®¤å¯†ç    |

ä¾‹å¦‚ï¼Œä¿®æ”¹ç«¯å£ï¼š

```sh
java -jar sentinel-dashboard-1.8.1.jar --server.port=8090
```



è®¿é—®

è®¿é—®http://localhost:8080é¡µé¢ï¼Œå°±å¯ä»¥çœ‹åˆ°sentinelçš„æ§åˆ¶å°äº†ï¼š

![image-20210715190827846](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210715190827846.png)

éœ€è¦è¾“å…¥è´¦å·å’Œå¯†ç ï¼Œé»˜è®¤éƒ½æ˜¯ï¼šsentinel



ç™»å½•åï¼Œå‘ç°ä¸€ç‰‡ç©ºç™½ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ï¼š

![image-20210715191134448](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210715191134448.png)

è¿™æ˜¯å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰ä¸å¾®æœåŠ¡æ•´åˆã€‚







---





#### å¾®æœåŠ¡æ•´åˆSentinel





æˆ‘ä»¬åœ¨order-serviceä¸­æ•´åˆsentinelï¼Œå¹¶è¿æ¥sentinelçš„æ§åˆ¶å°ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

ä¸€ã€å¼•å…¥sentinelä¾èµ–

```xml
<!--sentinel-->
<dependency>
    <groupId>com.alibaba.cloud</groupId> 
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>
```



é…ç½®æ§åˆ¶å°

äºŒã€ä¿®æ”¹application.yamlæ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢å†…å®¹ï¼š

```yaml
server:
  port: 8088
spring:
  cloud: 
    sentinel:
      transport:
        dashboard: localhost:8080
```



ä¸‰ã€è®¿é—®order-serviceçš„ä»»æ„ç«¯ç‚¹

æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®http://localhost:8088/order/101ï¼Œè¿™æ ·æ‰èƒ½è§¦å‘sentinelçš„ç›‘æ§ã€‚

ç„¶åå†è®¿é—®sentinelçš„æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æ•ˆæœï¼š

![image-20210715191241799](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210715191241799.png)





---





#### ç°‡ç‚¹é“¾è·¯

â€‹	å½“è¯·æ±‚è¿›å…¥å¾®æœåŠ¡æ—¶ï¼Œé¦–å…ˆä¼šè®¿é—®DispatcherServletï¼Œç„¶åè¿›å…¥Controllerã€Serviceã€Mapperï¼Œè¿™æ ·çš„ä¸€ä¸ªè°ƒç”¨é“¾å°±å«åš**ç°‡ç‚¹é“¾è·¯**ã€‚ç°‡ç‚¹é“¾è·¯ä¸­è¢«ç›‘æ§çš„æ¯ä¸€ä¸ªæ¥å£å°±æ˜¯ä¸€ä¸ª**èµ„æº**ã€‚

é»˜è®¤æƒ…å†µä¸‹sentinelä¼šç›‘æ§SpringMVCçš„æ¯ä¸€ä¸ªç«¯ç‚¹ï¼ˆEndpointï¼Œä¹Ÿå°±æ˜¯controllerä¸­çš„æ–¹æ³•ï¼‰ï¼Œ

å› æ­¤SpringMVCçš„æ¯ä¸€ä¸ªç«¯ç‚¹ï¼ˆEndpointï¼‰å°±æ˜¯è°ƒç”¨é“¾è·¯ä¸­çš„ä¸€ä¸ªèµ„æºã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬åˆšæ‰è®¿é—®çš„`order-service`ä¸­çš„`OrderController`ä¸­çš„ç«¯ç‚¹ï¼š`/order/{orderId}`

![image-20210715191757319](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210715191757319-167819320216615.png)

**æµæ§**ã€**ç†”æ–­** ç­‰ éƒ½æ˜¯é’ˆå¯¹ç°‡ç‚¹é“¾è·¯ä¸­çš„èµ„æºæ¥è®¾ç½®çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç‚¹å‡»å¯¹åº”èµ„æºåé¢çš„æŒ‰é’®æ¥è®¾ç½®è§„åˆ™ï¼š

- æµæ§ï¼šæµé‡æ§åˆ¶
- é™çº§ï¼šé™çº§ç†”æ–­
- çƒ­ç‚¹ï¼šçƒ­ç‚¹å‚æ•°é™æµï¼Œæ˜¯é™æµçš„ä¸€ç§
- æˆæƒï¼šè¯·æ±‚çš„æƒé™æ§åˆ¶



---



#### æµé‡æ§åˆ¶



åŸºæœ¬æ“ä½œï¼š

ç‚¹å‡»èµ„æº/order/{orderId}åé¢çš„æµæ§æŒ‰é’®ï¼Œå°±å¯ä»¥å¼¹å‡ºè¡¨å•ã€‚

è¡¨å•ä¸­å¯ä»¥å¡«å†™é™æµè§„åˆ™ï¼Œå¦‚ä¸‹ï¼š

![image-20210715192010657](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210715192010657.png)

å…¶å«ä¹‰æ˜¯é™åˆ¶ /order/{orderId}è¿™ä¸ªèµ„æºçš„å•æœºQPSä¸º1ï¼Œå³æ¯ç§’åªå…è®¸1æ¬¡è¯·æ±‚ï¼Œè¶…å‡ºçš„è¯·æ±‚ä¼šè¢«æ‹¦æˆªå¹¶æŠ¥é”™ã€‚







##### æµæ§æ¨¡å¼

åœ¨æ·»åŠ é™æµè§„åˆ™æ—¶ï¼Œç‚¹å‡»é«˜çº§é€‰é¡¹ï¼Œå¯ä»¥é€‰æ‹©ä¸‰ç§**æµæ§æ¨¡å¼**ï¼š

- ç›´æ¥ï¼šç»Ÿè®¡å½“å‰èµ„æºçš„è¯·æ±‚ï¼Œè§¦å‘é˜ˆå€¼æ—¶å¯¹å½“å‰èµ„æºç›´æ¥é™æµï¼Œä¹Ÿæ˜¯é»˜è®¤çš„æ¨¡å¼
- å…³è”ï¼šç»Ÿè®¡ä¸å½“å‰èµ„æºç›¸å…³çš„å¦ä¸€ä¸ªèµ„æºï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œå¯¹å½“å‰èµ„æºé™æµ
- é“¾è·¯ï¼šç»Ÿè®¡ä»æŒ‡å®šé“¾è·¯è®¿é—®åˆ°æœ¬èµ„æºçš„è¯·æ±‚ï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œå¯¹æŒ‡å®šé“¾è·¯é™æµ

![image-20230307212536664](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230307212536664.png)



###### **ç›´è¿æ¨¡å¼**

ç»Ÿè®¡å½“å‰èµ„æºçš„è¯·æ±‚ï¼Œè§¦å‘é˜ˆå€¼æ—¶å¯¹å½“å‰èµ„æºç›´æ¥é™æµï¼Œä¹Ÿæ˜¯é»˜è®¤çš„æ¨¡å¼



###### **å…³è”æ¨¡å¼**

ç»Ÿè®¡ä¸å½“å‰èµ„æºç›¸å…³çš„å¦ä¸€ä¸ªèµ„æºï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œå¯¹å½“å‰èµ„æºé™æµ

**é…ç½®è§„åˆ™**ï¼š

![image-20210715202540786](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210715202540786.png)

**è¯­æ³•è¯´æ˜**ï¼šå½“/writeèµ„æºè®¿é—®é‡è§¦å‘é˜ˆå€¼æ—¶ï¼Œå°±ä¼šå¯¹/readèµ„æºé™æµï¼Œé¿å…å½±å“/writeèµ„æºã€‚



**ä½¿ç”¨åœºæ™¯**ï¼šæ¯”å¦‚ç”¨æˆ·æ”¯ä»˜æ—¶éœ€è¦ä¿®æ”¹è®¢å•çŠ¶æ€ï¼ŒåŒæ—¶ç”¨æˆ·è¦æŸ¥è¯¢è®¢å•ã€‚æŸ¥è¯¢å’Œä¿®æ”¹æ“ä½œä¼šäº‰æŠ¢æ•°æ®åº“é”ï¼Œäº§ç”Ÿç«äº‰ã€‚ä¸šåŠ¡éœ€æ±‚æ˜¯ä¼˜å…ˆæ”¯ä»˜å’Œæ›´æ–°è®¢å•çš„ä¸šåŠ¡ï¼Œå› æ­¤å½“ä¿®æ”¹è®¢å•ä¸šåŠ¡è§¦å‘é˜ˆå€¼æ—¶ï¼Œéœ€è¦å¯¹æŸ¥è¯¢è®¢å•ä¸šåŠ¡é™æµã€‚



**éœ€æ±‚è¯´æ˜**ï¼š

- åœ¨OrderControlleræ–°å»ºä¸¤ä¸ªç«¯ç‚¹ï¼š/order/queryå’Œ/order/updateï¼Œæ— éœ€å®ç°ä¸šåŠ¡

- é…ç½®æµæ§è§„åˆ™ï¼Œå½“/order/ updateèµ„æºè¢«è®¿é—®çš„QPSè¶…è¿‡5æ—¶ï¼Œå¯¹/order/queryè¯·æ±‚é™æµ



1ï¼‰å®šä¹‰/order/queryç«¯ç‚¹ï¼Œæ¨¡æ‹Ÿè®¢å•æŸ¥è¯¢

```java
@GetMapping("/query")
public String queryOrder() {
    return "æŸ¥è¯¢è®¢å•æˆåŠŸ";
}
```

2ï¼‰å®šä¹‰/order/updateç«¯ç‚¹ï¼Œæ¨¡æ‹Ÿè®¢å•æ›´æ–°

```java
@GetMapping("/update")
public String updateOrder() {
    return "æ›´æ–°è®¢å•æˆåŠŸ";
}
```

é‡å¯æœåŠ¡ï¼ŒæŸ¥çœ‹sentinelæ§åˆ¶å°çš„ç°‡ç‚¹é“¾è·¯ï¼š

![image-20210716101805951](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716101805951.png)



**é…ç½®æµæ§è§„åˆ™**

å¯¹å“ªä¸ªç«¯ç‚¹é™æµï¼Œå°±ç‚¹å‡»å“ªä¸ªç«¯ç‚¹åé¢çš„æŒ‰é’®ã€‚æˆ‘ä»¬æ˜¯å¯¹è®¢å•æŸ¥è¯¢/order/queryé™æµï¼Œå› æ­¤ç‚¹å‡»å®ƒåé¢çš„æŒ‰é’®ï¼š

![image-20210716101934499](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716101934499.png)

åœ¨è¡¨å•ä¸­å¡«å†™æµæ§è§„åˆ™ï¼š

![image-20210716102103814](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716102103814.png)



**åœ¨Jmeteræµ‹è¯•**

é€‰æ‹©ã€Šæµæ§æ¨¡å¼-å…³è”ã€‹ï¼š

![image-20210716102416266](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716102416266.png)

å¯ä»¥çœ‹åˆ°1000ä¸ªç”¨æˆ·ï¼Œ100ç§’ï¼Œå› æ­¤QPSä¸º10ï¼Œè¶…è¿‡äº†æˆ‘ä»¬è®¾å®šçš„é˜ˆå€¼ï¼š5

æŸ¥çœ‹httpè¯·æ±‚ï¼š

![image-20210716102532554](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716102532554.png)

è¯·æ±‚çš„ç›®æ ‡æ˜¯/order/updateï¼Œè¿™æ ·è¿™ä¸ªæ–­ç‚¹å°±ä¼šè§¦å‘é˜ˆå€¼ã€‚

ä½†é™æµçš„ç›®æ ‡æ˜¯/order/queryï¼Œæˆ‘ä»¬åœ¨æµè§ˆå™¨è®¿é—®ï¼Œå¯ä»¥å‘ç°ï¼š

![image-20210716102636030](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716102636030.png)

ç¡®å®è¢«é™æµäº†ã€‚



**æ€»ç»“**

![image-20210716103143002](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716103143002.png)





###### **é“¾è·¯æ¨¡å¼**

**é“¾è·¯æ¨¡å¼**ï¼šåªé’ˆå¯¹ä»æŒ‡å®šé“¾è·¯è®¿é—®åˆ°æœ¬èµ„æºçš„è¯·æ±‚åšç»Ÿè®¡ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡é˜ˆå€¼ã€‚

**é…ç½®ç¤ºä¾‹**ï¼š

ä¾‹å¦‚æœ‰ä¸¤æ¡è¯·æ±‚é“¾è·¯ï¼š

- /test1 --> /common

- /test2 --> /common

å¦‚æœåªå¸Œæœ›ç»Ÿè®¡ä»/test2è¿›å…¥åˆ°/commonçš„è¯·æ±‚ï¼Œåˆ™å¯ä»¥è¿™æ ·é…ç½®ï¼š

![image-20210716103536346](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716103536346.png)

**å®æˆ˜æ¡ˆä¾‹**

éœ€æ±‚ï¼šæœ‰æŸ¥è¯¢è®¢å•å’Œåˆ›å»ºè®¢å•ä¸šåŠ¡ï¼Œä¸¤è€…éƒ½éœ€è¦æŸ¥è¯¢å•†å“ã€‚é’ˆå¯¹ä»æŸ¥è¯¢è®¢å•è¿›å…¥åˆ°æŸ¥è¯¢å•†å“çš„è¯·æ±‚ç»Ÿè®¡ï¼Œå¹¶è®¾ç½®é™æµã€‚

æ­¥éª¤ï¼š

1. åœ¨OrderServiceä¸­æ·»åŠ ä¸€ä¸ªqueryGoodsæ–¹æ³•ï¼Œä¸ç”¨å®ç°ä¸šåŠ¡

2. åœ¨OrderControllerä¸­ï¼Œæ”¹é€ /order/queryç«¯ç‚¹ï¼Œè°ƒç”¨OrderServiceä¸­çš„queryGoodsæ–¹æ³•

3. åœ¨OrderControllerä¸­æ·»åŠ ä¸€ä¸ª/order/saveçš„ç«¯ç‚¹ï¼Œè°ƒç”¨OrderServiceçš„queryGoodsæ–¹æ³•

4. ç»™queryGoodsè®¾ç½®é™æµè§„åˆ™ï¼Œä»/order/queryè¿›å…¥queryGoodsçš„æ–¹æ³•é™åˆ¶QPSå¿…é¡»å°äº2



**å®ç°ï¼š**

**æ·»åŠ æŸ¥è¯¢å•†å“æ–¹æ³•**

åœ¨order-serviceæœåŠ¡ä¸­ï¼Œç»™OrderServiceç±»æ·»åŠ ä¸€ä¸ªqueryGoodsæ–¹æ³•ï¼š

```java
public void queryGoods(){
    System.err.println("æŸ¥è¯¢å•†å“");
}
```



**æŸ¥è¯¢è®¢å•æ—¶ï¼ŒæŸ¥è¯¢å•†å“**

åœ¨order-serviceçš„OrderControllerä¸­ï¼Œä¿®æ”¹/order/queryç«¯ç‚¹çš„ä¸šåŠ¡é€»è¾‘ï¼š

```java
@GetMapping("/query")
public String queryOrder() {
    // æŸ¥è¯¢å•†å“
    orderService.queryGoods();
    // æŸ¥è¯¢è®¢å•
    System.out.println("æŸ¥è¯¢è®¢å•");
    return "æŸ¥è¯¢è®¢å•æˆåŠŸ";
}
```



**æ–°å¢è®¢å•ï¼ŒæŸ¥è¯¢å•†å“**

åœ¨order-serviceçš„OrderControllerä¸­ï¼Œä¿®æ”¹/order/saveç«¯ç‚¹ï¼Œæ¨¡æ‹Ÿæ–°å¢è®¢å•ï¼š

```java
@GetMapping("/save")
public String saveOrder() {
    // æŸ¥è¯¢å•†å“
    orderService.queryGoods();
    // æŸ¥è¯¢è®¢å•
    System.err.println("æ–°å¢è®¢å•");
    return "æ–°å¢è®¢å•æˆåŠŸ";
}
```



**ç»™æŸ¥è¯¢å•†å“æ·»åŠ èµ„æºæ ‡è®°**

é»˜è®¤æƒ…å†µä¸‹ï¼ŒOrderServiceä¸­çš„æ–¹æ³•æ˜¯ä¸è¢«Sentinelç›‘æ§çš„ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±é€šè¿‡æ³¨è§£æ¥æ ‡è®°è¦ç›‘æ§çš„æ–¹æ³•ã€‚

ç»™OrderServiceçš„queryGoodsæ–¹æ³•æ·»åŠ @SentinelResourceæ³¨è§£ï¼š

```java
@SentinelResource("goods")
public void queryGoods(){
    System.err.println("æŸ¥è¯¢å•†å“");
}
```



é“¾è·¯æ¨¡å¼ä¸­ï¼Œæ˜¯å¯¹ä¸åŒæ¥æºçš„ä¸¤ä¸ªé“¾è·¯åšç›‘æ§ã€‚ä½†æ˜¯sentinelé»˜è®¤ä¼šç»™è¿›å…¥SpringMVCçš„æ‰€æœ‰è¯·æ±‚è®¾ç½®åŒä¸€ä¸ªrootèµ„æºï¼Œä¼šå¯¼è‡´é“¾è·¯æ¨¡å¼å¤±æ•ˆã€‚

æˆ‘ä»¬éœ€è¦å…³é—­è¿™ç§å¯¹SpringMVCçš„èµ„æºèšåˆï¼Œä¿®æ”¹order-serviceæœåŠ¡çš„application.ymlæ–‡ä»¶ï¼š

```yaml
spring:
  cloud:
    sentinel:
      web-context-unify: false # å…³é—­contextæ•´åˆ
```

é‡å¯æœåŠ¡ï¼Œè®¿é—®/order/queryå’Œ/order/saveï¼Œå¯ä»¥æŸ¥çœ‹åˆ°sentinelçš„ç°‡ç‚¹é“¾è·¯è§„åˆ™ä¸­ï¼Œå‡ºç°äº†æ–°çš„èµ„æºï¼š

![image-20210716105227163](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716105227163.png)



**æ·»åŠ æµæ§è§„åˆ™**

ç‚¹å‡»goodsèµ„æºåé¢çš„æµæ§æŒ‰é’®ï¼Œåœ¨å¼¹å‡ºçš„è¡¨å•ä¸­å¡«å†™ä¸‹é¢ä¿¡æ¯ï¼š

![image-20210716105408723](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716105408723.png)



åªç»Ÿè®¡ä»/order/queryè¿›å…¥/goodsçš„èµ„æºï¼ŒQPSé˜ˆå€¼ä¸º2ï¼Œè¶…å‡ºåˆ™è¢«é™æµã€‚



**Jmeteræµ‹è¯•**

é€‰æ‹©ã€Šæµæ§æ¨¡å¼-é“¾è·¯ã€‹ï¼š

![image-20210716105612312](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716105612312.png)

å¯ä»¥çœ‹åˆ°è¿™é‡Œ200ä¸ªç”¨æˆ·ï¼Œ50ç§’å†…å‘å®Œï¼ŒQPSä¸º4ï¼Œè¶…è¿‡äº†æˆ‘ä»¬è®¾å®šçš„é˜ˆå€¼2

ä¸€ä¸ªhttpè¯·æ±‚æ˜¯è®¿é—®/order/saveï¼š

![image-20210716105812789](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716105812789.png)

è¿è¡Œçš„ç»“æœï¼š

![image-20210716110027064](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716110027064.png)

å®Œå…¨ä¸å—å½±å“ã€‚



å¦ä¸€ä¸ªæ˜¯è®¿é—®/order/queryï¼š

![image-20210716105855951](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716105855951.png)

è¿è¡Œç»“æœï¼š

![image-20210716105956401](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716105956401.png)

æ¯æ¬¡åªæœ‰2ä¸ªé€šè¿‡ã€‚





**æ€»ç»“**

æµæ§æ¨¡å¼æœ‰å“ªäº›ï¼Ÿ

â€¢ç›´æ¥ï¼šå¯¹å½“å‰èµ„æºé™æµ

â€¢å…³è”ï¼šé«˜ä¼˜å…ˆçº§èµ„æºè§¦å‘é˜ˆå€¼ï¼Œå¯¹ä½ä¼˜å…ˆçº§èµ„æºé™æµã€‚

â€¢é“¾è·¯ï¼šé˜ˆå€¼ç»Ÿè®¡æ—¶ï¼Œåªç»Ÿè®¡ä»æŒ‡å®šèµ„æºè¿›å…¥å½“å‰èµ„æºçš„è¯·æ±‚ï¼Œæ˜¯å¯¹è¯·æ±‚æ¥æºçš„é™æµ



---



##### æµæ§æ•ˆæœ

åœ¨æµæ§çš„é«˜çº§é€‰é¡¹ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªæµæ§æ•ˆæœé€‰é¡¹ï¼š

![image-20210716110225104](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716110225104.png)

æµæ§æ•ˆæœæ˜¯æŒ‡è¯·æ±‚è¾¾åˆ°æµæ§é˜ˆå€¼æ—¶åº”è¯¥é‡‡å–çš„æªæ–½ï¼ŒåŒ…æ‹¬ä¸‰ç§ï¼š

- **å¿«é€Ÿå¤±è´¥**ï¼šè¾¾åˆ°é˜ˆå€¼åï¼Œæ–°çš„è¯·æ±‚ä¼šè¢«ç«‹å³æ‹’ç»å¹¶æŠ›å‡ºFlowExceptionå¼‚å¸¸ã€‚æ˜¯é»˜è®¤çš„å¤„ç†æ–¹å¼ã€‚

- **warm up**ï¼šé¢„çƒ­æ¨¡å¼ï¼Œå¯¹è¶…å‡ºé˜ˆå€¼çš„è¯·æ±‚åŒæ ·æ˜¯æ‹’ç»å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚ä½†è¿™ç§æ¨¡å¼é˜ˆå€¼ä¼šåŠ¨æ€å˜åŒ–ï¼Œä»ä¸€ä¸ªè¾ƒå°å€¼é€æ¸å¢åŠ åˆ°æœ€å¤§é˜ˆå€¼ã€‚

- **æ’é˜Ÿç­‰å¾…**ï¼šè®©æ‰€æœ‰çš„è¯·æ±‚æŒ‰ç…§å…ˆåæ¬¡åºæ’é˜Ÿæ‰§è¡Œï¼Œä¸¤ä¸ªè¯·æ±‚çš„é—´éš”ä¸èƒ½å°äºæŒ‡å®šæ—¶é•¿





###### **å¿«é€Ÿå¤±è´¥**

è¾¾åˆ°é˜ˆå€¼åï¼Œæ–°çš„è¯·æ±‚ä¼šè¢«ç«‹å³æ‹’ç»å¹¶æŠ›å‡ºFlowExceptionå¼‚å¸¸ã€‚æ˜¯é»˜è®¤çš„å¤„ç†æ–¹å¼ã€‚



###### **warm up**

â€‹	é˜ˆå€¼ä¸€èˆ¬æ˜¯ä¸€ä¸ªå¾®æœåŠ¡èƒ½æ‰¿æ‹…çš„æœ€å¤§QPSï¼Œä½†æ˜¯ä¸€ä¸ªæœåŠ¡åˆšåˆšå¯åŠ¨æ—¶ï¼Œä¸€åˆ‡èµ„æºå°šæœªåˆå§‹åŒ–ï¼ˆ**å†·å¯åŠ¨**ï¼‰ï¼Œå¦‚æœç›´æ¥å°†QPSè·‘åˆ°æœ€å¤§å€¼ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡ç¬é—´å®•æœºã€‚

â€‹	warm upä¹Ÿå«**é¢„çƒ­æ¨¡å¼**ï¼Œæ˜¯åº”å¯¹æœåŠ¡å†·å¯åŠ¨çš„ä¸€ç§æ–¹æ¡ˆã€‚è¯·æ±‚é˜ˆå€¼åˆå§‹å€¼æ˜¯ maxThreshold / coldFactorï¼ŒæŒç»­æŒ‡å®šæ—¶é•¿åï¼Œé€æ¸æé«˜åˆ°maxThresholdå€¼ã€‚è€ŒcoldFactorçš„é»˜è®¤å€¼æ˜¯3.

ä¾‹å¦‚ï¼Œæˆ‘è®¾ç½®QPSçš„maxThresholdä¸º10ï¼Œé¢„çƒ­æ—¶é—´ä¸º5ç§’ï¼Œé‚£ä¹ˆåˆå§‹é˜ˆå€¼å°±æ˜¯ 10 / 3 ï¼Œä¹Ÿå°±æ˜¯3ï¼Œç„¶ååœ¨5ç§’åé€æ¸å¢é•¿åˆ°10.

![image-20210716110629796](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716110629796.png)



**æ¡ˆä¾‹**

éœ€æ±‚ï¼šç»™/order/{orderId}è¿™ä¸ªèµ„æºè®¾ç½®é™æµï¼Œæœ€å¤§QPSä¸º10ï¼Œåˆ©ç”¨warm upæ•ˆæœï¼Œé¢„çƒ­æ—¶é•¿ä¸º5ç§’



**é…ç½®æµæ§è§„åˆ™**ï¼š

![image-20210716111012387](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716111012387.png)



**Jmeteræµ‹è¯•**

é€‰æ‹©ã€Šæµæ§æ•ˆæœï¼Œwarm upã€‹ï¼š

![image-20210716111136699](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716111136699.png)

QPSä¸º10.

åˆšåˆšå¯åŠ¨æ—¶ï¼Œå¤§éƒ¨åˆ†è¯·æ±‚å¤±è´¥ï¼ŒæˆåŠŸçš„åªæœ‰3ä¸ªï¼Œè¯´æ˜QPSè¢«é™å®šåœ¨3ï¼š

![image-20210716111303701](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716111303701.png)

éšç€æ—¶é—´æ¨ç§»ï¼ŒæˆåŠŸæ¯”ä¾‹è¶Šæ¥è¶Šé«˜ï¼š

![image-20210716111404717](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716111404717.png)



åˆ°Sentinelæ§åˆ¶å°æŸ¥çœ‹å®æ—¶ç›‘æ§ï¼š

![image-20210716111526480](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716111526480.png)

ä¸€æ®µæ—¶é—´åï¼š

![image-20210716111658541](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716111658541.png)





###### **æ’é˜Ÿç­‰å¾…**

â€‹	å½“è¯·æ±‚è¶…è¿‡QPSé˜ˆå€¼æ—¶ï¼Œå¿«é€Ÿå¤±è´¥å’Œwarm up ä¼šæ‹’ç»æ–°çš„è¯·æ±‚å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚

â€‹	è€Œæ’é˜Ÿç­‰å¾…åˆ™æ˜¯è®©æ‰€æœ‰è¯·æ±‚è¿›å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åæŒ‰ç…§é˜ˆå€¼å…è®¸çš„æ—¶é—´é—´éš”ä¾æ¬¡æ‰§è¡Œã€‚åæ¥çš„è¯·æ±‚å¿…é¡»ç­‰å¾…å‰é¢æ‰§è¡Œå®Œæˆï¼Œå¦‚æœè¯·æ±‚é¢„æœŸçš„ç­‰å¾…æ—¶é—´è¶…å‡ºæœ€å¤§æ—¶é•¿ï¼Œåˆ™ä¼šè¢«æ‹’ç»ã€‚

**å·¥ä½œåŸç†**ï¼š

â€‹	ä¾‹å¦‚ï¼šQPS = 5ï¼Œæ„å‘³ç€æ¯200mså¤„ç†ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„è¯·æ±‚ï¼›timeout = 2000ï¼Œæ„å‘³ç€**é¢„æœŸç­‰å¾…æ—¶é•¿**è¶…è¿‡2000msçš„è¯·æ±‚ä¼šè¢«æ‹’ç»å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚

é‚£ä»€ä¹ˆå«åšé¢„æœŸç­‰å¾…æ—¶é•¿å‘¢ï¼Ÿ

æ¯”å¦‚ç°åœ¨ä¸€ä¸‹å­æ¥äº†12 ä¸ªè¯·æ±‚ï¼Œå› ä¸ºæ¯200msæ‰§è¡Œä¸€ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆï¼š

- ç¬¬6ä¸ªè¯·æ±‚çš„**é¢„æœŸç­‰å¾…æ—¶é•¿** =  200 * ï¼ˆ6 - 1ï¼‰ = 1000ms
- ç¬¬12ä¸ªè¯·æ±‚çš„é¢„æœŸç­‰å¾…æ—¶é•¿ = 200 * ï¼ˆ12-1ï¼‰ = 2200ms



ç°åœ¨ï¼Œç¬¬1ç§’åŒæ—¶æ¥æ”¶åˆ°10ä¸ªè¯·æ±‚ï¼Œä½†ç¬¬2ç§’åªæœ‰1ä¸ªè¯·æ±‚ï¼Œæ­¤æ—¶QPSçš„æ›²çº¿è¿™æ ·çš„ï¼š

![image-20210716113147176](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716113147176.png)

å¦‚æœä½¿ç”¨é˜Ÿåˆ—æ¨¡å¼åšæµæ§ï¼Œæ‰€æœ‰è¿›å…¥çš„è¯·æ±‚éƒ½è¦æ’é˜Ÿï¼Œä»¥å›ºå®šçš„200msçš„é—´éš”æ‰§è¡Œï¼ŒQPSä¼šå˜çš„å¾ˆå¹³æ»‘ï¼š

![image-20210716113426524](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716113426524.png)



å¹³æ»‘çš„QPSæ›²çº¿ï¼Œå¯¹äºæœåŠ¡å™¨æ¥è¯´æ˜¯æ›´å‹å¥½çš„ã€‚



**æ¡ˆä¾‹**

éœ€æ±‚ï¼šç»™/order/{orderId}è¿™ä¸ªèµ„æºè®¾ç½®é™æµï¼Œæœ€å¤§QPSä¸º10ï¼Œåˆ©ç”¨æ’é˜Ÿçš„æµæ§æ•ˆæœï¼Œè¶…æ—¶æ—¶é•¿è®¾ç½®ä¸º5s



**æ·»åŠ æµæ§è§„åˆ™**

![image-20210716114048918](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716114048918.png)



**Jmeteræµ‹è¯•**

é€‰æ‹©ã€Šæµæ§æ•ˆæœï¼Œé˜Ÿåˆ—ã€‹ï¼š

![image-20210716114243558](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716114243558.png)

QPSä¸º15ï¼Œå·²ç»è¶…è¿‡äº†æˆ‘ä»¬è®¾å®šçš„10ã€‚

å¦‚æœæ˜¯ä¹‹å‰çš„ å¿«é€Ÿå¤±è´¥ã€warmupæ¨¡å¼ï¼Œè¶…å‡ºçš„è¯·æ±‚åº”è¯¥ä¼šç›´æ¥æŠ¥é”™ã€‚

ä½†æ˜¯æˆ‘ä»¬çœ‹çœ‹é˜Ÿåˆ—æ¨¡å¼çš„è¿è¡Œç»“æœï¼š

![image-20210716114429361](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716114429361.png)

å…¨éƒ¨éƒ½é€šè¿‡äº†ã€‚

å†å»sentinelæŸ¥çœ‹å®æ—¶ç›‘æ§çš„QPSæ›²çº¿ï¼š

![image-20210716114522935](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716114522935.png)

QPSéå¸¸å¹³æ»‘ï¼Œä¸€è‡´ä¿æŒåœ¨10ï¼Œä½†æ˜¯è¶…å‡ºçš„è¯·æ±‚æ²¡æœ‰è¢«æ‹’ç»ï¼Œè€Œæ˜¯æ”¾å…¥é˜Ÿåˆ—ã€‚å› æ­¤**å“åº”æ—¶é—´**ï¼ˆç­‰å¾…æ—¶é—´ï¼‰ä¼šè¶Šæ¥è¶Šé•¿ã€‚

å½“é˜Ÿåˆ—æ»¡äº†ä»¥åï¼Œæ‰ä¼šæœ‰éƒ¨åˆ†è¯·æ±‚å¤±è´¥ï¼š

![image-20210716114651137](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716114651137.png)





###### **æ€»ç»“**

æµæ§æ•ˆæœæœ‰å“ªäº›ï¼Ÿ

- å¿«é€Ÿå¤±è´¥ï¼šQPSè¶…è¿‡é˜ˆå€¼æ—¶ï¼Œæ‹’ç»æ–°çš„è¯·æ±‚

- warm upï¼š QPSè¶…è¿‡é˜ˆå€¼æ—¶ï¼Œæ‹’ç»æ–°çš„è¯·æ±‚ï¼›QPSé˜ˆå€¼æ˜¯é€æ¸æå‡çš„ï¼Œå¯ä»¥é¿å…å†·å¯åŠ¨æ—¶é«˜å¹¶å‘å¯¼è‡´æœåŠ¡å®•æœºã€‚

- æ’é˜Ÿç­‰å¾…ï¼šè¯·æ±‚ä¼šè¿›å…¥é˜Ÿåˆ—ï¼ŒæŒ‰ç…§é˜ˆå€¼å…è®¸çš„æ—¶é—´é—´éš”ä¾æ¬¡æ‰§è¡Œè¯·æ±‚ï¼›å¦‚æœè¯·æ±‚é¢„æœŸç­‰å¾…æ—¶é•¿å¤§äºè¶…æ—¶æ—¶é—´ï¼Œç›´æ¥æ‹’ç»







---

---





##### çƒ­ç‚¹å‚æ•°é™æµ

ä¹‹å‰çš„é™æµæ˜¯ç»Ÿè®¡è®¿é—®æŸä¸ªèµ„æºçš„æ‰€æœ‰è¯·æ±‚ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡QPSé˜ˆå€¼ã€‚è€Œçƒ­ç‚¹å‚æ•°é™æµæ˜¯**åˆ†åˆ«ç»Ÿè®¡å‚æ•°å€¼ç›¸åŒçš„è¯·æ±‚**ï¼Œåˆ¤æ–­æ˜¯å¦è¶…è¿‡QPSé˜ˆå€¼ã€‚



###### å…¨å±€å‚æ•°é™æµ

ä¾‹å¦‚ï¼Œä¸€ä¸ªæ ¹æ®idæŸ¥è¯¢å•†å“çš„æ¥å£ï¼š

![image-20210716115014663](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716115014663.png)

è®¿é—®/goods/{id}çš„è¯·æ±‚ä¸­ï¼Œidå‚æ•°å€¼ä¼šæœ‰å˜åŒ–ï¼Œçƒ­ç‚¹å‚æ•°é™æµä¼šæ ¹æ®å‚æ•°å€¼åˆ†åˆ«ç»Ÿè®¡QPSï¼Œç»Ÿè®¡ç»“æœï¼š

![image-20210716115131463](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716115131463.png)

å½“id=1çš„è¯·æ±‚è§¦å‘é˜ˆå€¼è¢«é™æµæ—¶ï¼Œidå€¼ä¸ä¸º1çš„è¯·æ±‚ä¸å—å½±å“ã€‚



é…ç½®ç¤ºä¾‹ï¼š

![image-20210716115232426](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716115232426.png)

ä»£è¡¨çš„å«ä¹‰æ˜¯ï¼šå¯¹hotè¿™ä¸ªèµ„æºçš„0å·å‚æ•°ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°ï¼‰åšç»Ÿè®¡ï¼Œæ¯1ç§’**ç›¸åŒå‚æ•°å€¼**çš„è¯·æ±‚æ•°ä¸èƒ½è¶…è¿‡5



###### çƒ­ç‚¹å‚æ•°é™æµ

åˆšæ‰çš„é…ç½®ä¸­ï¼Œå¯¹æŸ¥è¯¢å•†å“è¿™ä¸ªæ¥å£çš„æ‰€æœ‰å•†å“ä¸€è§†åŒä»ï¼ŒQPSéƒ½é™å®šä¸º5.

è€Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œå¯èƒ½éƒ¨åˆ†å•†å“æ˜¯çƒ­ç‚¹å•†å“ï¼Œä¾‹å¦‚ç§’æ€å•†å“ï¼Œæˆ‘ä»¬å¸Œæœ›è¿™éƒ¨åˆ†å•†å“çš„QPSé™åˆ¶ä¸å…¶å®ƒå•†å“ä¸ä¸€æ ·ï¼Œé«˜ä¸€äº›ã€‚é‚£å°±éœ€è¦é…ç½®çƒ­ç‚¹å‚æ•°é™æµçš„é«˜çº§é€‰é¡¹äº†ï¼š

![image-20210716115717523](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716115717523.png)

ç»“åˆä¸Šä¸€ä¸ªé…ç½®ï¼Œè¿™é‡Œçš„å«ä¹‰æ˜¯å¯¹0å·çš„longç±»å‹å‚æ•°é™æµï¼Œæ¯1ç§’ç›¸åŒå‚æ•°çš„QPSä¸èƒ½è¶…è¿‡5ï¼Œæœ‰ä¸¤ä¸ªä¾‹å¤–ï¼š

â€¢å¦‚æœå‚æ•°å€¼æ˜¯100ï¼Œåˆ™æ¯1ç§’å…è®¸çš„QPSä¸º10

â€¢å¦‚æœå‚æ•°å€¼æ˜¯101ï¼Œåˆ™æ¯1ç§’å…è®¸çš„QPSä¸º15



**æ¡ˆä¾‹**

**æ¡ˆä¾‹éœ€æ±‚**ï¼šç»™/order/{orderId}è¿™ä¸ªèµ„æºæ·»åŠ çƒ­ç‚¹å‚æ•°é™æµï¼Œè§„åˆ™å¦‚ä¸‹ï¼š

â€¢é»˜è®¤çš„çƒ­ç‚¹å‚æ•°è§„åˆ™æ˜¯æ¯1ç§’è¯·æ±‚é‡ä¸è¶…è¿‡2

â€¢ç»™102è¿™ä¸ªå‚æ•°è®¾ç½®ä¾‹å¤–ï¼šæ¯1ç§’è¯·æ±‚é‡ä¸è¶…è¿‡4

â€¢ç»™103è¿™ä¸ªå‚æ•°è®¾ç½®ä¾‹å¤–ï¼šæ¯1ç§’è¯·æ±‚é‡ä¸è¶…è¿‡10



**æ³¨æ„äº‹é¡¹**ï¼šçƒ­ç‚¹å‚æ•°é™æµå¯¹é»˜è®¤çš„SpringMVCèµ„æºæ— æ•ˆï¼Œéœ€è¦åˆ©ç”¨@SentinelResourceæ³¨è§£æ ‡è®°èµ„æº



**æ ‡è®°èµ„æº**

ç»™order-serviceä¸­çš„OrderControllerä¸­çš„/order/{orderId}èµ„æºæ·»åŠ æ³¨è§£ï¼š

![image-20210716120033572](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716120033572.png)



**çƒ­ç‚¹å‚æ•°é™æµè§„åˆ™**

è®¿é—®è¯¥æ¥å£ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ ‡è®°çš„hotèµ„æºå‡ºç°äº†ï¼š

![image-20210716120208509](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716120208509.png)

è¿™é‡Œä¸è¦ç‚¹å‡»hotåé¢çš„æŒ‰é’®ï¼Œé¡µé¢æœ‰BUG



ç‚¹å‡»å·¦ä¾§èœå•ä¸­**çƒ­ç‚¹è§„åˆ™**èœå•ï¼š

![image-20210716120319009](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716120319009.png)

ç‚¹å‡»æ–°å¢ï¼Œå¡«å†™è¡¨å•ï¼š

![image-20210716120536714](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716120536714.png)





**Jmeteræµ‹è¯•**

é€‰æ‹©ã€Šçƒ­ç‚¹å‚æ•°é™æµ QPS1ã€‹ï¼š

![image-20210716120754527](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716120754527.png)

è¿™é‡Œå‘èµ·è¯·æ±‚çš„QPSä¸º5.

åŒ…å«3ä¸ªhttpè¯·æ±‚ï¼š

æ™®é€šå‚æ•°ï¼ŒQPSé˜ˆå€¼ä¸º2

![image-20210716120840501](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716120840501.png)

è¿è¡Œç»“æœï¼š

![image-20210716121105567](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716121105567.png)



ä¾‹å¤–é¡¹ï¼ŒQPSé˜ˆå€¼ä¸º4

![image-20210716120900365](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716120900365.png)

è¿è¡Œç»“æœï¼š

![image-20210716121201630](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716121201630.png)



ä¾‹å¤–é¡¹ï¼ŒQPSé˜ˆå€¼ä¸º10

![image-20210716120919131](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716120919131.png)

è¿è¡Œç»“æœï¼š

![image-20210716121220305](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716121220305.png)



---

---

---





#### éš”ç¦»å’Œé™çº§

â€‹	é™æµæ˜¯ä¸€ç§é¢„é˜²æªæ–½ï¼Œè™½ç„¶é™æµå¯ä»¥å°½é‡é¿å…å› é«˜å¹¶å‘è€Œå¼•èµ·çš„æœåŠ¡æ•…éšœï¼Œä½†æœåŠ¡è¿˜ä¼šå› ä¸ºå…¶å®ƒåŸå› è€Œæ•…éšœã€‚

è€Œè¦å°†è¿™äº›æ•…éšœæ§åˆ¶åœ¨ä¸€å®šèŒƒå›´ï¼Œé¿å…é›ªå´©ï¼Œå°±è¦é **çº¿ç¨‹éš”ç¦»**ï¼ˆèˆ±å£æ¨¡å¼ï¼‰å’Œ**ç†”æ–­é™çº§**æ‰‹æ®µäº†ã€‚



**çº¿ç¨‹éš”ç¦»**ä¹‹å‰è®²åˆ°è¿‡ï¼šè°ƒç”¨è€…åœ¨è°ƒç”¨æœåŠ¡æä¾›è€…æ—¶ï¼Œç»™æ¯ä¸ªè°ƒç”¨çš„è¯·æ±‚åˆ†é…ç‹¬ç«‹çº¿ç¨‹æ± ï¼Œå‡ºç°æ•…éšœæ—¶ï¼Œæœ€å¤šæ¶ˆè€—è¿™ä¸ªçº¿ç¨‹æ± å†…èµ„æºï¼Œé¿å…æŠŠè°ƒç”¨è€…çš„æ‰€æœ‰èµ„æºè€—å°½ã€‚

![image-20210715173215243](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210715173215243-167819652794265.png)



**ç†”æ–­é™çº§**ï¼šæ˜¯åœ¨è°ƒç”¨æ–¹è¿™è¾¹åŠ å…¥æ–­è·¯å™¨ï¼Œç»Ÿè®¡å¯¹æœåŠ¡æä¾›è€…çš„è°ƒç”¨ï¼Œå¦‚æœè°ƒç”¨çš„å¤±è´¥æ¯”ä¾‹è¿‡é«˜ï¼Œåˆ™ç†”æ–­è¯¥ä¸šåŠ¡ï¼Œä¸å…è®¸è®¿é—®è¯¥æœåŠ¡çš„æä¾›è€…äº†ã€‚

![image-20210715173428073](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210715173428073-167819652794366.png)





å¯ä»¥çœ‹åˆ°ï¼Œä¸ç®¡æ˜¯çº¿ç¨‹éš”ç¦»è¿˜æ˜¯ç†”æ–­é™çº§ï¼Œéƒ½æ˜¯å¯¹**å®¢æˆ·ç«¯**ï¼ˆè°ƒç”¨æ–¹ï¼‰çš„ä¿æŠ¤ã€‚éœ€è¦åœ¨**è°ƒç”¨æ–¹** å‘èµ·è¿œç¨‹è°ƒç”¨æ—¶åšçº¿ç¨‹éš”ç¦»ã€æˆ–è€…æœåŠ¡ç†”æ–­ã€‚

è€Œæˆ‘ä»¬çš„å¾®æœåŠ¡è¿œç¨‹è°ƒç”¨éƒ½æ˜¯åŸºäºFeignæ¥å®Œæˆçš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†Feignä¸Sentinelæ•´åˆï¼Œåœ¨Feigné‡Œé¢å®ç°çº¿ç¨‹éš”ç¦»å’ŒæœåŠ¡ç†”æ–­ã€‚





##### FeignClientæ•´åˆSentinel



SpringCloudä¸­ï¼Œå¾®æœåŠ¡è°ƒç”¨éƒ½æ˜¯é€šè¿‡Feignæ¥å®ç°çš„ï¼Œå› æ­¤åšå®¢æˆ·ç«¯ä¿æŠ¤å¿…é¡»æ•´åˆFeignå’ŒSentinelã€‚



**ä¿®æ”¹é…ç½®ï¼Œå¼€å¯sentinelåŠŸèƒ½**

ä¿®æ”¹OrderServiceçš„application.ymlæ–‡ä»¶ï¼Œå¼€å¯Feignçš„SentinelåŠŸèƒ½ï¼š

```yaml
feign:
  sentinel:
    enabled: true # å¼€å¯feignå¯¹sentinelçš„æ”¯æŒ
```







##### **ç¼–å†™å¤±è´¥é™çº§é€»è¾‘**

ä¸šåŠ¡å¤±è´¥åï¼Œä¸èƒ½ç›´æ¥æŠ¥é”™ï¼Œè€Œåº”è¯¥è¿”å›ç”¨æˆ·ä¸€ä¸ªå‹å¥½æç¤ºæˆ–è€…é»˜è®¤ç»“æœï¼Œè¿™ä¸ªå°±æ˜¯å¤±è´¥é™çº§é€»è¾‘ã€‚

ç»™FeignClientç¼–å†™å¤±è´¥åçš„é™çº§é€»è¾‘

â‘ æ–¹å¼ä¸€ï¼šFallbackClassï¼Œæ— æ³•å¯¹è¿œç¨‹è°ƒç”¨çš„å¼‚å¸¸åšå¤„ç†

â‘¡æ–¹å¼äºŒï¼šFallbackFactoryï¼Œå¯ä»¥å¯¹è¿œç¨‹è°ƒç”¨çš„å¼‚å¸¸åšå¤„ç†ï¼Œæˆ‘ä»¬é€‰æ‹©è¿™ç§



è¿™é‡Œæˆ‘ä»¬æ¼”ç¤ºæ–¹å¼äºŒçš„å¤±è´¥é™çº§å¤„ç†ã€‚

**æ­¥éª¤ä¸€**ï¼šåœ¨feing-apié¡¹ç›®ä¸­å®šä¹‰ç±»ï¼Œå®ç°FallbackFactoryï¼š

![image-20210716122403502](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716122403502.png)

ä»£ç ï¼š

```java
package cn.itcast.feign.clients.fallback;

import cn.itcast.feign.clients.UserClient;
import cn.itcast.feign.pojo.User;
import feign.hystrix.FallbackFactory;
import lombok.extern.slf4j.Slf4j;

@Slf4j
public class UserClientFallbackFactory implements FallbackFactory<UserClient> {
    @Override
    public UserClient create(Throwable throwable) {
        return new UserClient() {
            @Override
            public User findById(Long id) {
                log.error("æŸ¥è¯¢ç”¨æˆ·å¼‚å¸¸", throwable);
                return new User();
            }
        };
    }
}

```



**æ­¥éª¤äºŒ**ï¼šåœ¨feing-apié¡¹ç›®ä¸­çš„DefaultFeignConfigurationç±»ä¸­å°†UserClientFallbackFactoryæ³¨å†Œä¸ºä¸€ä¸ªBeanï¼š

```java
@Bean
public UserClientFallbackFactory userClientFallbackFactory(){
    return new UserClientFallbackFactory();
}
```

**æ­¥éª¤ä¸‰**ï¼šåœ¨feing-apié¡¹ç›®ä¸­çš„UserClientæ¥å£ä¸­ä½¿ç”¨UserClientFallbackFactoryï¼š

```java
import cn.itcast.feign.clients.fallback.UserClientFallbackFactory;
import cn.itcast.feign.pojo.User;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

@FeignClient(value = "userservice", fallbackFactory = UserClientFallbackFactory.class)
public interface UserClient {

    @GetMapping("/user/{id}")
    User findById(@PathVariable("id") Long id);
}
```



é‡å¯åï¼Œè®¿é—®ä¸€æ¬¡è®¢å•æŸ¥è¯¢ä¸šåŠ¡ï¼Œç„¶åæŸ¥çœ‹sentinelæ§åˆ¶å°ï¼Œå¯ä»¥çœ‹åˆ°æ–°çš„ç°‡ç‚¹é“¾è·¯ï¼š

![image-20210716123705780](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716123705780.png)





**æ€»ç»“**

Sentinelæ”¯æŒçš„é›ªå´©è§£å†³æ–¹æ¡ˆï¼š

- çº¿ç¨‹éš”ç¦»ï¼ˆä»“å£æ¨¡å¼ï¼‰
- é™çº§ç†”æ–­

Feignæ•´åˆSentinelçš„æ­¥éª¤ï¼š

- åœ¨application.ymlä¸­é…ç½®ï¼šfeign.sentienl.enable=true
- ç»™FeignClientç¼–å†™FallbackFactoryå¹¶æ³¨å†Œä¸ºBean
- å°†FallbackFactoryé…ç½®åˆ°FeignClient







---



##### çº¿ç¨‹éš”ç¦»ï¼ˆèˆ±å£æ¨¡å¼ï¼‰



**çº¿ç¨‹éš”ç¦»çš„å®ç°æ–¹å¼**

çº¿ç¨‹éš”ç¦»æœ‰ä¸¤ç§æ–¹å¼å®ç°ï¼š

- **çº¿ç¨‹æ± éš”ç¦»**

- **ä¿¡å·é‡éš”ç¦»ï¼ˆSentinelé»˜è®¤é‡‡ç”¨ï¼‰**

å¦‚å›¾ï¼š

![image-20210716123036937](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716123036937.png)



**çº¿ç¨‹æ± éš”ç¦»**ï¼šç»™æ¯ä¸ªæœåŠ¡è°ƒç”¨ä¸šåŠ¡åˆ†é…ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œåˆ©ç”¨çº¿ç¨‹æ± æœ¬èº«å®ç°éš”ç¦»æ•ˆæœ

**ä¿¡å·é‡éš”ç¦»**ï¼šä¸åˆ›å»ºçº¿ç¨‹æ± ï¼Œè€Œæ˜¯è®¡æ•°å™¨æ¨¡å¼ï¼Œè®°å½•ä¸šåŠ¡ä½¿ç”¨çš„çº¿ç¨‹æ•°é‡ï¼Œè¾¾åˆ°ä¿¡å·é‡ä¸Šé™æ—¶ï¼Œç¦æ­¢æ–°çš„è¯·æ±‚ã€‚



ä¸¤è€…çš„ä¼˜ç¼ºç‚¹ï¼š

![image-20210716123240518](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716123240518.png)







**sentinelçš„çº¿ç¨‹éš”ç¦»**

**ç”¨æ³•è¯´æ˜**ï¼š

åœ¨æ·»åŠ é™æµè§„åˆ™æ—¶ï¼Œå¯ä»¥é€‰æ‹©ä¸¤ç§é˜ˆå€¼ç±»å‹ï¼š

![image-20210716123411217](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716123411217.png)

- QPSï¼šå°±æ˜¯æ¯ç§’çš„è¯·æ±‚æ•°ï¼Œåœ¨å¿«é€Ÿå…¥é—¨ä¸­å·²ç»æ¼”ç¤ºè¿‡

- çº¿ç¨‹æ•°ï¼šæ˜¯è¯¥èµ„æºèƒ½ä½¿ç”¨ç”¨çš„tomcatçº¿ç¨‹æ•°çš„æœ€å¤§å€¼ã€‚ä¹Ÿå°±æ˜¯é€šè¿‡é™åˆ¶çº¿ç¨‹æ•°é‡ï¼Œå®ç°**çº¿ç¨‹éš”ç¦»**ï¼ˆèˆ±å£æ¨¡å¼ï¼‰ã€‚



**æ¡ˆä¾‹éœ€æ±‚**ï¼šç»™ order-serviceæœåŠ¡ä¸­çš„UserClientçš„æŸ¥è¯¢ç”¨æˆ·æ¥å£è®¾ç½®æµæ§è§„åˆ™ï¼Œçº¿ç¨‹æ•°ä¸èƒ½è¶…è¿‡ 2ã€‚ç„¶ååˆ©ç”¨jemeteræµ‹è¯•ã€‚



**é…ç½®éš”ç¦»è§„åˆ™**

é€‰æ‹©feignæ¥å£åé¢çš„æµæ§æŒ‰é’®ï¼š

![image-20210716123831992](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716123831992.png)

å¡«å†™è¡¨å•ï¼š

![image-20210716123936844](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716123936844.png)





**Jmeteræµ‹è¯•**

é€‰æ‹©ã€Šé˜ˆå€¼ç±»å‹-çº¿ç¨‹æ•°<2ã€‹ï¼š

![image-20210716124229894](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716124229894.png)

ä¸€æ¬¡å‘ç”Ÿ10ä¸ªè¯·æ±‚ï¼Œæœ‰è¾ƒå¤§æ¦‚ç‡å¹¶å‘çº¿ç¨‹æ•°è¶…è¿‡2ï¼Œè€Œè¶…å‡ºçš„è¯·æ±‚ä¼šèµ°ä¹‹å‰å®šä¹‰çš„å¤±è´¥é™çº§é€»è¾‘ã€‚



æŸ¥çœ‹è¿è¡Œç»“æœï¼š

![image-20210716124147820](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716124147820.png)

å‘ç°è™½ç„¶ç»“æœéƒ½æ˜¯é€šè¿‡äº†ï¼Œä¸è¿‡éƒ¨åˆ†è¯·æ±‚å¾—åˆ°çš„å“åº”æ˜¯é™çº§è¿”å›çš„nullä¿¡æ¯ã€‚





**æ€»ç»“**

çº¿ç¨‹éš”ç¦»çš„ä¸¤ç§æ‰‹æ®µæ˜¯ï¼Ÿ

- ä¿¡å·é‡éš”ç¦»

- çº¿ç¨‹æ± éš”ç¦»

ä¿¡å·é‡éš”ç¦»çš„ç‰¹ç‚¹æ˜¯ï¼Ÿ

- åŸºäºè®¡æ•°å™¨æ¨¡å¼ï¼Œç®€å•ï¼Œå¼€é”€å°

çº¿ç¨‹æ± éš”ç¦»çš„ç‰¹ç‚¹æ˜¯ï¼Ÿ

- åŸºäºçº¿ç¨‹æ± æ¨¡å¼ï¼Œæœ‰é¢å¤–å¼€é”€ï¼Œä½†éš”ç¦»æ§åˆ¶æ›´å¼º





##### ç†”æ–­é™çº§

â€‹	ç†”æ–­é™çº§æ˜¯è§£å†³é›ªå´©é—®é¢˜çš„é‡è¦æ‰‹æ®µã€‚å…¶æ€è·¯æ˜¯ç”±**æ–­è·¯å™¨**ç»Ÿè®¡æœåŠ¡è°ƒç”¨çš„å¼‚å¸¸æ¯”ä¾‹ã€æ…¢è¯·æ±‚æ¯”ä¾‹ï¼Œå¦‚æœè¶…å‡ºé˜ˆå€¼åˆ™ä¼š**ç†”æ–­**è¯¥æœåŠ¡ã€‚å³æ‹¦æˆªè®¿é—®è¯¥æœåŠ¡çš„ä¸€åˆ‡è¯·æ±‚ï¼›è€Œå½“æœåŠ¡æ¢å¤æ—¶ï¼Œæ–­è·¯å™¨ä¼šæ”¾è¡Œè®¿é—®è¯¥æœåŠ¡çš„è¯·æ±‚ã€‚

æ–­è·¯å™¨æ§åˆ¶ç†”æ–­å’Œæ”¾è¡Œæ˜¯é€šè¿‡çŠ¶æ€æœºæ¥å®Œæˆçš„ï¼š

![image-20210716130958518](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716130958518.png)

çŠ¶æ€æœºåŒ…æ‹¬ä¸‰ä¸ªçŠ¶æ€ï¼š

- closedï¼šå…³é—­çŠ¶æ€ï¼Œæ–­è·¯å™¨æ”¾è¡Œæ‰€æœ‰è¯·æ±‚ï¼Œå¹¶å¼€å§‹ç»Ÿè®¡å¼‚å¸¸æ¯”ä¾‹ã€æ…¢è¯·æ±‚æ¯”ä¾‹ã€‚è¶…è¿‡é˜ˆå€¼åˆ™åˆ‡æ¢åˆ°opençŠ¶æ€
- openï¼šæ‰“å¼€çŠ¶æ€ï¼ŒæœåŠ¡è°ƒç”¨è¢«**ç†”æ–­**ï¼Œè®¿é—®è¢«ç†”æ–­æœåŠ¡çš„è¯·æ±‚ä¼šè¢«æ‹’ç»ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œç›´æ¥èµ°é™çº§é€»è¾‘ã€‚OpençŠ¶æ€5ç§’åä¼šè¿›å…¥half-opençŠ¶æ€
- half-openï¼šåŠå¼€çŠ¶æ€ï¼Œæ”¾è¡Œä¸€æ¬¡è¯·æ±‚ï¼Œæ ¹æ®æ‰§è¡Œç»“æœæ¥åˆ¤æ–­æ¥ä¸‹æ¥çš„æ“ä½œã€‚
  - è¯·æ±‚æˆåŠŸï¼šåˆ™åˆ‡æ¢åˆ°closedçŠ¶æ€
  - è¯·æ±‚å¤±è´¥ï¼šåˆ™åˆ‡æ¢åˆ°opençŠ¶æ€



æ–­è·¯å™¨ç†”æ–­ç­–ç•¥æœ‰ä¸‰ç§ï¼šæ…¢è°ƒç”¨ã€å¼‚å¸¸æ¯”ä¾‹ã€å¼‚å¸¸æ•°



###### æ…¢è°ƒç”¨

**æ…¢è°ƒç”¨**ï¼šä¸šåŠ¡çš„å“åº”æ—¶é•¿ï¼ˆRTï¼‰å¤§äºæŒ‡å®šæ—¶é•¿çš„è¯·æ±‚è®¤å®šä¸ºæ…¢è°ƒç”¨è¯·æ±‚ã€‚åœ¨æŒ‡å®šæ—¶é—´å†…ï¼Œå¦‚æœè¯·æ±‚æ•°é‡è¶…è¿‡è®¾å®šçš„æœ€å°æ•°é‡ï¼Œæ…¢è°ƒç”¨æ¯”ä¾‹å¤§äºè®¾å®šçš„é˜ˆå€¼ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚

ä¾‹å¦‚ï¼š

![image-20210716145934347](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716145934347.png)

è§£è¯»ï¼šRTè¶…è¿‡500msçš„è°ƒç”¨æ˜¯æ…¢è°ƒç”¨ï¼Œç»Ÿè®¡æœ€è¿‘10000mså†…çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚é‡è¶…è¿‡10æ¬¡ï¼Œå¹¶ä¸”æ…¢è°ƒç”¨æ¯”ä¾‹ä¸ä½äº0.5ï¼Œåˆ™è§¦å‘ç†”æ–­ï¼Œç†”æ–­æ—¶é•¿ä¸º5ç§’ã€‚ç„¶åè¿›å…¥half-opençŠ¶æ€ï¼Œæ”¾è¡Œä¸€æ¬¡è¯·æ±‚åšæµ‹è¯•ã€‚



**æ¡ˆä¾‹**

éœ€æ±‚ï¼šç»™ UserClientçš„æŸ¥è¯¢ç”¨æˆ·æ¥å£è®¾ç½®é™çº§è§„åˆ™ï¼Œæ…¢è°ƒç”¨çš„RTé˜ˆå€¼ä¸º50msï¼Œç»Ÿè®¡æ—¶é—´ä¸º1ç§’ï¼Œæœ€å°è¯·æ±‚æ•°é‡ä¸º5ï¼Œå¤±è´¥é˜ˆå€¼æ¯”ä¾‹ä¸º0.4ï¼Œç†”æ–­æ—¶é•¿ä¸º5



**è®¾ç½®æ…¢è°ƒç”¨**

ä¿®æ”¹user-serviceä¸­çš„/user/{id}è¿™ä¸ªæ¥å£çš„ä¸šåŠ¡ã€‚é€šè¿‡ä¼‘çœ æ¨¡æ‹Ÿä¸€ä¸ªå»¶è¿Ÿæ—¶é—´ï¼š

![image-20210716150234787](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716150234787.png)



æ­¤æ—¶ï¼ŒorderId=101çš„è®¢å•ï¼Œå…³è”çš„æ˜¯idä¸º1çš„ç”¨æˆ·ï¼Œè°ƒç”¨æ—¶é•¿ä¸º60msï¼š

![image-20210716150510956](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716150510956.png)

orderId=102çš„è®¢å•ï¼Œå…³è”çš„æ˜¯idä¸º2çš„ç”¨æˆ·ï¼Œè°ƒç”¨æ—¶é•¿ä¸ºéå¸¸çŸ­ï¼›

![image-20210716150605208](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716150605208.png)



**è®¾ç½®ç†”æ–­è§„åˆ™**

ä¸‹é¢ï¼Œç»™feignæ¥å£è®¾ç½®é™çº§è§„åˆ™ï¼š

![image-20210716150654094](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716150654094.png)

è§„åˆ™ï¼š

![image-20210716150740434](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716150740434.png)

è¶…è¿‡50msçš„è¯·æ±‚éƒ½ä¼šè¢«è®¤ä¸ºæ˜¯æ…¢è¯·æ±‚



**æµ‹è¯•**

åœ¨æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8088/order/101ï¼Œå¿«é€Ÿåˆ·æ–°5æ¬¡ï¼Œå¯ä»¥å‘ç°ï¼š

![image-20210716150911004](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716150911004.png)

è§¦å‘äº†ç†”æ–­ï¼Œè¯·æ±‚æ—¶é•¿ç¼©çŸ­è‡³5msï¼Œå¿«é€Ÿå¤±è´¥äº†ï¼Œå¹¶ä¸”èµ°é™çº§é€»è¾‘ï¼Œè¿”å›çš„null



åœ¨æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8088/order/102ï¼Œç«Ÿç„¶ä¹Ÿè¢«ç†”æ–­äº†ï¼š

![image-20210716151107785](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716151107785.png)





###### å¼‚å¸¸æ¯”ä¾‹ã€å¼‚å¸¸æ•°

**å¼‚å¸¸æ¯”ä¾‹æˆ–å¼‚å¸¸æ•°**ï¼šç»Ÿè®¡æŒ‡å®šæ—¶é—´å†…çš„è°ƒç”¨ï¼Œå¦‚æœè°ƒç”¨æ¬¡æ•°è¶…è¿‡æŒ‡å®šè¯·æ±‚æ•°ï¼Œå¹¶ä¸”å‡ºç°å¼‚å¸¸çš„æ¯”ä¾‹è¾¾åˆ°è®¾å®šçš„æ¯”ä¾‹é˜ˆå€¼ï¼ˆæˆ–è¶…è¿‡æŒ‡å®šå¼‚å¸¸æ•°ï¼‰ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚

ä¾‹å¦‚ï¼Œä¸€ä¸ªå¼‚å¸¸æ¯”ä¾‹è®¾ç½®ï¼š

![image-20210716131430682](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716131430682.png)

è§£è¯»ï¼šç»Ÿè®¡æœ€è¿‘1000mså†…çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚é‡è¶…è¿‡10æ¬¡ï¼Œå¹¶ä¸”å¼‚å¸¸æ¯”ä¾‹ä¸ä½äº0.4ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚

ä¸€ä¸ªå¼‚å¸¸æ•°è®¾ç½®ï¼š

![image-20210716131522912](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716131522912.png)

è§£è¯»ï¼šç»Ÿè®¡æœ€è¿‘1000mså†…çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚é‡è¶…è¿‡10æ¬¡ï¼Œå¹¶ä¸”å¼‚å¸¸æ¯”ä¾‹ä¸ä½äº2æ¬¡ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚



**æ¡ˆä¾‹**

éœ€æ±‚ï¼šç»™ UserClientçš„æŸ¥è¯¢ç”¨æˆ·æ¥å£è®¾ç½®é™çº§è§„åˆ™ï¼Œç»Ÿè®¡æ—¶é—´ä¸º1ç§’ï¼Œæœ€å°è¯·æ±‚æ•°é‡ä¸º5ï¼Œå¤±è´¥é˜ˆå€¼æ¯”ä¾‹ä¸º0.4ï¼Œç†”æ–­æ—¶é•¿ä¸º5s



**è®¾ç½®å¼‚å¸¸è¯·æ±‚**

é¦–å…ˆï¼Œä¿®æ”¹user-serviceä¸­çš„/user/{id}è¿™ä¸ªæ¥å£çš„ä¸šåŠ¡ã€‚æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸ï¼Œä»¥è§¦å‘å¼‚å¸¸æ¯”ä¾‹çš„ç†”æ–­ï¼š

![image-20210716151348183](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716151348183.png)

ä¹Ÿå°±æ˜¯è¯´ï¼Œid ä¸º 2æ—¶ï¼Œå°±ä¼šè§¦å‘å¼‚å¸¸



**è®¾ç½®ç†”æ–­è§„åˆ™**

ä¸‹é¢ï¼Œç»™feignæ¥å£è®¾ç½®é™çº§è§„åˆ™ï¼š

![image-20210716150654094](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716150654094.png)

è§„åˆ™ï¼š

![image-20210716151538785](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716151538785.png)

åœ¨5æ¬¡è¯·æ±‚ä¸­ï¼Œåªè¦å¼‚å¸¸æ¯”ä¾‹è¶…è¿‡0.4ï¼Œä¹Ÿå°±æ˜¯æœ‰2æ¬¡ä»¥ä¸Šçš„å¼‚å¸¸ï¼Œå°±ä¼šè§¦å‘ç†”æ–­ã€‚



**æµ‹è¯•**

åœ¨æµè§ˆå™¨å¿«é€Ÿè®¿é—®ï¼šhttp://localhost:8088/order/102ï¼Œå¿«é€Ÿåˆ·æ–°5æ¬¡ï¼Œè§¦å‘ç†”æ–­ï¼š

![image-20210716151722916](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716151722916.png)



æ­¤æ—¶ï¼Œæˆ‘ä»¬å»è®¿é—®æœ¬æ¥åº”è¯¥æ­£å¸¸çš„103ï¼š

![image-20210716151844817](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716151844817.png)





---

---

---



#### æˆæƒè§„åˆ™

æˆæƒè§„åˆ™å¯ä»¥å¯¹è¯·æ±‚æ–¹æ¥æºåšåˆ¤æ–­å’Œæ§åˆ¶ã€‚



##### åŸºæœ¬è§„åˆ™

æˆæƒè§„åˆ™å¯ä»¥å¯¹è°ƒç”¨æ–¹çš„æ¥æºåšæ§åˆ¶ï¼Œæœ‰ç™½åå•å’Œé»‘åå•ä¸¤ç§æ–¹å¼ã€‚

- ç™½åå•ï¼šæ¥æºï¼ˆoriginï¼‰åœ¨ç™½åå•å†…çš„è°ƒç”¨è€…å…è®¸è®¿é—®

- é»‘åå•ï¼šæ¥æºï¼ˆoriginï¼‰åœ¨é»‘åå•å†…çš„è°ƒç”¨è€…ä¸å…è®¸è®¿é—®

ç‚¹å‡»å·¦ä¾§èœå•çš„æˆæƒï¼Œå¯ä»¥çœ‹åˆ°æˆæƒè§„åˆ™ï¼š

![image-20210716152010750](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716152010750.png)

- èµ„æºåï¼šå°±æ˜¯å—ä¿æŠ¤çš„èµ„æºï¼Œä¾‹å¦‚/order/{orderId}

- æµæ§åº”ç”¨ï¼šæ˜¯æ¥æºè€…çš„åå•ï¼Œ
  - å¦‚æœæ˜¯å‹¾é€‰ç™½åå•ï¼Œåˆ™åå•ä¸­çš„æ¥æºè¢«è®¸å¯è®¿é—®ã€‚
  - å¦‚æœæ˜¯å‹¾é€‰é»‘åå•ï¼Œåˆ™åå•ä¸­çš„æ¥æºè¢«ç¦æ­¢è®¿é—®ã€‚

æ¯”å¦‚ï¼š

![image-20210716152349191](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716152349191.png)

æˆ‘ä»¬å…è®¸è¯·æ±‚ä»gatewayåˆ°order-serviceï¼Œä¸å…è®¸æµè§ˆå™¨è®¿é—®order-serviceï¼Œé‚£ä¹ˆç™½åå•ä¸­å°±è¦å¡«å†™**ç½‘å…³çš„æ¥æºåç§°ï¼ˆoriginï¼‰**ã€‚



##### **å¦‚ä½•è·å–origin**

Sentinelæ˜¯é€šè¿‡RequestOriginParserè¿™ä¸ªæ¥å£çš„parseOriginæ¥è·å–è¯·æ±‚çš„æ¥æºçš„ã€‚

```java
public interface RequestOriginParser {
    /**
     * ä»è¯·æ±‚requestå¯¹è±¡ä¸­è·å–originï¼Œè·å–æ–¹å¼è‡ªå®šä¹‰
     */
    String parseOrigin(HttpServletRequest request);
}
```

è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯ä»requestå¯¹è±¡ä¸­ï¼Œè·å–è¯·æ±‚è€…çš„originå€¼å¹¶è¿”å›ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œsentinelä¸ç®¡è¯·æ±‚è€…ä»å“ªé‡Œæ¥ï¼Œè¿”å›å€¼æ°¸è¿œæ˜¯defaultï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€åˆ‡è¯·æ±‚çš„æ¥æºéƒ½è¢«è®¤ä¸ºæ˜¯ä¸€æ ·çš„å€¼defaultã€‚



å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰è¿™ä¸ªæ¥å£çš„å®ç°ï¼Œè®©**ä¸åŒçš„è¯·æ±‚ï¼Œè¿”å›ä¸åŒçš„origin**ã€‚



ä¾‹å¦‚order-serviceæœåŠ¡ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªRequestOriginParserçš„å®ç°ç±»ï¼š

```java
package cn.itcast.order.sentinel;

import com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.RequestOriginParser;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;

import javax.servlet.http.HttpServletRequest;

@Component
public class HeaderOriginParser implements RequestOriginParser {
    @Override
    public String parseOrigin(HttpServletRequest request) {
        // 1.è·å–è¯·æ±‚å¤´
        String origin = request.getHeader("origin");
        // 2.éç©ºåˆ¤æ–­
        if (StringUtils.isEmpty(origin)) {
            origin = "blank";
        }
        return origin;
    }
}
```

æˆ‘ä»¬ä¼šå°è¯•ä»request-headerä¸­è·å–originå€¼ã€‚



##### **ç»™ç½‘å…³æ·»åŠ è¯·æ±‚å¤´**

æ—¢ç„¶è·å–è¯·æ±‚originçš„æ–¹å¼æ˜¯ä»reques-headerä¸­è·å–originå€¼ï¼Œæˆ‘ä»¬å¿…é¡»è®©**æ‰€æœ‰ä»gatewayè·¯ç”±åˆ°å¾®æœåŠ¡çš„è¯·æ±‚éƒ½å¸¦ä¸Šoriginå¤´**ã€‚

è¿™ä¸ªéœ€è¦åˆ©ç”¨ä¹‹å‰å­¦ä¹ çš„ä¸€ä¸ªGatewayFilteræ¥å®ç°ï¼ŒAddRequestHeaderGatewayFilterã€‚

ä¿®æ”¹gatewayæœåŠ¡ä¸­çš„application.ymlï¼Œæ·»åŠ ä¸€ä¸ªdefaultFilterï¼š

```yaml
spring:
  cloud:
    gateway:
      default-filters:
        - AddRequestHeader=origin,gateway
      routes:
       # ...ç•¥
```

è¿™æ ·ï¼Œä»gatewayè·¯ç”±çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šå¸¦ä¸Šoriginå¤´ï¼Œå€¼ä¸ºgatewayã€‚è€Œä»å…¶å®ƒåœ°æ–¹åˆ°è¾¾å¾®æœåŠ¡çš„è¯·æ±‚åˆ™æ²¡æœ‰è¿™ä¸ªå¤´ã€‚



##### **é…ç½®æˆæƒè§„åˆ™**

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæˆæƒè§„åˆ™ï¼Œæ”¾è¡Œoriginå€¼ä¸ºgatewayçš„è¯·æ±‚ã€‚

![image-20210716153250134](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716153250134.png)

é…ç½®å¦‚ä¸‹ï¼š

![image-20210716153301069](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716153301069.png)

ç°åœ¨ï¼Œæˆ‘ä»¬ç›´æ¥è·³è¿‡ç½‘å…³ï¼Œè®¿é—®order-serviceæœåŠ¡ï¼š

![image-20210716153348396](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716153348396.png)

é€šè¿‡ç½‘å…³è®¿é—®ï¼š

![image-20210716153434095](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716153434095.png)







---

---

---







#### è‡ªå®šä¹‰å¼‚å¸¸ç»“æœ

â€‹	é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘ç”Ÿé™æµã€é™çº§ã€æˆæƒæ‹¦æˆªæ—¶ï¼Œéƒ½ä¼šæŠ›å‡ºå¼‚å¸¸åˆ°è°ƒç”¨æ–¹ã€‚å¼‚å¸¸ç»“æœéƒ½æ˜¯flow limmitingï¼ˆé™æµï¼‰ã€‚è¿™æ ·ä¸å¤Ÿå‹å¥½ï¼Œæ— æ³•å¾—çŸ¥æ˜¯é™æµè¿˜æ˜¯é™çº§è¿˜æ˜¯æˆæƒæ‹¦æˆªã€‚





##### å¼‚å¸¸ç±»å‹



è€Œå¦‚æœè¦è‡ªå®šä¹‰å¼‚å¸¸æ—¶çš„è¿”å›ç»“æœï¼Œéœ€è¦å®ç°BlockExceptionHandleræ¥å£ï¼š

```java
public interface BlockExceptionHandler {
    /**
     * å¤„ç†è¯·æ±‚è¢«é™æµã€é™çº§ã€æˆæƒæ‹¦æˆªæ—¶æŠ›å‡ºçš„å¼‚å¸¸ï¼šBlockException
     */
    void handle(HttpServletRequest request, HttpServletResponse response, BlockException e) throws Exception;
}
```

è¿™ä¸ªæ–¹æ³•æœ‰ä¸‰ä¸ªå‚æ•°ï¼š

- HttpServletRequest requestï¼šrequestå¯¹è±¡
- HttpServletResponse responseï¼šresponseå¯¹è±¡
- BlockException eï¼šè¢«sentinelæ‹¦æˆªæ—¶æŠ›å‡ºçš„å¼‚å¸¸

è¿™é‡Œçš„BlockExceptionåŒ…å«å¤šä¸ªä¸åŒçš„å­ç±»ï¼š

| **å¼‚å¸¸**             | **è¯´æ˜**           |
| -------------------- | ------------------ |
| FlowException        | é™æµå¼‚å¸¸           |
| ParamFlowException   | çƒ­ç‚¹å‚æ•°é™æµçš„å¼‚å¸¸ |
| DegradeException     | é™çº§å¼‚å¸¸           |
| AuthorityException   | æˆæƒè§„åˆ™å¼‚å¸¸       |
| SystemBlockException | ç³»ç»Ÿè§„åˆ™å¼‚å¸¸       |



##### è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†

ä¸‹é¢ï¼Œæˆ‘ä»¬å°±åœ¨order-serviceå®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰å¼‚å¸¸å¤„ç†ç±»ï¼š

```java
package cn.itcast.order.sentinel;

import com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.BlockExceptionHandler;
import com.alibaba.csp.sentinel.slots.block.BlockException;
import com.alibaba.csp.sentinel.slots.block.authority.AuthorityException;
import com.alibaba.csp.sentinel.slots.block.degrade.DegradeException;
import com.alibaba.csp.sentinel.slots.block.flow.FlowException;
import com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowException;
import org.springframework.stereotype.Component;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Component
public class SentinelExceptionHandler implements BlockExceptionHandler {
    @Override
    public void handle(HttpServletRequest request, HttpServletResponse response, BlockException e) throws Exception {
        String msg = "æœªçŸ¥å¼‚å¸¸";
        int status = 429;

        if (e instanceof FlowException) {
            msg = "è¯·æ±‚è¢«é™æµäº†";
        } else if (e instanceof ParamFlowException) {
            msg = "è¯·æ±‚è¢«çƒ­ç‚¹å‚æ•°é™æµ";
        } else if (e instanceof DegradeException) {
            msg = "è¯·æ±‚è¢«é™çº§äº†";
        } else if (e instanceof AuthorityException) {
            msg = "æ²¡æœ‰æƒé™è®¿é—®";
            status = 401;
        }

        response.setContentType("application/json;charset=utf-8");
        response.setStatus(status);
        response.getWriter().println("{\"msg\": " + msg + ", \"status\": " + status + "}");
    }
}
```



é‡å¯æµ‹è¯•ï¼Œåœ¨ä¸åŒåœºæ™¯ä¸‹ï¼Œä¼šè¿”å›ä¸åŒçš„å¼‚å¸¸æ¶ˆæ¯.

é™æµï¼š

![image-20210716153938887](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716153938887.png)

æˆæƒæ‹¦æˆªæ—¶ï¼š

![image-20210716154012736](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716154012736.png)







#### è§„åˆ™æŒä¹…åŒ–

ç°åœ¨ï¼Œsentinelçš„æ‰€æœ‰è§„åˆ™éƒ½æ˜¯å†…å­˜å­˜å‚¨ï¼Œé‡å¯åæ‰€æœ‰è§„åˆ™éƒ½ä¼šä¸¢å¤±ã€‚

åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿è¿™äº›è§„åˆ™çš„æŒä¹…åŒ–ï¼Œé¿å…ä¸¢å¤±ã€‚



##### è§„åˆ™ç®¡ç†æ¨¡å¼

è§„åˆ™æ˜¯å¦èƒ½æŒä¹…åŒ–ï¼Œå–å†³äºè§„åˆ™ç®¡ç†æ¨¡å¼ï¼Œsentinelæ”¯æŒä¸‰ç§è§„åˆ™ç®¡ç†æ¨¡å¼ï¼š

- åŸå§‹æ¨¡å¼ï¼šSentinelçš„é»˜è®¤æ¨¡å¼ï¼Œå°†è§„åˆ™ä¿å­˜åœ¨å†…å­˜ï¼Œé‡å¯æœåŠ¡ä¼šä¸¢å¤±ã€‚
- pullæ¨¡å¼
- pushæ¨¡å¼



##### pullæ¨¡å¼

pullæ¨¡å¼ï¼šæ§åˆ¶å°å°†é…ç½®çš„è§„åˆ™æ¨é€åˆ°Sentinelå®¢æˆ·ç«¯ï¼Œè€Œå®¢æˆ·ç«¯ä¼šå°†é…ç½®è§„åˆ™ä¿å­˜åœ¨æœ¬åœ°æ–‡ä»¶æˆ–æ•°æ®åº“ä¸­ã€‚ä»¥åä¼šå®šæ—¶å»æœ¬åœ°æ–‡ä»¶æˆ–æ•°æ®åº“ä¸­æŸ¥è¯¢ï¼Œæ›´æ–°æœ¬åœ°è§„åˆ™ã€‚

![image-20210716154155238](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716154155238.png)



##### pushæ¨¡å¼

pushæ¨¡å¼ï¼šæ§åˆ¶å°å°†é…ç½®è§„åˆ™æ¨é€åˆ°è¿œç¨‹é…ç½®ä¸­å¿ƒï¼Œä¾‹å¦‚Nacosã€‚Sentinelå®¢æˆ·ç«¯ç›‘å¬Nacosï¼Œè·å–é…ç½®å˜æ›´çš„æ¨é€æ¶ˆæ¯ï¼Œå®Œæˆæœ¬åœ°é…ç½®æ›´æ–°ã€‚

![image-20210716154215456](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210716154215456.png)







##### å®ç°pushæ¨¡å¼





è®©æœåŠ¡ç›‘å¬Nacosä¸­çš„sentinelè§„åˆ™é…ç½®ã€‚





###### å¼•å…¥ä¾èµ–

åœ¨order-serviceä¸­å¼•å…¥sentinelç›‘å¬nacosçš„ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-datasource-nacos</artifactId>
</dependency>
```



###### é…ç½®nacosåœ°å€

åœ¨order-serviceä¸­çš„application.ymlæ–‡ä»¶é…ç½®nacosåœ°å€åŠç›‘å¬çš„é…ç½®ä¿¡æ¯ï¼š

```yaml
spring:
  cloud:
    sentinel:
      datasource:
        flow:
          nacos:
            server-addr: localhost:8848 # nacosåœ°å€
            dataId: orderservice-flow-rules
            groupId: SENTINEL_GROUP
            rule-type: flow # è¿˜å¯ä»¥æ˜¯ï¼šdegradeã€authorityã€param-flow
```





###### ä¿®æ”¹æºç 

SentinelDashboardé»˜è®¤ä¸æ”¯æŒnacosçš„æŒä¹…åŒ–ï¼Œéœ€è¦ä¿®æ”¹æºç ã€‚



**ä¸€ã€è§£å‹**

è§£å‹è¯¾å‰èµ„æ–™ä¸­çš„sentinelæºç åŒ…ï¼š

![image-20210618201340086](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210618201340086.png)

ç„¶åå¹¶ç”¨IDEAæ‰“å¼€è¿™ä¸ªé¡¹ç›®ï¼Œç»“æ„å¦‚ä¸‹ï¼š

![image-20210618201412878](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210618201412878.png)

**äºŒã€ä¿®æ”¹nacosä¾èµ–**

åœ¨sentinel-dashboardæºç çš„pomæ–‡ä»¶ä¸­ï¼Œnacosçš„ä¾èµ–é»˜è®¤çš„scopeæ˜¯testï¼Œåªèƒ½åœ¨æµ‹è¯•æ—¶ä½¿ç”¨ï¼Œè¿™é‡Œè¦å»é™¤ï¼š

![image-20210618201607831](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210618201607831.png)

å°†sentinel-datasource-nacosä¾èµ–çš„scopeå»æ‰ï¼š

```xml
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-datasource-nacos</artifactId>
</dependency>
```



**ä¸‰ã€æ·»åŠ nacosæ”¯æŒ**

åœ¨sentinel-dashboardçš„teståŒ…ä¸‹ï¼Œå·²ç»ç¼–å†™äº†å¯¹nacosçš„æ”¯æŒï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æ‹·è´åˆ°mainä¸‹ã€‚

![image-20210618201726280](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210618201726280.png)



**å››ã€ä¿®æ”¹nacosåœ°å€**

ç„¶åï¼Œè¿˜éœ€è¦ä¿®æ”¹æµ‹è¯•ä»£ç ä¸­çš„NacosConfigç±»ï¼š

![image-20210618201912078](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210618201912078.png)

ä¿®æ”¹å…¶ä¸­çš„nacosåœ°å€ï¼Œè®©å…¶è¯»å–application.propertiesä¸­çš„é…ç½®ï¼š

![image-20210618202047575](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210618202047575.png)

åœ¨sentinel-dashboardçš„application.propertiesä¸­æ·»åŠ nacosåœ°å€é…ç½®ï¼š

```properties
nacos.addr=localhost:8848
```



**äº”ã€é…ç½®nacosæ•°æ®æº**

å¦å¤–ï¼Œè¿˜éœ€è¦ä¿®æ”¹com.alibaba.csp.sentinel.dashboard.controller.v2åŒ…ä¸‹çš„FlowControllerV2ç±»ï¼š

![image-20210618202322301](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210618202322301.png)

è®©æˆ‘ä»¬æ·»åŠ çš„Nacosæ•°æ®æºç”Ÿæ•ˆï¼š

![image-20210618202334536](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210618202334536.png)



**å…­ã€ä¿®æ”¹å‰ç«¯é¡µé¢**

æ¥ä¸‹æ¥ï¼Œè¿˜è¦ä¿®æ”¹å‰ç«¯é¡µé¢ï¼Œæ·»åŠ ä¸€ä¸ªæ”¯æŒnacosçš„èœå•ã€‚

ä¿®æ”¹src/main/webapp/resources/app/scripts/directives/sidebar/ç›®å½•ä¸‹çš„sidebar.htmlæ–‡ä»¶ï¼š

![image-20210618202433356](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210618202433356.png)



å°†å…¶ä¸­çš„è¿™éƒ¨åˆ†æ³¨é‡Šæ‰“å¼€ï¼š

![image-20210618202449881](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210618202449881.png)



ä¿®æ”¹å…¶ä¸­çš„æ–‡æœ¬ï¼š

![image-20210618202501928](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210618202501928.png)



**ä¸ƒã€é‡æ–°ç¼–è¯‘ã€æ‰“åŒ…é¡¹ç›®**

è¿è¡ŒIDEAä¸­çš„mavenæ’ä»¶ï¼Œç¼–è¯‘å’Œæ‰“åŒ…ä¿®æ”¹å¥½çš„Sentinel-Dashboardï¼š

![image-20210618202701492](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210618202701492.png)



**å…«ã€å¯åŠ¨**

å¯åŠ¨æ–¹å¼è·Ÿå®˜æ–¹ä¸€æ ·ï¼š

```sh
java -jar sentinel-dashboard.jar
```

å¦‚æœè¦ä¿®æ”¹nacosåœ°å€ï¼Œéœ€è¦æ·»åŠ å‚æ•°ï¼š

```sh
java -jar -Dnacos.addr=localhost:8848 sentinel-dashboard.jar
```



---

---

---







## ğŸ’¸åˆ†å¸ƒå¼äº‹åŠ¡



### ç®€è¿°





#### æœ¬åœ°äº‹åŠ¡

æœ¬åœ°äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯ä¼ ç»Ÿçš„**å•æœºäº‹åŠ¡**ã€‚åœ¨ä¼ ç»Ÿæ•°æ®åº“äº‹åŠ¡ä¸­ï¼Œå¿…é¡»è¦æ»¡è¶³å››ä¸ªåŸåˆ™ï¼š

![image-20210724165045186](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210724165045186.png)







#### åˆ†å¸ƒå¼äº‹åŠ¡

**åˆ†å¸ƒå¼äº‹åŠ¡**ï¼Œå°±æ˜¯æŒ‡ä¸æ˜¯åœ¨å•ä¸ªæœåŠ¡æˆ–å•ä¸ªæ•°æ®åº“æ¶æ„ä¸‹ï¼Œäº§ç”Ÿçš„äº‹åŠ¡ï¼Œä¾‹å¦‚ï¼š

- è·¨æ•°æ®æºçš„åˆ†å¸ƒå¼äº‹åŠ¡
- è·¨æœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡
- ç»¼åˆæƒ…å†µ



åœ¨æ•°æ®åº“æ°´å¹³æ‹†åˆ†ã€æœåŠ¡å‚ç›´æ‹†åˆ†ä¹‹åï¼Œä¸€ä¸ªä¸šåŠ¡æ“ä½œé€šå¸¸è¦è·¨å¤šä¸ªæ•°æ®åº“ã€æœåŠ¡æ‰èƒ½å®Œæˆã€‚ä¾‹å¦‚ç”µå•†è¡Œä¸šä¸­æ¯”è¾ƒå¸¸è§çš„ä¸‹å•ä»˜æ¬¾æ¡ˆä¾‹ï¼ŒåŒ…æ‹¬ä¸‹é¢å‡ ä¸ªè¡Œä¸ºï¼š

- åˆ›å»ºæ–°è®¢å•
- æ‰£å‡å•†å“åº“å­˜
- ä»ç”¨æˆ·è´¦æˆ·ä½™é¢æ‰£é™¤é‡‘é¢



å®Œæˆä¸Šé¢çš„æ“ä½œéœ€è¦è®¿é—®ä¸‰ä¸ªä¸åŒçš„å¾®æœåŠ¡å’Œä¸‰ä¸ªä¸åŒçš„æ•°æ®åº“ã€‚

![image-20210724165338958](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210724165338958.png)



è®¢å•çš„åˆ›å»ºã€åº“å­˜çš„æ‰£å‡ã€è´¦æˆ·æ‰£æ¬¾åœ¨æ¯ä¸€ä¸ªæœåŠ¡å’Œæ•°æ®åº“å†…æ˜¯ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œå¯ä»¥ä¿è¯ACIDåŸåˆ™ã€‚

ä½†æ˜¯å½“æˆ‘ä»¬æŠŠä¸‰ä»¶äº‹æƒ…çœ‹åšä¸€ä¸ª"ä¸šåŠ¡"ï¼Œè¦æ»¡è¶³ä¿è¯â€œä¸šåŠ¡â€çš„åŸå­æ€§ï¼Œè¦ä¹ˆæ‰€æœ‰æ“ä½œå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸å…è®¸å‡ºç°éƒ¨åˆ†æˆåŠŸéƒ¨åˆ†å¤±è´¥çš„ç°è±¡ï¼Œè¿™å°±æ˜¯**åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹çš„äº‹åŠ¡**äº†ã€‚

æ­¤æ—¶ACIDéš¾ä»¥æ»¡è¶³ï¼Œè¿™æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡è¦è§£å†³çš„é—®é¢˜ã€‚





**åˆ†å¸ƒå¼æœåŠ¡çš„äº‹åŠ¡é—®é¢˜**

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ï¼Œä¸€ä¸ªä¸šåŠ¡è·¨è¶Šå¤šä¸ªæœåŠ¡æˆ–æ•°æ®æºï¼Œæ¯ä¸ªæœåŠ¡éƒ½æ˜¯ä¸€ä¸ªåˆ†æ”¯äº‹åŠ¡ï¼Œè¦ä¿è¯æ‰€æœ‰åˆ†æ”¯äº‹åŠ¡æœ€ç»ˆçŠ¶æ€ä¸€è‡´ ï¼Œè¿™æ ·çš„äº‹åŠ¡å°±æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ã€‚

![image-20230311200306408](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311200306408.png)









### ç†è®ºåŸºç¡€



![image-20230311200401946](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311200401946.png)





#### CAPå®šç†

1998å¹´ï¼ŒåŠ å·å¤§å­¦çš„è®¡ç®—æœºç§‘å­¦å®¶ Eric Brewer æå‡ºï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿæœ‰ä¸‰ä¸ªæŒ‡æ ‡ï¼š

- **Consistencyï¼ˆä¸€è‡´æ€§ï¼‰**

- **Availabilityï¼ˆå¯ç”¨æ€§ï¼‰**

- **Partition tolerance ï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰**



Eric Brewer è¯´ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿæ— æ³•åŒæ—¶æ»¡è¶³è¿™ä¸‰ä¸ªæŒ‡æ ‡ã€‚ è¿™ä¸ªç»“è®ºå°±å«åš CAP å®šç†ã€‚

![image-20230311200613390](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311200613390.png)







**Consistencyï¼ˆä¸€è‡´æ€§ï¼‰**

![image-20230311200613390](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311200724875.png)



**Availabilityï¼ˆå¯ç”¨æ€§ï¼‰**

![image-20230311201138077](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311201138077.png)



**Partition tolerance ï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰**

![image-20230311201207714](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311201207714.png)





ç®€è¿°CAPå®šç†å†…å®¹ï¼Ÿ

- **åˆ†å¸ƒå¼ç³»ç»ŸèŠ‚ç‚¹é€šè¿‡ç½‘ç»œè¿æ¥ï¼Œä¸€å®šä¼šå‡ºç°åˆ†åŒºé—®é¢˜ï¼ˆPï¼‰**
- å½“åˆ†åŒºå‡ºç°æ—¶ï¼Œç³»ç»Ÿçš„ä¸€è‡´æ€§ï¼ˆ**C**ï¼‰å’Œå¯ç”¨æ€§ï¼ˆ**A**ï¼‰å°±æ— æ³• åŒæ—¶æ»¡è¶³



æ€è€ƒï¼šelasticsearché›†ç¾¤æ˜¯CPè¿˜æ˜¯APï¼Ÿ

- ESé›†ç¾¤å‡ºç°åˆ†åŒºæ—¶ï¼Œæ•…éšœèŠ‚ç‚¹ä¼šè¢«å‰”é™¤é›†ç¾¤ï¼Œæ•°æ®åˆ†ç‰‡ä¼š é‡æ–°åˆ†é…åˆ°å…¶å®ƒèŠ‚ç‚¹ï¼Œä¿è¯æ•°æ®ä¸€è‡´ã€‚
- å› æ­¤æ˜¯ä½å¯ç”¨æ€§ï¼Œé«˜ä¸€è‡´æ€§ï¼Œå±äºCP







#### BASEç†è®º

BASEç†è®ºæ˜¯å¯¹CAPçš„ä¸€ç§è§£å†³æ€è·¯ï¼ŒåŒ…å«ä¸‰ä¸ªæ€æƒ³ï¼š

- BA[**åŸºæœ¬å¯ç”¨**]ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°æ•…éšœæ—¶ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼Œå³ä¿è¯æ ¸å¿ƒå¯ç”¨ã€‚
- S [**è½¯çŠ¶æ€**]ï¼šåœ¨ä¸€å®šæ—¶é—´å†…ï¼Œå…è®¸å‡ºç°ä¸­é—´çŠ¶æ€ï¼Œæ¯”å¦‚ä¸´æ—¶çš„ä¸ä¸€è‡´çŠ¶æ€ã€‚
- E [**æœ€ç»ˆä¸€è‡´æ€§**]ï¼šè™½ç„¶æ— æ³•ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œä½†æ˜¯åœ¨è½¯çŠ¶æ€ç»“æŸåï¼Œæœ€ç»ˆè¾¾åˆ°æ•°æ®ä¸€è‡´ã€‚



|          è¯           |     æ„     |
| :-------------------: | :--------: |
|  Basically Available  |  åŸºæœ¬å¯ç”¨  |
|      Soft State       |   è½¯çŠ¶æ€   |
| Eventually Consistent | æœ€ç»ˆä¸€è‡´æ€§ |



è€Œåˆ†å¸ƒå¼äº‹åŠ¡æœ€å¤§çš„é—®é¢˜æ˜¯å„ä¸ªå­äº‹åŠ¡çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œå› æ­¤å¯ä»¥å€Ÿé‰´CAPå®šç†å’ŒBASEç†è®ºï¼š

- **APæ¨¡å¼ï¼š**å„å­äº‹åŠ¡åˆ†åˆ«æ‰§è¡Œå’Œæäº¤ï¼Œå…è®¸å‡ºç°ç»“æœä¸ä¸€è‡´ï¼Œç„¶åé‡‡ç”¨å¼¥è¡¥æªæ–½æ¢å¤æ•°æ®å³å¯ï¼Œ**å®ç°æœ€ç»ˆä¸€è‡´**ã€‚
- **CPæ¨¡å¼ï¼š**å„ä¸ªå­äº‹åŠ¡æ‰§è¡Œåäº’ç›¸ç­‰å¾…ï¼ŒåŒæ—¶æäº¤ï¼ŒåŒæ—¶å›æ»šï¼Œè¾¾æˆ**å¼ºä¸€è‡´**ã€‚ä½†äº‹åŠ¡ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œå¤„äº**å¼±å¯ç”¨çŠ¶æ€**ã€‚







#### åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹

è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå„ä¸ªå­ç³»ç»Ÿä¹‹é—´å¿…é¡»èƒ½æ„ŸçŸ¥åˆ°å½¼æ­¤çš„äº‹åŠ¡çŠ¶æ€ï¼Œæ‰èƒ½ä¿è¯çŠ¶æ€ä¸€è‡´ï¼Œ

å› æ­¤éœ€è¦ä¸€ä¸ªäº‹åŠ¡åè°ƒè€…æ¥åè°ƒæ¯ä¸€ä¸ªäº‹åŠ¡çš„å‚ä¸è€…ï¼ˆå­ç³»ç»Ÿäº‹åŠ¡ï¼‰ã€‚

è¿™é‡Œçš„å­ç³»ç»Ÿäº‹åŠ¡ï¼Œç§°ä¸º**åˆ†æ”¯äº‹åŠ¡**ï¼›æœ‰å…³è”çš„å„ä¸ªåˆ†æ”¯äº‹åŠ¡åœ¨ä¸€èµ·ç§°ä¸º**å…¨å±€äº‹åŠ¡**

![image-20230311202345432](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311202345432.png)







ç®€è¿°BASEç†è®ºä¸‰ä¸ªæ€æƒ³ï¼š

- **åŸºæœ¬å¯ç”¨** â€¢ **è½¯çŠ¶æ€** â€¢ **æœ€ç»ˆä¸€è‡´**



è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„æ€æƒ³å’Œæ¨¡å‹ï¼š

- **å…¨å±€äº‹åŠ¡**ï¼šæ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡
- **åˆ†æ”¯äº‹åŠ¡**ï¼šåˆ†å¸ƒå¼äº‹åŠ¡ä¸­åŒ…å«çš„æ¯ä¸ªå­ç³»ç»Ÿçš„äº‹åŠ¡
- **æœ€ç»ˆä¸€è‡´æ€æƒ³**ï¼šå„åˆ†æ”¯äº‹åŠ¡åˆ†åˆ«æ‰§è¡Œå¹¶æäº¤ï¼Œå¦‚æœæœ‰ä¸ä¸€è‡´ çš„æƒ…å†µï¼Œå†æƒ³åŠæ³•æ¢å¤æ•°æ®
- **å¼ºä¸€è‡´æ€æƒ³**ï¼šå„åˆ†æ”¯äº‹åŠ¡æ‰§è¡Œå®Œä¸šåŠ¡ä¸è¦æäº¤ï¼Œç­‰å¾…å½¼æ­¤ç»“ æœã€‚è€Œåç»Ÿä¸€æäº¤æˆ–å›æ»š









### Seataæ¡†æ¶



#### ğŸ”–Seataä»‹ç»

Seataæ˜¯2019å¹´1æœˆä»½èš‚èšé‡‘æœå’Œé˜¿é‡Œå·´å·´å…±åŒå¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚è‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼ äº‹åŠ¡æœåŠ¡ï¼Œä¸ºç”¨æˆ·æ‰“é€ ä¸€ç«™å¼çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‚

å®˜ç½‘åœ°å€ï¼šhttp://seata.io/ï¼Œå…¶ä¸­çš„æ–‡æ¡£ã€æ’­å®¢ä¸­æä¾›äº†å¤§é‡çš„ä½¿ç”¨è¯´æ˜ã€æºç åˆ†æã€‚





#### ğŸ”–Seataæ¶æ„

Seataäº‹åŠ¡ç®¡ç†ä¸­æœ‰ä¸‰ä¸ªé‡è¦çš„è§’è‰²ï¼š

- **TC - äº‹åŠ¡åè°ƒè€…**ï¼šç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œåè°ƒå…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚
- **TM - äº‹åŠ¡ç®¡ç†å™¨**ï¼šå®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ã€å¼€å§‹å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡ã€‚
- **RM - èµ„æºç®¡ç†å™¨**ï¼šç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œä¸TCäº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡ çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»š



![image-20230311203012810](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311203012810.png)



|           è¯            |ç®€|     æ„     |
| :---------------------: | :--------:|:--------: |
| Transaction Coordinator |**TC** |**äº‹åŠ¡åè°ƒè€…** |
|   Transaction Manager   |**TM** |**äº‹åŠ¡ç®¡ç†å™¨** |
|    Resource Manager     | **RM** |**èµ„æºç®¡ç†å™¨** |







#### ğŸ”–Seataéƒ¨ç½²



é¦–å…ˆæˆ‘ä»¬è¦ä¸‹è½½`seata-server`åŒ…ï¼Œåœ°å€åœ¨[http](http://seata.io/zh-cn/blog/download.html)[://seata.io/zh-cn/blog/download](http://seata.io/zh-cn/blog/download.html)[.](http://seata.io/zh-cn/blog/download.html)[html](http://seata.io/zh-cn/blog/download.html)

åœ¨éä¸­æ–‡ç›®å½•è§£å‹ç¼©è¿™ä¸ª`zip`åŒ…ï¼Œå…¶ç›®å½•ç»“æ„å¦‚ä¸‹

ä¿®æ”¹confç›®å½•ä¸‹çš„`registry.conf`æ–‡ä»¶ï¼Œæ–°ç‰ˆæœ¬æ˜¯`application.yaml`

`registry.conf`:

```yaml
registry {
  # tcæœåŠ¡çš„æ³¨å†Œä¸­å¿ƒç±»ï¼Œè¿™é‡Œé€‰æ‹©nacosï¼Œä¹Ÿå¯ä»¥æ˜¯eurekaã€zookeeperç­‰
  type = "nacos"

  nacos {
    # seata tc æœåŠ¡æ³¨å†Œåˆ° nacosçš„æœåŠ¡åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰
    application = "seata-tc-server"
    serverAddr = "127.0.0.1:8848"
    group = "DEFAULT_GROUP"
    namespace = ""
    cluster = "SH"
    username = "nacos"
    password = "nacos"
  }
}

config {
  # è¯»å–tcæœåŠ¡ç«¯çš„é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œè¿™é‡Œæ˜¯ä»nacosé…ç½®ä¸­å¿ƒè¯»å–ï¼Œè¿™æ ·å¦‚æœtcæ˜¯é›†ç¾¤ï¼Œå¯ä»¥å…±äº«é…ç½®
  type = "nacos"
  # é…ç½®nacosåœ°å€ç­‰ä¿¡æ¯
  nacos {
    serverAddr = "127.0.0.1:8848"
    namespace = ""
    group = "SEATA_GROUP"
    username = "nacos"
    password = "nacos"
    dataId = "seataServer.properties"
  }
}
```

`application.yaml`

```yaml
seata:
  # æœåŠ¡æ³¨å†Œä¸­å¿ƒ
  registry:
    # support: nacos ã€ eureka ã€ redis ã€ zk  ã€ consul ã€ etcd3 ã€ sofa
    type: nacos
    # preferred-networks: 30.240.*
    nacos:
      application: seata-tc-server
      server-addr: 127.0.0.1:8848
      group: "DEFAULT_GROUP"
      namespace: ""
      cluster: SH
      username: nacos
      password: nacos
      context-path:
      ##if use MSE Nacos with auth, mutex with username/password attribute
      #access-key:
      #secret-key:

  # é…ç½®ä¸­å¿ƒ
  config:
    # support: nacos ã€ consul ã€ apollo ã€ zk  ã€ etcd3
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      namespace: ""
      group: SEATA_GROUP
      username: nacos
      password: nacos
      context-path:
      ##if use MSE Nacos with auth, mutex with username/password attribute
      #access-key:
      #secret-key:
      data-id: seataServer.properties
  security:
    secretKey: SeataSecretKey0c382ef121d778043159209298fd40bf3850a017
    tokenValidityInMilliseconds: 1800000
    ignore:
      urls: /,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.ico,/console-fe/public/**,/api/v1/auth/login

```



åœ¨nacosæ·»åŠ é…ç½®

ç‰¹åˆ«æ³¨æ„ï¼Œä¸ºäº†è®©tcæœåŠ¡çš„é›†ç¾¤å¯ä»¥å…±äº«é…ç½®ï¼Œæˆ‘ä»¬é€‰æ‹©äº†nacosä½œä¸ºç»Ÿä¸€é…ç½®ä¸­å¿ƒã€‚å› æ­¤æœåŠ¡ç«¯é…ç½®æ–‡ä»¶seataServer.propertiesæ–‡ä»¶éœ€è¦åœ¨nacosä¸­é…å¥½ã€‚

![image-20230311204924791](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311204924791.png)



```properties
# æ•°æ®å­˜å‚¨æ–¹å¼ï¼Œdbä»£è¡¨æ•°æ®åº“
store.mode=db
store.db.datasource=druid
store.db.dbType=mysql
store.db.driverClassName=com.mysql.jdbc.Driver
store.db.url=jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true&rewriteBatchedStatements=true
store.db.user=root
store.db.password=123
store.db.minConn=5
store.db.maxConn=30
store.db.globalTable=global_table
store.db.branchTable=branch_table
store.db.queryLimit=100
store.db.lockTable=lock_table
store.db.maxWait=5000
# äº‹åŠ¡ã€æ—¥å¿—ç­‰é…ç½®
server.recovery.committingRetryPeriod=1000
server.recovery.asynCommittingRetryPeriod=1000
server.recovery.rollbackingRetryPeriod=1000
server.recovery.timeoutRetryPeriod=1000
server.maxCommitRetryTimeout=-1
server.maxRollbackRetryTimeout=-1
server.rollbackRetryTimeoutUnlockEnable=false
server.undo.logSaveDays=7
server.undo.logDeletePeriod=86400000

# å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¼ è¾“æ–¹å¼
transport.serialization=seata
transport.compressor=none
# å…³é—­metricsåŠŸèƒ½ï¼Œæé«˜æ€§èƒ½
metrics.enabled=false
metrics.registryType=compact
metrics.exporterList=prometheus
metrics.exporterPrometheusPort=9898
```

å…¶ä¸­çš„`æ•°æ®åº“åœ°å€`ã€`ç”¨æˆ·å`ã€`å¯†ç `éƒ½éœ€è¦ä¿®æ”¹æˆä½ è‡ªå·±çš„æ•°æ®åº“ä¿¡æ¯ã€‚



**åˆ›å»ºæ•°æ®åº“è¡¨**

ç‰¹åˆ«æ³¨æ„ï¼štcæœåŠ¡åœ¨ç®¡ç†åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œéœ€è¦è®°å½•äº‹åŠ¡ç›¸å…³æ•°æ®åˆ°æ•°æ®åº“ä¸­ï¼Œä½ éœ€è¦æå‰åˆ›å»ºå¥½è¿™äº›è¡¨ã€‚

æ–°å»ºä¸€ä¸ªåä¸º`seataçš„æ•°æ®åº“`/`åˆšåˆšé…ç½®çš„åº“`

è¿™äº›è¡¨ä¸»è¦è®°å½•`å…¨å±€äº‹åŠ¡`ã€`åˆ†æ”¯äº‹åŠ¡`ã€`å…¨å±€é”ä¿¡æ¯`ï¼š

```mysql
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- åˆ†æ”¯äº‹åŠ¡è¡¨
-- ----------------------------
DROP TABLE IF EXISTS `branch_table`;
CREATE TABLE `branch_table`  (
  `branch_id` bigint(20) NOT NULL,
  `xid` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `transaction_id` bigint(20) NULL DEFAULT NULL,
  `resource_group_id` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `resource_id` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `branch_type` varchar(8) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `status` tinyint(4) NULL DEFAULT NULL,
  `client_id` varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `application_data` varchar(2000) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `gmt_create` datetime(6) NULL DEFAULT NULL,
  `gmt_modified` datetime(6) NULL DEFAULT NULL,
  PRIMARY KEY (`branch_id`) USING BTREE,
  INDEX `idx_xid`(`xid`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;

-- ----------------------------
-- å…¨å±€äº‹åŠ¡è¡¨
-- ----------------------------
DROP TABLE IF EXISTS `global_table`;
CREATE TABLE `global_table`  (
  `xid` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `transaction_id` bigint(20) NULL DEFAULT NULL,
  `status` tinyint(4) NOT NULL,
  `application_id` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `transaction_service_group` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `transaction_name` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `timeout` int(11) NULL DEFAULT NULL,
  `begin_time` bigint(20) NULL DEFAULT NULL,
  `application_data` varchar(2000) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `gmt_create` datetime NULL DEFAULT NULL,
  `gmt_modified` datetime NULL DEFAULT NULL,
  PRIMARY KEY (`xid`) USING BTREE,
  INDEX `idx_gmt_modified_status`(`gmt_modified`, `status`) USING BTREE,
  INDEX `idx_transaction_id`(`transaction_id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;

SET FOREIGN_KEY_CHECKS = 1;
```



**å¯åŠ¨TCæœåŠ¡**

è¿›å…¥binç›®å½•ï¼Œè¿è¡Œå…¶ä¸­çš„seata-server.batå³å¯

å¯åŠ¨æˆåŠŸåï¼Œseata-serveråº”è¯¥å·²ç»æ³¨å†Œåˆ°nacosæ³¨å†Œä¸­å¿ƒäº†ã€‚

æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®nacosåœ°å€ï¼šhttp://localhost:8848ï¼Œç„¶åè¿›å…¥æœåŠ¡åˆ—è¡¨é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°seata-tc-serverçš„ä¿¡æ¯ï¼š





#### ğŸ”–Seataæ•´åˆ

**å¾®æœåŠ¡é›†æˆseata**



å¼•å…¥ä¾èµ– `pom.xml`

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
    <exclusions>
        <!--ç‰ˆæœ¬è¾ƒä½ï¼Œ1.3.0ï¼Œå› æ­¤æ’é™¤-->
        <exclusion>
            <artifactId>seata-spring-boot-starter</artifactId>
            <groupId>io.seata</groupId>
        </exclusion>
    </exclusions>
</dependency>
<!--seata starter é‡‡ç”¨1.4.2ç‰ˆæœ¬-->
<dependency>
    <groupId>io.seata</groupId>
    <artifactId>seata-spring-boot-starter</artifactId>
    <version>${seata.version}</version>
</dependency>
```

ä¿®æ”¹é…ç½®æ–‡ä»¶ `application.yaml`

```yaml
seata:
  registry: # TCæœåŠ¡æ³¨å†Œä¸­å¿ƒçš„é…ç½®ï¼Œå¾®æœåŠ¡æ ¹æ®è¿™äº›ä¿¡æ¯å»æ³¨å†Œä¸­å¿ƒè·å–tcæœåŠ¡åœ°å€
    # å‚è€ƒtcæœåŠ¡è‡ªå·±çš„registry.confä¸­çš„é…ç½®
    type: nacos
    nacos: # tc
      server-addr: 127.0.0.1:8848
      namespace: ""
      group: DEFAULT_GROUP
      application: seata-tc-server # tcæœåŠ¡åœ¨nacosä¸­çš„æœåŠ¡åç§°
      cluster: SH
  tx-service-group: seata-demo # äº‹åŠ¡ç»„ï¼Œæ ¹æ®è¿™ä¸ªè·å–tcæœåŠ¡çš„clusteråç§°
  service:
    vgroup-mapping: # äº‹åŠ¡ç»„ä¸TCæœåŠ¡clusterçš„æ˜ å°„å…³ç³»
      seata-demo: SH
```

**æ³¨æ„ï¼š**

nacosæœåŠ¡åç§°ç»„æˆåŒ…æ‹¬`namespace`+`group`+`serviceName`+`cluster`

seataå®¢æˆ·ç«¯è·å–`tcçš„cluster`åç§°æ–¹å¼æ˜¯ä»¥`tx-group-service`çš„å€¼ä¸º`keyåˆ°vgroupMapping`ä¸­æŸ¥æ‰¾

![image-20230311205806993](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311205806993.png)









#### ğŸ”¢Seataæ¨¡å¼â¤µï¸



#### 1ï¸âƒ£XAæ¨¡å¼



**XAæ¨¡å¼åŸç†**

`XAè§„èŒƒ`æ˜¯ X/Open ç»„ç»‡å®šä¹‰çš„åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ï¼ˆDTPï¼ŒDistributed Transaction Processingï¼‰æ ‡å‡†ï¼Œ`XAè§„èŒƒ`æè¿°äº†å…¨å±€çš„ `TM`ä¸å±€éƒ¨çš„`RM`ä¹‹é—´çš„æ¥å£ï¼Œå‡ ä¹æ‰€æœ‰ä¸»æµçš„æ•°æ®åº“éƒ½å¯¹`XAè§„èŒƒ`æä¾›äº†æ”¯æŒã€‚



**æˆåŠŸ**![image-20230311210818874](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311210818874.png)

**å¤±è´¥**![image-20230311210921104](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311210921104.png)

---





**seataçš„XAæ¨¡å¼**

![image-20230311211457115](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311211457115.png)

---

![image-20230311212528831](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311212528831.png)

---



XAæ¨¡å¼çš„ä¼˜ç‚¹

- äº‹åŠ¡çš„å¼ºä¸€è‡´æ€§ï¼Œæ»¡è¶³ACIDåŸåˆ™ã€‚
- å¸¸ç”¨æ•°æ®åº“éƒ½æ”¯æŒï¼Œå®ç°ç®€å•ï¼Œå¹¶ä¸”æ²¡æœ‰ä»£ç ä¾µå…¥

XAæ¨¡å¼çš„ç¼ºç‚¹

- å› ä¸ºä¸€é˜¶æ®µéœ€è¦é”å®šæ•°æ®åº“èµ„æºï¼Œç­‰å¾…äºŒé˜¶æ®µç»“æŸæ‰é‡Šæ”¾ï¼Œæ€§èƒ½è¾ƒå·®
- ä¾èµ–å…³ç³»å‹æ•°æ®åº“å®ç°äº‹åŠ¡



**å®ç°XAæ¨¡å¼**

Seataçš„starterå·²ç»å®Œæˆäº†XAæ¨¡å¼çš„è‡ªåŠ¨è£…é…ï¼Œå®ç°éå¸¸ç®€å•ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

1. ä¿®æ”¹application.ymlæ–‡ä»¶ï¼ˆæ¯ä¸ªå‚ä¸äº‹åŠ¡çš„å¾®æœåŠ¡ï¼‰ï¼Œå¼€å¯XAæ¨¡å¼ï¼š

```yaml
seata:
  data-source-proxy-mode: XA # å¼€å¯æ•°æ®æºä»£ç†çš„XAæ¨¡å¼
```

2. ç»™å‘èµ·å…¨å±€äº‹åŠ¡çš„å…¥å£æ–¹æ³•æ·»åŠ `@GlobalTransactional`æ³¨è§£ï¼Œæœ¬ä¾‹ä¸­æ˜¯OrderServiceImplä¸­çš„createæ–¹æ³•ï¼š

```java
@Override
@GlobalTransactional
public Long create(Order order) {
	// åˆ›å»ºè®¢å•
	orderMapper.insert(order);
	// æ‰£ä½™é¢ ...ç•¥
	// æ‰£å‡åº“å­˜ ...ç•¥
	return order.getId();
}
```

3. é‡å¯æœåŠ¡å¹¶æµ‹è¯•





---



#### 2ï¸âƒ£ATæ¨¡å¼

**ATæ¨¡å¼åŸç†**

ATæ¨¡å¼åŒæ ·æ˜¯åˆ†é˜¶æ®µæäº¤çš„äº‹åŠ¡æ¨¡å‹ï¼Œä¸è¿‡ç¼ºå¼¥è¡¥äº†XAæ¨¡å‹ä¸­èµ„æºé”å®šå‘¨æœŸè¿‡é•¿çš„ç¼ºé™·ã€‚

**é˜¶æ®µä¸€RMçš„å·¥ä½œ**ï¼š

1. æ³¨å†Œåˆ†æ”¯äº‹åŠ¡
2. è®°å½•undo-logï¼ˆæ•°æ®å¿«ç…§ï¼‰
3. æ‰§è¡Œä¸šåŠ¡sqlå¹¶æäº¤
4. æŠ¥å‘Šäº‹åŠ¡çŠ¶æ€

**é˜¶æ®µäºŒæäº¤æ—¶RMçš„å·¥ä½œ**ï¼š

- åˆ é™¤undo-logå³å¯

**é˜¶æ®µäºŒå›æ»šæ—¶RMçš„å·¥ä½œ**ï¼š

- æ ¹æ®undo-logæ¢å¤æ•°æ®åˆ°æ›´æ–°å‰

![image-20230311212141324](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311212141324.png)

![image-20230311212428736](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311212428736.png)

ä¾‹å¦‚ï¼Œä¸€ä¸ªåˆ†æ”¯ä¸šåŠ¡çš„SQLæ˜¯è¿™æ ·çš„ï¼šupdate tb_account set money = money - 10 where id = 1

![image-20230311212835820](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311212835820.png)

ATæ¨¡å¼ä¸XAæ¨¡å¼æœ€å¤§çš„åŒºåˆ«

- XAæ¨¡å¼ä¸€é˜¶æ®µä¸æäº¤äº‹åŠ¡ï¼Œé”å®šèµ„æºï¼›ATæ¨¡å¼ä¸€é˜¶æ®µç›´æ¥ æäº¤ï¼Œä¸é”å®šèµ„æºã€‚
- XAæ¨¡å¼ä¾èµ–æ•°æ®åº“æœºåˆ¶å®ç°å›æ»šï¼›ATæ¨¡å¼åˆ©ç”¨æ•°æ®å¿«ç…§å® ç°æ•°æ®å›æ»š
- XAæ¨¡å¼å¼ºä¸€è‡´ï¼›ATæ¨¡å¼æœ€ç»ˆä¸€è‡´





**å‡ºç°è„å†™é—®é¢˜**

![image-20230311213133505](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311213133505.png)

**è§£å†³è„å†™é—®é¢˜**

![image-20230311213802206](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311213802206.png)





ATæ¨¡å¼çš„ä¼˜ç‚¹ï¼š

- ä¸€é˜¶æ®µå®Œæˆç›´æ¥æäº¤äº‹åŠ¡ï¼Œé‡Šæ”¾æ•°æ®åº“èµ„æºï¼Œæ€§èƒ½æ¯”è¾ƒå¥½

- åˆ©ç”¨å…¨å±€é”å®ç°è¯»å†™éš”ç¦»
- æ²¡æœ‰ä»£ç ä¾µå…¥ï¼Œæ¡†æ¶è‡ªåŠ¨å®Œæˆå›æ»šå’Œæäº¤

ATæ¨¡å¼çš„ç¼ºç‚¹ï¼š

- ä¸¤é˜¶æ®µä¹‹é—´å±äºè½¯çŠ¶æ€ï¼Œå±äºæœ€ç»ˆä¸€è‡´
- æ¡†æ¶çš„å¿«ç…§åŠŸèƒ½ä¼šå½±å“æ€§èƒ½ï¼Œä½†æ¯”XAæ¨¡å¼è¦å¥½å¾ˆå¤š





**å®ç°ATæ¨¡å¼**

ATæ¨¡å¼ä¸­çš„å¿«ç…§ç”Ÿæˆã€å›æ»šç­‰åŠ¨ä½œéƒ½æ˜¯ç”±æ¡†æ¶è‡ªåŠ¨å®Œæˆï¼Œæ²¡æœ‰ä»»ä½•ä»£ç ä¾µå…¥ï¼Œå› æ­¤å®ç°éå¸¸ç®€å•ã€‚

ç”±äºéœ€è¦ç”Ÿæˆå¿«ç…§ä¿¡æ¯ï¼ŒATæ¨¡å¼éœ€è¦ä¸¤å¼ æ•°æ®åº“è¡¨``undo_log`å’Œ`lock_table`

`lock_table`å¯¼å…¥åˆ°`TCæœåŠ¡`å…³è”çš„æ•°æ®åº“

`undo_log`è¡¨å¯¼å…¥åˆ°`å¾®æœåŠ¡`å…³è”çš„æ•°æ®åº“

```sql
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for undo_log
-- ----------------------------
DROP TABLE IF EXISTS `undo_log`;
CREATE TABLE `undo_log`  (
  `branch_id` bigint(20) NOT NULL COMMENT 'branch transaction id',
  `xid` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT 'global transaction id',
  `context` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT 'undo_log context,such as serialization',
  `rollback_info` longblob NOT NULL COMMENT 'rollback info',
  `log_status` int(11) NOT NULL COMMENT '0:normal status,1:defense status',
  `log_created` datetime(6) NOT NULL COMMENT 'create datetime',
  `log_modified` datetime(6) NOT NULL COMMENT 'modify datetime',
  UNIQUE INDEX `ux_undo_log`(`xid`, `branch_id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci COMMENT = 'AT transaction mode undo table' ROW_FORMAT = Compact;


-- ----------------------------
-- Table structure for lock_table
-- ----------------------------
DROP TABLE IF EXISTS `lock_table`;
CREATE TABLE `lock_table`  (
  `row_key` varchar(128) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `xid` varchar(96) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `transaction_id` bigint(20) NULL DEFAULT NULL,
  `branch_id` bigint(20) NOT NULL,
  `resource_id` varchar(256) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `table_name` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `pk` varchar(36) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL,
  `gmt_create` datetime NULL DEFAULT NULL,
  `gmt_modified` datetime NULL DEFAULT NULL,
  PRIMARY KEY (`row_key`) USING BTREE,
  INDEX `idx_branch_id`(`branch_id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Compact;


SET FOREIGN_KEY_CHECKS = 1;
```



ä¿®æ”¹application.ymlæ–‡ä»¶ï¼Œå°†äº‹åŠ¡æ¨¡å¼ä¿®æ”¹ä¸ºATæ¨¡å¼å³å¯ï¼š

```yaml
 seata: 
   data-source-proxy-mode: AT # å¼€å¯æ•°æ®æºä»£ç†çš„ATæ¨¡å¼
```



é‡å¯æœåŠ¡å¹¶æµ‹è¯•



---



#### 3ï¸âƒ£TCCæ¨¡å¼



TCCæ¨¡å¼ä¸ATæ¨¡å¼éå¸¸ç›¸ä¼¼ï¼Œæ¯é˜¶æ®µéƒ½æ˜¯ç‹¬ç«‹äº‹åŠ¡ï¼Œä¸åŒçš„æ˜¯TCCé€šè¿‡äººå·¥ç¼–ç æ¥å®ç°æ•°æ®æ¢å¤ã€‚

éœ€è¦å®ç°ä¸‰ä¸ªæ–¹æ³• ï¼š

- Tryï¼šèµ„æºçš„æ£€æµ‹å’Œé¢„ç•™
- Confirmï¼šå®Œæˆèµ„æºæ“ä½œä¸šåŠ¡ï¼›è¦æ±‚ Try æˆåŠŸ Confirm ä¸€å®šè¦èƒ½æˆåŠŸã€‚
- Cancelï¼šé¢„ç•™èµ„æºé‡Šæ”¾ï¼Œå¯ä»¥ç†è§£ä¸ºtryçš„åå‘æ“ä½œã€‚







ä¾‹å¦‚ï¼š

---

**é˜¶æ®µä¸€ï¼ˆ Try ï¼‰**ï¼šæ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³ï¼Œå¦‚æœå……è¶³åˆ™å†»ç»“é‡‘é¢å¢åŠ 30å…ƒï¼Œå¯ç”¨ä½™é¢æ‰£é™¤30

åˆè¯†ä½™é¢ï¼š

![image-20210724182424907](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210724182424907.png)

ä½™é¢å……è¶³ï¼Œå¯ä»¥å†»ç»“ï¼š

![image-20210724182457951](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210724182457951.png)



æ­¤æ—¶ï¼Œæ€»é‡‘é¢ = å†»ç»“é‡‘é¢ + å¯ç”¨é‡‘é¢ï¼Œæ•°é‡ä¾ç„¶æ˜¯100ä¸å˜ã€‚äº‹åŠ¡ç›´æ¥æäº¤æ— éœ€ç­‰å¾…å…¶å®ƒäº‹åŠ¡ã€‚

---



**é˜¶æ®µäºŒï¼ˆConfirm)**ï¼šå‡å¦‚è¦æäº¤ï¼ˆConfirmï¼‰ï¼Œåˆ™å†»ç»“é‡‘é¢æ‰£å‡30

ç¡®è®¤å¯ä»¥æäº¤ï¼Œä¸è¿‡ä¹‹å‰å¯ç”¨é‡‘é¢å·²ç»æ‰£å‡è¿‡äº†ï¼Œè¿™é‡Œåªè¦æ¸…é™¤å†»ç»“é‡‘é¢å°±å¥½äº†ï¼š

![image-20210724182706011](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210724182706011.png)

æ­¤æ—¶ï¼Œæ€»é‡‘é¢ = å†»ç»“é‡‘é¢ + å¯ç”¨é‡‘é¢ = 0 + 70  = 70å…ƒ

---



**é˜¶æ®µäºŒ(Canncel)**ï¼šå¦‚æœè¦å›æ»šï¼ˆCancelï¼‰ï¼Œåˆ™å†»ç»“é‡‘é¢æ‰£å‡30ï¼Œå¯ç”¨ä½™é¢å¢åŠ 30

éœ€è¦å›æ»šï¼Œé‚£ä¹ˆå°±è¦é‡Šæ”¾å†»ç»“é‡‘é¢ï¼Œæ¢å¤å¯ç”¨é‡‘é¢ï¼š

![image-20210724182810734](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210724182810734.png)

---

---





**TCCçš„å·¥ä½œæ¨¡å‹å›¾ï¼š**

![image-20230311215306253](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311215306253.png)

TCCæ¨¡å¼çš„æ¯ä¸ªé˜¶æ®µ

- Tryï¼šèµ„æºæ£€æŸ¥å’Œé¢„ç•™
- Confirmï¼šä¸šåŠ¡æ‰§è¡Œå’Œæäº¤
- Cancelï¼šé¢„ç•™èµ„æºçš„é‡Šæ”¾

TCCçš„ä¼˜ç‚¹

- ä¸€é˜¶æ®µå®Œæˆç›´æ¥æäº¤äº‹åŠ¡ï¼Œé‡Šæ”¾æ•°æ®åº“èµ„æºï¼Œæ€§èƒ½å¥½
- ç›¸æ¯”ATæ¨¡å‹ï¼Œæ— éœ€ç”Ÿæˆå¿«ç…§ï¼Œæ— éœ€ä½¿ç”¨å…¨å±€é”ï¼Œæ€§èƒ½æœ€å¼º
- ä¸ä¾èµ–æ•°æ®åº“äº‹åŠ¡ï¼Œè€Œæ˜¯ä¾èµ–è¡¥å¿æ“ä½œï¼Œå¯ä»¥ç”¨äºéäº‹åŠ¡å‹æ•°æ®åº“

TCCçš„ç¼ºç‚¹

- æœ‰ä»£ç ä¾µå…¥ï¼Œéœ€è¦äººä¸ºç¼–å†™tryã€Confirmå’ŒCancelæ¥å£ï¼Œå¤ªéº»çƒ¦
- è½¯çŠ¶æ€ï¼Œäº‹åŠ¡æ˜¯æœ€ç»ˆä¸€è‡´
- éœ€è¦è€ƒè™‘Confirmå’ŒCancelçš„å¤±è´¥æƒ…å†µï¼Œåšå¥½å¹‚ç­‰å¤„ç†
- ä¸šä½™å±€é™



---





**åˆ©ç”¨TCCå®ç°åˆ†å¸ƒå¼äº‹åŠ¡**

éœ€æ±‚å¦‚ä¸‹ï¼š

- ä¿®æ”¹account-serviceï¼Œç¼–å†™tryã€confirmã€cancelé€»è¾‘
- tryä¸šåŠ¡ï¼šæ·»åŠ å†»ç»“é‡‘é¢ï¼Œæ‰£å‡å¯ç”¨é‡‘é¢
- confirmä¸šåŠ¡ï¼šåˆ é™¤å†»ç»“é‡‘é¢
- cancelä¸šåŠ¡ï¼šåˆ é™¤å†»ç»“é‡‘é¢ï¼Œæ¢å¤å¯ç”¨é‡‘é¢
- ä¿è¯confirmã€cancelæ¥å£çš„å¹‚ç­‰æ€§
- å…è®¸ç©ºå›æ»š
- æ‹’ç»ä¸šåŠ¡æ‚¬æŒ‚



TCCçš„ç©ºå›æ»šå’Œä¸šåŠ¡æ‚¬æŒ‚



`ç©ºå›æ»š`ï¼šå½“æŸåˆ†æ”¯äº‹åŠ¡çš„tryé˜¶æ®µé˜»å¡æ—¶ï¼Œå¯èƒ½å¯¼è‡´å…¨å±€äº‹åŠ¡è¶…æ—¶è€Œè§¦å‘äºŒé˜¶æ®µçš„cancelæ“ä½œã€‚åœ¨æœªæ‰§è¡Œtryæ“ä½œæ—¶å…ˆæ‰§è¡Œäº† cancelæ“ä½œï¼Œè¿™æ—¶cancelä¸èƒ½åšå›æ»šï¼Œå°±æ˜¯ç©ºå›æ»šã€‚

`ä¸šåŠ¡æ‚¬æŒ‚`ï¼šå¯¹äºå·²ç»ç©ºå›æ»šçš„ä¸šåŠ¡ï¼Œå¦‚æœä»¥ åç»§ç»­æ‰§è¡Œtryï¼Œå°±æ°¸è¿œä¸å¯èƒ½ confirmæˆ–cancelï¼Œè¿™å°±æ˜¯ä¸šåŠ¡ æ‚¬æŒ‚ã€‚åº”å½“é˜»æ­¢æ‰§è¡Œç©ºå›æ»šåçš„ tryæ“ä½œï¼Œé¿å…æ‚¬æŒ‚

![image-20230311220107126](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311220107126.png)

---



![image-20230311220134500](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311220134500.png)

```mysql
CREATE TABLE `account_freeze_tbl` (
	`xid` varchar(128) NOT NULL,
	`user_id` varchar(255) DEFAULT NULL COMMENT 'ç”¨æˆ·id',
	`freeze_money` int(11) unsigned DEFAULT '0' COMMENT 'å†»ç»“é‡‘é¢',
	`state` int(1) DEFAULT NULL COMMENT 'äº‹åŠ¡çŠ¶æ€ï¼Œ0:tryï¼Œ1:confirmï¼Œ2:cancel',
    PRIMARY KEY (`xid`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT;
```





**å£°æ˜TCCæ¥å£**

TCCçš„Tryã€Confirmã€Cancelæ–¹æ³•éƒ½éœ€è¦åœ¨æ¥å£ä¸­åŸºäºæ³¨è§£æ¥å£°æ˜ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š

åœ¨account-serviceé¡¹ç›®ä¸­çš„`com.ganga.account.service`åŒ…ä¸­æ–°å»ºä¸€ä¸ªæ¥å£ï¼Œå£°æ˜TCCä¸‰ä¸ªæ¥å£ï¼š

```java
package com.ganga.account.service;

import io.seata.rm.tcc.api.BusinessActionContext;
import io.seata.rm.tcc.api.BusinessActionContextParameter;
import io.seata.rm.tcc.api.LocalTCC;
import io.seata.rm.tcc.api.TwoPhaseBusinessAction;

@LocalTCC
public interface AccountTCCService {

    @TwoPhaseBusinessAction(name = "deduct", commitMethod = "confirm", rollbackMethod = "cancel")
    void deduct(@BusinessActionContextParameter(paramName = "userId") String userId,
                @BusinessActionContextParameter(paramName = "money")int money);

    boolean confirm(BusinessActionContext ctx);

    boolean cancel(BusinessActionContext ctx);
}
```



ç¼–å†™å®ç°ç±»

åœ¨account-serviceæœåŠ¡ä¸­çš„`com.ganga.account.service.impl`åŒ…ä¸‹æ–°å»ºä¸€ä¸ªç±»ï¼Œå®ç°TCCä¸šåŠ¡ï¼š

```java
@Service
@Slf4j
public class AccountTCCServiceImpl implements AccountTCCService {

    @Autowired
    private AccountMapper accountMapper;
    @Autowired
    private AccountFreezeMapper freezeMapper;

    @Override
    @Transactional
    public void deduct(String userId, int money) {
        // 0.è·å–äº‹åŠ¡id
        String xid = RootContext.getXID();
        // 1.æ‰£å‡å¯ç”¨ä½™é¢
        accountMapper.deduct(userId, money);
        // 2.è®°å½•å†»ç»“é‡‘é¢ï¼Œäº‹åŠ¡çŠ¶æ€
        AccountFreeze freeze = new AccountFreeze();
        freeze.setUserId(userId);
        freeze.setFreezeMoney(money);
        freeze.setState(AccountFreeze.State.TRY);
        freeze.setXid(xid);
        freezeMapper.insert(freeze);
    }

    @Override
    public boolean confirm(BusinessActionContext ctx) {
        // 1.è·å–äº‹åŠ¡id
        String xid = ctx.getXid();
        // 2.æ ¹æ®idåˆ é™¤å†»ç»“è®°å½•
        int count = freezeMapper.deleteById(xid);
        return count == 1;
    }

    @Override
    public boolean cancel(BusinessActionContext ctx) {
        // 0.æŸ¥è¯¢å†»ç»“è®°å½•
        String xid = ctx.getXid();
        AccountFreeze freeze = freezeMapper.selectById(xid);

        // 1.æ¢å¤å¯ç”¨ä½™é¢
        accountMapper.refund(freeze.getUserId(), freeze.getFreezeMoney());
        // 2.å°†å†»ç»“é‡‘é¢æ¸…é›¶ï¼ŒçŠ¶æ€æ”¹ä¸ºCANCEL
        freeze.setFreezeMoney(0);
        freeze.setState(AccountFreeze.State.CANCEL);
        int count = freezeMapper.updateById(freeze);
        return count == 1;
    }
}
```





---





#### 4ï¸âƒ£SAGAæ¨¡å¼

Saga æ¨¡å¼æ˜¯ Seata å³å°†å¼€æºçš„é•¿äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œå°†ç”±èš‚èšé‡‘æœä¸»è¦è´¡çŒ®ã€‚

å…¶ç†è®ºåŸºç¡€æ˜¯ `Hector` & `Kenneth`åœ¨1987å¹´å‘è¡¨çš„è®ºæ–‡[Sagas](https://microservices.io/patterns/data/saga.html)ã€‚

Seataå®˜ç½‘å¯¹äºSagaçš„æŒ‡å—ï¼šhttps://seata.io/zh-cn/docs/user/saga.html





**åŸç†**

åœ¨`Sagaæ¨¡å¼`ä¸‹ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡å†…æœ‰å¤šä¸ªå‚ä¸è€…ï¼Œæ¯ä¸€ä¸ªå‚ä¸è€…éƒ½æ˜¯ä¸€ä¸ªå†²æ­£è¡¥å¿æœåŠ¡ï¼Œéœ€è¦ç”¨æˆ·æ ¹æ®ä¸šåŠ¡åœºæ™¯å®ç°å…¶æ­£å‘æ“ä½œå’Œé€†å‘å›æ»šæ“ä½œã€‚

åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¾æ¬¡æ‰§è¡Œå„å‚ä¸è€…çš„æ­£å‘æ“ä½œï¼Œå¦‚æœæ‰€æœ‰æ­£å‘æ“ä½œå‡æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆåˆ†å¸ƒå¼äº‹åŠ¡æäº¤ã€‚å¦‚æœä»»ä½•ä¸€ä¸ªæ­£å‘æ“ä½œæ‰§è¡Œå¤±è´¥ï¼Œé‚£ä¹ˆåˆ†å¸ƒå¼äº‹åŠ¡ä¼šå»é€€å›å»æ‰§è¡Œå‰é¢å„å‚ä¸è€…çš„é€†å‘å›æ»šæ“ä½œï¼Œå›æ»šå·²æäº¤çš„å‚ä¸è€…ï¼Œä½¿åˆ†å¸ƒå¼äº‹åŠ¡å›åˆ°åˆå§‹çŠ¶æ€ã€‚

![image-20230311221005583](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311221005583.png)

Sagaæ¨¡å¼æ˜¯SEATAæä¾›çš„é•¿äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚ä¹Ÿåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

- ä¸€é˜¶æ®µï¼šç›´æ¥æäº¤æœ¬åœ°äº‹åŠ¡
- äºŒé˜¶æ®µï¼šæˆåŠŸåˆ™ä»€ä¹ˆéƒ½ä¸åšï¼›å¤±è´¥åˆ™é€šè¿‡ç¼–å†™è¡¥å¿ä¸šåŠ¡æ¥å›æ»š



Sagaæ¨¡å¼ä¼˜ç‚¹ï¼š

- äº‹åŠ¡å‚ä¸è€…å¯ä»¥åŸºäºäº‹ä»¶é©±åŠ¨å®ç°å¼‚æ­¥è°ƒç”¨ï¼Œååé«˜
- ä¸€é˜¶æ®µç›´æ¥æäº¤äº‹åŠ¡ï¼Œæ— é”ï¼Œæ€§èƒ½å¥½
- ä¸ç”¨ç¼–å†™TCCä¸­çš„ä¸‰ä¸ªé˜¶æ®µï¼Œå®ç°ç®€å•

Sagaæ¨¡å¼ç¼ºç‚¹ï¼š

- è½¯çŠ¶æ€æŒç»­æ—¶é—´ä¸ç¡®å®šï¼Œæ—¶æ•ˆæ€§å·®
- æ²¡æœ‰é”ï¼Œæ²¡æœ‰äº‹åŠ¡éš”ç¦»ï¼Œä¼šæœ‰è„å†™





#### ğŸ†šå››ç§æ¨¡å¼å¯¹æ¯”

![image-20230311221914300](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311221914300.png)





#### ğŸ†˜Seataé«˜å¯ç”¨





**TCçš„å¼‚åœ°å¤šæœºæˆ¿å®¹ç¾æ¶æ„**

TCæœåŠ¡ä½œä¸ºSeataçš„æ ¸å¿ƒæœåŠ¡ï¼Œä¸€å®šè¦ä¿è¯é«˜å¯ç”¨å’Œå¼‚åœ°å®¹ç¾ã€‚

![image-20230311222733286](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20230311222733286.png)



---



**1ï¸âƒ£æ¨¡æ‹Ÿå¼‚åœ°å®¹ç¾çš„TCé›†ç¾¤**



è®¡åˆ’å¯åŠ¨ä¸¤å°seataçš„tcæœåŠ¡èŠ‚ç‚¹ï¼š

| èŠ‚ç‚¹åç§° | ipåœ°å€    | ç«¯å£å· | é›†ç¾¤åç§° |
| -------- | --------- | ------ | -------- |
| seata    | 127.0.0.1 | 8091   | SH       |
| seata2   | 127.0.0.1 | 8092   | HZ       |

ä¹‹å‰æˆ‘ä»¬å·²ç»å¯åŠ¨äº†ä¸€å°seataæœåŠ¡ï¼Œç«¯å£æ˜¯8091ï¼Œé›†ç¾¤åä¸ºSHã€‚

ç°åœ¨ï¼Œå°†seataç›®å½•å¤åˆ¶ä¸€ä»½ï¼Œèµ·åä¸ºseata2

ä¿®æ”¹`seata2/conf/registry.conf`æˆ–`seata2/conf/application.yaml`å†…å®¹å¦‚ä¸‹ï¼š

```yaml
registry {
  # tcæœåŠ¡çš„æ³¨å†Œä¸­å¿ƒç±»ï¼Œè¿™é‡Œé€‰æ‹©nacosï¼Œä¹Ÿå¯ä»¥æ˜¯eurekaã€zookeeperç­‰
  type = "nacos"

  nacos {
    # seata tc æœåŠ¡æ³¨å†Œåˆ° nacosçš„æœåŠ¡åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰
    application = "seata-tc-server"
    serverAddr = "127.0.0.1:8848"
    group = "DEFAULT_GROUP"
    namespace = ""
    cluster = "HZ"
    username = "nacos"
    password = "nacos"
  }
}

config {
  # è¯»å–tcæœåŠ¡ç«¯çš„é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œè¿™é‡Œæ˜¯ä»nacosé…ç½®ä¸­å¿ƒè¯»å–ï¼Œè¿™æ ·å¦‚æœtcæ˜¯é›†ç¾¤ï¼Œå¯ä»¥å…±äº«é…ç½®
  type = "nacos"
  # é…ç½®nacosåœ°å€ç­‰ä¿¡æ¯
  nacos {
    serverAddr = "127.0.0.1:8848"
    namespace = ""
    group = "SEATA_GROUP"
    username = "nacos"
    password = "nacos"
    dataId = "seataServer.properties"
  }
}
```



è¿›å…¥seata2/binç›®å½•ï¼Œç„¶åè¿è¡Œå‘½ä»¤ï¼š

```powershell
seata-server.bat -p 8092
```

æ‰“å¼€nacosæ§åˆ¶å°ï¼ŒæŸ¥çœ‹æœåŠ¡åˆ—è¡¨ï¼š

![image-20210624151150840](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210624151150840.png)

ç‚¹è¿›è¯¦æƒ…æŸ¥çœ‹ï¼š

![image-20210624151221747](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210624151221747.png)





**2ï¸âƒ£å°†äº‹åŠ¡ç»„æ˜ å°„é…ç½®åˆ°nacos**

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å°†tx-service-groupä¸clusterçš„æ˜ å°„å…³ç³»éƒ½é…ç½®åˆ°nacosé…ç½®ä¸­å¿ƒã€‚

æ–°å»ºä¸€ä¸ªé…ç½®ï¼š

![image-20210624151507072](MDå›¾ç‰‡/SpringCloudç¬”è®°å¤‡å¿˜.assets/image-20210624151507072.png)

é…ç½®çš„å†…å®¹å¦‚ä¸‹ï¼š

```properties
# äº‹åŠ¡ç»„æ˜ å°„å…³ç³»
service.vgroupMapping.seata-demo=SH

service.enableDegrade=false
service.disableGlobalTransaction=false
# ä¸TCæœåŠ¡çš„é€šä¿¡é…ç½®
transport.type=TCP
transport.server=NIO
transport.heartbeat=true
transport.enableClientBatchSendRequest=false
transport.threadFactory.bossThreadPrefix=NettyBoss
transport.threadFactory.workerThreadPrefix=NettyServerNIOWorker
transport.threadFactory.serverExecutorThreadPrefix=NettyServerBizHandler
transport.threadFactory.shareBossWorker=false
transport.threadFactory.clientSelectorThreadPrefix=NettyClientSelector
transport.threadFactory.clientSelectorThreadSize=1
transport.threadFactory.clientWorkerThreadPrefix=NettyClientWorkerThread
transport.threadFactory.bossThreadSize=1
transport.threadFactory.workerThreadSize=default
transport.shutdown.wait=3
# RMé…ç½®
client.rm.asyncCommitBufferLimit=10000
client.rm.lock.retryInterval=10
client.rm.lock.retryTimes=30
client.rm.lock.retryPolicyBranchRollbackOnConflict=true
client.rm.reportRetryCount=5
client.rm.tableMetaCheckEnable=false
client.rm.tableMetaCheckerInterval=60000
client.rm.sqlParserType=druid
client.rm.reportSuccessEnable=false
client.rm.sagaBranchRegisterEnable=false
# TMé…ç½®
client.tm.commitRetryCount=5
client.tm.rollbackRetryCount=5
client.tm.defaultGlobalTransactionTimeout=60000
client.tm.degradeCheck=false
client.tm.degradeCheckAllowTimes=10
client.tm.degradeCheckPeriod=2000

# undoæ—¥å¿—é…ç½®
client.undo.dataValidation=true
client.undo.logSerialization=jackson
client.undo.onlyCareUpdateColumns=true
client.undo.logTable=undo_log
client.undo.compress.enable=true
client.undo.compress.type=zip
client.undo.compress.threshold=64k
client.log.exceptionRate=100
```







**3ï¸âƒ£å¾®æœåŠ¡è¯»å–nacosé…ç½®**

æ¥ä¸‹æ¥ï¼Œéœ€è¦ä¿®æ”¹æ¯ä¸€ä¸ªå¾®æœåŠ¡çš„application.ymlæ–‡ä»¶ï¼Œè®©å¾®æœåŠ¡è¯»å–nacosä¸­çš„client.propertiesæ–‡ä»¶ï¼š

```yaml
seata:
  config:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      username: nacos
      password: nacos
      group: SEATA_GROUP
      data-id: client.properties
```







**3ï¸âƒ£é‡å¯å¾®æœåŠ¡**ï¼Œç°åœ¨å¾®æœåŠ¡åˆ°åº•æ˜¯è¿æ¥tcçš„SHé›†ç¾¤ï¼Œè¿˜æ˜¯tcçš„HZé›†ç¾¤ï¼Œéƒ½ç»Ÿä¸€ç”±nacosçš„client.propertiesæ¥å†³å®šäº†ã€‚





















## âš¡åˆ†å¸ƒå¼ç¼“å­˜



### OK

å¦ä¸€ä¸ªåº“ï¼š[åŸºäºRedis+Nginx+Caffin](https://github.com/ayaka-icu/MyRedis/blob/master/README.md)











## ğŸ’Œé«˜çº§MQå®ç° TODO:



### TODO:





---

---









## ğŸ‘»ğŸ‘»å•è¯å¤‡å¿˜



|         å•è¯         |         è§£é‡Š         |
| :------------------: | :------------------: |
| -------------------- | -------------------- |
|     LoadBalanced     |       è´Ÿè½½å‡è¡¡       |
|  RegistrationCenter  |       æ³¨å†Œä¸­å¿ƒ       |
|      discovery       |         å‘ç°         |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |
|                      |                      |













































